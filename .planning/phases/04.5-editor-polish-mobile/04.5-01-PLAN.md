---
phase: 04.5-editor-polish-mobile
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/hooks/use-media-query.ts
  - src/hooks/use-online.ts
  - src/lib/image-compression.ts
  - src/lib/url-validation.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "Editor detects mobile vs desktop breakpoints including tablet orientation"
    - "Editor detects online/offline network state"
    - "Images can be compressed client-side before upload"
    - "URLs can be validated and auto-fixed with https://"
  artifacts:
    - path: "src/hooks/use-media-query.ts"
      provides: "Generic media query hook"
      exports: ["useMediaQuery", "useIsMobileLayout"]
    - path: "src/hooks/use-online.ts"
      provides: "Online/offline detection hook"
      exports: ["useOnline"]
    - path: "src/lib/image-compression.ts"
      provides: "Image compression wrapper"
      exports: ["compressImageForUpload"]
    - path: "src/lib/url-validation.ts"
      provides: "URL validation utilities"
      exports: ["validateAndFixUrl"]
  key_links:
    - from: "src/hooks/use-media-query.ts"
      to: "window.matchMedia"
      via: "media query listeners"
      pattern: "matchMedia.*change"
    - from: "src/hooks/use-online.ts"
      to: "navigator.onLine"
      via: "online/offline events"
      pattern: "addEventListener.*online|offline"
    - from: "src/lib/image-compression.ts"
      to: "browser-image-compression"
      via: "library import"
      pattern: "imageCompression"
---

<objective>
Create foundational hooks and utilities for mobile responsiveness, offline detection, image compression, and URL validation.

Purpose: These utilities underpin all mobile-responsive and error-handling features in subsequent plans.
Output: Four utility modules ready for integration into editor components.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04.5-editor-polish-mobile/04.5-CONTEXT.md
@.planning/phases/04.5-editor-polish-mobile/04.5-RESEARCH.md
@src/hooks/use-mobile.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create media query hooks</name>
  <files>
    package.json
    src/hooks/use-media-query.ts
  </files>
  <action>
    1. Install required dependencies:
       ```bash
       pnpm add browser-image-compression
       pnpm dlx shadcn@latest add drawer
       ```

    2. Create `src/hooks/use-media-query.ts` with:
       - Generic `useMediaQuery(query: string): boolean` hook using window.matchMedia with event listeners
       - `useIsMobileLayout(): boolean` that combines width AND orientation:
         - Returns true if width < 768px OR (tablet-sized AND portrait orientation)
         - This ensures tablets in landscape get desktop layout
       - Handle SSR by returning false initially and updating on mount
       - Use proper cleanup with removeEventListener

    Note: The existing `src/hooks/use-mobile.ts` remains unchanged (it's used elsewhere). The new hook adds orientation awareness.
  </action>
  <verify>
    - `pnpm list browser-image-compression` shows installed
    - `src/components/ui/drawer.tsx` exists (shadcn component added)
    - `src/hooks/use-media-query.ts` exports useMediaQuery and useIsMobileLayout
    - TypeScript compiles: `pnpm tsc --noEmit`
  </verify>
  <done>
    Dependencies installed; useMediaQuery hook detects breakpoints with orientation support.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create online/offline detection hook</name>
  <files>
    src/hooks/use-online.ts
  </files>
  <action>
    Create `src/hooks/use-online.ts` with:

    - `useOnline(): boolean` hook that:
      1. Returns `navigator.onLine` state
      2. Listens to `online` and `offline` window events
      3. Debounces state changes by 500ms to prevent flickering on unstable connections
      4. Handles SSR gracefully (assume online initially)
      5. Cleans up event listeners on unmount

    Implementation notes:
    - Use useState + useEffect pattern (not useSyncExternalStore, as debouncing adds complexity)
    - Debounce ONLY going offline (not coming online) - users want immediate feedback when reconnected
    - Reference: MDN navigator.onLine documentation
  </action>
  <verify>
    - `src/hooks/use-online.ts` exists and exports `useOnline`
    - Hook returns boolean
    - TypeScript compiles: `pnpm tsc --noEmit`
  </verify>
  <done>
    useOnline hook detects connection state with debounced offline detection.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create image compression and URL validation utilities</name>
  <files>
    src/lib/image-compression.ts
    src/lib/url-validation.ts
  </files>
  <action>
    1. Create `src/lib/image-compression.ts`:
       - `compressImageForUpload(file: File): Promise<Blob>` that:
         - PRESERVES animated GIFs - check `file.type === 'image/gif'` and return original
         - Compresses other images with browser-image-compression:
           - maxSizeMB: 1
           - maxWidthOrHeight: 1920
           - useWebWorker: true
           - initialQuality: 0.8
           - fileType: preserve original format (file.type)
         - Falls back to original file if compression fails (log error, don't throw)
         - Returns Blob (compatible with existing upload functions)

    2. Create `src/lib/url-validation.ts`:
       - `validateAndFixUrl(input: string): { valid: boolean; url?: string; error?: string }` that:
         - Trims input
         - Returns early `{ valid: true, url: '' }` if input is empty (allow optional URLs)
         - Auto-adds `https://` if no protocol present
         - Uses native `new URL()` constructor for validation (handles international domains)
         - Only allows http:// and https:// protocols
         - Returns `{ valid: true, url: normalizedUrl }` or `{ valid: false, error: 'message' }`
  </action>
  <verify>
    - Both files exist and export their functions
    - TypeScript compiles: `pnpm tsc --noEmit`
    - Verify imports resolve: browser-image-compression imported correctly
  </verify>
  <done>
    Image compression wrapper and URL validation utility ready for integration.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Run `pnpm tsc --noEmit` - no type errors
2. Run `pnpm lint` - no lint errors
3. Verify all 4 new files exist:
   - src/hooks/use-media-query.ts
   - src/hooks/use-online.ts
   - src/lib/image-compression.ts
   - src/lib/url-validation.ts
4. Verify shadcn drawer component added: src/components/ui/drawer.tsx
5. Verify browser-image-compression in package.json dependencies
</verification>

<success_criteria>
- All hooks and utilities exported and typed correctly
- No breaking changes to existing code
- Dependencies installed and verified
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/04.5-editor-polish-mobile/04.5-01-SUMMARY.md`
</output>
