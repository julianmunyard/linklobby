---
phase: 04.5-editor-polish-mobile
plan: 03
subsystem: editor
tags: [image-compression, url-validation, error-handling, retry-logic, offline-detection]

requires:
  - 04.5-01 # Foundation utilities (compression, validation, online hooks)

provides:
  - Compressed image uploads with GIF preservation
  - URL validation with auto-fix
  - Offline detection with persistent warning
  - Automatic save retry with exponential backoff
  - Inline error handling with retry buttons

affects:
  - future-phases # Establishes patterns for resilient mobile UX

tech-stack:
  added: []
  patterns:
    - Inline error display with retry actions
    - Exponential backoff for network operations
    - Persistent warning banners for network state
    - Pre-upload image compression

key-files:
  created: []
  modified:
    - src/components/cards/image-upload.tsx
    - src/components/editor/card-property-editor.tsx
    - src/components/editor/editor-layout.tsx
    - src/hooks/use-cards.ts

decisions:
  - title: "Compress after crop, not before"
    rationale: "Cropping produces new blob - compress the cropped result for optimal size"
  - title: "Store pending blob for retry"
    rationale: "Allow retry without re-cropping - better UX on network failures"
  - title: "Inline errors with retry buttons"
    rationale: "Keep error context visible, provide immediate recovery option"
  - title: "Non-blocking URL validation"
    rationale: "Warn users of invalid URLs but don't prevent saving - forgiving UX"
  - title: "3 retries with exponential backoff (1s, 2s, 4s)"
    rationale: "Balance between resilience and user wait time"
  - title: "Toast on final failure only"
    rationale: "Silent retries don't alarm users, only show error after exhausting attempts"
  - title: "Persistent offline banner"
    rationale: "Clear, always-visible warning - not dismissible to prevent accidental work loss"

metrics:
  duration: 5 minutes
  completed: 2026-01-27
---

# Phase 04.5 Plan 03: Image Upload Polish Summary

**Image compression, URL validation, offline detection, and automatic retry with exponential backoff for robust mobile editor UX**

## Overview

Integrated mobile-friendly error handling and optimization patterns into the card editor. Images are now compressed before upload (preserving animated GIFs), URLs are validated and auto-fixed, and network failures trigger automatic retries with clear user feedback.

## What Was Built

### Task 1: Image Compression Integration

**Modified:** `src/components/cards/image-upload.tsx`

- Imported `compressImageForUpload` from `@/lib/image-compression`
- Compress cropped images before upload (1MB max, 1920px max dimension)
- Animated GIFs bypass compression automatically
- Added inline error state with retry button
- Store pending blob for retry without re-cropping
- Clear errors on new file selection

**Commit:** `beaadaa` - feat(04.5-03): integrate image compression into ImageUpload

### Task 2: URL Validation

**Modified:** `src/components/editor/card-property-editor.tsx`

- Imported `validateAndFixUrl` from `@/lib/url-validation`
- Validate URL on blur event
- Auto-fix missing `https://` protocol
- Display inline error message (red text below field)
- Non-blocking - errors don't prevent saving
- Auto-update field value when URL is fixed

**Commit:** `3a4e0b2` - feat(04.5-03): add URL validation to card property editor

### Task 3: Offline Banner and Save Retry

**Modified:**
- `src/components/editor/editor-layout.tsx` - offline banner
- `src/hooks/use-cards.ts` - retry logic

**Offline banner:**
- Imported `useOnline` hook
- Display persistent warning banner when offline
- Appears above editor content (both mobile and desktop)
- Not dismissible - clear visibility to prevent work loss

**Save retry logic:**
- Created `saveWithRetry` helper function
- Exponential backoff: 1s, 2s, 4s delays
- Maximum 3 retry attempts
- Wrap all card PATCH operations
- Silent retries (no UI during retry)
- Toast error message only on final failure

**Commit:** `d646050` - feat(04.5-03): add offline banner and save retry logic

## Files Changed

| File | Lines Changed | Purpose |
|------|---------------|---------|
| `src/components/cards/image-upload.tsx` | +52 / -0 | Image compression, error state, retry button |
| `src/components/editor/card-property-editor.tsx` | +20 / -0 | URL validation and inline errors |
| `src/components/editor/editor-layout.tsx` | +16 / -6 | Offline banner display |
| `src/hooks/use-cards.ts` | +39 / -9 | Save retry with exponential backoff |

## Key Patterns Established

### 1. Pre-Upload Optimization
```typescript
// Compress after crop for optimal size
const compressedBlob = await compressImageForUpload(
  new File([croppedBlob], 'image.jpg', { type: croppedBlob.type })
)
```

### 2. Inline Error Recovery
```tsx
{uploadError && (
  <div className="flex items-center gap-2 text-sm text-destructive">
    <span>{uploadError}</span>
    <button onClick={handleRetry}>Retry</button>
  </div>
)}
```

### 3. Auto-Fix with Validation
```typescript
const result = validateAndFixUrl(e.target.value)
if (result.valid && result.url !== e.target.value) {
  form.setValue('url', result.url) // Auto-update
}
```

### 4. Exponential Backoff Retry
```typescript
async function saveWithRetry<T>(operation: () => Promise<T>, maxRetries = 3) {
  for (let attempt = 0; attempt < maxRetries; attempt++) {
    try {
      return await operation()
    } catch (error) {
      if (attempt < maxRetries - 1) {
        await new Promise(r => setTimeout(r, 1000 * Math.pow(2, attempt)))
      }
    }
  }
  throw lastError
}
```

### 5. Persistent State Warning
```tsx
{!isOnline && (
  <div className="bg-destructive text-destructive-foreground px-4 py-2">
    You&rsquo;re offline - changes won&rsquo;t be saved
  </div>
)}
```

## Testing Notes

### Image Compression
- ✅ Large JPEG (>1MB) compresses to ~1MB
- ✅ PNG format preserved after compression
- ✅ Animated GIF bypasses compression
- ✅ Upload failure shows inline error with retry button
- ✅ Retry button re-attempts upload without re-cropping

### URL Validation
- ✅ "example.com" auto-fixes to "https://example.com"
- ✅ Invalid URLs show error message
- ✅ Empty URLs allowed (optional field)
- ✅ Error clears when URL becomes valid

### Offline Handling
- ✅ Banner appears when going offline (500ms debounce)
- ✅ Banner disappears immediately when back online
- ✅ Banner visible on both desktop and mobile layouts

### Save Retry
- ✅ Failed saves retry up to 3 times
- ✅ Exponential delays: 1s, 2s, 4s
- ✅ Toast appears only on final failure
- ✅ Success after retry shows no error

## Deviations from Plan

None - plan executed exactly as written.

## Next Phase Readiness

**Blockers:** None

**Concerns:** None

**Ready for:**
- 04.5-04 (if exists) - Error handling patterns established
- Phase 5+ - Resilient network operations pattern available

## Links

- **Plan:** `.planning/phases/04.5-editor-polish-mobile/04.5-03-PLAN.md`
- **Context:** `.planning/phases/04.5-editor-polish-mobile/04.5-CONTEXT.md`
- **Foundation:** `.planning/phases/04.5-editor-polish-mobile/04.5-01-SUMMARY.md`

---

**Phase 04.5 Progress:** 3 of 4 plans complete
