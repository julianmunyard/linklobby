# Phase 4.5: Editor Polish (Mobile) - Research

**Researched:** 2026-01-27
**Domain:** Mobile responsive UI, touch interactions, image optimization, error handling
**Confidence:** HIGH

## Summary

This phase focuses on making the LinkLobby editor work flawlessly on mobile devices and handling errors gracefully. The research investigated mobile UI patterns (bottom sheets, FABs), touch gesture handling, image optimization for uploads, URL validation, error recovery patterns, and offline detection.

The codebase already uses Radix UI primitives (Dialog/Sheet), Tailwind CSS for responsive design, Sonner for toasts, and has established patterns for state management (Zustand), form handling (react-hook-form), and image uploads. The mobile layout requires a bottom sheet pattern (not full-screen overlay), touch-friendly controls, and robust error handling with retry mechanisms.

**Primary recommendation:** Use shadcn/ui Drawer (built on Vaul) for mobile bottom sheet, browser-image-compression for client-side image optimization, native URL constructor for validation, custom useMediaQuery hook for responsive behavior, and extend existing toast patterns with inline error states for upload/save failures.

## Standard Stack

### Core

| Library | Version | Purpose | Why Standard |
|---------|---------|---------|--------------|
| Vaul | Latest (via shadcn/ui) | Bottom sheet/drawer component | Industry standard for mobile drawers, built on Radix Dialog, provides physics-based animations and gesture support |
| browser-image-compression | ^2.x | Client-side image compression | Most popular browser-based compression library, supports web workers for non-blocking compression, handles multiple formats |
| @use-gesture/react | ^10.x | Touch gesture handling | Standard gesture library for React web, supports drag, swipe, long-press, works with animation libraries |
| Native URL API | Built-in | URL validation | Browser native, no dependencies, most reliable validation method |
| navigator.onLine | Built-in | Offline detection | Standard browser API, real-time connection monitoring |

### Supporting

| Library | Version | Purpose | When to Use |
|---------|---------|---------|-------------|
| Tailwind touch-action utilities | v4 (current) | Control touch scrolling behavior | Prevent scroll conflicts during drag operations (touch-none on handles) |
| CSS orientation media queries | Built-in | Detect landscape/portrait | Tablet orientation handling (landscape → desktop, portrait → mobile) |
| window.matchMedia | Built-in | Responsive breakpoint detection | More efficient than resize listeners for breakpoint detection |

### Alternatives Considered

| Instead of | Could Use | Tradeoff |
|------------|-----------|----------|
| Vaul/shadcn Drawer | react-modal-sheet | Similar features but Vaul has better ecosystem integration with Radix |
| browser-image-compression | CompressorJS | CompressorJS is lighter but browser-image-compression has better format support and web worker integration |
| @use-gesture/react | Custom event handlers | Custom solution would miss edge cases like touch-action, multi-touch, and gesture conflicts |
| Native URL API | Regex validation | Regex is error-prone and can't handle all URL edge cases; URL constructor is safer |

**Installation:**
```bash
# Bottom sheet
pnpm dlx shadcn@latest add drawer

# Image compression
pnpm add browser-image-compression

# Touch gestures
pnpm add @use-gesture/react

# Already installed (existing dependencies)
# - @radix-ui/react-dialog (Drawer built on this)
# - sonner (toast notifications)
# - tailwindcss v4
```

## Architecture Patterns

### Recommended Project Structure

```
src/
├── components/
│   ├── ui/
│   │   ├── drawer.tsx           # shadcn/ui Drawer (add this)
│   │   ├── sheet.tsx            # Existing Sheet (desktop)
│   │   └── button.tsx           # Existing Button (use for FAB)
│   ├── editor/
│   │   ├── mobile-bottom-sheet.tsx    # Mobile editor panel wrapper
│   │   ├── editor-panel.tsx           # Existing (adapt for mobile)
│   │   └── card-property-editor.tsx   # Existing (use in bottom sheet)
│   └── cards/
│       └── image-upload.tsx           # Extend with compression
├── hooks/
│   ├── use-media-query.ts       # Add for responsive detection
│   ├── use-online.ts            # Add for offline detection
│   └── use-cards.ts             # Extend with retry logic
└── lib/
    ├── image-compression.ts     # Wrapper for browser-image-compression
    ├── url-validation.ts        # URL validation utilities
    └── utils.ts                 # Existing
```

### Pattern 1: Mobile-First Bottom Sheet

**What:** Replace sidebar with bottom sheet on mobile using shadcn/ui Drawer
**When to use:** Screen width < 768px (md breakpoint)
**Example:**
```typescript
// Source: https://ui.shadcn.com/docs/components/drawer
import { Drawer, DrawerContent, DrawerTrigger } from "@/components/ui/drawer"

export function MobileEditor() {
  return (
    <Drawer>
      <DrawerTrigger asChild>
        <Button className="md:hidden">Edit Card</Button>
      </DrawerTrigger>
      <DrawerContent>
        {/* Card property editor goes here */}
        <CardPropertyEditor card={selectedCard} />
      </DrawerContent>
    </Drawer>
  )
}
```

### Pattern 2: Responsive Layout with useMediaQuery

**What:** Conditionally render desktop vs mobile layouts based on screen size and orientation
**When to use:** Need to switch between desktop split-view and mobile bottom sheet
**Example:**
```typescript
// Source: https://usehooks.com/usemediaquery
function useMediaQuery(query: string): boolean {
  const [matches, setMatches] = useState(false)

  useEffect(() => {
    const media = window.matchMedia(query)
    setMatches(media.matches)

    const listener = () => setMatches(media.matches)
    media.addEventListener('change', listener)
    return () => media.removeEventListener('change', listener)
  }, [query])

  return matches
}

// Usage
const isMobile = useMediaQuery('(max-width: 768px)')
const isPortrait = useMediaQuery('(orientation: portrait)')
const useMobileLayout = isMobile || (isTablet && isPortrait)
```

### Pattern 3: Touch Gesture Handling

**What:** Long-press to enter drag mode, swipe gestures for actions
**When to use:** Mobile card reordering and swipe-to-delete/duplicate
**Example:**
```typescript
// Source: https://use-gesture.netlify.app/docs/
import { useLongPress, useDrag } from '@use-gesture/react'

function SortableCard() {
  const [dragMode, setDragMode] = useState(false)

  const bind = useLongPress(() => {
    setDragMode(true)
    // Haptic feedback if available
    navigator.vibrate?.(50)
  }, {
    threshold: 500, // 500ms long press
    onCancel: () => setDragMode(false)
  })

  return (
    <div {...bind()} className={cn(dragMode && "cursor-move")}>
      {/* Card content */}
    </div>
  )
}
```

### Pattern 4: Client-Side Image Compression

**What:** Auto-compress images before upload to reduce bandwidth
**When to use:** All image uploads in ImageUpload component
**Example:**
```typescript
// Source: https://github.com/Donaldcwl/browser-image-compression
import imageCompression from 'browser-image-compression'

async function compressImage(file: File): Promise<Blob> {
  // Preserve animated GIFs - don't compress
  if (file.type === 'image/gif') {
    return file
  }

  const options = {
    maxSizeMB: 1,
    maxWidthOrHeight: 1920,
    useWebWorker: true,
    initialQuality: 0.8,
    fileType: file.type // Preserve format (JPEG/PNG/WebP)
  }

  return await imageCompression(file, options)
}
```

### Pattern 5: URL Validation with Auto-Fix

**What:** Validate URLs using native URL constructor and auto-add https://
**When to use:** Link fields in card property editor
**Example:**
```typescript
// Source: https://www.freecodecamp.org/news/how-to-validate-urls-in-javascript/
function validateAndFixUrl(input: string): { valid: boolean; url?: string; error?: string } {
  let urlToTest = input.trim()

  // Auto-add https:// if no protocol
  if (urlToTest && !urlToTest.match(/^https?:\/\//i)) {
    urlToTest = `https://${urlToTest}`
  }

  try {
    const parsed = new URL(urlToTest)
    // Only allow http/https
    if (parsed.protocol !== 'http:' && parsed.protocol !== 'https:') {
      return { valid: false, error: 'Only HTTP/HTTPS URLs are supported' }
    }
    return { valid: true, url: parsed.href }
  } catch {
    return { valid: false, error: 'Invalid URL format' }
  }
}
```

### Pattern 6: Offline Detection with Persistent Banner

**What:** Monitor navigator.onLine and show persistent warning banner
**When to use:** Editor layout to warn users before they make unsaved changes
**Example:**
```typescript
// Source: https://medium.com/@abdulahad2024/real-time-network-status-detection-in-react-js-next-js-67595c4bd81c
function useOnline(): boolean {
  const [isOnline, setIsOnline] = useState(true)

  useEffect(() => {
    setIsOnline(navigator.onLine)

    const handleOnline = () => setIsOnline(true)
    const handleOffline = () => setIsOnline(false)

    window.addEventListener('online', handleOnline)
    window.addEventListener('offline', handleOffline)

    return () => {
      window.removeEventListener('online', handleOnline)
      window.removeEventListener('offline', handleOffline)
    }
  }, [])

  return isOnline
}

// Usage in layout
function EditorLayout() {
  const isOnline = useOnline()

  return (
    <>
      {!isOnline && (
        <div className="bg-destructive text-white px-4 py-2 text-center">
          You're offline - changes won't be saved
        </div>
      )}
      {/* Rest of editor */}
    </>
  )
}
```

### Pattern 7: Error Recovery with Retry

**What:** Inline error states with retry buttons for upload/save failures
**When to use:** Image uploads and save operations
**Example:**
```typescript
// Source: https://blog.logrocket.com/react-error-handling-react-error-boundary/
async function saveWithRetry(
  saveFn: () => Promise<void>,
  maxRetries = 3
): Promise<{ success: boolean; error?: string }> {
  let lastError: Error | null = null

  for (let attempt = 0; attempt < maxRetries; attempt++) {
    try {
      await saveFn()
      return { success: true }
    } catch (error) {
      lastError = error as Error
      // Exponential backoff: 1s, 2s, 4s
      if (attempt < maxRetries - 1) {
        await new Promise(resolve => setTimeout(resolve, 1000 * Math.pow(2, attempt)))
      }
    }
  }

  return {
    success: false,
    error: lastError?.message || 'Save failed after retries'
  }
}
```

### Anti-Patterns to Avoid

- **Don't use sm: breakpoint for mobile** - Tailwind is mobile-first, use unprefixed utilities for mobile and md:+ for desktop
- **Don't compress animated GIFs** - They lose animation; detect `image/gif` MIME type and skip compression
- **Don't use regex for URL validation** - Native URL constructor is more reliable and handles edge cases
- **Don't poll for offline status** - Use navigator.onLine with event listeners, not setInterval
- **Don't show toasts for upload errors** - Use inline error states so users can retry without losing context
- **Don't mix px and rem in media queries** - Stick to rem for consistency and accessibility

## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Bottom sheet with physics-based animations | Custom modal with transform animations | shadcn/ui Drawer (Vaul) | Handles gesture momentum, snap points, backdrop scaling, focus trapping, accessibility |
| Image compression algorithm | Canvas-based manual compression | browser-image-compression | Handles format detection, web workers, quality iteration, EXIF preservation, multiple formats |
| Touch gesture detection | Touch event listeners with state machines | @use-gesture/react | Handles touch-action, multi-touch conflicts, gesture cancellation, browser differences |
| URL parsing and validation | Regex patterns | Native URL constructor | Handles internationalized domains, edge cases, protocol validation, path normalization |
| Responsive breakpoint detection | Window resize listeners with state | window.matchMedia with hooks | More performant (browser-native media query engine), no resize event spam |

**Key insight:** Mobile UX has many subtle edge cases (touch-action conflicts, gesture momentum, orientation changes, keyboard interactions) that well-tested libraries handle better than custom solutions. Focus implementation effort on business logic, not reinventing mobile primitives.

## Common Pitfalls

### Pitfall 1: Bottom Sheet Doesn't Dismiss on Background Tap (Mobile Safari)

**What goes wrong:** Users tap dimmed background expecting sheet to close, but nothing happens on iOS
**Why it happens:** Radix Dialog's dismissible prop defaults differ, and iOS Safari has touch event quirks
**How to avoid:** Explicitly set `modal={true}` on Drawer component and ensure overlay has `onClick` handler
**Warning signs:** Testing only on Chrome DevTools mobile emulator, not real iOS devices

### Pitfall 2: Drag Handle Prevents Page Scrolling on Mobile

**What goes wrong:** Users can't scroll the page on mobile when touching card drag handles
**Why it happens:** Default `touch-action` allows both drag and scroll, creating conflicts
**How to avoid:** Apply `touch-none` Tailwind class to drag handle, `touch-pan-y` to scrollable container
**Warning signs:** Cards draggable on desktop but scrolling broken on mobile

### Pitfall 3: Image Compression Breaks Animated GIFs

**What goes wrong:** Users upload animated GIF, but saved image is static first frame
**Why it happens:** browser-image-compression processes GIFs as static images by default
**How to avoid:** Check `file.type === 'image/gif'` and skip compression, upload original
**Warning signs:** No format-specific handling in compression logic

### Pitfall 4: URL Validation Rejects Valid International Domains

**What goes wrong:** URLs like `https://example.中国` fail validation
**Why it happens:** Regex patterns assume ASCII domains
**How to avoid:** Use native URL constructor which handles punycode and internationalized domains
**Warning signs:** Using regex patterns found on Stack Overflow for URL validation

### Pitfall 5: Landscape Tablet Shows Mobile Layout

**What goes wrong:** iPad in landscape shows cramped mobile bottom sheet instead of desktop split view
**Why it happens:** Only checking screen width, not orientation
**How to avoid:** Combine width and orientation queries: `(max-width: 768px) or (orientation: portrait)`
**Warning signs:** Testing only in portrait mode, or only width-based media queries

### Pitfall 6: Save Retry Creates Duplicate Cards

**What goes wrong:** User clicks save, network fails, retry creates duplicate entries
**Why it happens:** Retry logic calls POST endpoint multiple times without idempotency
**How to avoid:** Use PATCH with card IDs (existing pattern in codebase), not POST retries
**Warning signs:** Retry logic on create operations instead of update operations

### Pitfall 7: Offline Banner Flickers on Slow Connections

**What goes wrong:** Banner appears/disappears rapidly when connection is unstable
**Why it happens:** navigator.onLine fires for every connection state change
**How to avoid:** Debounce offline state changes (500ms delay before showing banner)
**Warning signs:** Testing only on stable WiFi, not throttled/unstable connections

## Code Examples

Verified patterns from official sources:

### shadcn/ui Drawer with Bottom Sheet Behavior

```typescript
// Source: https://ui.shadcn.com/docs/components/drawer
import {
  Drawer,
  DrawerClose,
  DrawerContent,
  DrawerDescription,
  DrawerFooter,
  DrawerHeader,
  DrawerTitle,
  DrawerTrigger,
} from "@/components/ui/drawer"

export function MobileCardEditor({ card }: { card: Card }) {
  return (
    <Drawer direction="bottom">
      <DrawerTrigger asChild>
        <button className="touch-none">Edit</button>
      </DrawerTrigger>
      <DrawerContent className="h-[80vh]">
        <DrawerHeader>
          <DrawerTitle>Edit Card</DrawerTitle>
          <DrawerDescription>Make changes to your card</DrawerDescription>
        </DrawerHeader>
        <div className="flex-1 overflow-y-auto p-4">
          <CardPropertyEditor card={card} />
        </div>
        <DrawerFooter>
          <DrawerClose asChild>
            <Button variant="outline">Cancel</Button>
          </DrawerClose>
        </DrawerFooter>
      </DrawerContent>
    </Drawer>
  )
}
```

### Image Compression with Format Preservation

```typescript
// Source: https://github.com/Donaldcwl/browser-image-compression
import imageCompression from 'browser-image-compression'

export async function compressImageForUpload(file: File): Promise<Blob> {
  // Preserve animated GIFs
  if (file.type === 'image/gif') {
    return file
  }

  const options = {
    maxSizeMB: 1,
    maxWidthOrHeight: 1920,
    useWebWorker: true,
    initialQuality: 0.8,
    // Preserve original format (JPG stays JPG, PNG stays PNG, WebP stays WebP)
    fileType: file.type,
    preserveExif: false, // Remove metadata to reduce size
  }

  try {
    const compressed = await imageCompression(file, options)
    return compressed
  } catch (error) {
    console.error('Compression failed, using original:', error)
    return file // Fallback to original if compression fails
  }
}
```

### Touch Gesture Long-Press for Drag Mode

```typescript
// Source: https://use-gesture.netlify.app/docs/gestures/
import { useLongPress } from '@use-gesture/react'

export function SortableCard({ card }: { card: Card }) {
  const [isDragMode, setIsDragMode] = useState(false)

  const bind = useLongPress(
    () => {
      setIsDragMode(true)
      // Haptic feedback on mobile
      if ('vibrate' in navigator) {
        navigator.vibrate(50)
      }
    },
    {
      threshold: 500, // 500ms to activate
      onCancel: () => setIsDragMode(false),
    }
  )

  return (
    <div
      {...bind()}
      className={cn(
        "p-4 rounded-lg",
        isDragMode && "opacity-50 cursor-move"
      )}
    >
      {/* Card content */}
    </div>
  )
}
```

### Responsive Layout Detection with Orientation

```typescript
// Source: https://developer.mozilla.org/en-US/docs/Web/API/CSS_Object_Model/Managing_screen_orientation
export function useIsMobile(): boolean {
  const [isMobile, setIsMobile] = useState(false)

  useEffect(() => {
    const mobileQuery = window.matchMedia('(max-width: 768px)')
    const portraitQuery = window.matchMedia('(orientation: portrait)')

    const checkMobile = () => {
      // Mobile if width < 768px OR tablet in portrait mode
      setIsMobile(mobileQuery.matches || portraitQuery.matches)
    }

    checkMobile()

    mobileQuery.addEventListener('change', checkMobile)
    portraitQuery.addEventListener('change', checkMobile)

    return () => {
      mobileQuery.removeEventListener('change', checkMobile)
      portraitQuery.removeEventListener('change', checkMobile)
    }
  }, [])

  return isMobile
}
```

### FAB (Floating Action Button) Pattern

```typescript
// Source: https://mui.com/material-ui/react-floating-action-button/
// Using existing Button component with custom styling
export function FloatingAddButton({ onClick }: { onClick: () => void }) {
  return (
    <Button
      size="icon-lg"
      className={cn(
        "fixed bottom-6 right-6 z-50 rounded-full shadow-lg",
        "md:hidden", // Only show on mobile
      )}
      onClick={onClick}
      aria-label="Add card"
    >
      <Plus className="h-6 w-6" />
    </Button>
  )
}
```

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| react-use-gesture | @use-gesture/react | 2021 | Package was renamed and reorganized; old package no longer maintained |
| Custom Sheet animations | Vaul library | 2023 | Physics-based animations and gesture handling now standard; custom implementations outdated |
| Browser regex for URL validation | Native URL constructor | Always supported | URL constructor has been supported since IE10+; regex approach is legacy anti-pattern |
| Polling navigator.onLine | Event listeners | HTML5 era | Event-based approach more efficient; polling wastes resources |
| ImageOptim/server-side compression | Client-side browser-image-compression | 2020+ | Mobile bandwidth improvements make client-side compression viable; reduces server load |

**Deprecated/outdated:**
- **react-beautiful-dnd**: No longer maintained, incompatible with React 19; replaced by dnd-kit (already in codebase)
- **react-use-gesture**: Renamed to @use-gesture/react; old package deprecated
- **Regex-based URL validation**: Never was best practice; URL constructor is standard
- **useWindowSize with resize events**: matchMedia is more performant; resize events fire hundreds of times during drag

## Open Questions

Things that couldn't be fully resolved:

1. **Broken Link Detection (404 checking)**
   - What we know: Requires HEAD requests to target URLs; marked as "Claude's discretion" in context
   - What's unclear: Cost/benefit tradeoff - adds complexity and external requests, may hit CORS issues
   - Recommendation: Defer to planning phase; consider as optional enhancement if time permits

2. **Bottom Sheet vs Sheet Component Reuse**
   - What we know: Codebase has existing Sheet component (Radix Dialog); Drawer is also Radix Dialog-based
   - What's unclear: Whether to replace Sheet with Drawer, or use both (Sheet desktop, Drawer mobile)
   - Recommendation: Keep both - Sheet for desktop, Drawer for mobile; they serve different UX patterns

3. **Save Retry Count and Strategy**
   - What we know: Marked as "Claude's discretion"; common patterns use 3 retries with exponential backoff
   - What's unclear: Specific retry count and backoff timing for this application's network conditions
   - Recommendation: Start with 3 retries, 1s/2s/4s backoff; can tune based on user feedback

4. **Touch Target Size Specifics**
   - What we know: Material Design recommends 48x48dp minimum; marked as "Claude's discretion"
   - What's unclear: Exact pixel sizes for this app's buttons and interactive elements
   - Recommendation: Use Tailwind's size utilities - h-12 w-12 minimum for touch targets (48px)

## Sources

### Primary (HIGH confidence)

- [shadcn/ui Drawer Documentation](https://ui.shadcn.com/docs/components/drawer) - Official component API
- [Vaul Getting Started](https://vaul.emilkowal.ski/getting-started) - Official Vaul library docs
- [Tailwind CSS Touch Action](https://tailwindcss.com/docs/touch-action) - Official Tailwind utilities
- [Tailwind CSS Responsive Design](https://tailwindcss.com/docs/responsive-design) - Official breakpoint documentation
- [@use-gesture/react Documentation](https://use-gesture.netlify.app/docs/) - Official gesture library docs
- [MDN URL Constructor](https://developer.mozilla.org/en-US/docs/Web/API/URL/URL) - Web standard documentation
- [MDN Orientation Media Query](https://developer.mozilla.org/en-US/docs/Web/CSS/@media/orientation) - CSS standard
- [browser-image-compression GitHub](https://github.com/Donaldcwl/browser-image-compression) - Official library documentation

### Secondary (MEDIUM confidence)

- [React Error Boundaries Guide](https://refine.dev/blog/react-error-boundaries/) - LogRocket verified patterns
- [Material UI FAB Component](https://mui.com/material-ui/react-floating-action-button/) - Established UI patterns
- [Real-Time Network Status Detection](https://medium.com/@abdulahad2024/real-time-network-status-detection-in-react-js-next-js-67595c4bd81c) - Community pattern verified with MDN
- [Image Compression Using browser-image-compression](https://medium.com/@pereravidura/image-compression-using-browser-image-compression-with-reactjs-7f284d5ff35b) - Implementation examples

### Tertiary (LOW confidence)

- Web search results for GIF preservation - Multiple sources agree but no authoritative docs found; should test manually
- Broken link detection patterns - Community discussions but no standard library; needs validation

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH - All libraries verified via official docs and npm registry
- Architecture: HIGH - Patterns from official documentation and established best practices
- Pitfalls: MEDIUM - Based on community experience and some from codebase analysis, not all independently verified

**Research date:** 2026-01-27
**Valid until:** ~60 days (stable ecosystem, but mobile web standards evolve slowly)

**Codebase analysis:**
- Existing: Radix UI primitives, Tailwind v4, Sonner, Zustand, react-hook-form, dnd-kit, react-easy-crop
- Patterns: Sheet component for desktop sidebars, toast notifications, client-side image upload
- Gaps: No mobile responsive layout, no gesture handling, no image compression, no offline detection
