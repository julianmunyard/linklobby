---
phase: 04.5-editor-polish-mobile
plan: 03
type: execute
wave: 2
depends_on: ["04.5-01"]
files_modified:
  - src/components/cards/image-upload.tsx
  - src/components/editor/card-property-editor.tsx
  - src/components/editor/editor-layout.tsx
  - src/hooks/use-cards.ts
  - src/lib/supabase/storage.ts
autonomous: true

must_haves:
  truths:
    - "Images are auto-compressed before upload (except animated GIFs)"
    - "URL fields validate input and auto-add https://"
    - "Upload failures show inline error with retry button"
    - "Save failures retry automatically with exponential backoff"
    - "Offline state shows persistent warning banner"
  artifacts:
    - path: "src/components/cards/image-upload.tsx"
      provides: "Image upload with compression and retry"
      contains: "compressImageForUpload"
    - path: "src/components/editor/card-property-editor.tsx"
      provides: "URL validation on link fields"
      contains: "validateAndFixUrl"
    - path: "src/components/editor/editor-layout.tsx"
      provides: "Offline banner display"
      contains: "useOnline"
  key_links:
    - from: "src/components/cards/image-upload.tsx"
      to: "src/lib/image-compression.ts"
      via: "compression import"
      pattern: "compressImageForUpload"
    - from: "src/components/editor/card-property-editor.tsx"
      to: "src/lib/url-validation.ts"
      via: "validation import"
      pattern: "validateAndFixUrl"
    - from: "src/components/editor/editor-layout.tsx"
      to: "src/hooks/use-online.ts"
      via: "hook import"
      pattern: "useOnline"
---

<objective>
Integrate image compression, URL validation, and error handling with retry mechanisms.

Purpose: Handle errors gracefully and optimize uploads for mobile bandwidth constraints.
Output: Robust error handling with retry options; optimized image uploads; validated URLs.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04.5-editor-polish-mobile/04.5-CONTEXT.md
@.planning/phases/04.5-editor-polish-mobile/04.5-RESEARCH.md
@.planning/phases/04.5-editor-polish-mobile/04.5-01-SUMMARY.md
@src/components/cards/image-upload.tsx
@src/components/editor/card-property-editor.tsx
@src/hooks/use-cards.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate image compression into ImageUpload</name>
  <files>
    src/components/cards/image-upload.tsx
  </files>
  <action>
    Update `src/components/cards/image-upload.tsx` to compress images before upload:

    1. Import `compressImageForUpload` from `@/lib/image-compression`

    2. Modify `handleCropComplete` function:
       - Before uploading, compress the cropped blob:
         ```typescript
         const compressedBlob = await compressImageForUpload(
           new File([croppedBlob], 'image.jpg', { type: croppedBlob.type })
         )
         ```
       - Note: Compression already handles GIF preservation

    3. Also compress in `handleFileSelect` BEFORE the crop dialog:
       - Actually, cropping outputs a new blob, so compress AFTER crop in handleCropComplete
       - The crop dialog processes the image, then we compress the result

    4. Add inline error state with retry:
       - Add state: `const [uploadError, setUploadError] = useState<string | null>(null)`
       - On upload failure, set error message instead of toast
       - Display inline error below upload area with "Retry" button
       - Clear error on successful upload or new file selection
       - Keep toast for success (brief feedback)

    5. Update error UI:
       - Show red text below upload area: `{uploadError && <p className="text-sm text-destructive mt-1">{uploadError} <button onClick={retry}>Retry</button></p>}`
       - Add retry function that re-attempts the last upload with the stored blob

    6. Store last attempted blob for retry:
       - `const [pendingBlob, setPendingBlob] = useState<Blob | null>(null)`
       - Set on crop complete, clear on successful upload
  </action>
  <verify>
    - Image compression is called before upload
    - Animated GIFs upload without compression (test with a .gif file)
    - Upload failure shows inline error with retry button (test by disconnecting network)
    - TypeScript compiles: `pnpm tsc --noEmit`
  </verify>
  <done>
    Images auto-compressed before upload; failures show inline retry option.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add URL validation to card property editor</name>
  <files>
    src/components/editor/card-property-editor.tsx
    src/components/editor/hero-card-fields.tsx
    src/components/editor/horizontal-link-fields.tsx
    src/components/editor/square-card-fields.tsx
  </files>
  <action>
    Add URL validation to all URL input fields in card editors:

    1. Import `validateAndFixUrl` from `@/lib/url-validation`

    2. For each URL field (in card-property-editor.tsx and card-type-specific field files):
       - Add validation on blur: validate URL when user leaves the field
       - If invalid, show error text below input (red, small)
       - If valid but was auto-fixed (https:// added), update the field value silently
       - Allow empty URLs (optional field)

    3. Implementation pattern:
       ```typescript
       const handleUrlBlur = (e: React.FocusEvent<HTMLInputElement>) => {
         const result = validateAndFixUrl(e.target.value)
         if (!result.valid && result.error) {
           setUrlError(result.error)
         } else {
           setUrlError(null)
           // If URL was fixed (https added), update form
           if (result.url !== e.target.value) {
             form.setValue('url', result.url)
           }
         }
       }
       ```

    4. Add URL error state in each component that has URL fields:
       - hero-card-fields.tsx: url and buttonUrl fields
       - horizontal-link-fields.tsx: url field
       - square-card-fields.tsx: url field
       - card-property-editor.tsx: if it has common URL handling

    5. Don't block saves on invalid URLs - just warn the user
       - Invalid URL warning stays visible but doesn't prevent saving
       - This is forgiving UX: artist can fix later
  </action>
  <verify>
    - Entering "example.com" auto-fixes to "https://example.com"
    - Invalid URLs like "not a url" show error message
    - Empty URLs allowed (no error)
    - TypeScript compiles: `pnpm tsc --noEmit`
  </verify>
  <done>
    URL fields validate on blur, auto-fix missing protocol, show inline errors.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add offline banner and save retry logic</name>
  <files>
    src/components/editor/editor-layout.tsx
    src/hooks/use-cards.ts
  </files>
  <action>
    1. Update `src/components/editor/editor-layout.tsx` - offline banner:
       - Import `useOnline` from `@/hooks/use-online`
       - At the top of the layout (before panels or mobile content), conditionally render:
         ```tsx
         {!isOnline && (
           <div className="bg-destructive text-destructive-foreground px-4 py-2 text-center text-sm font-medium">
             You're offline - changes won't be saved
           </div>
         )}
         ```
       - This banner is persistent while offline (not dismissible)
       - Banner appears above the editor content (both desktop and mobile)

    2. Update `src/hooks/use-cards.ts` - save retry logic:
       - Find the `saveCards` function (or equivalent save operation)
       - Wrap the API call with retry logic:
         ```typescript
         async function saveWithRetry<T>(
           operation: () => Promise<T>,
           maxRetries = 3
         ): Promise<T> {
           let lastError: Error | null = null
           for (let attempt = 0; attempt < maxRetries; attempt++) {
             try {
               return await operation()
             } catch (error) {
               lastError = error as Error
               if (attempt < maxRetries - 1) {
                 // Exponential backoff: 1s, 2s, 4s
                 await new Promise(r => setTimeout(r, 1000 * Math.pow(2, attempt)))
               }
             }
           }
           throw lastError
         }
         ```
       - Use PATCH (not POST) to ensure idempotency - existing pattern uses PATCH
       - On final failure after retries, show toast with error message
       - The retry is automatic and silent (user doesn't need to click)

    3. Optional: Add visual feedback during retry
       - Could show "Saving..." with subtle indicator during retries
       - But keep it low-key - auto-retry shouldn't alarm users
  </action>
  <verify>
    - Toggle offline in DevTools Network tab: banner appears
    - Go back online: banner disappears
    - Simulate API failure: retries happen (check Network tab for multiple requests)
    - After retries exhausted, error toast appears
    - TypeScript compiles: `pnpm tsc --noEmit`
  </verify>
  <done>
    Offline banner warns users; save operations retry automatically with exponential backoff.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Run `pnpm tsc --noEmit` - no type errors
2. Run `pnpm lint` - no lint errors
3. Run `pnpm dev` and test:

   Image compression:
   - Upload a large JPEG (>1MB) - should compress to ~1MB or less
   - Upload a PNG - should stay PNG format
   - Upload animated GIF - should preserve animation (check in preview)
   - Disconnect network, try upload - inline error with retry appears

   URL validation:
   - Enter "google.com" in URL field, blur - becomes "https://google.com"
   - Enter "not a url" - error message appears
   - Leave empty - no error

   Offline handling:
   - Toggle offline in DevTools - banner appears immediately
   - Try to save while offline - operation queued/fails gracefully
   - Go online - banner disappears

   Save retry:
   - Throttle network in DevTools to simulate failures
   - Save cards - observe retry attempts in Network tab
</verification>

<success_criteria>
- Images auto-compressed (large images visibly smaller after upload)
- GIFs preserve animation
- URL validation with auto-https and error display
- Offline banner appears/disappears correctly
- Save operations retry 3 times with backoff
- All errors have inline recovery options (retry buttons)
</success_criteria>

<output>
After completion, create `.planning/phases/04.5-editor-polish-mobile/04.5-03-SUMMARY.md`
</output>
