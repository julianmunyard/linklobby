---
phase: 05-media-cards
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/components/cards/video-card.tsx
  - src/components/editor/video-card-fields.tsx
  - src/components/cards/card-renderer.tsx
  - src/components/editor/card-property-editor.tsx
autonomous: true

must_haves:
  truths:
    - "Video Card displays video embed with thumbnail + play button"
    - "Video Card displays uploaded video with muted autoplay loop"
    - "Artist can enter YouTube/Vimeo/TikTok URL in editor"
    - "Artist can upload video file in editor"
    - "Video Card respects big/small sizing"
  artifacts:
    - path: "src/components/cards/video-card.tsx"
      provides: "VideoCard component with embed and upload modes"
      exports: ["VideoCard"]
    - path: "src/components/editor/video-card-fields.tsx"
      provides: "Video card editor fields"
      exports: ["VideoCardFields"]
    - path: "src/components/cards/card-renderer.tsx"
      provides: "Updated card renderer with video case"
      contains: "case 'video'"
    - path: "src/components/editor/card-property-editor.tsx"
      provides: "Updated editor with video fields"
      contains: "VideoCardFields"
  key_links:
    - from: "src/components/cards/card-renderer.tsx"
      to: "src/components/cards/video-card.tsx"
      via: "import and switch case"
      pattern: "<VideoCard"
    - from: "src/components/editor/video-card-fields.tsx"
      to: "src/lib/video-embed.ts"
      via: "parseVideoUrl import"
      pattern: "parseVideoUrl"
---

<objective>
Create the Video Card component and editor fields, wiring them into the existing card system.

Purpose: Enable artists to add video content (embeds or uploads) to their pages.
Output: Fully functional Video Card that displays embeds (thumbnail + click-to-play) or uploads (muted autoplay loop).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/05-media-cards/05-CONTEXT.md
@.planning/phases/05-media-cards/05-RESEARCH.md
@.planning/phases/05-media-cards/05-01-SUMMARY.md
@src/types/card.ts
@src/lib/video-embed.ts
@src/components/cards/card-renderer.tsx
@src/components/cards/hero-card.tsx
@src/components/editor/card-property-editor.tsx
@src/components/editor/hero-card-fields.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create VideoCard component</name>
  <files>src/components/cards/video-card.tsx</files>
  <action>
Create src/components/cards/video-card.tsx with:

1. Imports:
   ```typescript
   'use client'
   import { useState } from 'react'
   import Image from 'next/image'
   import { Play, Video } from 'lucide-react'
   import type { Card, VideoCardContent } from '@/types/card'
   ```

2. Props interface:
   ```typescript
   interface VideoCardProps {
     card: Card
     isPreview?: boolean
   }
   ```

3. Main VideoCard component that:
   - Casts card.content to VideoCardContent
   - Routes to VideoCardUpload if videoType === 'upload' && uploadedVideoUrl exists
   - Routes to VideoCardEmbed if videoType === 'embed' && embedUrl exists
   - Shows placeholder if no video configured

4. VideoCardUpload sub-component:
   - Renders HTML5 video with `autoPlay muted loop playsInline` attributes
   - Uses `aspect-video` for 16:9 aspect ratio
   - Has `object-cover` for proper scaling
   - Includes aria-label for accessibility

5. VideoCardEmbed sub-component:
   - Uses useState to track isPlaying state
   - When NOT playing: Show thumbnail with play button overlay
   - When playing: Render iframe with proper allow attributes
   - Convert watch URL to embed URL if needed (YouTube watch?v= to embed/)
   - Handle missing thumbnail gracefully (show Play icon on muted background)

6. Placeholder state for unconfigured cards:
   ```tsx
   <div className="relative w-full aspect-video rounded-xl overflow-hidden bg-muted flex items-center justify-center">
     <div className="text-center text-muted-foreground">
       <Video className="h-12 w-12 mx-auto mb-2" />
       <p>Add video URL or upload video</p>
     </div>
   </div>
   ```

Key styling:
- `aspect-video` for 16:9 ratio
- `rounded-xl overflow-hidden` for rounded corners
- Play button: white circle with black Play icon, scales on hover
- Gradient overlay on bottom for title (if provided)

TikTok handling:
- TikTok embeds require special iframe with blockquote + script
- For MVP: Render TikTok as a simple iframe embed, may show "video unavailable" but will work on public videos
- Consider: Store full TikTok URL, use iframe with that URL as src
  </action>
  <verify>
   - TypeScript compiles: `npx tsc --noEmit`
   - VideoCard is exported from the file
   - Both VideoCardUpload and VideoCardEmbed modes exist
  </verify>
  <done>
   - VideoCard component renders embeds with thumbnail + click-to-play
   - Uploaded videos autoplay with muted loop playsInline
   - Placeholder shown when no video configured
   - Proper aspect ratio and styling
  </done>
</task>

<task type="auto">
  <name>Task 2: Create video-card-fields editor component</name>
  <files>src/components/editor/video-card-fields.tsx</files>
  <action>
Create src/components/editor/video-card-fields.tsx following hero-card-fields.tsx pattern:

1. Imports:
   ```typescript
   'use client'
   import { useState } from 'react'
   import { Input } from '@/components/ui/input'
   import { Label } from '@/components/ui/label'
   import { Button } from '@/components/ui/button'
   import { ToggleGroup, ToggleGroupItem } from '@/components/ui/toggle-group'
   import { Link2, Upload, Loader2, AlertCircle } from 'lucide-react'
   import { parseVideoUrl } from '@/lib/video-embed'
   import { uploadCardVideo } from '@/lib/supabase/storage'
   import type { VideoCardContent } from '@/types/card'
   ```

2. Props interface:
   ```typescript
   interface VideoCardFieldsProps {
     content: VideoCardContent
     onChange: (updates: Record<string, unknown>) => void
     cardId: string  // Needed for video upload path
   }
   ```

3. Component state:
   - videoType toggle: 'embed' | 'upload'
   - embedUrl input value
   - isLoading for async operations
   - error message string

4. Video Type Toggle:
   ```tsx
   <ToggleGroup
     type="single"
     value={content.videoType || 'embed'}
     onValueChange={(value) => {
       if (value) onChange({ videoType: value })
     }}
   >
     <ToggleGroupItem value="embed" aria-label="Embed URL">
       <Link2 className="h-4 w-4 mr-2" /> Embed
     </ToggleGroupItem>
     <ToggleGroupItem value="upload" aria-label="Upload video">
       <Upload className="h-4 w-4 mr-2" /> Upload
     </ToggleGroupItem>
   </ToggleGroup>
   ```

5. Embed URL input (show when videoType === 'embed'):
   - Input for video URL with placeholder "Paste YouTube, Vimeo, or TikTok URL"
   - On blur: Call parseVideoUrl, update content with result
   - Show loading spinner during oEmbed fetch
   - Show error message if URL invalid
   - Success: Update content with embedService, embedVideoId, embedThumbnailUrl, embedUrl

6. Video Upload (show when videoType === 'upload'):
   - File input accepting video/* (or specifically mp4,webm,ogg)
   - 100MB size limit with client-side validation
   - On file select: Upload to Supabase, update content with uploadedVideoUrl and uploadedVideoPath
   - Show progress/loading state
   - Show error if upload fails
   - If video already uploaded: Show "Replace video" button + current filename indicator

7. Error display:
   ```tsx
   {error && (
     <div className="flex items-center gap-2 text-sm text-destructive">
       <AlertCircle className="h-4 w-4" />
       {error}
     </div>
   )}
   ```

Handle async carefully:
- Set isLoading before async operation
- Clear isLoading in finally block
- Only update content on success
  </action>
  <verify>
   - TypeScript compiles: `npx tsc --noEmit`
   - VideoCardFields exported
   - Has videoType toggle, embed URL input, file upload input
  </verify>
  <done>
   - Toggle between embed and upload modes
   - Embed mode: URL input with validation and oEmbed fetch
   - Upload mode: File picker with 100MB limit and Supabase upload
   - Loading and error states displayed clearly
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire VideoCard into card-renderer.tsx</name>
  <files>src/components/cards/card-renderer.tsx</files>
  <action>
Update src/components/cards/card-renderer.tsx:

1. Add import at top:
   ```typescript
   import { VideoCard } from "./video-card"
   ```

2. Add case in switch statement (after link case, before default):
   ```typescript
   case "video":
     return <VideoCard card={card} isPreview={isPreview} />
   ```

Note: The 'video' CardType already exists in types/card.ts, it just falls through to the default "coming soon" placeholder currently.
  </action>
  <verify>
   - TypeScript compiles: `npx tsc --noEmit`
   - grep "case.*video" src/components/cards/card-renderer.tsx shows the new case
   - VideoCard import exists
  </verify>
  <done>
   - VideoCard imported and rendered for card_type === 'video'
   - No more "coming soon" placeholder for video cards
  </done>
</task>

<task type="auto">
  <name>Task 4: Wire VideoCardFields into card-property-editor.tsx</name>
  <files>src/components/editor/card-property-editor.tsx</files>
  <action>
Update src/components/editor/card-property-editor.tsx:

1. Add import near other field component imports:
   ```typescript
   import { VideoCardFields } from "./video-card-fields"
   ```

2. Add VideoCardContent to type imports from @/types/card:
   ```typescript
   import type { Card, CardType, CardSize, HeroCardContent, HorizontalLinkContent, SquareCardContent, VideoCardContent, TextAlign, VerticalAlign } from "@/types/card"
   ```

3. Add video case in the type-specific fields section (around line 410-427, after SquareCardFields):
   ```tsx
   {card.card_type === "video" && (
     <VideoCardFields
       content={currentContent as VideoCardContent}
       onChange={handleContentChange}
       cardId={card.id}
     />
   )}
   ```

4. Update CARD_TYPES_NO_IMAGE check if needed:
   - video cards DO have media (video), but not the standard image upload
   - Check if video is in CARD_TYPES_NO_IMAGE - if not, it should be added
   - Video cards manage their own media via VideoCardFields, not ImageUpload

5. If video NOT in CARD_TYPES_NO_IMAGE array, add it to src/types/card.ts:
   ```typescript
   export const CARD_TYPES_NO_IMAGE: CardType[] = ['social-icons', 'link', 'dropdown', 'audio', 'video', 'gallery']
   ```
   This hides the generic ImageUpload component for video/gallery cards since they have custom media handling.
  </action>
  <verify>
   - TypeScript compiles: `npx tsc --noEmit`
   - grep "VideoCardFields" src/components/editor/card-property-editor.tsx shows the import and usage
   - Video cards don't show the generic ImageUpload component
  </verify>
  <done>
   - VideoCardFields rendered when editing video cards
   - Video type added to CARD_TYPES_NO_IMAGE (no generic image upload)
   - Type imports updated
  </done>
</task>

</tasks>

<verification>
After completing all tasks:
1. `npx tsc --noEmit` - TypeScript compiles without errors
2. Start dev server: `npm run dev`
3. Manual test:
   - Add a video card via card type picker
   - Paste YouTube URL - should fetch thumbnail and display card with play button
   - Click play - should load iframe and play video
   - Switch to upload mode - should show file picker
   - Upload MP4 file - should autoplay muted in preview
</verification>

<success_criteria>
- VideoCard component renders both embed and upload modes correctly
- Embed mode shows thumbnail with play button, loads iframe on click
- Upload mode shows muted autoplay loop video
- VideoCardFields allows switching between embed/upload modes
- Embed URL validation extracts platform info and fetches thumbnail
- Video upload respects 100MB limit and uploads to Supabase
- Video card works in editor preview and card size (big/small) respected
</success_criteria>

<output>
After completion, create `.planning/phases/05-media-cards/05-02-SUMMARY.md`
</output>
