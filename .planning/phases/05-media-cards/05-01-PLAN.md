---
phase: 05-media-cards
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/card.ts
  - src/lib/supabase/storage.ts
  - src/lib/video-embed.ts
  - package.json
autonomous: true
user_setup:
  - service: supabase-storage
    why: "Video uploads require a new storage bucket"
    dashboard_config:
      - task: "Create 'card-videos' bucket with public access and 100MB file limit"
        location: "Supabase Dashboard -> Storage -> New bucket"

must_haves:
  truths:
    - "VideoCardContent and GalleryCardContent types exist"
    - "Video URL can be parsed to extract platform and ID"
    - "Video files can be uploaded to Supabase Storage"
    - "oEmbed thumbnails can be fetched for YouTube/Vimeo"
  artifacts:
    - path: "src/types/card.ts"
      provides: "VideoCardContent and GalleryCardContent interfaces"
      contains: "interface VideoCardContent"
    - path: "src/lib/video-embed.ts"
      provides: "Video URL parsing and oEmbed helpers"
      exports: ["parseVideoUrl", "VideoEmbedInfo"]
    - path: "src/lib/supabase/storage.ts"
      provides: "Video upload/delete functions"
      contains: "uploadCardVideo"
  key_links:
    - from: "src/lib/video-embed.ts"
      to: "get-video-id"
      via: "npm import"
      pattern: "from 'get-video-id'"
---

<objective>
Create the foundational types, dependencies, and helper functions needed for Video Card and Gallery Card features.

Purpose: Establish type-safe content schemas and utility functions before building UI components.
Output: VideoCardContent/GalleryCardContent types, video-embed.ts helper, video storage functions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-media-cards/05-CONTEXT.md
@.planning/phases/05-media-cards/05-RESEARCH.md
@src/types/card.ts
@src/lib/supabase/storage.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and add content type interfaces</name>
  <files>
    package.json
    src/types/card.ts
  </files>
  <action>
1. Install dependencies:
   ```bash
   npm install get-video-id embla-carousel-react
   ```

2. Add VideoCardContent interface to src/types/card.ts:
   ```typescript
   export interface VideoCardContent {
     videoType: 'embed' | 'upload'
     // For embeds
     embedUrl?: string           // Original URL (YouTube/Vimeo/TikTok)
     embedService?: 'youtube' | 'vimeo' | 'tiktok'
     embedVideoId?: string
     embedThumbnailUrl?: string
     // For uploads
     uploadedVideoUrl?: string
     uploadedVideoPath?: string  // Supabase Storage path for deletion
   }
   ```

3. Add GalleryCardContent interface to src/types/card.ts:
   ```typescript
   export interface GalleryImage {
     id: string
     url: string
     alt: string
     storagePath: string  // For deletion
   }

   export interface GalleryCardContent {
     galleryStyle: 'circular' | 'carousel'
     images: GalleryImage[]
     // ReactBits Circular Gallery settings (optional overrides)
     scrollEase?: number       // Default: 0.15
     scrollSpeed?: number      // Default: 4.6
     borderRadius?: number     // Default: 0
     bend?: number            // Default: 10
   }
   ```

4. Add new content types to the CardContent union at bottom of file:
   ```typescript
   export type CardContent =
     | HeroCardContent
     | HorizontalLinkContent
     | SquareCardContent
     | VideoCardContent
     | GalleryCardContent
     | Record<string, unknown>
   ```

5. Add type guards for new content types:
   ```typescript
   export function isVideoContent(content: unknown): content is VideoCardContent {
     return typeof content === 'object' && content !== null && 'videoType' in content
   }

   export function isGalleryContent(content: unknown): content is GalleryCardContent {
     return typeof content === 'object' && content !== null && 'galleryStyle' in content
   }
   ```
  </action>
  <verify>
   - `npm ls get-video-id embla-carousel-react` shows both installed
   - TypeScript compiles without errors: `npx tsc --noEmit`
   - VideoCardContent and GalleryCardContent are exported from src/types/card.ts
  </verify>
  <done>
   - get-video-id and embla-carousel-react installed
   - VideoCardContent interface exists with embed/upload fields
   - GalleryCardContent interface exists with images array and style settings
   - Type guards isVideoContent and isGalleryContent exported
  </done>
</task>

<task type="auto">
  <name>Task 2: Create video URL parsing and oEmbed helper</name>
  <files>src/lib/video-embed.ts</files>
  <action>
Create new file src/lib/video-embed.ts with:

1. Import get-video-id:
   ```typescript
   import getVideoId from 'get-video-id'
   ```

2. Export VideoEmbedInfo interface:
   ```typescript
   export interface VideoEmbedInfo {
     id: string
     service: 'youtube' | 'vimeo' | 'tiktok'
     thumbnailUrl: string
     embedUrl: string
     title?: string
   }
   ```

3. Create parseVideoUrl function that:
   - Uses getVideoId to extract id and service from URL
   - Throws descriptive error if URL not recognized
   - Calls platform-specific helper based on service

4. Create getYouTubeInfo helper:
   - Call YouTube oEmbed: `https://www.youtube.com/oembed?url=https://www.youtube.com/watch?v=${id}&format=json`
   - Extract thumbnail_url and title from response
   - Build embedUrl: `https://www.youtube.com/embed/${id}`
   - Fallback to standard thumbnail pattern if oEmbed fails: `https://img.youtube.com/vi/${id}/hqdefault.jpg`

5. Create getVimeoInfo helper:
   - Call Vimeo oEmbed: `https://vimeo.com/api/oembed.json?url=https://vimeo.com/${id}`
   - Extract thumbnail_url and title
   - Build embedUrl: `https://player.vimeo.com/video/${id}`
   - Throw error if oEmbed fails (Vimeo video may be private)

6. Create getTikTokInfo helper:
   - TikTok oEmbed is unreliable - don't rely on it
   - Extract video ID from URL pattern: `/video/([0-9]+)`
   - Return empty thumbnailUrl (TikTok embeds are iframe-only)
   - Store full URL as embedUrl (TikTok requires original URL)

Error handling:
- Wrap each platform call in try/catch
- Return meaningful error messages ("Video may be private", "Invalid video URL")
- YouTube fallback ensures thumbnails work even if oEmbed fails
  </action>
  <verify>
   - TypeScript compiles: `npx tsc --noEmit`
   - Test parseVideoUrl with YouTube URL: should return id, service: 'youtube', thumbnailUrl, embedUrl
   - Test parseVideoUrl with invalid URL: should throw descriptive error
  </verify>
  <done>
   - parseVideoUrl extracts video info from YouTube/Vimeo/TikTok URLs
   - YouTube and Vimeo return thumbnail URLs from oEmbed
   - TikTok returns empty thumbnail (expected behavior)
   - Invalid URLs throw clear error messages
  </done>
</task>

<task type="auto">
  <name>Task 3: Add video storage functions</name>
  <files>src/lib/supabase/storage.ts</files>
  <action>
Extend src/lib/supabase/storage.ts with video upload capability:

1. Add constants at top of file:
   ```typescript
   const VIDEO_BUCKET = "card-videos"
   const MAX_VIDEO_SIZE = 100 * 1024 * 1024  // 100MB
   ```

2. Add uploadCardVideo function following existing uploadCardImage pattern:
   ```typescript
   export async function uploadCardVideo(
     file: File,
     cardId: string
   ): Promise<UploadResult> {
     // Validate file size
     if (file.size > MAX_VIDEO_SIZE) {
       throw new Error("Video must be less than 100MB")
     }

     // Validate file type (MP4, WebM, OGG)
     const validVideoTypes = ['video/mp4', 'video/webm', 'video/ogg']
     if (!validVideoTypes.includes(file.type)) {
       throw new Error("Video must be MP4, WebM, or OGG format")
     }

     const supabase = createClient()

     // Generate unique filename: cardId/uuid.ext
     const fileExt = file.name.split(".").pop()?.toLowerCase() || "mp4"
     const fileName = `${cardId}/${crypto.randomUUID()}.${fileExt}`

     const { data, error } = await supabase.storage
       .from(VIDEO_BUCKET)
       .upload(fileName, file, {
         contentType: file.type,
         upsert: false,
       })

     if (error) {
       console.error("Video upload error:", error)
       throw new Error(error.message || "Failed to upload video")
     }

     // Get public URL
     const { data: urlData } = supabase.storage
       .from(VIDEO_BUCKET)
       .getPublicUrl(data.path)

     return {
       url: urlData.publicUrl,
       path: data.path,
     }
   }
   ```

3. Add deleteCardVideo function:
   ```typescript
   export async function deleteCardVideo(path: string): Promise<void> {
     const supabase = createClient()

     const { error } = await supabase.storage
       .from(VIDEO_BUCKET)
       .remove([path])

     if (error) {
       console.error("Video delete error:", error)
       throw new Error(error.message || "Failed to delete video")
     }
   }
   ```

Note: The card-videos bucket must be created in Supabase Dashboard with public access and 100MB file limit. This is handled via user_setup.
  </action>
  <verify>
   - TypeScript compiles: `npx tsc --noEmit`
   - uploadCardVideo and deleteCardVideo are exported from storage.ts
   - Constants VIDEO_BUCKET and MAX_VIDEO_SIZE defined
  </verify>
  <done>
   - uploadCardVideo handles MP4/WebM/OGG up to 100MB
   - deleteCardVideo removes video from card-videos bucket
   - Functions follow existing pattern from uploadCardImage
  </done>
</task>

</tasks>

<verification>
After completing all tasks:
1. `npm ls get-video-id embla-carousel-react` - both packages installed
2. `npx tsc --noEmit` - TypeScript compiles without errors
3. Grep for exports: `grep -E "export (interface|function|type)" src/types/card.ts src/lib/video-embed.ts src/lib/supabase/storage.ts`
   - Should show VideoCardContent, GalleryCardContent, GalleryImage, parseVideoUrl, uploadCardVideo, deleteCardVideo
</verification>

<success_criteria>
- get-video-id and embla-carousel-react in package.json
- VideoCardContent interface with embed/upload fields
- GalleryCardContent interface with images array and style
- GalleryImage interface with id, url, alt, storagePath
- parseVideoUrl extracts video info from YouTube/Vimeo/TikTok URLs
- uploadCardVideo/deleteCardVideo for video storage
- All TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-media-cards/05-01-SUMMARY.md`
</output>
