---
phase: 05-media-cards
plan: 03
type: execute
wave: 3
depends_on: ["05-02"]
files_modified:
  - src/components/ui/circular-gallery.tsx
  - src/components/ui/embla-carousel.tsx
  - src/components/cards/gallery-card.tsx
  - src/components/editor/gallery-card-fields.tsx
  - src/components/cards/card-renderer.tsx
  - src/components/editor/card-property-editor.tsx
autonomous: false

must_haves:
  truths:
    - "Photo Gallery displays images in Circular Gallery style"
    - "Photo Gallery displays images in Carousel style"
    - "Artist can add images to gallery (max 10)"
    - "Artist can remove images from gallery"
    - "Artist can reorder gallery images via drag-and-drop"
    - "Carousel has swipe support on mobile and arrow buttons on desktop"
  artifacts:
    - path: "src/components/ui/circular-gallery.tsx"
      provides: "ReactBits Circular Gallery component"
      exports: ["CircularGallery"]
    - path: "src/components/ui/embla-carousel.tsx"
      provides: "Embla Carousel wrapper for gallery"
      exports: ["EmblaCarouselGallery"]
    - path: "src/components/cards/gallery-card.tsx"
      provides: "GalleryCard component with style switching"
      exports: ["GalleryCard"]
    - path: "src/components/editor/gallery-card-fields.tsx"
      provides: "Gallery editor with drag-and-drop image reorder"
      exports: ["GalleryCardFields"]
  key_links:
    - from: "src/components/cards/gallery-card.tsx"
      to: "src/components/ui/circular-gallery.tsx"
      via: "conditional import based on style"
      pattern: "<CircularGallery"
    - from: "src/components/editor/gallery-card-fields.tsx"
      to: "@dnd-kit/core"
      via: "drag-and-drop reordering"
      pattern: "DndContext"
---

<objective>
Create the Photo Gallery Card component and editor fields with two gallery styles and drag-and-drop image reordering.

Purpose: Enable artists to showcase multiple photos in engaging carousel formats.
Output: Fully functional Gallery Card with Circular Gallery and Carousel styles, plus editor for add/remove/reorder images.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/05-media-cards/05-CONTEXT.md
@.planning/phases/05-media-cards/05-RESEARCH.md
@.planning/phases/05-media-cards/05-01-SUMMARY.md
@.planning/phases/05-media-cards/05-02-SUMMARY.md
@src/types/card.ts
@src/components/cards/card-renderer.tsx
@src/components/editor/card-property-editor.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CircularGallery component from ReactBits</name>
  <files>src/components/ui/circular-gallery.tsx</files>
  <action>
Create src/components/ui/circular-gallery.tsx by copying the ReactBits Circular Gallery component.

1. Visit https://reactbits.dev/components/circular-gallery
2. Copy the component code (click "Code" tab or copy button)
3. Create the file with appropriate modifications:
   - Add 'use client' directive at top
   - Ensure TypeScript types are correct
   - Add cn() utility import from @/lib/utils if needed for className merging

The component should accept these props (per CONTEXT.md):
- images: string[] - array of image URLs
- scrollEase: number (default 0.15)
- scrollSpeed: number (default 4.6)
- borderRadius: number (default 0)
- bend: number (default 10)

If ReactBits component has different prop names, adapt accordingly but document the mapping.

Expected structure:
```typescript
'use client'

// ... component code from ReactBits

export interface CircularGalleryProps {
  images: string[]
  scrollEase?: number
  scrollSpeed?: number
  borderRadius?: number
  bend?: number
}

export function CircularGallery({
  images,
  scrollEase = 0.15,
  scrollSpeed = 4.6,
  borderRadius = 0,
  bend = 10,
}: CircularGalleryProps) {
  // ... implementation from ReactBits
}
```

Note: If the ReactBits component requires additional dependencies, install them. If it uses specific CSS, include in the component or add to globals.css.

IMPORTANT: Check ReactBits licensing before copying. Most component libraries allow commercial use.
  </action>
  <verify>
   - TypeScript compiles: `npx tsc --noEmit`
   - CircularGallery is exported from the file
   - Component accepts images array and optional scroll/bend settings
  </verify>
  <done>
   - CircularGallery component created from ReactBits source
   - Props typed correctly (images, scrollEase, scrollSpeed, borderRadius, bend)
   - Component renders without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Create EmblaCarouselGallery wrapper component</name>
  <files>src/components/ui/embla-carousel.tsx</files>
  <action>
Create src/components/ui/embla-carousel.tsx following the research patterns:

1. Imports:
   ```typescript
   'use client'
   import { useCallback, useEffect, useState } from 'react'
   import useEmblaCarousel from 'embla-carousel-react'
   import { ChevronLeft, ChevronRight } from 'lucide-react'
   import Image from 'next/image'
   import { cn } from '@/lib/utils'
   ```

2. Props interface:
   ```typescript
   interface EmblaCarouselGalleryProps {
     images: Array<{ id: string; url: string; alt: string }>
     className?: string
   }
   ```

3. Component implementation:
   - Initialize useEmblaCarousel with `{ loop: true, align: 'center' }`
   - Track canScrollPrev/canScrollNext with useState
   - Set up onSelect callback to update scroll state
   - Add embla listeners on mount, clean up on unmount

4. Render structure:
   - Outer div with relative positioning
   - Overflow-hidden viewport div with emblaRef
   - Flex container with `touch-pan-y touch-pinch-zoom` for mobile
   - Map images to slides with `flex-[0_0_100%] min-w-0`
   - Each slide: aspect-square container with Next/Image fill

5. Navigation buttons:
   - Position absolute, left/right edges, vertically centered
   - Only render if canScrollPrev/canScrollNext is true
   - Style: white/80 background, rounded-full, shadow-md
   - ChevronLeft/ChevronRight icons

6. Dot indicators (optional):
   - Flex row below carousel
   - One dot per image
   - Active dot has bg-primary, inactive has bg-primary/30
   - Click dot to scroll to that image

Key CSS classes for slides:
```css
.flex-[0_0_100%] { flex: 0 0 100%; }
.touch-pan-y { touch-action: pan-y; }
.touch-pinch-zoom { touch-action: pinch-zoom; }
```

Note: Images use square aspect ratio (aspect-square) and object-cover for consistent cropping per CONTEXT.md.
  </action>
  <verify>
   - TypeScript compiles: `npx tsc --noEmit`
   - EmblaCarouselGallery is exported
   - Component accepts images array with id, url, alt
  </verify>
  <done>
   - Embla Carousel wrapper created with loop and center alignment
   - Mobile swipe support via touch-pan-y
   - Desktop navigation arrows (show/hide based on scroll state)
   - Dot indicators for image position
   - Square aspect ratio with object-cover cropping
  </done>
</task>

<task type="auto">
  <name>Task 3: Create GalleryCard component</name>
  <files>src/components/cards/gallery-card.tsx</files>
  <action>
Create src/components/cards/gallery-card.tsx:

1. Imports:
   ```typescript
   'use client'
   import { CircularGallery } from '@/components/ui/circular-gallery'
   import { EmblaCarouselGallery } from '@/components/ui/embla-carousel'
   import { ImageIcon } from 'lucide-react'
   import type { Card, GalleryCardContent } from '@/types/card'
   ```

2. Props interface:
   ```typescript
   interface GalleryCardProps {
     card: Card
     isPreview?: boolean
   }
   ```

3. Main GalleryCard component:
   - Cast card.content to GalleryCardContent
   - Check if images array exists and has items
   - Route to appropriate gallery component based on galleryStyle

4. Empty state (no images):
   ```tsx
   <div className="relative w-full aspect-video rounded-xl overflow-hidden bg-muted flex items-center justify-center">
     <div className="text-center text-muted-foreground">
       <ImageIcon className="h-12 w-12 mx-auto mb-2" />
       <p>Add images to gallery</p>
       <p className="text-sm mt-1">Up to 10 images</p>
     </div>
   </div>
   ```

5. Circular Gallery rendering:
   ```tsx
   if (content.galleryStyle === 'circular') {
     return (
       <div className="w-full aspect-video rounded-xl overflow-hidden">
         <CircularGallery
           images={content.images.map(img => img.url)}
           scrollEase={content.scrollEase}
           scrollSpeed={content.scrollSpeed}
           borderRadius={content.borderRadius}
           bend={content.bend}
         />
       </div>
     )
   }
   ```

6. Carousel rendering (default):
   ```tsx
   return (
     <div className="w-full rounded-xl overflow-hidden">
       <EmblaCarouselGallery images={content.images} />
     </div>
   )
   ```

Note: Circular Gallery uses aspect-video, Carousel uses square per-image (handled internally).
  </action>
  <verify>
   - TypeScript compiles: `npx tsc --noEmit`
   - GalleryCard is exported
   - Renders CircularGallery for style='circular', EmblaCarouselGallery otherwise
  </verify>
  <done>
   - GalleryCard routes to correct gallery component based on style
   - Empty state shown when no images
   - Circular Gallery uses video aspect ratio wrapper
   - Carousel shows images in square format
  </done>
</task>

<task type="auto">
  <name>Task 4: Create gallery-card-fields editor with drag-and-drop</name>
  <files>src/components/editor/gallery-card-fields.tsx</files>
  <action>
Create src/components/editor/gallery-card-fields.tsx with image reordering:

1. Imports:
   ```typescript
   'use client'
   import { useState, useCallback } from 'react'
   import { DndContext, closestCenter, DragEndEvent, PointerSensor, TouchSensor, useSensor, useSensors } from '@dnd-kit/core'
   import { SortableContext, arrayMove, useSortable, rectSortingStrategy } from '@dnd-kit/sortable'
   import { CSS } from '@dnd-kit/utilities'
   import Image from 'next/image'
   import { Input } from '@/components/ui/input'
   import { Label } from '@/components/ui/label'
   import { Button } from '@/components/ui/button'
   import { ToggleGroup, ToggleGroupItem } from '@/components/ui/toggle-group'
   import { Plus, X, Loader2, ImageIcon, Circle, Rows3 } from 'lucide-react'
   import { uploadCardImage } from '@/lib/supabase/storage'
   import { compressImage } from '@/lib/image-compression'
   import type { GalleryCardContent, GalleryImage } from '@/types/card'
   ```

2. Props interface:
   ```typescript
   interface GalleryCardFieldsProps {
     content: GalleryCardContent
     onChange: (updates: Record<string, unknown>) => void
     cardId: string
   }
   ```

3. SortableImage sub-component:
   ```typescript
   function SortableImage({
     image,
     onRemove
   }: {
     image: GalleryImage
     onRemove: () => void
   }) {
     const { attributes, listeners, setNodeRef, transform, transition, isDragging } = useSortable({ id: image.id })

     const style = {
       transform: CSS.Transform.toString(transform),
       transition,
       opacity: isDragging ? 0.5 : 1,
     }

     return (
       <div ref={setNodeRef} style={style} className="relative group aspect-square">
         <div {...attributes} {...listeners} className="cursor-move w-full h-full">
           <Image src={image.url} alt={image.alt} fill className="object-cover rounded" />
         </div>
         <button
           onClick={onRemove}
           className="absolute -top-2 -right-2 bg-destructive text-destructive-foreground rounded-full p-1 opacity-0 group-hover:opacity-100 transition-opacity"
           aria-label="Remove image"
         >
           <X className="h-3 w-3" />
         </button>
       </div>
     )
   }
   ```

4. Main GalleryCardFields component:
   - State: isUploading, error
   - sensors: useSensors(useSensor(PointerSensor), useSensor(TouchSensor, { activationConstraint: { delay: 50 } }))
   - Current images: content.images || []

5. Gallery Style Toggle:
   ```tsx
   <div className="space-y-2">
     <Label>Gallery Style</Label>
     <ToggleGroup
       type="single"
       value={content.galleryStyle || 'carousel'}
       onValueChange={(value) => {
         if (value) onChange({ galleryStyle: value })
       }}
       className="justify-start"
     >
       <ToggleGroupItem value="circular" aria-label="Circular gallery">
         <Circle className="h-4 w-4 mr-2" /> Circular
       </ToggleGroupItem>
       <ToggleGroupItem value="carousel" aria-label="Carousel">
         <Rows3 className="h-4 w-4 mr-2" /> Carousel
       </ToggleGroupItem>
     </ToggleGroup>
   </div>
   ```

6. Image Grid with dnd-kit:
   ```tsx
   <div className="space-y-2">
     <Label>Images ({images.length}/10)</Label>
     <DndContext
       sensors={sensors}
       collisionDetection={closestCenter}
       onDragEnd={handleDragEnd}
     >
       <SortableContext items={images.map(img => img.id)} strategy={rectSortingStrategy}>
         <div className="grid grid-cols-4 gap-2">
           {images.map(image => (
             <SortableImage
               key={image.id}
               image={image}
               onRemove={() => handleRemoveImage(image.id)}
             />
           ))}
         </div>
       </SortableContext>
     </DndContext>
   </div>
   ```

7. Add Image button (hidden at 10 images):
   ```tsx
   {images.length < 10 && (
     <div className="space-y-2">
       <Label htmlFor="addImage">Add Image</Label>
       <Input
         id="addImage"
         type="file"
         accept="image/*"
         disabled={isUploading}
         onChange={handleFileSelect}
         className="cursor-pointer"
       />
       {isUploading && (
         <div className="flex items-center gap-2 text-sm text-muted-foreground">
           <Loader2 className="h-4 w-4 animate-spin" />
           Uploading...
         </div>
       )}
     </div>
   )}
   ```

8. Handler functions:
   - handleDragEnd: Use arrayMove from dnd-kit, update images array via onChange
   - handleFileSelect: Compress image, upload to Supabase, generate id, add to images array
   - handleRemoveImage: Filter out image by id, update via onChange

9. Image upload flow:
   ```typescript
   async function handleFileSelect(e: React.ChangeEvent<HTMLInputElement>) {
     const file = e.target.files?.[0]
     if (!file) return

     setIsUploading(true)
     setError(null)
     try {
       // Compress before upload
       const compressed = await compressImage(file)

       // Upload to Supabase
       const result = await uploadCardImage(compressed, cardId)

       // Create new image entry
       const newImage: GalleryImage = {
         id: crypto.randomUUID(),
         url: result.url,
         alt: file.name.replace(/\.[^/.]+$/, ''), // filename without extension
         storagePath: result.path,
       }

       // Add to images array
       const newImages = [...images, newImage]
       onChange({ images: newImages })
     } catch (err) {
       setError(err instanceof Error ? err.message : 'Upload failed')
     } finally {
       setIsUploading(false)
       // Reset input
       e.target.value = ''
     }
   }
   ```

10. Drag end handler:
    ```typescript
    function handleDragEnd(event: DragEndEvent) {
      const { active, over } = event
      if (!over || active.id === over.id) return

      const oldIndex = images.findIndex(img => img.id === active.id)
      const newIndex = images.findIndex(img => img.id === over.id)

      const reordered = arrayMove(images, oldIndex, newIndex)
      onChange({ images: reordered })
    }
    ```
  </action>
  <verify>
   - TypeScript compiles: `npx tsc --noEmit`
   - GalleryCardFields exported
   - Has style toggle, image grid with drag-and-drop, add/remove buttons
  </verify>
  <done>
   - Gallery style toggle between Circular and Carousel
   - Image grid with drag-and-drop reordering via dnd-kit
   - Add image with compression and Supabase upload
   - Remove image button on hover
   - 10 image limit enforced (add button hidden at limit)
  </done>
</task>

<task type="auto">
  <name>Task 5: Wire GalleryCard into card-renderer and card-property-editor</name>
  <files>
    src/components/cards/card-renderer.tsx
    src/components/editor/card-property-editor.tsx
  </files>
  <action>
1. Update src/components/cards/card-renderer.tsx:

   Add import:
   ```typescript
   import { GalleryCard } from "./gallery-card"
   ```

   Add case in switch (after video case):
   ```typescript
   case "gallery":
     return <GalleryCard card={card} isPreview={isPreview} />
   ```

2. Update src/components/editor/card-property-editor.tsx:

   Add import:
   ```typescript
   import { GalleryCardFields } from "./gallery-card-fields"
   ```

   Add GalleryCardContent to type imports:
   ```typescript
   import type { ..., GalleryCardContent } from "@/types/card"
   ```

   Add gallery case in type-specific fields section (after video):
   ```tsx
   {card.card_type === "gallery" && (
     <GalleryCardFields
       content={currentContent as GalleryCardContent}
       onChange={handleContentChange}
       cardId={card.id}
     />
   )}
   ```

3. Verify 'gallery' is in CARD_TYPES_NO_IMAGE (should be from Plan 02):
   - Gallery cards manage their own images, not via generic ImageUpload
   - If not already added, add 'gallery' to the CARD_TYPES_NO_IMAGE array in src/types/card.ts
  </action>
  <verify>
   - TypeScript compiles: `npx tsc --noEmit`
   - grep "case.*gallery" src/components/cards/card-renderer.tsx shows the case
   - grep "GalleryCardFields" src/components/editor/card-property-editor.tsx shows usage
  </verify>
  <done>
   - GalleryCard rendered for card_type === 'gallery'
   - GalleryCardFields shown when editing gallery cards
   - Gallery added to CARD_TYPES_NO_IMAGE if needed
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Media Cards phase: Video Card and Photo Gallery Card with two gallery styles (Circular Gallery and Carousel), drag-and-drop image reordering, and full editor integration.
  </what-built>
  <how-to-verify>
1. Start dev server: `npm run dev`
2. Open editor at http://localhost:3000/dashboard

**Video Card Tests:**
3. Add a new Video card (card type picker)
4. In editor, ensure URL input is shown (embed mode default)
5. Paste YouTube URL: https://www.youtube.com/watch?v=dQw4w9WgXcQ
   - Should fetch thumbnail and show video card with play button
6. Click play button - should load YouTube iframe
7. Switch to Upload mode in editor
8. Upload small MP4 file (< 100MB)
   - Should show uploading state, then autoplay muted loop
9. Try uploading file > 100MB - should show error message

**Photo Gallery Tests:**
10. Add a new Gallery card (card type picker)
11. Default style should be Carousel
12. Add 3-4 images via file picker
    - Each should compress and upload
13. Swipe/arrow through carousel - should work
14. Drag thumbnails to reorder in editor - order should update
15. Remove an image via X button - should be removed
16. Switch to Circular Gallery style - should show different effect
17. Try adding images until you have 10 - Add button should hide
18. Resize cards to small - both video and gallery should work at half width

**Mobile Tests (use Chrome DevTools):**
19. Test carousel swipe on mobile viewport
20. Test gallery thumbnail drag on mobile (may have touch sensor delay)
  </how-to-verify>
  <resume-signal>Type "approved" to complete phase, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
After completing all tasks:
1. `npx tsc --noEmit` - TypeScript compiles without errors
2. `npm run dev` - Dev server runs without errors
3. All manual tests in checkpoint pass
</verification>

<success_criteria>
- CircularGallery component works with configurable scroll/bend settings
- EmblaCarouselGallery has swipe + arrow navigation
- GalleryCard routes to correct gallery based on style
- GalleryCardFields has style toggle, add/remove/reorder images
- Drag-and-drop reorder works on desktop and mobile
- 10 image limit enforced
- Both card types respect big/small sizing
- Video Card thumbnail preview + click-to-play for embeds
- Video Card muted autoplay loop for uploads
</success_criteria>

<output>
After completion, create `.planning/phases/05-media-cards/05-03-SUMMARY.md`
</output>
