---
phase: 06.1-dropdown-card-fix
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/canvas/dropdown-sortable.tsx
  - src/components/cards/dropdown-card.tsx
  - src/components/canvas/selectable-flow-grid.tsx
autonomous: true

must_haves:
  truths:
    - "Clicking dropdown header toggles expand/collapse reliably"
    - "Dropdown card can be dragged to reorder on main canvas"
    - "Dropdown auto-collapses when drag starts"
    - "Toggle and drag don't interfere with each other"
  artifacts:
    - path: "src/components/canvas/dropdown-sortable.tsx"
      provides: "Sortable dropdown wrapper with drag handle"
      contains: "useSortable"
    - path: "src/components/cards/dropdown-card.tsx"
      provides: "Controlled collapsible dropdown UI"
      contains: "isOpen"
  key_links:
    - from: "src/components/canvas/dropdown-sortable.tsx"
      to: "src/components/cards/dropdown-card.tsx"
      via: "isOpen and onOpenChange props"
      pattern: "isOpen.*onOpenChange"
    - from: "src/components/canvas/dropdown-sortable.tsx"
      to: "@dnd-kit/sortable"
      via: "useSortable with setActivatorNodeRef"
      pattern: "setActivatorNodeRef"
---

<objective>
Refactor DropdownSortable and DropdownCard to fix dropdown drag and toggle functionality.

Purpose: The dropdown card is currently broken - it can't be dragged to reorder on the main canvas, and the toggle often stops working. This plan fixes both issues by implementing proper drag handle separation and lifting open/close state to prevent corruption.

Output: Working dropdown that toggles reliably and can be reordered via drag handle.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06.1-dropdown-card-fix/06.1-CONTEXT.md
@.planning/phases/06.1-dropdown-card-fix/06.1-RESEARCH.md

# Current implementation (broken)
@src/components/canvas/dropdown-sortable.tsx
@src/components/cards/dropdown-card.tsx
@src/components/canvas/selectable-flow-grid.tsx

# Working pattern to follow (drag handle on interactive cards)
@src/components/canvas/preview-sortable-card.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor DropdownCard to controlled component</name>
  <files>src/components/cards/dropdown-card.tsx</files>
  <action>
Refactor DropdownCard to be a controlled component that receives open/close state from parent:

1. Remove the local `useState(false)` for `isOpen`
2. Add props: `isOpen: boolean` and `onOpenChange: (open: boolean) => void`
3. Remove the `onPointerDown={(e) => e.stopPropagation()}` - this is the main bug that blocks drag
4. Keep the button element but change it to a div with role="button" to avoid accessibility conflicts with drag
5. The toggle div should NOT have stopPropagation - that's the key fix
6. Use Radix Collapsible (already installed) for proper animation support

Structure:
```tsx
interface DropdownCardProps {
  card: Card
  isOpen: boolean
  onOpenChange: (open: boolean) => void
  isPreview?: boolean
  children?: React.ReactNode
}

export function DropdownCard({ card, isOpen, onOpenChange, isPreview = false, children }: DropdownCardProps) {
  // No local useState - state is controlled by parent

  return (
    <Collapsible open={isOpen} onOpenChange={onOpenChange}>
      <div className="w-full">
        {/* Header with trigger - NO stopPropagation */}
        <div className="flex items-center">
          <CollapsibleTrigger asChild>
            <div
              role="button"
              tabIndex={0}
              className="flex-1 flex items-center justify-between px-4 py-3 cursor-pointer ..."
              onKeyDown={(e) => { if (e.key === 'Enter' || e.key === ' ') onOpenChange(!isOpen) }}
            >
              {/* Header content + chevron */}
            </div>
          </CollapsibleTrigger>
          {/* Drag handle will be added by parent (DropdownSortable) */}
        </div>

        <CollapsibleContent className="dropdown-content overflow-hidden">
          {/* Children slot for nested cards */}
        </CollapsibleContent>
      </div>
    </Collapsible>
  )
}
```

Key changes:
- NO `onPointerDown stopPropagation` anywhere
- Controlled `isOpen` prop from parent
- `CollapsibleTrigger` wraps only the clickable header area
- Drag handle is NOT inside this component - parent adds it
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
No `useState` for `isOpen` in the file
No `stopPropagation` on pointerDown events
  </verify>
  <done>
DropdownCard is a controlled component accepting isOpen/onOpenChange props, uses Radix Collapsible, no event blocking that would prevent drag
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor DropdownSortable with useSortable and drag handle</name>
  <files>src/components/canvas/dropdown-sortable.tsx</files>
  <action>
Refactor DropdownSortable to use `useSortable` instead of just `useDroppable`, with proper drag handle separation:

1. Add `useSortable` hook (in addition to existing `useDroppable` for card drops)
2. Use `setActivatorNodeRef` to attach drag listeners ONLY to a dedicated drag handle
3. Add local `useState` for `isOpen` - this component owns the dropdown open state
4. Add auto-collapse on drag: when `isDragging` becomes true, set `isOpen` to false
5. Render a drag handle (GripVertical icon) on the RIGHT side of the header
6. Pass `isOpen` and `onOpenChange` to the DropdownCard child

Structure:
```tsx
export function DropdownSortable({ dropdown, childCards }: DropdownSortableProps) {
  const [isOpen, setIsOpen] = useState(false)

  // Sortable for drag-to-reorder on main canvas
  const {
    attributes,
    listeners,
    setNodeRef: setSortableRef,
    setActivatorNodeRef,  // KEY: For drag handle
    transform,
    transition,
    isDragging,
  } = useSortable({ id: dropdown.id })

  // Droppable for receiving cards (keep existing)
  const { setNodeRef: setDroppableRef, isOver } = useDroppable({
    id: dropdown.id,
    data: { type: "dropdown", dropdownId: dropdown.id },
  })

  // Combine refs
  const setNodeRef = (node: HTMLDivElement | null) => {
    setSortableRef(node)
    setDroppableRef(node)
  }

  // Auto-collapse when drag starts (per CONTEXT.md)
  useEffect(() => {
    if (isDragging && isOpen) {
      setIsOpen(false)
    }
  }, [isDragging, isOpen])

  const style = {
    transform: CSS.Translate.toString(transform),
    transition: transition ?? 'transform 200ms ease',
  }

  return (
    <div
      ref={setNodeRef}
      style={style}
      className={cn(
        "w-full",
        isDragging && "opacity-50",
        isOver && "ring-2 ring-primary ring-offset-2"
      )}
    >
      {/* Wrapper with drag handle on the right */}
      <div className="flex items-start">
        {/* DropdownCard takes most of the space */}
        <div className="flex-1">
          <DropdownCard
            card={dropdown}
            isOpen={isOpen}
            onOpenChange={setIsOpen}
          >
            {/* Nested SortableContext for children */}
            <SortableContext items={childCards.map(c => c.id)} strategy={rectSortingStrategy}>
              <div className="space-y-2">
                {childCards.map((card) => (
                  <SortableFlowCard key={card.id} card={card} isInsideDropdown />
                ))}
              </div>
            </SortableContext>
          </DropdownCard>
        </div>

        {/* Drag handle - ONLY this receives drag listeners */}
        <div
          ref={setActivatorNodeRef}
          {...attributes}
          {...listeners}
          className="p-3 cursor-grab active:cursor-grabbing touch-none hover:bg-accent/30 rounded-r-lg self-stretch flex items-center"
          aria-label="Drag to reorder dropdown"
        >
          <GripVertical className="h-4 w-4 text-muted-foreground" />
        </div>
      </div>
    </div>
  )
}
```

Key changes:
- useSortable added with setActivatorNodeRef for drag handle
- Local useState for isOpen (parent of DropdownCard)
- Auto-collapse effect when isDragging
- Drag handle is a sibling to DropdownCard, receives all drag listeners
- Keep existing useDroppable for card-into-dropdown drops
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
`useSortable` imported and used
`setActivatorNodeRef` attached to drag handle element
`isDragging` triggers `setIsOpen(false)`
  </verify>
  <done>
DropdownSortable uses useSortable with drag handle pattern, manages isOpen state, auto-collapses on drag start
  </done>
</task>

<task type="auto">
  <name>Task 3: Update SelectableFlowGrid to handle dropdown in DragOverlay</name>
  <files>src/components/canvas/selectable-flow-grid.tsx</files>
  <action>
Update SelectableFlowGrid to properly render dropdown in DragOverlay and ensure dropdown IDs are in the SortableContext items:

1. The SortableContext items already include dropdowns (line 244 filters by !parentDropdownId, dropdowns have no parent)
2. Add dropdown rendering to DragOverlay - when activeCard is a dropdown, render it appropriately
3. Ensure handleDragEnd properly handles dropdown reordering (Case 4 already works)

Changes to DragOverlay section:
```tsx
<DragOverlay dropAnimation={null}>
  {activeCard && (
    <div className="relative">
      <div className={cn(
        "shadow-xl pointer-events-none",
        activeCard.card_type === "dropdown"
          ? "w-80"  // Fixed width for dropdown overlay
          : activeCard.size === "big" ? "w-80" : "w-40",
      )}>
        {activeCard.card_type === "dropdown" ? (
          // Simplified dropdown preview during drag (collapsed)
          <div className="bg-card/50 border border-border/50 rounded-lg px-4 py-3">
            <div className="flex items-center justify-between">
              <span className="text-sm font-medium">
                {activeCard.title || "Dropdown"}
              </span>
              <ChevronDown className="h-4 w-4 text-muted-foreground/70" />
            </div>
          </div>
        ) : (
          <CardRenderer card={activeCard} isPreview />
        )}
      </div>
      {/* Badge for multi-drag */}
      {draggedCardIds.length > 1 && (
        <div className="absolute -top-2 -right-2 ...">
          {draggedCardIds.length}
        </div>
      )}
    </div>
  )}
</DragOverlay>
```

Also add ChevronDown to imports:
```tsx
import { ChevronDown } from "lucide-react"
```

No changes needed to handleDragEnd - it already handles main canvas reordering correctly.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
DragOverlay renders dropdown cards with collapsed preview
ChevronDown imported from lucide-react
  </verify>
  <done>
SelectableFlowGrid properly renders dropdown in DragOverlay with collapsed preview
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **TypeScript check:** `npx tsc --noEmit` - no type errors
2. **Build check:** `npm run build` - builds successfully
3. **Manual verification (automated in next plan):**
   - Dropdown toggle should respond to every click
   - Dropdown should be draggable via the grip handle on the right
   - When drag starts, expanded dropdown should auto-collapse
   - Child cards should still be visible when dropdown is open
</verification>

<success_criteria>
- DropdownCard is a controlled component (no local useState for isOpen)
- DropdownSortable uses useSortable with setActivatorNodeRef pattern
- Drag handle is visible on right side of dropdown header
- No stopPropagation on pointerDown events
- SelectableFlowGrid renders dropdown in DragOverlay
- TypeScript compiles without errors
- App builds successfully
</success_criteria>

<output>
After completion, create `.planning/phases/06.1-dropdown-card-fix/06.1-01-SUMMARY.md`
</output>
