---
phase: 06.1-dropdown-card-fix
plan: 02
type: execute
wave: 2
depends_on: ["06.1-01"]
files_modified:
  - src/components/canvas/sortable-flow-card.tsx
autonomous: false

must_haves:
  truths:
    - "Child cards inside dropdown can be dragged to reorder"
    - "Child cards use drag handle pattern (not entire card)"
    - "Dropdown interactions work on both desktop and mobile"
    - "No stuck states or loss of functionality after interactions"
  artifacts:
    - path: "src/components/canvas/sortable-flow-card.tsx"
      provides: "Sortable child card with drag handle"
      contains: "setActivatorNodeRef"
  key_links:
    - from: "src/components/canvas/sortable-flow-card.tsx"
      to: "@dnd-kit/sortable"
      via: "useSortable with setActivatorNodeRef"
      pattern: "setActivatorNodeRef"
---

<objective>
Add drag handles to child cards inside dropdowns and verify all dropdown functionality works correctly.

Purpose: Child cards inside dropdowns need their own drag handles for reordering within the dropdown. Currently they use the entire card as drag activator, which conflicts with click interactions. This plan adds the drag handle pattern and includes human verification of all dropdown functionality.

Output: Fully working dropdown card with all interactions verified.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06.1-dropdown-card-fix/06.1-CONTEXT.md
@.planning/phases/06.1-dropdown-card-fix/06.1-RESEARCH.md

# Prior plan output
@.planning/phases/06.1-dropdown-card-fix/06.1-01-SUMMARY.md

# Current implementation
@src/components/canvas/sortable-flow-card.tsx

# Working pattern to follow
@src/components/canvas/preview-sortable-card.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add drag handle to SortableFlowCard for child cards</name>
  <files>src/components/canvas/sortable-flow-card.tsx</files>
  <action>
Refactor SortableFlowCard to use drag handle pattern when inside a dropdown:

1. Add `setActivatorNodeRef` from useSortable
2. When `isInsideDropdown` is true, render with a drag handle on the right side
3. Remove `{...attributes} {...listeners}` from the container div when inside dropdown
4. Apply drag listeners ONLY to the drag handle element
5. Ensure child cards render at full width inside dropdown (remove half-width calc)

Structure:
```tsx
export function SortableFlowCard({ card, isInsideDropdown = false }: SortableFlowCardProps) {
  const {
    attributes,
    listeners,
    setNodeRef,
    setActivatorNodeRef,  // ADD THIS
    transform,
    transition,
    isDragging,
  } = useSortable({ id: card.id })

  const style = {
    transform: CSS.Translate.toString(transform),
    transition: transition ?? 'transform 200ms ease',
  }

  // Inside dropdown: full width. On main canvas: respect size
  const widthClass = isInsideDropdown
    ? "w-full"
    : card.size === "big" ? "w-full" : "w-[calc(50%-0.5rem)]"

  // When inside dropdown, use drag handle pattern
  if (isInsideDropdown) {
    return (
      <div
        ref={setNodeRef}
        style={style}
        className={cn(
          widthClass,
          isDragging && "opacity-0",
          "group/child"  // For hover states
        )}
      >
        <div className="flex items-start">
          {/* Card content - takes most space, clickable */}
          <div className="flex-1 min-w-0">
            <CardRenderer card={card} isPreview />
          </div>

          {/* Drag handle - visible on hover, always on mobile */}
          <div
            ref={setActivatorNodeRef}
            {...attributes}
            {...listeners}
            className={cn(
              "p-2 cursor-grab active:cursor-grabbing touch-none",
              "flex items-center self-stretch",
              "opacity-0 group-hover/child:opacity-100 transition-opacity",
              // Always visible on touch devices
              "[@media(hover:none)]:opacity-100"
            )}
            aria-label="Drag to reorder"
          >
            <GripVertical className="h-4 w-4 text-muted-foreground" />
          </div>
        </div>
      </div>
    )
  }

  // Not inside dropdown - original behavior (entire card is drag activator)
  return (
    <div
      ref={setNodeRef}
      style={style}
      className={cn(
        widthClass,
        isDragging && "opacity-0",
        "cursor-grab active:cursor-grabbing"
      )}
      {...attributes}
      {...listeners}
    >
      <CardRenderer card={card} isPreview />
    </div>
  )
}
```

Also add GripVertical to imports:
```tsx
import { GripVertical } from "lucide-react"
```

Key changes:
- setActivatorNodeRef from useSortable
- When isInsideDropdown: drag handle pattern
- Child cards get full width inside dropdown
- Drag handle visible on hover (desktop) or always (mobile via @media(hover:none))
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
`setActivatorNodeRef` used when `isInsideDropdown`
GripVertical imported
  </verify>
  <done>
SortableFlowCard uses drag handle pattern when inside dropdown, child cards render at full width
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete dropdown card fix including:
- Dropdown toggle (click header to expand/collapse)
- Dropdown drag (use grip handle on right side to reorder on main canvas)
- Child card reorder (use grip handle on child cards to reorder within dropdown)
- Auto-collapse (dropdown collapses when you start dragging it)
  </what-built>
  <how-to-verify>
Start the dev server: `npm run dev`
Open the app in browser at http://localhost:3000

**Test 1: Dropdown Toggle**
1. Create a dropdown card (if not already present)
2. Click the header text - should expand
3. Click the header text again - should collapse
4. Repeat 5 times - should work every time without getting "stuck"

**Test 2: Dropdown Drag**
1. Create 3+ cards including at least 1 dropdown
2. Look for the drag handle (GripVertical icon) on the RIGHT side of dropdown header
3. Drag the dropdown by the handle to reorder among other cards
4. Dropdown should move to new position
5. If dropdown was expanded, it should auto-collapse when you start dragging

**Test 3: Child Card Reorder**
1. Add 2+ cards to a dropdown (via editor panel checkboxes)
2. Expand the dropdown
3. Hover over a child card - drag handle should appear on the right
4. Drag a child card to reorder within the dropdown
5. Child cards should swap positions

**Test 4: Desktop vs Mobile**
1. Test all above on desktop (normal browser)
2. Open Chrome DevTools, toggle device toolbar (Ctrl+Shift+M)
3. Select a mobile device (iPhone 14 Pro)
4. Test toggle, dropdown drag, and child reorder
5. On mobile, drag handles should be always visible (not hover-only)

**Test 5: No Stuck States**
1. Rapidly click toggle while trying to drag
2. Start a drag then cancel (drop in same place)
3. Expand, drag child, collapse, expand again
4. Toggle should still work after any interaction sequence

Expected: All 5 tests pass without any "stuck" or broken states.
  </how-to-verify>
  <resume-signal>Type "approved" or describe specific issues</resume-signal>
</task>

</tasks>

<verification>
After Task 1:
- `npx tsc --noEmit` passes
- `npm run build` succeeds

After Task 2 (checkpoint):
- Human verifies all dropdown interactions work correctly
- All 5 test scenarios pass
</verification>

<success_criteria>
- Child cards inside dropdown have visible drag handles
- Child cards can be reordered within dropdown
- All dropdown interactions work on desktop AND mobile
- No "stuck" states after any interaction sequence
- Human verification confirms all functionality works
</success_criteria>

<output>
After completion, create `.planning/phases/06.1-dropdown-card-fix/06.1-02-SUMMARY.md`
</output>
