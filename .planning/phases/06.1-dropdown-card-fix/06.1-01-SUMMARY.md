---
phase: 06.1-dropdown-card-fix
plan: 01
subsystem: ui
tags: [react, dnd-kit, radix-ui, sortable, drag-and-drop]

# Dependency graph
requires:
  - phase: 06-advanced-cards
    provides: Dropdown card infrastructure and nested drag-drop
provides:
  - Controlled DropdownCard component with external state management
  - DropdownSortable with useSortable drag handle pattern
  - Auto-collapse dropdown on drag start
  - Dropdown rendering in DragOverlay for visual feedback
affects: [06-advanced-cards, future-drag-drop-features]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - Controlled component pattern for interactive cards with drag
    - setActivatorNodeRef drag handle pattern
    - Combined sortable + droppable refs for dual functionality
    - Auto-collapse on drag via isDragging effect

key-files:
  created: []
  modified:
    - src/components/cards/dropdown-card.tsx
    - src/components/canvas/dropdown-sortable.tsx
    - src/components/canvas/selectable-flow-grid.tsx
    - src/components/cards/card-renderer.tsx

key-decisions:
  - "Controlled component pattern prevents state corruption during drag transforms"
  - "Removed stopPropagation to allow dnd-kit event propagation"
  - "Drag handle on right side for visual consistency"
  - "Auto-collapse dropdown when drag starts for cleaner UX"

patterns-established:
  - "Controlled component with isOpen/onOpenChange for interactive cards in drag contexts"
  - "setActivatorNodeRef pattern for drag handles on interactive elements"
  - "Combined sortable/droppable refs for containers with dual functionality"

# Metrics
duration: 2min
completed: 2026-01-27
---

# Phase 6.1 Plan 01: Dropdown Card Fix Summary

**Refactored dropdown to controlled component with dedicated drag handle, fixing toggle and reorder functionality**

## Performance

- **Duration:** 2 min
- **Started:** 2026-01-27T10:58:07Z
- **Completed:** 2026-01-27T11:00:29Z
- **Tasks:** 3
- **Files modified:** 4

## Accomplishments
- Converted DropdownCard to controlled component with external state management
- Implemented useSortable with drag handle pattern in DropdownSortable
- Fixed event propagation issues blocking drag functionality
- Added dropdown-specific rendering in DragOverlay

## Task Commits

Each task was committed atomically:

1. **Task 1: Fix DropdownCard broken toggle and event blocking** - `57d60ee` (refactor)
2. **Task 2: Refactor DropdownSortable with useSortable and drag handle** - `b5ebd2e` (feat)
3. **Task 3: Update SelectableFlowGrid to handle dropdown in DragOverlay** - `df14209` (feat)

## Files Created/Modified
- `src/components/cards/dropdown-card.tsx` - Converted to controlled component with Radix Collapsible, removed stopPropagation
- `src/components/canvas/dropdown-sortable.tsx` - Added useSortable with drag handle, manages isOpen state, auto-collapse on drag
- `src/components/canvas/selectable-flow-grid.tsx` - Added dropdown rendering in DragOverlay with collapsed preview
- `src/components/cards/card-renderer.tsx` - Updated dropdown case with default collapsed state for DragOverlay

## Decisions Made

**1. Controlled component pattern for DropdownCard**
- Rationale: Local useState caused state corruption during drag transforms (React re-renders with transform CSS)
- Solution: Lift state to parent (DropdownSortable), pass as props

**2. Remove stopPropagation on pointerDown**
- Rationale: Blocked dnd-kit drag listeners from receiving events
- Solution: Remove stopPropagation entirely, let events bubble to drag handlers

**3. Drag handle on right side**
- Rationale: Clear separation between toggle (left) and drag (right) interactions
- Solution: GripVertical icon in separate div with setActivatorNodeRef

**4. Auto-collapse on drag start**
- Rationale: Better UX - expanded dropdown during drag looks cluttered
- Solution: useEffect watching isDragging, sets isOpen to false

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Fixed CardRenderer dropdown type error**
- **Found during:** Task 1 TypeScript compilation
- **Issue:** CardRenderer passed DropdownCard without required isOpen/onOpenChange props
- **Fix:** Added default props (isOpen={false}, onOpenChange={() => {}}) for non-interactive DragOverlay preview
- **Files modified:** src/components/cards/card-renderer.tsx
- **Verification:** TypeScript compiles without errors
- **Committed in:** 57d60ee (Task 1 commit)

---

**Total deviations:** 1 auto-fixed (1 blocking)
**Impact on plan:** Necessary fix to unblock TypeScript compilation after making DropdownCard controlled. No scope creep.

## Issues Encountered
None - plan executed smoothly with one expected blocking fix for CardRenderer.

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness

**Ready for Phase 6 continuation:**
- Dropdown toggle works reliably
- Dropdown can be dragged via drag handle on main canvas
- Dropdown auto-collapses when drag starts
- No interference between toggle and drag interactions
- TypeScript compiles and app builds successfully

**Verification needed:**
- Manual testing of dropdown toggle in live app
- Manual testing of dropdown drag-to-reorder
- Verify child cards still draggable within dropdown
- Test on mobile/touch devices

**Next steps:**
- Complete Phase 6 Plan 15 (Editor Testing & Polish)
- Complete Phase 6 Plan 16 (Phase Verification)
- Unblock Phase 6 progression

---
*Phase: 06.1-dropdown-card-fix*
*Completed: 2026-01-27*
