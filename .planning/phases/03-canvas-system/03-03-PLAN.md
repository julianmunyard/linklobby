---
phase: 03-canvas-system
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/components/canvas/sortable-card-list.tsx
  - src/components/canvas/sortable-card.tsx
  - src/components/canvas/canvas-container.tsx
autonomous: true

must_haves:
  truths:
    - "Cards render in a vertical stack"
    - "Cards can be dragged up/down to reorder"
    - "Drag handle allows mobile users to scroll the page"
    - "Keyboard navigation works for accessibility"
  artifacts:
    - path: "src/components/canvas/sortable-card-list.tsx"
      provides: "DndContext wrapper with sortable context"
      exports: ["SortableCardList"]
      min_lines: 50
    - path: "src/components/canvas/sortable-card.tsx"
      provides: "Individual draggable card with drag handle"
      exports: ["SortableCard"]
      min_lines: 40
    - path: "src/components/canvas/canvas-container.tsx"
      provides: "Mobile-first responsive container"
      exports: ["CanvasContainer"]
  key_links:
    - from: "src/components/canvas/sortable-card-list.tsx"
      to: "@dnd-kit/core"
      via: "DndContext import"
      pattern: "from '@dnd-kit/core'"
    - from: "src/components/canvas/sortable-card.tsx"
      to: "@dnd-kit/sortable"
      via: "useSortable hook"
      pattern: "useSortable"
---

<objective>
Create the sortable card components using dnd-kit for drag-and-drop reordering.

Purpose: Build the core UI components that enable artists to drag cards up/down in a vertical stack. These components handle all the complexity of drag interactions, accessibility, and mobile touch support.

Output: SortableCardList, SortableCard, and CanvasContainer components
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-canvas-system/03-RESEARCH.md
@.planning/phases/03-canvas-system/03-01-SUMMARY.md

# Types created in 03-01
@src/types/card.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CanvasContainer component</name>
  <files>src/components/canvas/canvas-container.tsx</files>
  <action>
Create a mobile-first responsive container for the canvas:

```typescript
// src/components/canvas/canvas-container.tsx
"use client"

import { cn } from "@/lib/utils"

interface CanvasContainerProps {
  children: React.ReactNode
  className?: string
}

/**
 * Mobile-first container for the card stack.
 * - max-w-md (448px) matches typical link-in-bio width
 * - Centered with auto margins
 * - Padding for breathing room
 * - space-y-4 gap between cards
 */
export function CanvasContainer({ children, className }: CanvasContainerProps) {
  return (
    <div
      className={cn(
        "w-full max-w-md mx-auto px-4 py-6",
        className
      )}
    >
      {children}
    </div>
  )
}
```

Per CONTEXT.md: Same layout on mobile and desktop - mobile-first, desktop is just wider. The max-w-md keeps cards readable on wide screens.
  </action>
  <verify>
File exists and exports CanvasContainer.
`npx tsc --noEmit src/components/canvas/canvas-container.tsx`
  </verify>
  <done>CanvasContainer component with mobile-first responsive layout.</done>
</task>

<task type="auto">
  <name>Task 2: Create SortableCard component</name>
  <files>src/components/canvas/sortable-card.tsx</files>
  <action>
Create the individual draggable card with a dedicated drag handle:

```typescript
// src/components/canvas/sortable-card.tsx
"use client"

import { useSortable } from "@dnd-kit/sortable"
import { CSS } from "@dnd-kit/utilities"
import { GripVertical } from "lucide-react"
import { cn } from "@/lib/utils"
import type { Card } from "@/types/card"
import { CARD_SIZES } from "@/types/card"

interface SortableCardProps {
  card: Card
  isSelected?: boolean
  onSelect?: (id: string) => void
}

export function SortableCard({ card, isSelected, onSelect }: SortableCardProps) {
  const {
    attributes,
    listeners,
    setNodeRef,
    transform,
    transition,
    isDragging,
  } = useSortable({ id: card.id })

  const style = {
    transform: CSS.Transform.toString(transform),
    transition,
  }

  const sizeConfig = CARD_SIZES[card.size || "medium"]

  return (
    <div
      ref={setNodeRef}
      style={style}
      className={cn(
        "relative flex items-stretch gap-3 bg-card border rounded-lg overflow-hidden",
        sizeConfig.minHeight,
        isDragging && "opacity-50 shadow-lg z-50",
        isSelected && "ring-2 ring-primary"
      )}
      onClick={() => onSelect?.(card.id)}
    >
      {/* Drag handle - touch-action: none for mobile scrolling */}
      <button
        {...attributes}
        {...listeners}
        className={cn(
          "flex items-center justify-center px-2 bg-muted/50",
          "cursor-grab active:cursor-grabbing touch-none",
          "hover:bg-muted focus:bg-muted focus:outline-none"
        )}
        aria-label={`Drag to reorder ${card.title || "card"}`}
      >
        <GripVertical className="h-4 w-4 text-muted-foreground" />
      </button>

      {/* Card content area */}
      <div className="flex-1 p-3 min-w-0">
        <p className="font-medium truncate">
          {card.title || "Untitled"}
        </p>
        <p className="text-sm text-muted-foreground capitalize">
          {card.card_type.replace("_", " ")}
        </p>
        {card.description && (
          <p className="text-sm text-muted-foreground mt-1 line-clamp-2">
            {card.description}
          </p>
        )}
      </div>
    </div>
  )
}
```

Key points:
- Drag handle is a separate button with touch-action: none (allows page scrolling on mobile)
- transform and transition from useSortable for smooth animations
- isDragging state for visual feedback
- Optional selection state for editor integration
  </action>
  <verify>
File exists with useSortable hook integration.
`npx tsc --noEmit src/components/canvas/sortable-card.tsx`
  </verify>
  <done>SortableCard with drag handle, size support, and selection state.</done>
</task>

<task type="auto">
  <name>Task 3: Create SortableCardList component</name>
  <files>src/components/canvas/sortable-card-list.tsx</files>
  <action>
Create the DndContext wrapper with hydration guard:

```typescript
// src/components/canvas/sortable-card-list.tsx
"use client"

import { useState, useEffect } from "react"
import {
  DndContext,
  closestCenter,
  KeyboardSensor,
  PointerSensor,
  useSensor,
  useSensors,
  DragEndEvent,
} from "@dnd-kit/core"
import {
  SortableContext,
  sortableKeyboardCoordinates,
  verticalListSortingStrategy,
} from "@dnd-kit/sortable"
import { SortableCard } from "./sortable-card"
import type { Card } from "@/types/card"

interface SortableCardListProps {
  cards: Card[]
  onReorder: (oldIndex: number, newIndex: number) => void
  selectedCardId?: string | null
  onSelectCard?: (id: string) => void
}

export function SortableCardList({
  cards,
  onReorder,
  selectedCardId,
  onSelectCard,
}: SortableCardListProps) {
  const [mounted, setMounted] = useState(false)

  // Hydration guard: dnd-kit generates different IDs on server vs client
  useEffect(() => {
    setMounted(true)
  }, [])

  const sensors = useSensors(
    useSensor(PointerSensor, {
      activationConstraint: {
        distance: 8, // Prevent accidental drags
      },
    }),
    useSensor(KeyboardSensor, {
      coordinateGetter: sortableKeyboardCoordinates,
    })
  )

  function handleDragEnd(event: DragEndEvent) {
    const { active, over } = event

    if (over && active.id !== over.id) {
      const oldIndex = cards.findIndex((c) => c.id === active.id)
      const newIndex = cards.findIndex((c) => c.id === over.id)
      onReorder(oldIndex, newIndex)
    }
  }

  // Show loading placeholder during SSR
  if (!mounted) {
    return (
      <div className="space-y-4">
        {cards.map((card) => (
          <div
            key={card.id}
            className="h-24 bg-muted rounded-lg animate-pulse"
          />
        ))}
      </div>
    )
  }

  // Empty state
  if (cards.length === 0) {
    return (
      <div className="flex items-center justify-center h-48 border-2 border-dashed rounded-lg text-muted-foreground">
        <p>No cards yet. Add your first card above.</p>
      </div>
    )
  }

  return (
    <DndContext
      sensors={sensors}
      collisionDetection={closestCenter}
      onDragEnd={handleDragEnd}
    >
      <SortableContext
        items={cards.map((c) => c.id)}
        strategy={verticalListSortingStrategy}
      >
        <div className="space-y-4">
          {cards.map((card) => (
            <SortableCard
              key={card.id}
              card={card}
              isSelected={card.id === selectedCardId}
              onSelect={onSelectCard}
            />
          ))}
        </div>
      </SortableContext>
    </DndContext>
  )
}
```

Critical patterns:
- Hydration guard (mounted check) prevents React warnings
- PointerSensor with distance constraint prevents accidental drags
- KeyboardSensor enables accessibility (arrow keys to reorder)
- verticalListSortingStrategy optimized for vertical lists
- onReorder callback passes indices for parent to handle
  </action>
  <verify>
File exists with DndContext, hydration guard, and empty state.
`npx tsc --noEmit src/components/canvas/sortable-card-list.tsx`
  </verify>
  <done>SortableCardList with hydration guard, keyboard support, and empty state.</done>
</task>

</tasks>

<verification>
1. All three components exist in src/components/canvas/
2. TypeScript compiles without errors: `npx tsc --noEmit`
3. Components export correctly
4. Hydration guard present in SortableCardList
5. Drag handle has touch-none class for mobile scrolling
</verification>

<success_criteria>
- CanvasContainer provides mobile-first responsive layout
- SortableCard has dedicated drag handle with touch-none
- SortableCardList has hydration guard for SSR
- Keyboard navigation enabled via KeyboardSensor
- All components properly typed with Card interface
</success_criteria>

<output>
After completion, create `.planning/phases/03-canvas-system/03-03-SUMMARY.md`
</output>
