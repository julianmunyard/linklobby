---
phase: 03-canvas-system
plan: 04
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/stores/page-store.ts
  - src/components/editor/editor-panel.tsx
  - src/components/editor/cards-tab.tsx
autonomous: true

must_haves:
  truths:
    - "Page store manages cards with sortKey ordering"
    - "Cards tab displays sortable card list"
    - "Card selection updates when clicking a card"
    - "Add card button creates new card with correct sortKey"
  artifacts:
    - path: "src/stores/page-store.ts"
      provides: "Updated store with Card type and reorderCards action"
      exports: ["usePageStore"]
      contains: "reorderCards"
    - path: "src/components/editor/cards-tab.tsx"
      provides: "Cards tab with sortable list and add card button"
      exports: ["CardsTab"]
      min_lines: 40
  key_links:
    - from: "src/components/editor/cards-tab.tsx"
      to: "src/stores/page-store.ts"
      via: "usePageStore hook"
      pattern: "usePageStore"
    - from: "src/stores/page-store.ts"
      to: "src/lib/ordering.ts"
      via: "generateAppendKey import"
      pattern: "from '@/lib/ordering'"
---

<objective>
Update the page store with proper Card type and integrate the sortable card list into the editor.

Purpose: Wire the canvas components into the existing editor shell. This connects the drag-and-drop UI to the Zustand store so card order is managed in application state.

Output: Updated page-store, CardsTab component, editor integration
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-canvas-system/03-RESEARCH.md
@.planning/phases/03-canvas-system/03-01-SUMMARY.md

# Existing store and editor
@src/stores/page-store.ts
@src/components/editor/editor-panel.tsx

# Types and helpers from 03-01
@src/types/card.ts
@src/lib/ordering.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update page-store with Card type and reorder action</name>
  <files>src/stores/page-store.ts</files>
  <action>
Replace the placeholder Card interface with the proper type and add reorderCards action:

```typescript
// src/stores/page-store.ts
import { create } from 'zustand'
import type { Card, CardType, CardSize } from '@/types/card'
import { generateAppendKey, generateMoveKey, sortCardsBySortKey } from '@/lib/ordering'

interface Theme {
  id: string
  name: string
}

const defaultTheme: Theme = {
  id: 'sleek',
  name: 'Sleek Modern'
}

interface PageState {
  // Data
  cards: Card[]
  theme: Theme
  selectedCardId: string | null

  // Tracking
  hasChanges: boolean
  lastSavedAt: number | null

  // Actions
  setCards: (cards: Card[]) => void
  addCard: (type: CardType, size?: CardSize) => void
  updateCard: (id: string, updates: Partial<Card>) => void
  removeCard: (id: string) => void
  reorderCards: (oldIndex: number, newIndex: number) => void
  selectCard: (id: string | null) => void
  setTheme: (theme: Theme) => void
  markSaved: () => void
  discardChanges: () => void

  // Computed
  getSortedCards: () => Card[]
  getSnapshot: () => { cards: Card[]; theme: Theme }
}

export const usePageStore = create<PageState>()((set, get) => ({
  cards: [],
  theme: defaultTheme,
  selectedCardId: null,
  hasChanges: false,
  lastSavedAt: null,

  setCards: (cards) => set({ cards, hasChanges: true }),

  addCard: (type, size = 'medium') => set((state) => {
    const newCard: Card = {
      id: crypto.randomUUID(),
      page_id: '', // Set when saving to DB
      card_type: type,
      title: null,
      description: null,
      url: null,
      content: {},
      size,
      sortKey: generateAppendKey(state.cards),
      is_visible: true,
      created_at: new Date().toISOString(),
      updated_at: new Date().toISOString(),
    }
    return {
      cards: [...state.cards, newCard],
      selectedCardId: newCard.id,
      hasChanges: true
    }
  }),

  updateCard: (id, updates) => set((state) => ({
    cards: state.cards.map((c) =>
      c.id === id ? { ...c, ...updates, updated_at: new Date().toISOString() } : c
    ),
    hasChanges: true,
  })),

  removeCard: (id) => set((state) => ({
    cards: state.cards.filter((c) => c.id !== id),
    selectedCardId: state.selectedCardId === id ? null : state.selectedCardId,
    hasChanges: true,
  })),

  reorderCards: (oldIndex, newIndex) => set((state) => {
    const sorted = sortCardsBySortKey(state.cards)
    const movedCard = sorted[oldIndex]
    if (!movedCard) return state

    // Generate new sort key for the moved card
    const newSortKey = generateMoveKey(state.cards, movedCard.id, newIndex)

    return {
      cards: state.cards.map((c) =>
        c.id === movedCard.id
          ? { ...c, sortKey: newSortKey, updated_at: new Date().toISOString() }
          : c
      ),
      hasChanges: true,
    }
  }),

  selectCard: (id) => set({ selectedCardId: id }),

  setTheme: (theme) => set({ theme, hasChanges: true }),

  markSaved: () => set({ hasChanges: false, lastSavedAt: Date.now() }),

  discardChanges: () => {
    // In future: reset to last saved state from DB
    set({ hasChanges: false })
  },

  getSortedCards: () => {
    return sortCardsBySortKey(get().cards)
  },

  getSnapshot: () => {
    const { cards, theme } = get()
    return { cards: sortCardsBySortKey(cards), theme }
  },
}))
```

Key changes:
- Import Card type from @/types/card
- addCard generates sortKey using generateAppendKey
- reorderCards uses generateMoveKey (only updates moved card)
- getSortedCards returns cards in display order
- selectedCardId for editor selection state
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit src/stores/page-store.ts`
  </verify>
  <done>Page store updated with proper Card type, reorderCards, and selection state.</done>
</task>

<task type="auto">
  <name>Task 2: Create CardsTab component</name>
  <files>src/components/editor/cards-tab.tsx</files>
  <action>
Create a CardsTab component that displays the sortable card list and add card button:

```typescript
// src/components/editor/cards-tab.tsx
"use client"

import { Plus } from "lucide-react"
import { Button } from "@/components/ui/button"
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu"
import { SortableCardList } from "@/components/canvas/sortable-card-list"
import { CanvasContainer } from "@/components/canvas/canvas-container"
import { usePageStore } from "@/stores/page-store"
import type { CardType } from "@/types/card"

const CARD_TYPES: { type: CardType; label: string }[] = [
  { type: "horizontal", label: "Horizontal Link" },
  { type: "hero", label: "Hero Card" },
  { type: "square", label: "Square Card" },
  { type: "video", label: "Video Card" },
  { type: "gallery", label: "Photo Gallery" },
  { type: "dropdown", label: "Dropdown" },
]

export function CardsTab() {
  const cards = usePageStore((state) => state.getSortedCards())
  const selectedCardId = usePageStore((state) => state.selectedCardId)
  const addCard = usePageStore((state) => state.addCard)
  const reorderCards = usePageStore((state) => state.reorderCards)
  const selectCard = usePageStore((state) => state.selectCard)

  return (
    <div className="flex flex-col h-full">
      {/* Header with add button */}
      <div className="flex items-center justify-between p-4 border-b">
        <h2 className="text-sm font-medium">Cards</h2>
        <DropdownMenu>
          <DropdownMenuTrigger asChild>
            <Button size="sm" variant="outline">
              <Plus className="h-4 w-4 mr-1" />
              Add Card
            </Button>
          </DropdownMenuTrigger>
          <DropdownMenuContent align="end">
            {CARD_TYPES.map(({ type, label }) => (
              <DropdownMenuItem
                key={type}
                onClick={() => addCard(type)}
              >
                {label}
              </DropdownMenuItem>
            ))}
          </DropdownMenuContent>
        </DropdownMenu>
      </div>

      {/* Scrollable card list */}
      <div className="flex-1 overflow-y-auto p-4">
        <CanvasContainer>
          <SortableCardList
            cards={cards}
            onReorder={reorderCards}
            selectedCardId={selectedCardId}
            onSelectCard={selectCard}
          />
        </CanvasContainer>
      </div>
    </div>
  )
}
```

This component:
- Shows sorted cards using getSortedCards
- Provides dropdown to add different card types
- Passes reorderCards to SortableCardList
- Manages card selection for future property editing
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit src/components/editor/cards-tab.tsx`
  </verify>
  <done>CardsTab with add card dropdown and sortable list.</done>
</task>

<task type="auto">
  <name>Task 3: Wire CardsTab into EditorPanel</name>
  <files>src/components/editor/editor-panel.tsx</files>
  <action>
Update EditorPanel to use the new CardsTab component instead of placeholder.

1. Import CardsTab at top:
```typescript
import { CardsTab } from "./cards-tab"
```

2. Find the TabsContent for "links" (was renamed from "cards" to "links" in 02-03) and replace its content:
```typescript
<TabsContent value="links" className="flex-1 overflow-hidden">
  <CardsTab />
</TabsContent>
```

Remove any placeholder content like "Cards coming in Phase 3" that may be there.

Keep the Design and Insights tabs as-is with their placeholder content.
  </action>
  <verify>
EditorPanel imports and renders CardsTab.
App starts without errors: `npm run dev` (check for console errors).
  </verify>
  <done>EditorPanel displays CardsTab in the Links tab.</done>
</task>

</tasks>

<verification>
1. Page store has reorderCards action
2. CardsTab displays sortable card list
3. Add card dropdown creates cards
4. Drag and drop reorders cards
5. App runs without errors
</verification>

<success_criteria>
- Page store uses proper Card type
- reorderCards only updates moved card's sortKey
- CardsTab shows add card dropdown with all types
- Cards display in sorted order
- Selection state tracks clicked card
</success_criteria>

<output>
After completion, create `.planning/phases/03-canvas-system/03-04-SUMMARY.md`
</output>
