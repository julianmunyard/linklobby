---
phase: 03-canvas-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - package-lock.json
  - src/types/card.ts
  - src/lib/ordering.ts
autonomous: true

must_haves:
  truths:
    - "dnd-kit packages are installed and importable"
    - "Card type exists with all required fields including sortKey"
    - "Fractional indexing helpers generate valid sort keys"
  artifacts:
    - path: "src/types/card.ts"
      provides: "Card, CardType, CardSize type definitions"
      exports: ["Card", "CardType", "CardSize"]
    - path: "src/lib/ordering.ts"
      provides: "Fractional indexing utility functions"
      exports: ["generateAppendKey", "generateInsertKey", "generateMoveKey", "sortCardsBySortKey"]
  key_links:
    - from: "src/lib/ordering.ts"
      to: "fractional-indexing"
      via: "import generateKeyBetween"
      pattern: "from 'fractional-indexing'"
---

<objective>
Install dnd-kit dependencies and create foundational types for the canvas system.

Purpose: Establish the type system and utility functions that all canvas components will use. This is the foundation layer that enables drag-and-drop reordering.

Output: Installed packages, Card type definition, fractional-indexing helpers
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-canvas-system/03-RESEARCH.md

# Prior phase context
@src/stores/page-store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dnd-kit and fractional-indexing packages</name>
  <files>package.json, package-lock.json</files>
  <action>
Install the required packages for drag-and-drop reordering:

```bash
npm install @dnd-kit/core @dnd-kit/sortable @dnd-kit/utilities fractional-indexing
```

These packages provide:
- @dnd-kit/core: Core drag-and-drop functionality
- @dnd-kit/sortable: Sortable list preset with vertical strategy
- @dnd-kit/utilities: CSS.Transform for smooth animations
- fractional-indexing: Efficient order persistence without renumbering

Do NOT install @dnd-kit/modifiers (not needed for basic vertical sorting).
  </action>
  <verify>
Run `npm ls @dnd-kit/core @dnd-kit/sortable @dnd-kit/utilities fractional-indexing` to confirm all packages installed.
  </verify>
  <done>All four packages listed in package.json dependencies and importable.</done>
</task>

<task type="auto">
  <name>Task 2: Create Card type definitions</name>
  <files>src/types/card.ts</files>
  <action>
Create the Card type that matches the database schema plus adds sortKey for fractional indexing.

```typescript
// src/types/card.ts
export type CardType =
  | 'hero'
  | 'horizontal'
  | 'square'
  | 'video'
  | 'gallery'
  | 'dropdown'
  | 'game'
  | 'audio'

export type CardSize = 'small' | 'medium' | 'large'

export interface Card {
  id: string
  page_id: string
  card_type: CardType
  title: string | null
  description: string | null
  url: string | null
  content: Record<string, unknown>
  size: CardSize
  sortKey: string  // fractional-indexing key for ordering
  is_visible: boolean
  created_at: string
  updated_at: string
}

// Card size configuration for Tailwind classes
export const CARD_SIZES = {
  small: {
    label: 'Small',
    height: 'h-24',      // 96px
    minHeight: 'min-h-24',
  },
  medium: {
    label: 'Medium',
    height: 'h-40',      // 160px
    minHeight: 'min-h-40',
  },
  large: {
    label: 'Large',
    height: 'h-64',      // 256px
    minHeight: 'min-h-64',
  },
} as const
```

Note: The database has position_x/position_y columns but per CONTEXT.md we're building a vertical stack, not a 2D canvas. Those columns are ignored. sortKey (stored as sort_key in DB) determines order.
  </action>
  <verify>
TypeScript compiles without errors: `npx tsc --noEmit src/types/card.ts`
  </verify>
  <done>Card, CardType, CardSize types exported and match database schema.</done>
</task>

<task type="auto">
  <name>Task 3: Create fractional-indexing helper functions</name>
  <files>src/lib/ordering.ts</files>
  <action>
Create utility functions for generating and managing sort keys using fractional-indexing.

```typescript
// src/lib/ordering.ts
import { generateKeyBetween } from 'fractional-indexing'
import type { Card } from '@/types/card'

/**
 * Sort cards by their sort key using string comparison
 */
export function sortCardsBySortKey(cards: Card[]): Card[] {
  return [...cards].sort((a, b) =>
    a.sortKey < b.sortKey ? -1 : a.sortKey > b.sortKey ? 1 : 0
  )
}

/**
 * Generate a sort key for a new card at the end of the list
 */
export function generateAppendKey(cards: Card[]): string {
  if (cards.length === 0) {
    return generateKeyBetween(null, null)
  }
  const sorted = sortCardsBySortKey(cards)
  const lastKey = sorted[sorted.length - 1].sortKey
  return generateKeyBetween(lastKey, null)
}

/**
 * Generate a sort key for inserting at a specific index
 */
export function generateInsertKey(cards: Card[], targetIndex: number): string {
  const sorted = sortCardsBySortKey(cards)
  const above = targetIndex > 0 ? sorted[targetIndex - 1].sortKey : null
  const below = targetIndex < sorted.length ? sorted[targetIndex].sortKey : null
  return generateKeyBetween(above, below)
}

/**
 * Generate a new sort key after moving a card to a new position
 * @param cards All cards (including the one being moved)
 * @param movedCardId The ID of the card being moved
 * @param newIndex The target index in the sorted list
 */
export function generateMoveKey(
  cards: Card[],
  movedCardId: string,
  newIndex: number
): string {
  // Filter out the moved card, then find neighbors at new position
  const otherCards = cards.filter((c) => c.id !== movedCardId)
  const sorted = sortCardsBySortKey(otherCards)

  const above = newIndex > 0 ? sorted[newIndex - 1]?.sortKey ?? null : null
  const below = sorted[newIndex]?.sortKey ?? null

  return generateKeyBetween(above, below)
}
```

Key insight: Fractional indexing generates string keys like "a0", "a1", "a0V" that allow infinite insertions between any two values. Only the moved card needs updating, not all cards.
  </action>
  <verify>
Create a quick test: import the functions and verify generateAppendKey returns a string.
Run `npx tsc --noEmit src/lib/ordering.ts` to verify TypeScript compiles.
  </verify>
  <done>All four helper functions exported and properly typed.</done>
</task>

</tasks>

<verification>
1. `npm ls @dnd-kit/core` shows version installed
2. `npx tsc --noEmit` passes with no errors
3. Imports work: `import { Card } from '@/types/card'`
4. Imports work: `import { generateAppendKey } from '@/lib/ordering'`
</verification>

<success_criteria>
- dnd-kit packages installed (core, sortable, utilities)
- fractional-indexing package installed
- Card type matches database schema
- CardSize enum and CARD_SIZES config exist
- Ordering helper functions work correctly
</success_criteria>

<output>
After completion, create `.planning/phases/03-canvas-system/03-01-SUMMARY.md`
</output>
