---
phase: 03-canvas-system
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260124_add_sort_key.sql
  - supabase/schema.sql
autonomous: false

must_haves:
  truths:
    - "Cards table has sort_key TEXT column"
    - "Existing cards have sort_key values assigned"
    - "sort_key column is indexed for efficient queries"
  artifacts:
    - path: "supabase/migrations/20260124_add_sort_key.sql"
      provides: "Migration to add sort_key column"
      contains: "ALTER TABLE public.cards ADD COLUMN"
    - path: "supabase/schema.sql"
      provides: "Updated schema with sort_key"
      contains: "sort_key TEXT"
  key_links:
    - from: "cards table"
      to: "sort_key column"
      via: "fractional-indexing values"
      pattern: "sort_key TEXT"
---

<objective>
Add sort_key column to cards table for fractional-indexing based ordering.

Purpose: Enable efficient card reordering without updating all cards. The sort_key column stores fractional-indexing strings that allow infinite insertions between any two values.

Output: Database migration script, updated schema documentation
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-canvas-system/03-RESEARCH.md

# Database context
@supabase/schema.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create database migration for sort_key</name>
  <files>supabase/migrations/20260124_add_sort_key.sql</files>
  <action>
Create a migration to add sort_key column and populate existing cards:

```sql
-- Migration: Add sort_key column for fractional-indexing ordering
-- Run in Supabase SQL Editor

-- 1. Add sort_key column (nullable initially for migration)
ALTER TABLE public.cards ADD COLUMN IF NOT EXISTS sort_key TEXT;

-- 2. Create index for efficient ordering queries
CREATE INDEX IF NOT EXISTS idx_cards_sort_key ON public.cards(page_id, sort_key);

-- 3. Populate existing cards with sort keys based on current sort_order
-- Uses simple incrementing keys: 'a0', 'a1', 'a2', etc.
-- This matches fractional-indexing's natural progression
UPDATE public.cards
SET sort_key = 'a' || sort_order::text
WHERE sort_key IS NULL;

-- 4. Add default for new cards (will be overwritten by application)
ALTER TABLE public.cards
ALTER COLUMN sort_key SET DEFAULT 'a0';

-- 5. Make sort_key NOT NULL after population
ALTER TABLE public.cards
ALTER COLUMN sort_key SET NOT NULL;

-- Verification query (run after migration):
-- SELECT id, title, sort_order, sort_key FROM public.cards ORDER BY sort_key;
```

Note: We keep sort_order for backwards compatibility but sort_key is now the source of truth for ordering. The application will manage sort_key values using fractional-indexing library.
  </action>
  <verify>
File exists at supabase/migrations/20260124_add_sort_key.sql with valid SQL.
  </verify>
  <done>Migration file created with sort_key column, index, and data population.</done>
</task>

<task type="auto">
  <name>Task 2: Update schema.sql documentation</name>
  <files>supabase/schema.sql</files>
  <action>
Update the master schema file to include sort_key column. Find the cards table definition and add:

```sql
sort_key TEXT NOT NULL DEFAULT 'a0',  -- fractional-indexing key for ordering
```

Add after the sort_order line. Also add a comment explaining:
- sort_key uses fractional-indexing strings (a0, a1, a0V, etc.)
- Only the moved card needs updating on reorder
- sort_order kept for backwards compatibility

Update the index section to include:
```sql
CREATE INDEX IF NOT EXISTS idx_cards_sort_key ON public.cards(page_id, sort_key);
```
  </action>
  <verify>
File contains sort_key column definition and index.
`grep "sort_key" supabase/schema.sql` returns matches.
  </verify>
  <done>schema.sql updated with sort_key column and index.</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <action>Run migration in Supabase Dashboard</action>
  <instructions>
The user needs to run the migration manually in Supabase:

1. Open Supabase Dashboard
2. Go to SQL Editor
3. Paste contents of `supabase/migrations/20260124_add_sort_key.sql`
4. Click "Run"
5. Verify with: `SELECT column_name, data_type FROM information_schema.columns WHERE table_name = 'cards' AND column_name = 'sort_key';`

Expected result: sort_key column exists with type TEXT.
  </instructions>
  <resume-signal>Type "migration complete" when done</resume-signal>
</task>

</tasks>

<verification>
1. Migration file exists with valid SQL
2. schema.sql includes sort_key column
3. Database has sort_key column (user verified)
4. Existing cards have sort_key values
</verification>

<success_criteria>
- sort_key TEXT column exists on cards table
- sort_key has NOT NULL constraint
- Index exists on (page_id, sort_key)
- schema.sql updated for documentation
</success_criteria>

<output>
After completion, create `.planning/phases/03-canvas-system/03-02-SUMMARY.md`
</output>
