---
phase: 03-canvas-system
plan: 06
type: execute
wave: 4
depends_on: ["03-03", "03-04", "03-05"]
files_modified:
  - src/components/editor/cards-tab.tsx
  - src/app/(dashboard)/preview/page.tsx
autonomous: false

must_haves:
  truths:
    - "Cards load from database on editor mount"
    - "Dragging cards reorders them visually"
    - "Preview shows cards in correct order"
    - "Save persists card order to database"
  artifacts: []
  key_links:
    - from: "src/components/editor/cards-tab.tsx"
      to: "src/hooks/use-cards.ts"
      via: "useCards hook"
      pattern: "useCards"
---

<objective>
Wire useCards hook into editor and verify the complete drag-and-drop flow works end-to-end.

Purpose: Connect all the pieces built in previous plans and verify the system works as a whole. This is the integration and verification step.

Output: Working drag-and-drop card reordering with database persistence
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-canvas-system/03-CONTEXT.md

# All prior plan summaries
@.planning/phases/03-canvas-system/03-01-SUMMARY.md
@.planning/phases/03-canvas-system/03-03-SUMMARY.md
@.planning/phases/03-canvas-system/03-04-SUMMARY.md
@.planning/phases/03-canvas-system/03-05-SUMMARY.md

# Components to wire
@src/components/editor/cards-tab.tsx
@src/hooks/use-cards.ts
@src/app/(dashboard)/preview/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire useCards into CardsTab</name>
  <files>src/components/editor/cards-tab.tsx</files>
  <action>
Update CardsTab to use the useCards hook for loading and persistence:

1. Import useCards hook
2. Show loading state while cards load
3. Show error state if loading fails
4. Wire the Add Card dropdown to actually create cards in DB
5. Keep using store for local state (reordering happens in store, save persists to DB)

```typescript
// Add these imports
import { useCards } from "@/hooks/use-cards"
import { Loader2 } from "lucide-react"

// In CardsTab component, add:
const { isLoading, error, createCard } = useCards()

// Update addCard handler to create in DB first, then add to store
const handleAddCard = async (type: CardType) => {
  try {
    const sortKey = generateAppendKey(cards)
    const newCard = await createCard({
      card_type: type,
      title: null,
      description: null,
      url: null,
      content: {},
      size: "medium",
      sortKey,
      is_visible: true,
    })
    // Add to store with DB-generated id
    usePageStore.getState().setCards([...cards, newCard])
    usePageStore.getState().selectCard(newCard.id)
  } catch (err) {
    // Error already tracked in hook
    console.error("Failed to add card:", err)
  }
}

// Show loading state
if (isLoading) {
  return (
    <div className="flex items-center justify-center h-full">
      <Loader2 className="h-6 w-6 animate-spin text-muted-foreground" />
    </div>
  )
}

// Show error state
if (error) {
  return (
    <div className="flex items-center justify-center h-full text-destructive">
      <p>Failed to load cards: {error}</p>
    </div>
  )
}
```

Import generateAppendKey from @/lib/ordering for creating new cards.
  </action>
  <verify>
Cards load from database when visiting editor.
Adding a card creates it in database.
  </verify>
  <done>CardsTab loads cards from DB and creates new cards via API.</done>
</task>

<task type="auto">
  <name>Task 2: Update preview to render cards</name>
  <files>src/app/(dashboard)/preview/page.tsx</files>
  <action>
Update the preview route to render cards from the store state it receives via postMessage:

1. The preview already receives state via postMessage (from Phase 2)
2. Add card rendering using the Card data
3. Use CanvasContainer for layout
4. Show cards in vertical stack with size styling

```typescript
// Add imports
import { CanvasContainer } from "@/components/canvas/canvas-container"
import { CARD_SIZES, type Card } from "@/types/card"

// In the PreviewPage component, render cards:
// (cards are already in pageState from postMessage)

{pageState.cards.length > 0 ? (
  <CanvasContainer>
    <div className="space-y-4">
      {pageState.cards.map((card: Card) => {
        const sizeConfig = CARD_SIZES[card.size || "medium"]
        return (
          <div
            key={card.id}
            className={cn(
              "w-full rounded-lg border bg-card p-4",
              sizeConfig.minHeight
            )}
          >
            <p className="font-medium">{card.title || "Untitled"}</p>
            <p className="text-sm text-muted-foreground capitalize">
              {card.card_type.replace("_", " ")}
            </p>
            {card.description && (
              <p className="text-sm text-muted-foreground mt-2">
                {card.description}
              </p>
            )}
          </div>
        )
      })}
    </div>
  </CanvasContainer>
) : (
  <div className="flex items-center justify-center h-full text-muted-foreground">
    <p>Add cards to see them here</p>
  </div>
)}
```

This creates a simple preview rendering. Full card rendering with themes comes in Phase 4.
  </action>
  <verify>
Preview shows cards in vertical stack.
Card order matches editor order.
  </verify>
  <done>Preview renders cards from store state.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete drag-and-drop card reordering system:
1. Cards load from database on editor mount
2. Add Card dropdown creates new cards
3. Cards display in vertical stack in both editor and preview
4. Dragging cards reorders them
5. Card order persists to database when saved
  </what-built>
  <how-to-verify>
1. Start the dev server: `npm run dev`
2. Log in and go to /editor
3. Click "Add Card" dropdown and add 3 different card types
4. Verify cards appear in both editor (left) and preview (right)
5. Drag a card up or down using the grip handle
6. Verify order changes in both editor and preview
7. Click "Save" in header
8. Refresh the page
9. Verify cards are still in the reordered position

Expected:
- Cards render in vertical stack
- Drag handle allows reordering
- Preview updates when order changes
- Order persists after refresh
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
1. useCards hook loads cards on mount
2. Add Card creates card in database
3. Drag and drop updates order
4. Preview shows cards in correct order
5. Save persists order to database
6. Refresh shows persisted order
</verification>

<success_criteria>
- Cards load from database automatically
- Add Card dropdown creates cards with correct sortKey
- Dragging reorders cards visually
- Preview reflects card order
- Order persists across page refresh
</success_criteria>

<output>
After completion, create `.planning/phases/03-canvas-system/03-06-SUMMARY.md`
</output>
