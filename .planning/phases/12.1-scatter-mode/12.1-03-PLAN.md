---
phase: 12.1-scatter-mode
plan: 03
type: execute
wave: 3
depends_on: ["12.1-01", "12.1-02"]
files_modified:
  - src/components/editor/style-controls.tsx
  - src/components/editor/preview-panel.tsx
  - src/components/canvas/selectable-flow-grid.tsx
autonomous: true

must_haves:
  truths:
    - "Artist sees a Scatter Mode toggle in Style Controls for supported themes only"
    - "Enabling scatter mode shows a sub-toggle for visitor drag"
    - "Scatter toggle is hidden for non-scatter themes (iPod, VCR, Receipt, etc.)"
    - "Preview panel renders ScatterCanvas when scatter mode is on, FlowGrid when off"
    - "Switching between scatter and flow layouts works without losing data"
    - "Selected card in scatter mode opens property editor (same as flow mode)"
  artifacts:
    - path: "src/components/editor/style-controls.tsx"
      provides: "Scatter mode toggle UI with visitor drag sub-toggle"
      contains: "scatterMode"
    - path: "src/components/editor/preview-panel.tsx"
      provides: "Conditional rendering between ScatterCanvas and FlowGrid/SelectableFlowGrid"
      contains: "ScatterCanvas"
  key_links:
    - from: "src/components/editor/style-controls.tsx"
      to: "src/stores/theme-store.ts"
      via: "setScatterMode and setVisitorDrag actions"
      pattern: "setScatterMode|setVisitorDrag"
    - from: "src/components/editor/preview-panel.tsx"
      to: "src/components/canvas/scatter-canvas.tsx"
      via: "Conditional ScatterCanvas import and render"
      pattern: "ScatterCanvas"
    - from: "src/components/editor/preview-panel.tsx"
      to: "src/stores/theme-store.ts"
      via: "scatterMode check to determine which layout to render"
      pattern: "scatterMode"
---

<objective>
Wire scatter mode into the editor UI: add scatter toggle to style controls, and switch the preview panel between flow layout and scatter canvas based on the toggle.

Purpose: This connects the scatter canvas (Plan 02) to the editor so artists can actually toggle and use scatter mode.
Output: Working scatter mode toggle in style controls, preview panel renders scatter canvas when enabled.
</objective>

<execution_context>
@/Users/julianmunyard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julianmunyard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12.1-scatter-mode/12.1-CONTEXT.md
@.planning/phases/12.1-scatter-mode/12.1-RESEARCH.md
@.planning/phases/12.1-scatter-mode/12.1-01-SUMMARY.md
@.planning/phases/12.1-scatter-mode/12.1-02-SUMMARY.md
@src/components/editor/style-controls.tsx
@src/components/editor/preview-panel.tsx
@src/components/canvas/selectable-flow-grid.tsx
@src/stores/theme-store.ts
@src/types/scatter.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add scatter mode toggle to style controls</name>
  <files>src/components/editor/style-controls.tsx</files>
  <action>
Read `src/components/editor/style-controls.tsx` first to understand the current structure.

Add a "Scatter Mode" section to StyleControls that appears ONLY when the current theme is in SCATTER_THEMES. Import `isScatterTheme` from `@/types/scatter`.

**Placement:** Add the scatter controls section near the top of the style controls, before the border radius section. It should be prominent since it's a major feature toggle.

**UI structure:**
```tsx
{isScatterTheme(themeId) && (
  <div className="space-y-3">
    {/* Scatter Mode Toggle */}
    <div className="flex items-center justify-between">
      <div>
        <Label className="text-xs font-medium text-muted-foreground">Freeform Layout</Label>
        <p className="text-[10px] text-muted-foreground/60 mt-0.5">
          Drag cards anywhere on canvas
        </p>
      </div>
      <Switch
        checked={scatterMode ?? false}
        onCheckedChange={(checked) => setScatterMode(checked)}
      />
    </div>

    {/* Visitor Drag Toggle - only visible when scatter mode is ON */}
    {scatterMode && (
      <div className="flex items-center justify-between pl-4 border-l-2 border-muted">
        <div>
          <Label className="text-xs font-medium text-muted-foreground">Visitor Drag</Label>
          <p className="text-[10px] text-muted-foreground/60 mt-0.5">
            Let visitors move cards for fun
          </p>
        </div>
        <Switch
          checked={visitorDrag ?? false}
          onCheckedChange={(checked) => setVisitorDrag(checked)}
        />
      </div>
    )}
  </div>
)}
```

**Destructure from theme store:** Add `scatterMode`, `visitorDrag`, `setScatterMode`, `setVisitorDrag` to the existing destructuring of `useThemeStore()`.

**Do NOT** modify any other style controls functionality. Keep existing border radius, shadows, sticker, texture, etc. controls exactly as they are.
  </action>
  <verify>Run `npx tsc --noEmit`. Verify style-controls.tsx imports isScatterTheme and conditionally renders scatter toggles.</verify>
  <done>Scatter mode toggle appears in style controls for the 5 supported themes. Enabling scatter reveals the visitor drag sub-toggle. Non-scatter themes show no scatter UI.</done>
</task>

<task type="auto">
  <name>Task 2: Wire ScatterCanvas into preview panel and selectable flow grid</name>
  <files>src/components/editor/preview-panel.tsx, src/components/canvas/selectable-flow-grid.tsx</files>
  <action>
**Part A: Update preview-panel.tsx**

Read `src/components/editor/preview-panel.tsx` first to understand the full component.

The preview panel currently renders an iframe that loads `/preview`. The scatter canvas needs to be wired into the preview system. There are two approaches depending on how the preview works:

**If the preview uses iframe (postMessage pattern):** The preview page itself needs to know about scatter mode. The preview iframe loads `/preview` which has its own component tree. In this case, the scatter mode state needs to be sent via postMessage along with other state.

**If the preview renders components directly (no iframe):** Import ScatterCanvas and conditionally render it.

Read the preview page at `src/app/preview/page.tsx` to understand the preview rendering approach. The preview panel sends state to the iframe via postMessage. The iframe's preview page receives state and renders components.

The key change: In the preview page's rendering logic (likely `src/app/preview/page.tsx` or the component it renders), add conditional rendering:

1. Import `ScatterCanvas` from `@/components/canvas/scatter-canvas`
2. Import `isScatterTheme` from `@/types/scatter`
3. Where the preview currently renders `FlowGrid` or `SelectableFlowGrid`, add a conditional:

```tsx
const scatterEnabled = themeStore.scatterMode && isScatterTheme(themeStore.themeId)

// In the render:
{scatterEnabled ? (
  <ScatterCanvas cards={visibleCards} />
) : (
  <SelectableFlowGrid ... /> // or FlowGrid, whatever is currently there
)}
```

Read the relevant preview files to understand exactly where this conditional goes. The scatter canvas replaces the flow grid entirely when scatter mode is active.

**Important:** The scatter canvas handles its own card selection (clicking a scatter card selects it). Make sure the selectedCardId state still flows to the editor property panel. ScatterCanvas already uses `selectCard` from page-store, which should be the same mechanism FlowGrid uses.

**Part B: Update selectable-flow-grid.tsx (if needed)**

Read `src/components/canvas/selectable-flow-grid.tsx`. If this component is what renders in the preview, ensure it does NOT render when scatter mode is active (the conditional in Part A handles this). No modifications needed to selectable-flow-grid.tsx itself unless the conditional is placed inside it.

**Part C: Ensure postMessage carries scatter state**

If the preview uses iframe + postMessage, the scatter mode state (`scatterMode`, `visitorDrag`, `themeId`) must be included in the STATE_UPDATE message sent to the iframe. Check the existing postMessage pattern in preview-panel.tsx and add `scatterMode` and `visitorDrag` to the message payload.

The preview page needs to read these values from the message and use them in the conditional rendering.

**Do NOT modify the FlowGrid or SelectableFlowGrid components themselves.** They should remain unchanged for non-scatter themes.
  </action>
  <verify>Run `npx tsc --noEmit`. Verify that when scatterMode is true and theme is in SCATTER_THEMES, the preview renders ScatterCanvas instead of FlowGrid. Verify selectedCardId from scatter canvas flows to property editor.</verify>
  <done>Preview panel conditionally renders ScatterCanvas when scatter mode is enabled for a supported theme. Flow layout continues to work for all other cases. Card selection in scatter mode opens the property editor. Scatter state is included in postMessage if preview uses iframe.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. Scatter mode toggle visible in style controls ONLY for mac-os, instagram-reels, system-settings, macintosh, word-art themes
3. Toggle is hidden for ipod-classic, vcr-menu, receipt, departures-board, etc.
4. Enabling scatter mode in style controls causes preview to render ScatterCanvas
5. Disabling scatter mode returns to FlowGrid layout
6. Visitor drag toggle appears below scatter toggle when scatter is ON
7. Selecting a card in scatter mode opens property editor
</verification>

<success_criteria>
- Artist can toggle scatter mode ON via the Freeform Layout switch in style controls
- Preview immediately switches from flow layout to scatter canvas with freeform positioning
- Cards are draggable and resizable in scatter mode
- Toggling scatter OFF returns to normal flow layout with cards in their original order
- Visitor drag toggle only appears when scatter mode is enabled
- Card selection works in scatter mode (tap card -> property editor opens)
</success_criteria>

<output>
After completion, create `.planning/phases/12.1-scatter-mode/12.1-03-SUMMARY.md`
</output>
