---
phase: 12.1-scatter-mode
plan: 04
type: execute
wave: 3
depends_on: ["12.1-01", "12.1-02"]
files_modified:
  - src/components/public/static-scatter-canvas.tsx
  - src/components/public/public-page-renderer.tsx
autonomous: true

must_haves:
  truths:
    - "Public page renders cards in exact scatter layout positions when scatter mode is enabled"
    - "Public page scatter layout is purely visual (absolute positioning from stored percentages)"
    - "Optional visitor drag allows visitors to move cards on the public page"
    - "Visitor drag positions reset on page refresh (ephemeral, never saved)"
    - "Click vs drag distinction works: tap/click follows link, hold+move drags"
    - "Public page falls back to normal layout when scatter mode is disabled"
    - "Cards stay within viewport bounds during visitor drag"
  artifacts:
    - path: "src/components/public/static-scatter-canvas.tsx"
      provides: "Public page scatter layout with optional visitor drag"
      min_lines: 80
    - path: "src/components/public/public-page-renderer.tsx"
      provides: "Conditional routing to scatter canvas for scatter themes"
      contains: "StaticScatterCanvas"
  key_links:
    - from: "src/components/public/static-scatter-canvas.tsx"
      to: "card.content.scatterLayouts"
      via: "Reads scatter positions from card content for absolute positioning"
      pattern: "scatterLayouts"
    - from: "src/components/public/public-page-renderer.tsx"
      to: "src/components/public/static-scatter-canvas.tsx"
      via: "Conditional import and render when scatter mode is enabled for theme"
      pattern: "StaticScatterCanvas"
    - from: "src/components/public/static-scatter-canvas.tsx"
      to: "@dnd-kit/core"
      via: "DndContext with MouseSensor/TouchSensor for visitor drag"
      pattern: "DndContext|useSensor"
---

<objective>
Create the public page scatter canvas that renders artist-arranged layouts, with optional visitor drag functionality.

Purpose: Public pages must render the exact layout the artist created in scatter mode. Visitor drag is a hidden delight feature that lets visitors move cards for fun.
Output: StaticScatterCanvas component and PublicPageRenderer integration for scatter themes.
</objective>

<execution_context>
@/Users/julianmunyard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julianmunyard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12.1-scatter-mode/12.1-CONTEXT.md
@.planning/phases/12.1-scatter-mode/12.1-RESEARCH.md
@.planning/phases/12.1-scatter-mode/12.1-01-SUMMARY.md
@.planning/phases/12.1-scatter-mode/12.1-02-SUMMARY.md
@src/components/public/public-page-renderer.tsx
@src/components/public/static-flow-grid.tsx
@src/types/scatter.ts
@src/types/card.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create StaticScatterCanvas for public pages</name>
  <files>src/components/public/static-scatter-canvas.tsx</files>
  <action>
Create `src/components/public/static-scatter-canvas.tsx` that renders cards in their scatter positions on public pages.

This component has TWO modes:
1. **Static mode (visitorDrag=false):** Pure CSS absolute positioning. No JavaScript interactivity needed for card placement. Server-renderable.
2. **Interactive mode (visitorDrag=true):** Client component with dnd-kit for ephemeral visitor drag.

Props:
```typescript
interface StaticScatterCanvasProps {
  cards: Card[]
  themeId: string
  visitorDrag?: boolean
}
```

**Static Rendering (core):**

For each card, read `card.content.scatterLayouts[themeId]` to get { x, y, width, height, zIndex }.

Render each card with absolute positioning using percentage values:
```tsx
<div
  key={card.id}
  className="absolute"
  style={{
    left: `${scatter.x}%`,
    top: `${scatter.y}%`,
    width: `${scatter.width}%`,
    height: `${scatter.height}%`,
    zIndex: scatter.zIndex,
  }}
>
  {/* Render card content using the same approach as static-flow-grid.tsx */}
  {/* Look at how StaticFlowGrid renders cards and follow the same pattern */}
  {/* Cards need ThemedCardWrapper, proper sizing, etc. */}
</div>
```

For cards WITHOUT a scatterLayouts entry for the current theme, fall back to a reasonable default position (stack vertically at left edge, each offset by 5% vertically).

**Container:** The scatter canvas container needs `position: relative` and should fill the width. Height should be determined by the extent of card positions (compute the maximum `y + height` across all cards, set min-height accordingly, with a minimum of 100vh).

**Visitor Drag (optional, client-side):**

When `visitorDrag` is true, this becomes a "use client" component. Use conditional `"use client"` by splitting into two components:

1. `StaticScatterCanvas` - server component for static render (no "use client")
2. `InteractiveScatterCanvas` - client component with dnd-kit drag (exported from same file, or create a separate wrapper)

The approach: Create `StaticScatterCanvas` as a server component that renders the static version. Create `VisitorDragCanvas` as a "use client" component that wraps the static render with dnd-kit interactivity.

**VisitorDragCanvas implementation:**
- Uses `@dnd-kit/core` with `DndContext`, `useDraggable` hook
- Sensors: MouseSensor with `distance: 8` (8px before drag activates - instant click follows link, slight move starts drag), TouchSensor with `delay: 250, tolerance: 5` (hold 250ms before touch drag activates, allows 5px drift)
- Ephemeral visitor positions stored in component state (`useState<Record<string, { x: number, y: number }>>({})`), NEVER saved to database
- On drag end, update visitor position by adding delta to current position
- Cards stay within container bounds (clamp positions)
- Reset on page refresh (state is ephemeral)
- No visual hint that cards are draggable (per CONTEXT.md)
- `touch-action: none` on draggable elements
- **Click vs drag distinction:** The distance: 8 activation means a simple click (no movement or < 8px movement) passes through to the card's link. Only movements >= 8px activate drag. This is the same pattern already used in the project for flow-grid drag.

**Card rendering inside scatter:** Follow the pattern from `static-flow-grid.tsx` for rendering card content. Read that file to understand how cards are rendered on public pages (ThemedCardWrapper, CardRenderer patterns, etc.). The scatter canvas must render cards identically, just with absolute positioning instead of flow layout.

**No grid overlay on public pages.** The grid is editor-only.
  </action>
  <verify>Run `npx tsc --noEmit`. Verify static-scatter-canvas.tsx renders cards with absolute positioning from percentage values. Verify visitor drag uses dnd-kit with distance: 8 activation.</verify>
  <done>StaticScatterCanvas renders cards in exact scatter positions using absolute CSS positioning with percentage values. VisitorDragCanvas adds optional dnd-kit drag with ephemeral state. Click follows links, hold+move drags. Positions reset on refresh.</done>
</task>

<task type="auto">
  <name>Task 2: Wire scatter canvas into public page renderer</name>
  <files>src/components/public/public-page-renderer.tsx</files>
  <action>
Read `src/components/public/public-page-renderer.tsx` fully to understand the complete rendering logic and all props.

**Part A: Add scatter props to PublicPageRendererProps:**

Add to the interface:
```typescript
scatterMode?: boolean       // Whether scatter layout is enabled
visitorDrag?: boolean       // Whether visitors can drag cards
```

**Part B: Add scatter canvas routing:**

For the 5 scatter-capable themes (mac-os, instagram-reels, system-settings, macintosh, word-art), add conditional rendering:

The current rendering pattern is:
- Special themes (VCR, iPod, Receipt, Macintosh, etc.) have their own layouts with early returns
- Default themes (mac-os, instagram-reels, system-settings) fall through to the StaticFlowGrid at the bottom

For scatter mode, the logic is:
- If `scatterMode` is true AND the theme is in SCATTER_THEMES, render `StaticScatterCanvas` (or `VisitorDragCanvas` if `visitorDrag` is true) INSTEAD of the normal layout
- If `scatterMode` is false, render the normal theme-specific layout

**Implementation approach:**

For themes that have their own layout components (macintosh, word-art), add the scatter check BEFORE the theme-specific layout:

```tsx
// Macintosh theme
if (themeId === 'macintosh') {
  // If scatter mode is enabled, render scatter canvas instead of Macintosh layout
  if (scatterMode) {
    return (
      <ScatterPublicLayout
        cards={cards}
        themeId={themeId}
        visitorDrag={visitorDrag}
        username={username}
        // ... profile header props
      />
    )
  }
  // Normal Macintosh layout
  return <StaticMacintoshLayout ... />
}
```

Create a helper component or inline the common scatter layout pattern that includes:
1. Profile header (StaticProfileHeader) - reuse existing
2. StaticScatterCanvas or VisitorDragCanvas based on visitorDrag prop
3. Legal footer

For the default themes (mac-os, instagram-reels, system-settings) that fall through to the bottom of the function, add the scatter check before the StaticFlowGrid:

```tsx
// At the bottom where default layout renders
if (scatterMode && isScatterTheme(themeId || '')) {
  return (
    <div className="min-h-screen">
      <StaticProfileHeader ... />
      {visitorDrag ? (
        <VisitorDragCanvas cards={cards} themeId={themeId || ''} />
      ) : (
        <StaticScatterCanvas cards={cards} themeId={themeId || ''} />
      )}
      <LegalFooter username={username} />
    </div>
  )
}

// Normal flow layout (existing code unchanged)
return (
  <div className="min-h-screen">
    <StaticProfileHeader ... />
    <StaticFlowGrid cards={cards} ... />
    <LegalFooter username={username} />
  </div>
)
```

**Part C: Pass scatter props from the dynamic route**

Read `src/app/[username]/page.tsx` to understand how PublicPageRenderer receives props. The scatter mode and visitor drag state are stored in the theme_settings JSON in the database. Add `scatterMode` and `visitorDrag` to the props passed from the dynamic route page.

Look for where `theme_settings` is parsed and props are extracted. Add:
```typescript
scatterMode: themeSettings?.scatterMode ?? false,
visitorDrag: themeSettings?.visitorDrag ?? false,
```

Import `isScatterTheme` from `@/types/scatter` for the conditional checks.
  </action>
  <verify>Run `npx tsc --noEmit`. Verify public-page-renderer.tsx conditionally renders StaticScatterCanvas for scatter themes with scatter mode enabled. Verify the [username] route passes scatterMode and visitorDrag props.</verify>
  <done>Public pages render scatter canvas when scatter mode is enabled for a scatter theme. Visitor drag is optional and ephemeral. Non-scatter themes and disabled scatter mode render normal layouts unchanged. Props flow from database through [username] route to renderer.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. Public page for a scatter theme with scatterMode=true renders cards in absolute positions
3. Public page for a scatter theme with scatterMode=false renders normal flow layout
4. Non-scatter themes (iPod, VCR, etc.) are completely unaffected
5. Visitor drag works with distance:8 activation (click follows link, move starts drag)
6. Visitor positions reset on page refresh
7. Cards stay within viewport during visitor drag
</verification>

<success_criteria>
- Public page matches editor preview layout exactly for scatter themes
- Cards positioned using percentages scale correctly across screen sizes
- Visitor drag is ephemeral (component state only, never saved)
- Click vs drag distinction: tap/click < 8px follows link, move >= 8px drags card
- Touch drag requires 250ms hold before activating (prevents scroll conflicts)
- All existing public page layouts (VCR, iPod, Receipt, etc.) work unchanged
- LegalFooter still renders on scatter pages
</success_criteria>

<output>
After completion, create `.planning/phases/12.1-scatter-mode/12.1-04-SUMMARY.md`
</output>
