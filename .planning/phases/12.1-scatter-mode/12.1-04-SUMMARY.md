---
phase: 12.1
plan: 04
subsystem: public-scatter-rendering
completed: 2026-02-11
duration: 4 minutes
tags: [scatter-mode, public-page, visitor-drag, freeform-layout]

requires:
  - 12.1-01 # Scatter types, store toggles, isScatterTheme
  - 12.1-02 # ScatterCard component patterns

provides:
  - Public page scatter layout rendering
  - Visitor drag interaction (ephemeral)
  - Click vs drag distinction

affects:
  - 12.1-05 # Will persist scatter positions to database

tech-stack:
  added: []
  patterns:
    - Ephemeral client state for visitor drag
    - Pointer events for drag handling
    - Click/drag threshold (8px)
    - Percentage-based absolute positioning

key-files:
  created:
    - src/components/public/static-scatter-canvas.tsx
  modified:
    - src/components/public/public-page-renderer.tsx
    - src/app/[username]/page.tsx

decisions:
  - title: "Visitor drag uses pointer events (not dnd-kit)"
    rationale: "Lighter weight, server-renderable when visitorDrag=false"
    impact: "Simple drag with ephemeral offsets, no resize on public pages"

  - title: "8px drag threshold for click vs drag distinction"
    rationale: "Matches ScatterCard pattern, prevents accidental drags on taps"
    impact: "Visitors can still click through to links, drag requires intentional movement"

  - title: "Scatter mode checked via isScatterTheme + scatterMode flag"
    rationale: "Only 5 themes support scatter, theme must opt-in"
    impact: "Non-scatter themes completely unaffected"
---

# Phase 12.1 Plan 04: Public Scatter Mode Summary

**One-liner:** Public pages render absolute-positioned scatter layouts with optional ephemeral visitor drag (reset on refresh)

## Objective

Create the public page scatter canvas that renders artist-arranged layouts with optional visitor drag functionality for scatter-enabled themes.

## What Was Built

### StaticScatterCanvas Component

**File:** `src/components/public/static-scatter-canvas.tsx`

A dual-mode component for rendering scatter layouts on public pages:

**Mode 1: Static (visitorDrag=false)**
- Pure CSS absolute positioning from `card.content.scatterLayouts[themeId]`
- Server-renderable (no client-side state)
- Percentage-based positioning (0-100% of canvas dimensions)
- Falls back to vertical stack for cards without scatter positions

**Mode 2: Interactive (visitorDrag=true)**
- Client component with pointer/touch drag support
- Ephemeral drag offsets stored in useState (reset on refresh)
- Click vs drag distinction: < 8px = click (follows link), >= 8px = drag
- Cards stay within container bounds
- Touch-action: none on draggable elements

**Key Features:**
- Audio card support with theme-specific variants (system-settings, mac-os, instagram-reels)
- Automatic container height calculation based on card extents
- Z-index preservation from scatter positions
- Prevents link navigation during drag (only triggers on < 8px movement)

### Public Page Integration

**Files Modified:**
- `src/components/public/public-page-renderer.tsx`
- `src/app/[username]/page.tsx`

**Changes:**
1. Added `scatterMode` and `visitorDrag` props to PublicPageRendererProps
2. Extract scatter settings from `theme_settings.scatterMode` and `theme_settings.visitorDrag`
3. Conditional rendering via `isScatterLayout = scatterMode && isScatterTheme(themeId)`
4. Scatter canvas renders for:
   - Macintosh theme (when scatter mode enabled)
   - Word Art theme (when scatter mode enabled)
   - Default themes: mac-os, instagram-reels, system-settings (when scatter mode enabled)
5. Falls back to normal layouts when scatter mode disabled
6. Profile header and legal footer still render in scatter mode

## Implementation Details

### Drag Handling Pattern

```typescript
// Track drag state
const [dragOffsets, setDragOffsets] = useState<Record<string, DragOffset>>({})
const [isDragging, setIsDragging] = useState<string | null>(null)
const [dragDistance, setDragDistance] = useState(0)

// 8px threshold: < 8px = click, >= 8px = drag
if (dragDistance < 8) {
  // Let click event propagate (follows link)
  return
}

// >= 8px: prevent click, apply drag offset
e.preventDefault()
e.stopPropagation()
```

### Scatter Position Application

```typescript
// Read scatter position from card content
const scatterLayouts = card.content.scatterLayouts || {}
const scatterPos = scatterLayouts[themeId]

// Apply percentage-based positioning
style={{
  left: `${scatterPos.x}%`,
  top: `${scatterPos.y}%`,
  width: `${scatterPos.width}%`,
  height: `${scatterPos.height}%`,
  zIndex: scatterPos.zIndex,
  transform: visitorDrag ? `translate(${offset.x}px, ${offset.y}px)` : undefined
}}
```

### Theme-Specific Routing

```typescript
// PublicPageRenderer checks scatter mode before theme layouts
const isScatterLayout = scatterMode && themeId && isScatterTheme(themeId)

// For each scatter-enabled theme:
if (themeId === 'macintosh') {
  if (isScatterLayout) {
    return <StaticScatterCanvas ... />
  }
  return <StaticMacintoshLayout ... /> // Normal layout
}
```

## Testing Performed

1. ✅ TypeScript compilation (`npx tsc --noEmit`)
2. ✅ Scatter themes (mac-os, instagram-reels, system-settings, macintosh, word-art) route to scatter canvas when enabled
3. ✅ Non-scatter themes unaffected by scatter mode flag
4. ✅ Scatter mode disabled falls back to normal flow/theme layouts
5. ✅ Profile header and legal footer render in both modes

## Decisions Made

### 1. Visitor Drag Uses Pointer Events (Not dnd-kit)

**Context:** Public pages need optional visitor drag without heavy dependencies.

**Decision:** Use native pointer/touch events instead of react-dnd-kit.

**Rationale:**
- Lighter weight (no external library)
- Server-renderable when visitorDrag=false
- Simpler implementation for ephemeral drag (no persistence)

**Tradeoffs:**
- More manual drag handling code
- No built-in grid snapping or advanced features
- Acceptable: visitor drag is a hidden delight feature, not core functionality

### 2. 8px Drag Threshold for Click vs Drag

**Context:** Mobile users need to tap cards to follow links, but also drag them for fun.

**Decision:** < 8px movement = click (follows link), >= 8px = drag.

**Rationale:**
- Matches the pattern used in ScatterCard component
- Prevents accidental drags on quick taps
- Provides clear distinction between intentional drag and click

**Tradeoffs:**
- Small threshold might trigger false drags on shaky hands
- Acceptable: 8px is enough to distinguish intent

### 3. Ephemeral Drag Offsets (Reset on Refresh)

**Context:** Visitors can drag cards on public pages, but we don't want to persist their changes.

**Decision:** Store drag offsets in component useState, never save to database.

**Rationale:**
- Visitor drag is a playful interaction, not an edit
- Avoids database writes for every public page visitor
- Artist-arranged layout is source of truth

**Tradeoffs:**
- Visitor changes lost on refresh (intentional)
- Each visitor sees the original layout

## Deviations from Plan

None - plan executed exactly as written.

## Next Phase Readiness

**Phase 12.1 Plan 05 (Scatter Persistence)** is ready to proceed:
- ✅ StaticScatterCanvas reads from `card.content.scatterLayouts[themeId]`
- ✅ Public page renderer conditionally uses scatter canvas
- ✅ Theme-specific routing in place
- ✅ Click vs drag distinction working

**What's needed for Plan 05:**
- Database sync for scatter positions
- API endpoint to save `card.content.scatterLayouts`
- Store action to trigger persistence
- Migration to add scatterLayouts to existing cards

## File Metrics

### Created Files

**src/components/public/static-scatter-canvas.tsx** (273 lines)
- StaticScatterCanvas component
- Pointer/touch drag handling
- Click vs drag distinction
- Audio card theme variant support
- Fallback to vertical layout for cards without scatter positions

### Modified Files

**src/components/public/public-page-renderer.tsx** (+154 lines, -42 lines)
- Added scatterMode and visitorDrag props
- Imported StaticScatterCanvas and isScatterTheme
- Conditional scatter rendering for Macintosh, Word Art, and default themes
- Falls back to normal layouts when scatter disabled

**src/app/[username]/page.tsx** (+4 lines)
- Extract scatterMode and visitorDrag from theme_settings
- Pass to PublicPageRenderer

## Commits

| Hash    | Message                                          | Files |
|---------|--------------------------------------------------|-------|
| 089d8d5 | feat(12.1-04): create StaticScatterCanvas       | 1     |
| df63420 | feat(12.1-04): wire scatter canvas into renderer | 2     |

## Risks & Concerns

### Low Risk

**Visitor drag performance on low-end mobile:**
- Impact: Potential jank during drag on old devices
- Mitigation: Touch-action: none reduces browser interference
- Monitoring: Test on low-end Android devices in later phases

**Click vs drag threshold edge cases:**
- Impact: Some users might trigger drag when clicking
- Mitigation: 8px is conservative, matches editor pattern
- Monitoring: User feedback will inform threshold adjustments

## Success Criteria

- [x] All tasks executed (2/2)
- [x] Each task committed individually
- [x] npx tsc --noEmit passes
- [x] Public pages with scatter mode render absolute-positioned cards
- [x] Public pages without scatter mode render normal flow layout
- [x] Non-scatter themes completely unaffected
- [x] Visitor drag works with click/drag distinction
- [x] LegalFooter still renders in scatter mode
- [x] SUMMARY.md created in plan directory
- [x] STATE.md updated (next step)
