---
phase: 12.1-scatter-mode
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/scatter.ts
  - src/stores/page-store.ts
  - src/stores/theme-store.ts
  - src/types/theme.ts
autonomous: true

must_haves:
  truths:
    - "ScatterPosition type defines x, y, width, height, zIndex as percentages"
    - "SCATTER_THEMES constant lists the 5 supported theme IDs"
    - "Theme store has scatterMode and visitorDrag boolean toggles with persistence"
    - "Page store has updateCardScatterPosition action that updates card.content.scatterLayouts[themeId]"
    - "Default scatter sizes exist per card type (hero=40%, square=25%, etc.)"
  artifacts:
    - path: "src/types/scatter.ts"
      provides: "ScatterPosition interface, SCATTER_THEMES constant, DEFAULT_SCATTER_SIZES"
      exports: ["ScatterPosition", "SCATTER_THEMES", "DEFAULT_SCATTER_SIZES", "ScatterLayouts"]
    - path: "src/stores/page-store.ts"
      provides: "updateCardScatterPosition action"
      contains: "updateCardScatterPosition"
    - path: "src/stores/theme-store.ts"
      provides: "scatterMode and visitorDrag toggles"
      contains: "scatterMode"
    - path: "src/types/theme.ts"
      provides: "ThemeState with scatterMode and visitorDrag fields"
      contains: "scatterMode"
  key_links:
    - from: "src/types/scatter.ts"
      to: "src/types/theme.ts"
      via: "ThemeId import for SCATTER_THEMES typing"
      pattern: "import.*ThemeId.*from.*theme"
    - from: "src/stores/page-store.ts"
      to: "src/types/scatter.ts"
      via: "ScatterPosition import for store action typing"
      pattern: "import.*ScatterPosition.*from.*scatter"
    - from: "src/stores/theme-store.ts"
      to: "card.content.scatterLayouts"
      via: "scatterMode toggle drives conditional rendering in later plans"
      pattern: "scatterMode.*boolean"
---

<objective>
Create the scatter mode type system, store actions, and theme toggles that form the foundation for freeform card positioning.

Purpose: All scatter mode components depend on these types and store actions. This plan establishes the data layer before any UI work.
Output: ScatterPosition types, SCATTER_THEMES constant, page-store scatter actions, theme-store scatter toggles.
</objective>

<execution_context>
@/Users/julianmunyard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julianmunyard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12.1-scatter-mode/12.1-CONTEXT.md
@.planning/phases/12.1-scatter-mode/12.1-RESEARCH.md
@src/types/theme.ts
@src/types/card.ts
@src/stores/page-store.ts
@src/stores/theme-store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create scatter types and constants</name>
  <files>src/types/scatter.ts</files>
  <action>
Create `src/types/scatter.ts` with the following exports:

1. **ScatterPosition interface:**
   ```typescript
   export interface ScatterPosition {
     x: number        // Percentage (0-100) of canvas width
     y: number        // Percentage (0-100) of canvas height
     width: number    // Percentage (0-100) of canvas width
     height: number   // Percentage (0-100) of canvas height
     zIndex: number   // Last moved = highest
   }
   ```

2. **ScatterLayouts type** (keyed by ThemeId):
   ```typescript
   export type ScatterLayouts = Partial<Record<ThemeId, ScatterPosition>>
   ```
   Import ThemeId from `@/types/theme`.

3. **SCATTER_THEMES constant** - the 5 themes that support scatter mode:
   ```typescript
   export const SCATTER_THEMES: ThemeId[] = ['mac-os', 'instagram-reels', 'system-settings', 'macintosh', 'word-art']
   ```

4. **DEFAULT_SCATTER_SIZES** - default width/height percentages by card type when scatter mode first activates for a theme. These are percentage values:
   ```typescript
   export const DEFAULT_SCATTER_SIZES: Record<string, { width: number; height: number }> = {
     hero: { width: 40, height: 30 },
     square: { width: 25, height: 25 },
     horizontal: { width: 45, height: 12 },
     link: { width: 30, height: 8 },
     text: { width: 30, height: 10 },
     video: { width: 35, height: 25 },
     gallery: { width: 35, height: 30 },
     game: { width: 30, height: 30 },
     music: { width: 35, height: 15 },
     audio: { width: 45, height: 20 },
     release: { width: 30, height: 35 },
     'email-collection': { width: 35, height: 20 },
     'social-icons': { width: 30, height: 8 },
     mini: { width: 15, height: 8 },
   }
   ```

5. **isScatterTheme helper:**
   ```typescript
   export function isScatterTheme(themeId: string): boolean {
     return SCATTER_THEMES.includes(themeId as ThemeId)
   }
   ```
  </action>
  <verify>Run `npx tsc --noEmit` to confirm no type errors. Verify the file exports all 5 items.</verify>
  <done>src/types/scatter.ts exists with ScatterPosition, ScatterLayouts, SCATTER_THEMES, DEFAULT_SCATTER_SIZES, and isScatterTheme all exported and type-correct.</done>
</task>

<task type="auto">
  <name>Task 2: Add scatter mode toggles to theme store and scatter actions to page store</name>
  <files>src/stores/theme-store.ts, src/stores/page-store.ts, src/types/theme.ts</files>
  <action>
**Part A: Update ThemeState type** (`src/types/theme.ts`)

Add two new optional fields to the `ThemeState` interface:
```typescript
scatterMode?: boolean       // Whether scatter (freeform) positioning is enabled
visitorDrag?: boolean       // Whether visitors can drag cards on public page
```

**Part B: Update theme store** (`src/stores/theme-store.ts`)

Add to state:
- `scatterMode: false` (default)
- `visitorDrag: false` (default)

Add actions:
- `setScatterMode: (enabled: boolean) => void` - toggles scatter mode. When disabling, also set `visitorDrag: false`.
- `setVisitorDrag: (enabled: boolean) => void` - toggles visitor drag (only meaningful when scatterMode is true).

These must persist to localStorage with the rest of the theme state (the store already uses `persist` middleware - just add the fields to the state).

Important: Read the theme store file first to understand its persist middleware pattern. Add the new fields alongside existing state fields and actions, following the exact same patterns (e.g., how `setCenterCards` is implemented).

**Part C: Update page store** (`src/stores/page-store.ts`)

Add a new action to the `PageState` interface:
```typescript
updateCardScatterPosition: (cardId: string, themeId: string, position: Partial<ScatterPosition>) => void
```

Implementation:
```typescript
updateCardScatterPosition: (cardId, themeId, position) => set((state) => ({
  cards: state.cards.map(card => {
    if (card.id !== cardId) return card
    const currentLayouts = (card.content as Record<string, unknown>).scatterLayouts as ScatterLayouts || {}
    const currentPosition = currentLayouts[themeId as ThemeId]
    return {
      ...card,
      content: {
        ...card.content,
        scatterLayouts: {
          ...currentLayouts,
          [themeId]: {
            ...currentPosition,
            ...position,
          }
        }
      }
    }
  }),
  hasChanges: true,
})),
```

Import `ScatterPosition` and `ScatterLayouts` from `@/types/scatter` and `ThemeId` from `@/types/theme`.

Also add a helper action for initializing scatter positions for all cards when scatter mode is first enabled for a theme:
```typescript
initializeScatterLayout: (themeId: string) => void
```

This action checks each card: if it doesn't have a scatterLayouts entry for the given themeId, it creates one with default position and size. Cards should be distributed in a staggered layout (not all at 0,0). Use a simple distribution algorithm: divide the canvas into a grid based on card count and assign each card a position. Use DEFAULT_SCATTER_SIZES for the width/height. Set zIndex to the card's index.

Import DEFAULT_SCATTER_SIZES from `@/types/scatter`.
  </action>
  <verify>Run `npx tsc --noEmit` to confirm no type errors. Verify theme store has scatterMode/visitorDrag fields and actions. Verify page store has updateCardScatterPosition and initializeScatterLayout actions.</verify>
  <done>Theme store persists scatterMode and visitorDrag toggles. Page store can update individual card scatter positions per-theme and initialize scatter layouts for all cards. All type-safe with no compilation errors.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. src/types/scatter.ts exports ScatterPosition, ScatterLayouts, SCATTER_THEMES (5 themes), DEFAULT_SCATTER_SIZES, isScatterTheme
3. Theme store has scatterMode and visitorDrag boolean fields that persist to localStorage
4. Page store has updateCardScatterPosition that updates card.content.scatterLayouts[themeId]
5. Page store has initializeScatterLayout that distributes cards with defaults
</verification>

<success_criteria>
- ScatterPosition type fully defined with x, y, width, height, zIndex (all percentage 0-100)
- SCATTER_THEMES includes exactly: mac-os, instagram-reels, system-settings, macintosh, word-art
- Theme store toggles work: setScatterMode(true) enables, setScatterMode(false) disables and clears visitorDrag
- Page store scatter actions update card.content.scatterLayouts correctly per-theme
- TypeScript compilation passes cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/12.1-scatter-mode/12.1-01-SUMMARY.md`
</output>
