---
phase: 12.1-scatter-mode
plan: 02
type: execute
wave: 2
depends_on: ["12.1-01"]
files_modified:
  - src/components/canvas/scatter-canvas.tsx
  - src/components/canvas/scatter-card.tsx
autonomous: true

must_haves:
  truths:
    - "Cards render in absolute positions using react-rnd when scatter mode is active"
    - "Artist can drag cards to any position within the canvas bounds"
    - "Artist can resize cards by dragging corners and edges"
    - "Last moved or resized card goes to front (z-index auto-increment)"
    - "Cards are constrained within the canvas container boundaries"
    - "Visual grid overlay (12x12) appears on the scatter canvas for optional alignment"
    - "Positions convert between percentages (storage) and pixels (display) correctly"
    - "touch-action: none is set on scatter elements for mobile support"
  artifacts:
    - path: "src/components/canvas/scatter-canvas.tsx"
      provides: "Scatter mode canvas container with grid overlay and percentage conversion"
      min_lines: 80
    - path: "src/components/canvas/scatter-card.tsx"
      provides: "react-rnd wrapper for individual draggable+resizable cards"
      min_lines: 60
  key_links:
    - from: "src/components/canvas/scatter-canvas.tsx"
      to: "src/stores/page-store.ts"
      via: "updateCardScatterPosition action for saving positions"
      pattern: "updateCardScatterPosition"
    - from: "src/components/canvas/scatter-canvas.tsx"
      to: "src/stores/theme-store.ts"
      via: "themeId for per-theme layout lookup"
      pattern: "useThemeStore"
    - from: "src/components/canvas/scatter-card.tsx"
      to: "react-rnd"
      via: "Rnd component import"
      pattern: "import.*Rnd.*from.*react-rnd"
    - from: "src/components/canvas/scatter-card.tsx"
      to: "src/components/cards/card-renderer.tsx"
      via: "CardRenderer for rendering card content inside rnd wrapper"
      pattern: "CardRenderer"
---

<objective>
Build the core scatter canvas and scatter card components using react-rnd. This plan creates the visual and interactive layer for freeform card positioning.

Purpose: These are the primary components that make scatter mode work - they handle drag, resize, z-index, bounds, and percentage conversion. Everything else wires into these.
Output: ScatterCanvas and ScatterCard components ready for integration into the editor preview.
</objective>

<execution_context>
@/Users/julianmunyard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julianmunyard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12.1-scatter-mode/12.1-CONTEXT.md
@.planning/phases/12.1-scatter-mode/12.1-RESEARCH.md
@.planning/phases/12.1-scatter-mode/12.1-01-SUMMARY.md
@src/types/scatter.ts
@src/stores/page-store.ts
@src/stores/theme-store.ts
@src/components/cards/card-renderer.tsx
@src/components/canvas/flow-grid.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install react-rnd and create ScatterCard component</name>
  <files>src/components/canvas/scatter-card.tsx</files>
  <action>
**Step 1: Install react-rnd**
```bash
npm install react-rnd
```

**Step 2: Create ScatterCard component** at `src/components/canvas/scatter-card.tsx`

This component wraps a single card in a react-rnd Rnd component for drag + resize.

Props:
```typescript
interface ScatterCardProps {
  card: Card
  themeId: string
  canvasWidth: number     // Pixel width of canvas container
  canvasHeight: number    // Pixel height of canvas container
  maxZIndex: number       // Current highest z-index
  isSelected: boolean     // Whether this card is selected in editor
  onDragStop: (cardId: string, x: number, y: number) => void  // Pixel position
  onResizeStop: (cardId: string, width: number, height: number, x: number, y: number) => void
  onBringToFront: (cardId: string) => void
  onSelect: (cardId: string) => void
}
```

Implementation details:

1. **Read scatter position from card.content.scatterLayouts[themeId]** to get the percentage-based stored position. Convert percentages to pixels using canvasWidth/canvasHeight.

2. **Render Rnd component** with:
   - `size={{ width: pixelWidth, height: pixelHeight }}`
   - `position={{ x: pixelX, y: pixelY }}`
   - `bounds="parent"` to constrain within canvas
   - `enableResizing` with all 8 directions enabled (top, right, bottom, left, topRight, bottomRight, bottomLeft, topLeft)
   - `style={{ touchAction: 'none', zIndex: scatter position zIndex }}`
   - `onDragStart` calls `onBringToFront(card.id)` and `onSelect(card.id)`
   - `onDragStop` calls `onDragStop(card.id, d.x, d.y)` with pixel coordinates
   - `onResizeStop` calls `onResizeStop(card.id, ref.offsetWidth, ref.offsetHeight, position.x, position.y)` with pixel dimensions and position
   - `onMouseDown` / `onTouchStart` calls `onSelect(card.id)` for selection

3. **Resize handle styling:** Custom resize handle components that show as small circles/squares on corners and edges. Visible on hover, always visible when card is selected (isSelected). Use 8px circles with a subtle border.

4. **Card content rendering:** Render `<CardRenderer card={card} />` inside the Rnd wrapper. The card content should scale to fill the rnd container. Use `className="w-full h-full overflow-hidden"` on the inner wrapper.

5. **Selection indicator:** When `isSelected`, add a blue ring/border around the card (e.g., `ring-2 ring-blue-500`).

6. **Do NOT use dnd-kit here.** Scatter mode uses react-rnd exclusively for drag/resize. dnd-kit is only for the flow layout.

7. Mark this as `"use client"` component.
  </action>
  <verify>Run `npx tsc --noEmit` to confirm no type errors. Verify react-rnd is in package.json dependencies.</verify>
  <done>ScatterCard component renders a card inside react-rnd with drag, resize, z-index, bounds, selection indicator, and custom resize handles. react-rnd installed.</done>
</task>

<task type="auto">
  <name>Task 2: Create ScatterCanvas container with grid overlay and percentage conversion</name>
  <files>src/components/canvas/scatter-canvas.tsx</files>
  <action>
Create `src/components/canvas/scatter-canvas.tsx` as the main scatter mode container.

Props:
```typescript
interface ScatterCanvasProps {
  cards: Card[]
}
```

Implementation details:

1. **Container setup:** The scatter canvas is a `position: relative` container that fills its parent. It needs a ref (`canvasRef`) to measure pixel dimensions for percentage conversion.

2. **Read state from stores:**
   - `useThemeStore()` for `themeId`
   - `usePageStore()` for `updateCardScatterPosition`, `initializeScatterLayout`, `selectCard`, `selectedCardId`

3. **Canvas measurement:** Use `useEffect` + `ResizeObserver` on canvasRef to track canvas pixel dimensions (`canvasWidth`, `canvasHeight`). Store in local state. This is critical for percentage <-> pixel conversion.

4. **Initialize scatter layout:** On mount (and when themeId changes), call `initializeScatterLayout(themeId)` to ensure all cards have scatter positions for the current theme.

5. **Z-index tracking:** Maintain local `maxZIndex` state, initialized from the highest zIndex across all cards' scatter positions for the current theme.

6. **Drag stop handler:** Convert pixel position back to percentages and call `updateCardScatterPosition`:
   ```typescript
   const handleDragStop = (cardId: string, pixelX: number, pixelY: number) => {
     const percentX = (pixelX / canvasWidth) * 100
     const percentY = (pixelY / canvasHeight) * 100
     updateCardScatterPosition(cardId, themeId, { x: percentX, y: percentY })
   }
   ```

7. **Resize stop handler:** Convert pixel dimensions back to percentages:
   ```typescript
   const handleResizeStop = (cardId: string, pixelW: number, pixelH: number, pixelX: number, pixelY: number) => {
     const percentW = (pixelW / canvasWidth) * 100
     const percentH = (pixelH / canvasHeight) * 100
     const percentX = (pixelX / canvasWidth) * 100
     const percentY = (pixelY / canvasHeight) * 100
     updateCardScatterPosition(cardId, themeId, { x: percentX, y: percentY, width: percentW, height: percentH })
   }
   ```

8. **Bring to front handler:**
   ```typescript
   const handleBringToFront = (cardId: string) => {
     const newZ = maxZIndex + 1
     updateCardScatterPosition(cardId, themeId, { zIndex: newZ })
     setMaxZIndex(newZ)
   }
   ```

9. **Grid overlay:** Render a 12x12 grid overlay on top of cards (pointer-events-none) using CSS linear-gradient:
   ```tsx
   <div className="absolute inset-0 pointer-events-none z-[999]">
     <div
       className="w-full h-full"
       style={{
         backgroundImage: `
           linear-gradient(to right, rgba(255,255,255,0.08) 1px, transparent 1px),
           linear-gradient(to bottom, rgba(255,255,255,0.08) 1px, transparent 1px)
         `,
         backgroundSize: '8.333% 8.333%',
       }}
     />
   </div>
   ```

10. **Bounds key for window resize:** Track a `boundsKey` state that increments on window resize, forcing react-rnd to recalculate bounds. Debounce the resize handler by 200ms.

11. **Render cards:** Map over `cards` (filter visible only: `cards.filter(c => c.is_visible)`), render each as `<ScatterCard>` with the current canvas dimensions and handlers.

12. **Canvas styling:** The container should have:
    - `position: relative`
    - `touch-action: none` (critical for mobile)
    - `min-height: 100%` to fill the preview panel
    - `overflow: hidden` to enforce visual bounds

13. **Card click to deselect:** Clicking the canvas background (not a card) should call `selectCard(null)`.

14. Mark as `"use client"`.
  </action>
  <verify>Run `npx tsc --noEmit` to confirm no type errors. Verify scatter-canvas.tsx renders ScatterCard components with percentage conversion and grid overlay.</verify>
  <done>ScatterCanvas renders cards with react-rnd, converts between percentage (storage) and pixel (display) positions, tracks z-index, shows 12x12 grid overlay, handles window resize for bounds recalculation, and supports mobile via touch-action: none.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. `react-rnd` appears in package.json dependencies
3. ScatterCanvas renders cards in absolute positions with a 12x12 grid overlay
4. ScatterCard wraps CardRenderer in react-rnd with drag, resize, bounds, z-index
5. Percentage <-> pixel conversion happens on every drag/resize stop
6. touch-action: none is set on canvas and card elements
7. Window resize triggers bounds recalculation
</verification>

<success_criteria>
- Cards can be dragged to any position within the canvas container
- Cards can be resized from all 8 handle directions (corners + edges)
- Cards cannot be dragged or resized beyond the canvas container bounds
- Dragging or resizing a card brings it to the front (z-index increments)
- Positions are stored as percentages via page store actions
- Grid overlay displays as subtle lines on 8.333% intervals
- Mobile touch drag works (touch-action: none prevents scroll conflicts)
</success_criteria>

<output>
After completion, create `.planning/phases/12.1-scatter-mode/12.1-02-SUMMARY.md`
</output>
