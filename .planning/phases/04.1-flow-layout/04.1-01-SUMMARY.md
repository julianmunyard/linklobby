---
phase: 04.1-flow-layout
plan: 01
subsystem: types
tags: [typescript, card-types, database-mapping, flow-layout]

# Dependency graph
requires:
  - phase: 04-basic-cards
    provides: Card interface, CardSize type, database mapping functions
provides:
  - CardSize type changed to 'big' | 'small'
  - HorizontalPosition type for small card positioning
  - CARD_TYPE_SIZING config for sizing support per card type
  - POSITION_MAP/POSITION_REVERSE for database position_x mapping
  - Legacy size value migration (large->big, small/medium->small)
affects: [04.1-02, 04.1-03, 04.1-04, flow-layout-rendering, card-property-editor]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Legacy value migration in mapDbToCard"
    - "Position mapping via position_x column (0=left, 1=center, 2=right)"

key-files:
  created: []
  modified:
    - src/types/card.ts
    - src/lib/supabase/cards.ts
    - src/stores/page-store.ts
    - src/app/api/cards/route.ts
    - src/components/canvas/sortable-card.tsx
    - src/components/editor/cards-tab.tsx

key-decisions:
  - "CardSize is 'big' | 'small' (not small/medium/large)"
  - "position field maps to existing position_x column in database"
  - "Legacy size values migrated: large->big, small/medium->small"
  - "Default size changed from 'medium' to 'big'"
  - "Default position is 'left'"

patterns-established:
  - "mapLegacySize helper for backward compatibility"
  - "CARD_TYPE_SIZING defines which card types support sizing (null = always full width)"

# Metrics
duration: 8min
completed: 2025-01-25
---

# Phase 4.1 Plan 01: Type Definitions & Database Mapping Summary

**Big/Small card sizing with horizontal position support via CardSize, HorizontalPosition types, and database position_x mapping**

## Performance

- **Duration:** ~8 min
- **Started:** 2025-01-25T12:XX:XXZ
- **Completed:** 2025-01-25T12:XX:XXZ
- **Tasks:** 2
- **Files modified:** 6

## Accomplishments
- Changed CardSize from 'small' | 'medium' | 'large' to 'big' | 'small'
- Added HorizontalPosition type for small card positioning (left/center/right)
- Added CARD_TYPE_SIZING config to define which card types support sizing
- Updated database mapping to handle position via position_x column
- Added legacy size migration for existing cards

## Task Commits

Each task was committed atomically:

1. **Task 1: Update Card Types for Flow Layout** - `1fcee05` (feat)
2. **Task 2: Update Database Mapping and Store** - `f0a937b` (feat)

## Files Created/Modified
- `src/types/card.ts` - CardSize, HorizontalPosition types, CARD_TYPE_SIZING, POSITION_MAP/REVERSE
- `src/lib/supabase/cards.ts` - mapDbToCard/mapCardToDb with position_x handling, mapLegacySize
- `src/stores/page-store.ts` - addCard with size='big', position='left' defaults
- `src/app/api/cards/route.ts` - POST handler includes position field
- `src/components/canvas/sortable-card.tsx` - Fixed minHeight for new CardSize type
- `src/components/editor/cards-tab.tsx` - Create card with size='big', position='left'

## Decisions Made
- CardSize is 'big' | 'small' (simplified from three sizes for flow layout)
- HorizontalPosition maps to existing position_x column (0=left, 1=center, 2=right)
- Legacy values mapped: 'large' -> 'big', 'small'/'medium' -> 'small'
- Cards default to size='big', position='left'
- CARD_TYPE_SIZING returns null for card types that don't support sizing (horizontal, dropdown, audio)

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Fixed TypeScript errors in dependent files**
- **Found during:** Task 2 (Database Mapping and Store)
- **Issue:** After changing CardSize type, three additional files had TypeScript errors
- **Fix:** Updated API route, sortable-card, and cards-tab to use new types
- **Files modified:** src/app/api/cards/route.ts, src/components/canvas/sortable-card.tsx, src/components/editor/cards-tab.tsx
- **Verification:** `npx tsc --noEmit` passes with no errors
- **Committed in:** f0a937b (Task 2 commit)

---

**Total deviations:** 1 auto-fixed (1 blocking)
**Impact on plan:** Auto-fix was necessary for TypeScript to compile. No scope creep.

## Issues Encountered
None - plan executed as specified with expected type cascading.

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- Card types ready for flow layout rendering (Plan 02)
- Position field available for small card horizontal positioning
- CARD_TYPE_SIZING can drive property editor UI (Plan 03)

---
*Phase: 04.1-flow-layout*
*Completed: 2025-01-25*
