---
phase: 04.1-flow-layout
plan: 03
type: execute
wave: 3
depends_on: ["04.1-02"]
files_modified:
  - src/app/preview/page.tsx
  - src/stores/page-store.ts
autonomous: false

must_haves:
  truths:
    - "Preview page uses FlowGrid instead of space-y-4 layout"
    - "Big cards take full width in preview"
    - "Small cards take half width and can be positioned"
    - "Drag-to-reorder works in flow layout"
    - "Position changes via drop zone update card position"
  artifacts:
    - path: "src/app/preview/page.tsx"
      provides: "Preview using FlowGrid with flow layout"
      contains: "FlowGrid"
    - path: "src/stores/page-store.ts"
      provides: "updateCardPosition action for position changes"
      contains: "updateCardPosition"
  key_links:
    - from: "src/app/preview/page.tsx"
      to: "src/components/canvas/flow-grid.tsx"
      via: "renders FlowGrid component"
      pattern: "import.*FlowGrid"
    - from: "src/app/preview/page.tsx"
      to: "parent editor via postMessage"
      via: "position changes sent to editor"
      pattern: "postMessage"
---

<objective>
Integrate flow layout into preview page and wire position updates.

Purpose: Connect the FlowGrid component to the preview page and establish the communication path for position changes. This completes the flow layout feature by enabling end-to-end sizing and positioning.

Output: Updated preview page using FlowGrid, position update action in store, human verification of complete flow.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04.1-flow-layout/04.1-CONTEXT.md
@.planning/phases/04.1-flow-layout/04.1-RESEARCH.md
@.planning/phases/04.1-flow-layout/04.1-01-SUMMARY.md
@.planning/phases/04.1-flow-layout/04.1-02-SUMMARY.md

# Current files
@src/app/preview/page.tsx
@src/stores/page-store.ts
@src/components/canvas/flow-grid.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate FlowGrid into Preview and Add Position Update</name>
  <files>src/app/preview/page.tsx, src/stores/page-store.ts</files>
  <action>
**1. Update src/stores/page-store.ts to add updateCardPosition action:**

Add to the interface:
```typescript
interface PageState {
  // ... existing
  updateCardPosition: (id: string, position: HorizontalPosition) => void
}
```

Add the action implementation after reorderCards:
```typescript
updateCardPosition: (id, position) => set((state) => ({
  cards: state.cards.map((c) =>
    c.id === id
      ? { ...c, position, updated_at: new Date().toISOString() }
      : c
  ),
  hasChanges: true,
})),
```

Import HorizontalPosition at the top:
```typescript
import type { Card, CardType, CardSize, HorizontalPosition } from '@/types/card'
```

**2. Update src/app/preview/page.tsx to use FlowGrid:**

Replace the current card rendering with FlowGrid. The preview is in an iframe and receives state via postMessage, so it needs to handle reorder/position changes by messaging back to the parent.

Update imports:
```typescript
import { FlowGrid } from "@/components/canvas/flow-grid"
import type { Card, HorizontalPosition } from "@/types/card"
```

Remove the CanvasContainer import if no longer needed (FlowGrid handles its own layout).

Replace the card rendering section. Find:
```tsx
<CanvasContainer>
  <div className="space-y-4">
    {state.cards.map((card) => (
      <CardRenderer key={card.id} card={card} isPreview />
    ))}
  </div>
</CanvasContainer>
```

Replace with:
```tsx
<FlowGrid
  cards={state.cards}
  onReorder={(oldIndex, newIndex) => {
    // Send reorder message to parent editor
    if (window.parent !== window) {
      window.parent.postMessage(
        { type: "REORDER_CARDS", payload: { oldIndex, newIndex } },
        window.location.origin
      )
    }
  }}
  onPositionChange={(cardId, position) => {
    // Send position change message to parent editor
    if (window.parent !== window) {
      window.parent.postMessage(
        { type: "POSITION_CHANGE", payload: { cardId, position } },
        window.location.origin
      )
    }
  }}
/>
```

Note: The preview iframe communicates with the parent via postMessage. The parent editor will need to handle these new message types. Check if the editor already handles postMessage - if so, update it. If the current architecture has the store directly in the preview, adjust accordingly.

**3. Update the parent editor to handle preview messages (if needed):**

Check src/components/editor/preview-panel.tsx or similar for postMessage handling. If found, add handlers for REORDER_CARDS and POSITION_CHANGE that call the store actions.

If the preview shares state directly with the editor (same React tree), the FlowGrid can call store actions directly instead of postMessage. Check the architecture and adjust.

**Alternative if preview uses store directly:**
If preview is not in an iframe but shares the store, update FlowGrid usage to:
```tsx
import { usePageStore } from "@/stores/page-store"

// Inside component
const reorderCards = usePageStore((state) => state.reorderCards)
const updateCardPosition = usePageStore((state) => state.updateCardPosition)

// Then
<FlowGrid
  cards={state.cards}
  onReorder={reorderCards}
  onPositionChange={updateCardPosition}
/>
```
  </action>
  <verify>
`grep "FlowGrid" src/app/preview/page.tsx` returns match.
`grep "updateCardPosition" src/stores/page-store.ts` returns match.
TypeScript compiles: `npx tsc --noEmit` shows no errors.
Dev server runs: `npm run dev` without errors.
  </verify>
  <done>Preview page uses FlowGrid, position update action added to store.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete flow layout system with Big/Small sizing and position drop zones</what-built>
  <how-to-verify>
1. Start the dev server: `npm run dev`
2. Open the dashboard at http://localhost:3000/dashboard
3. Create a Hero card - verify it shows "Big" and "Small" options in property editor
4. Create a Horizontal Link card - verify NO size selector appears
5. Create a Square card - verify it shows "Big" and "Small" options
6. Set a Square card to "Small" size - verify it takes half width in preview
7. Create another Small card - verify both appear side by side (2 per row)
8. Drag a Small card - verify left/center/right drop zones appear
9. Drop on "center" zone - verify card moves to center position
10. Drop on "right" zone - verify card moves to right position
11. Create a Big card - verify it takes full width
12. Drag to reorder cards - verify order changes work in flow layout

Expected behaviors:
- Big cards: 100% width, always left-aligned
- Small cards: ~50% width, can be left/center/right
- Two small cards fit side by side
- Position zones only appear when dragging small cards
- Drag overlay shows card preview following cursor
  </how-to-verify>
  <resume-signal>Type "approved" if flow layout works correctly, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. Preview displays cards in flow layout (flex-wrap)
3. Big cards take full width
4. Small cards take half width
5. Position drop zones appear for small cards
6. Position changes persist (left/center/right)
7. Drag-to-reorder works in flow layout
8. Horizontal cards have no size option in editor
</verification>

<success_criteria>
- FlowGrid renders in preview instead of space-y-4
- Big cards span full width
- Small cards span half width (2 fit side by side)
- Small cards can be positioned via drag drop zones
- Size selector hidden for Horizontal cards
- All existing functionality (add, delete, edit) still works
</success_criteria>

<output>
After completion, create `.planning/phases/04.1-flow-layout/04.1-03-SUMMARY.md`
</output>
