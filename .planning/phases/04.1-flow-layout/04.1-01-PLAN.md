---
phase: 04.1-flow-layout
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/card.ts
  - src/lib/supabase/cards.ts
  - src/stores/page-store.ts
autonomous: true

must_haves:
  truths:
    - "CardSize type is 'big' | 'small' (not small/medium/large)"
    - "HorizontalPosition type exists as 'left' | 'center' | 'right'"
    - "Card interface includes position field"
    - "CARD_TYPE_SIZING defines which card types support sizing"
    - "Database mapping handles position_x to/from position"
  artifacts:
    - path: "src/types/card.ts"
      provides: "CardSize, HorizontalPosition types, CARD_TYPE_SIZING config"
      contains: "export type CardSize = 'big' | 'small'"
    - path: "src/lib/supabase/cards.ts"
      provides: "Updated mapDbToCard/mapCardToDb with position"
      contains: "position: POSITION_REVERSE"
    - path: "src/stores/page-store.ts"
      provides: "Updated addCard with position default"
      contains: "position: 'left'"
  key_links:
    - from: "src/lib/supabase/cards.ts"
      to: "src/types/card.ts"
      via: "imports HorizontalPosition"
      pattern: "import.*HorizontalPosition"
    - from: "src/stores/page-store.ts"
      to: "src/types/card.ts"
      via: "uses CardSize, HorizontalPosition"
      pattern: "import.*CardSize"
---

<objective>
Update type definitions and database mapping for Big/Small sizing with horizontal positioning.

Purpose: Establish the foundation types that all flow layout components will use. This changes the size system from small/medium/large to big/small, and adds horizontal position tracking for small cards.

Output: Updated Card type, CardSize enum, HorizontalPosition type, CARD_TYPE_SIZING config, and database mapping functions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04.1-flow-layout/04.1-CONTEXT.md
@.planning/phases/04.1-flow-layout/04.1-RESEARCH.md

# Current files
@src/types/card.ts
@src/lib/supabase/cards.ts
@src/stores/page-store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Card Types for Flow Layout</name>
  <files>src/types/card.ts</files>
  <action>
Update src/types/card.ts with the new type system:

1. Change CardSize from 'small' | 'medium' | 'large' to 'big' | 'small':
```typescript
export type CardSize = 'big' | 'small'
```

2. Add HorizontalPosition type:
```typescript
export type HorizontalPosition = 'left' | 'center' | 'right'
```

3. Update Card interface to include position field:
```typescript
export interface Card {
  // ... existing fields
  size: CardSize
  position: HorizontalPosition  // NEW: horizontal position for small cards
  sortKey: string
  // ... rest
}
```

4. Replace CARD_SIZES with flow-layout config:
```typescript
export const CARD_SIZES = {
  big: {
    label: 'Big',
    description: 'Full width',
  },
  small: {
    label: 'Small',
    description: 'Half width',
  },
} as const
```

5. Add CARD_TYPE_SIZING to define which card types support sizing:
```typescript
export const CARD_TYPE_SIZING: Record<CardType, CardSize[] | null> = {
  hero: ['big', 'small'],
  square: ['big', 'small'],
  horizontal: null, // Always full width - no sizing option
  video: ['big', 'small'],
  gallery: ['big', 'small'],
  dropdown: null, // Always full width
  game: ['big', 'small'],
  audio: null, // Always full width
}
```

6. Add position mapping constants:
```typescript
export const POSITION_MAP: Record<HorizontalPosition, number> = {
  left: 0,
  center: 1,
  right: 2,
}

export const POSITION_REVERSE: Record<number, HorizontalPosition> = {
  0: 'left',
  1: 'center',
  2: 'right',
}
```

Keep existing content type definitions (HeroCardContent, etc.) unchanged.
  </action>
  <verify>
`grep "export type CardSize = 'big' | 'small'" src/types/card.ts` returns match.
`grep "export type HorizontalPosition" src/types/card.ts` returns match.
`grep "CARD_TYPE_SIZING" src/types/card.ts` returns match.
TypeScript compiles: `npx tsc --noEmit` shows no errors in card.ts.
  </verify>
  <done>Card types updated with big/small sizing, HorizontalPosition, and CARD_TYPE_SIZING config.</done>
</task>

<task type="auto">
  <name>Task 2: Update Database Mapping and Store</name>
  <files>src/lib/supabase/cards.ts, src/stores/page-store.ts</files>
  <action>
Update src/lib/supabase/cards.ts:

1. Import HorizontalPosition and position mapping:
```typescript
import type { Card, CardType, CardSize, HorizontalPosition } from "@/types/card"
import { POSITION_REVERSE, POSITION_MAP } from "@/types/card"
```

2. Update mapDbToCard to handle position (reads from position_x column):
```typescript
function mapDbToCard(row: Record<string, unknown>): Card {
  return {
    id: row.id as string,
    page_id: row.page_id as string,
    card_type: row.card_type as CardType,
    title: row.title as string | null,
    description: row.description as string | null,
    url: row.url as string | null,
    content: (row.content as Record<string, unknown>) || {},
    size: mapLegacySize(row.size as string),  // Handle legacy values
    position: POSITION_REVERSE[(row.position_x as number) ?? 0] || 'left',
    sortKey: row.sort_key as string,
    is_visible: row.is_visible as boolean,
    created_at: row.created_at as string,
    updated_at: row.updated_at as string,
  }
}

// Helper to migrate legacy size values
function mapLegacySize(size: string | null | undefined): CardSize {
  if (size === 'large') return 'big'
  if (size === 'small' || size === 'medium') return 'small'
  return 'big' // Default to big
}
```

3. Update mapCardToDb to handle position (writes to position_x column):
```typescript
function mapCardToDb(card: Partial<Card>) {
  const dbCard: Record<string, unknown> = {}
  if (card.page_id !== undefined) dbCard.page_id = card.page_id
  if (card.card_type !== undefined) dbCard.card_type = card.card_type
  if (card.title !== undefined) dbCard.title = card.title
  if (card.description !== undefined) dbCard.description = card.description
  if (card.url !== undefined) dbCard.url = card.url
  if (card.content !== undefined) dbCard.content = card.content
  if (card.size !== undefined) dbCard.size = card.size
  if (card.position !== undefined) dbCard.position_x = POSITION_MAP[card.position]
  if (card.sortKey !== undefined) dbCard.sort_key = card.sortKey
  if (card.is_visible !== undefined) dbCard.is_visible = card.is_visible
  return dbCard
}
```

Update src/stores/page-store.ts:

1. Update addCard to include default position:
```typescript
addCard: (type, size = 'big') => set((state) => {  // Changed default from 'medium' to 'big'
  const newCard: Card = {
    id: crypto.randomUUID(),
    page_id: '',
    card_type: type,
    title: null,
    description: null,
    url: null,
    content: {},
    size,
    position: 'left',  // NEW: default position
    sortKey: generateAppendKey(state.cards),
    is_visible: true,
    created_at: new Date().toISOString(),
    updated_at: new Date().toISOString(),
  }
  return {
    cards: [...state.cards, newCard],
    selectedCardId: newCard.id,
    hasChanges: true
  }
}),
```

Note: The database already has a position_x column (INTEGER DEFAULT 0), so no migration is needed. We're repurposing it for left(0)/center(1)/right(2).
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit` shows no errors.
`grep "position: POSITION_REVERSE" src/lib/supabase/cards.ts` returns match.
`grep "position_x = POSITION_MAP" src/lib/supabase/cards.ts` returns match.
`grep "position: 'left'" src/stores/page-store.ts` returns match.
  </verify>
  <done>Database mapping handles position_x column, store creates cards with default position.</done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors: `npx tsc --noEmit`
2. CardSize type is 'big' | 'small'
3. HorizontalPosition type is 'left' | 'center' | 'right'
4. CARD_TYPE_SIZING defines sizing options per card type
5. mapDbToCard reads position from position_x
6. mapCardToDb writes position to position_x
7. New cards default to size='big', position='left'
</verification>

<success_criteria>
- Card interface includes position: HorizontalPosition
- CardSize is 'big' | 'small' (legacy values mapped)
- CARD_TYPE_SIZING shows null for horizontal card
- Database mapping round-trips position correctly
- TypeScript builds cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/04.1-flow-layout/04.1-01-SUMMARY.md`
</output>
