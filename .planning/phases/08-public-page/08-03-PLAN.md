---
phase: 08-public-page
plan: 03
type: execute
wave: 2
depends_on: ["08-01", "08-02"]
files_modified:
  - src/app/[username]/page.tsx
  - src/app/[username]/layout.tsx
  - src/app/not-found.tsx
  - src/components/public/theme-injector.tsx
autonomous: true

must_haves:
  truths:
    - "Visiting linklobby.com/username renders the artist's page"
    - "Unpublished usernames return 404 page"
    - "Non-existent usernames return 404 page"
    - "404 page uses Ishmeria font"
    - "Theme colors are injected server-side"
  artifacts:
    - path: "src/app/[username]/page.tsx"
      provides: "Dynamic public page route"
      exports: ["default", "generateMetadata"]
    - path: "src/app/[username]/layout.tsx"
      provides: "Public page layout wrapper"
      exports: ["default"]
    - path: "src/app/not-found.tsx"
      provides: "Global 404 page with Ishmeria font"
      exports: ["default"]
    - path: "src/components/public/theme-injector.tsx"
      provides: "Server-side CSS variable injection"
      exports: ["ThemeInjector"]
  key_links:
    - from: "src/app/[username]/page.tsx"
      to: "src/lib/supabase/public.ts"
      via: "fetchPublicPageData call"
      pattern: "fetchPublicPageData"
    - from: "src/app/[username]/page.tsx"
      to: "src/components/public/public-page-renderer.tsx"
      via: "component import"
      pattern: "PublicPageRenderer"
---

<objective>
Create the dynamic route for public pages and the 404 page.

Purpose: This is the core public-facing route. When a visitor goes to linklobby.com/username, they see the artist's page with all cards and theme applied. Invalid/unpublished usernames show a styled 404 page.

Output: Dynamic [username] route, layout, 404 page, theme injector
</objective>

<execution_context>
@/Users/julianmunyard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julianmunyard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-public-page/08-CONTEXT.md
@.planning/phases/08-public-page/08-RESEARCH.md
@src/app/layout.tsx
@src/app/(dashboard)/editor/page.tsx
@src/lib/supabase/server.ts
@src/stores/theme-store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ThemeInjector component for server-side CSS variables</name>
  <files>src/components/public/theme-injector.tsx</files>
  <action>
Create `src/components/public/theme-injector.tsx` to inject theme CSS variables server-side:

```typescript
// src/components/public/theme-injector.tsx
import type { ThemeState } from '@/types/theme'

interface ThemeInjectorProps {
  theme: ThemeState | null
  children: React.ReactNode
}

/**
 * Server-side theme CSS variable injection
 * Prevents flash of wrong theme by injecting styles inline
 * Used for public pages where theme comes from database, not localStorage
 */
export function ThemeInjector({ theme, children }: ThemeInjectorProps) {
  // Default theme values if no theme saved
  const colors = theme?.colors ?? {
    background: 'oklch(0 0 0)',
    cardBg: 'oklch(1 0 0)',
    text: 'oklch(0 0 0)',
    accent: 'oklch(0.65 0.28 25)',
    border: 'oklch(0.85 0 0)',
    link: 'oklch(0.45 0.25 280)',
  }

  const fonts = theme?.fonts ?? {
    heading: 'var(--font-geist-sans)',
    body: 'var(--font-geist-sans)',
    headingSize: 1.1,
    bodySize: 1,
    headingWeight: 'bold',
  }

  const style = theme?.style ?? {
    borderRadius: 8,
    shadowEnabled: false,
    blurIntensity: 0,
  }

  const background = theme?.background ?? {
    type: 'solid' as const,
    value: colors.background,
  }

  // Build CSS variables
  const cssVariables: Record<string, string> = {
    // Colors
    '--theme-background': colors.background,
    '--theme-card-bg': colors.cardBg,
    '--theme-text': colors.text,
    '--theme-accent': colors.accent,
    '--theme-border': colors.border,
    '--theme-link': colors.link,
    // Fonts
    '--theme-heading-font': fonts.heading,
    '--theme-body-font': fonts.body,
    '--theme-heading-size': `${fonts.headingSize}em`,
    '--theme-body-size': `${fonts.bodySize}em`,
    '--theme-heading-weight': fonts.headingWeight || 'bold',
    // Styles
    '--theme-border-radius': `${style.borderRadius}px`,
    '--theme-blur-intensity': `${style.blurIntensity}px`,
  }

  // Background style
  let backgroundStyle: React.CSSProperties = {}
  if (background.type === 'solid') {
    backgroundStyle = { backgroundColor: background.value }
  } else if (background.type === 'image' && background.value) {
    backgroundStyle = {
      backgroundImage: `url(${background.value})`,
      backgroundSize: 'cover',
      backgroundPosition: 'center',
      backgroundAttachment: 'fixed',
    }
  }
  // Video backgrounds handled separately in layout

  return (
    <div
      className="min-h-screen"
      style={{
        ...cssVariables as React.CSSProperties,
        ...backgroundStyle,
        color: 'var(--theme-text)',
      }}
      data-theme={theme?.themeId ?? 'instagram-reels'}
    >
      {children}
    </div>
  )
}
```

This component:
- Injects CSS variables inline for SSR (no flash)
- Handles solid and image backgrounds
- Sets data-theme attribute for theme-specific styling
- Falls back to defaults if no theme saved
  </action>
  <verify>
Run `npx tsc --noEmit src/components/public/theme-injector.tsx`
  </verify>
  <done>ThemeInjector injects CSS variables server-side to prevent theme flash</done>
</task>

<task type="auto">
  <name>Task 2: Create public page route and layout</name>
  <files>src/app/[username]/page.tsx, src/app/[username]/layout.tsx</files>
  <action>
Create the [username] directory and files:

First, `src/app/[username]/layout.tsx`:

```typescript
// src/app/[username]/layout.tsx
import type { Metadata } from 'next'

interface LayoutProps {
  children: React.ReactNode
}

export default function PublicPageLayout({ children }: LayoutProps) {
  return <>{children}</>
}
```

Then, `src/app/[username]/page.tsx`:

```typescript
// src/app/[username]/page.tsx
import { notFound } from 'next/navigation'
import { fetchPublicPageData } from '@/lib/supabase/public'
import { PublicPageRenderer } from '@/components/public/public-page-renderer'
import { ThemeInjector } from '@/components/public/theme-injector'
import type { Metadata, ResolvingMetadata } from 'next'

interface PageProps {
  params: Promise<{ username: string }>
}

/**
 * Generate dynamic metadata for SEO
 */
export async function generateMetadata(
  { params }: PageProps,
  parent: ResolvingMetadata
): Promise<Metadata> {
  const { username } = await params
  const data = await fetchPublicPageData(username)

  if (!data) {
    return {
      title: 'Page Not Found | LinkLobby',
    }
  }

  const displayName = data.profile.display_name || username

  return {
    title: `${displayName} | LinkLobby`,
    description: `${displayName} links`,
  }
}

/**
 * Public profile page
 * Server-rendered for instant load, no loading skeleton
 */
export default async function PublicPage({ params }: PageProps) {
  const { username } = await params
  const data = await fetchPublicPageData(username)

  // 404 for non-existent or unpublished pages
  if (!data) {
    notFound()
  }

  // Get social icon size from theme or default to 24
  const socialIconSize = 24 // Could be stored in theme_settings if needed

  return (
    <ThemeInjector theme={data.page.theme_settings}>
      <PublicPageRenderer data={data} socialIconSize={socialIconSize} />
    </ThemeInjector>
  )
}
```

Key points:
- Uses `async/await` with `params` per Next.js 16 pattern
- Calls `notFound()` which triggers `not-found.tsx`
- SSR only - no loading states, instant render
- Theme injected server-side
- Metadata generated for SEO
  </action>
  <verify>
Run `npx tsc --noEmit src/app/[username]/page.tsx`
Confirm route structure: `ls -la src/app/[username]/`
  </verify>
  <done>Public page route fetches data, handles 404, renders with theme</done>
</task>

<task type="auto">
  <name>Task 3: Create global 404 page with Ishmeria font</name>
  <files>src/app/not-found.tsx</files>
  <action>
Create `src/app/not-found.tsx` - the global 404 page per CONTEXT.md requirement:

```typescript
// src/app/not-found.tsx
import Link from 'next/link'

/**
 * Global 404 page
 * Uses Ishmeria font per CONTEXT.md decision
 */
export default function NotFound() {
  return (
    <div className="min-h-screen flex flex-col items-center justify-center bg-background text-foreground">
      <h1
        className="text-6xl md:text-8xl font-bold mb-4"
        style={{ fontFamily: 'var(--font-ishmeria)' }}
      >
        404
      </h1>
      <p
        className="text-xl md:text-2xl mb-8 text-muted-foreground"
        style={{ fontFamily: 'var(--font-ishmeria)' }}
      >
        This page doesn't exist
      </p>
      <Link
        href="/"
        className="px-6 py-3 bg-primary text-primary-foreground rounded-lg hover:opacity-90 transition-opacity"
      >
        Go Home
      </Link>
    </div>
  )
}
```

The 404 page:
- Uses Ishmeria font (var(--font-ishmeria)) for retro aesthetic per CONTEXT.md
- Minimal design - just the essentials
- Dark background with foreground colors (inherits from app)
- Link back to home
  </action>
  <verify>
Run `npx tsc --noEmit src/app/not-found.tsx`
Confirm Ishmeria font used: `grep "ishmeria" src/app/not-found.tsx`
  </verify>
  <done>404 page displays with Ishmeria font and minimal design</done>
</task>

</tasks>

<verification>
1. Route created: `ls src/app/[username]/`
2. 404 page created: `ls src/app/not-found.tsx`
3. TypeScript compiles: `npx tsc --noEmit`
4. Ishmeria font used: `grep -l "ishmeria" src/app/not-found.tsx`
5. ThemeInjector created: `ls src/components/public/theme-injector.tsx`
</verification>

<success_criteria>
- `src/app/[username]/page.tsx` exists and calls fetchPublicPageData
- Invalid/unpublished usernames trigger notFound()
- ThemeInjector injects CSS variables server-side
- 404 page uses Ishmeria font
- Metadata generated dynamically for SEO
- All files compile without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/08-public-page/08-03-SUMMARY.md`
</output>
