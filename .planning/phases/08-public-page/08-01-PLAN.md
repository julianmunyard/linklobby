---
phase: 08-public-page
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260203_add_is_published.sql
  - src/lib/supabase/public.ts
  - src/types/page.ts
autonomous: true

must_haves:
  truths:
    - "Database has is_published column on pages table"
    - "Server-side query can fetch profile + page + cards + theme in single request"
    - "Unpublished pages return null/empty from fetch function"
  artifacts:
    - path: "supabase/migrations/20260203_add_is_published.sql"
      provides: "is_published column migration"
      contains: "is_published"
    - path: "src/lib/supabase/public.ts"
      provides: "Public page data fetching"
      exports: ["fetchPublicPageData"]
    - path: "src/types/page.ts"
      provides: "Page type definition"
      exports: ["Page", "PublicPageData"]
  key_links:
    - from: "src/lib/supabase/public.ts"
      to: "supabase profiles/pages/cards tables"
      via: "join query with is_published filter"
      pattern: "is_published.*true"
---

<objective>
Create the database migration and data fetching infrastructure for public pages.

Purpose: The public page needs to fetch profile, cards, and theme data efficiently in a single request. The is_published column controls page visibility.

Output: Migration SQL file, public data fetch helper, page type definitions
</objective>

<execution_context>
@/Users/julianmunyard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julianmunyard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-public-page/08-CONTEXT.md
@.planning/phases/08-public-page/08-RESEARCH.md
@src/lib/supabase/server.ts
@src/types/card.ts
@src/types/profile.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create database migration for is_published</name>
  <files>supabase/migrations/20260203_add_is_published.sql</files>
  <action>
Create SQL migration to add is_published column to pages table:

```sql
-- Add is_published column to pages table
-- Default to false for existing pages (artists must explicitly publish)
ALTER TABLE pages ADD COLUMN IF NOT EXISTS is_published BOOLEAN DEFAULT false NOT NULL;

-- Add index for efficient filtering of published pages (used in sitemap, public queries)
CREATE INDEX IF NOT EXISTS idx_pages_is_published ON pages(is_published) WHERE is_published = true;
```

Default is `false` so existing pages aren't accidentally exposed until artists choose to publish.
  </action>
  <verify>
Run `cat supabase/migrations/20260203_add_is_published.sql` to confirm file exists with correct SQL.
  </verify>
  <done>Migration file exists with ALTER TABLE statement adding is_published BOOLEAN column with partial index</done>
</task>

<task type="auto">
  <name>Task 2: Create Page type and PublicPageData interface</name>
  <files>src/types/page.ts</files>
  <action>
Create new file `src/types/page.ts` with type definitions:

```typescript
// src/types/page.ts
import type { Card } from './card'
import type { Profile } from './profile'
import type { ThemeState } from './theme'

/**
 * Page record from database
 */
export interface Page {
  id: string
  user_id: string
  is_published: boolean
  theme_settings: ThemeState | null  // Stored theme configuration
  created_at: string
  updated_at: string
}

/**
 * Complete data bundle for rendering a public page
 * Fetched in single query via join
 */
export interface PublicPageData {
  profile: {
    username: string
    display_name: string | null
    bio: string | null
    avatar_url: string | null
    avatar_feather: number
    show_avatar: boolean
    show_title: boolean
    title_size: 'small' | 'large'
    show_logo: boolean
    logo_url: string | null
    logo_scale: number
    profile_layout: 'classic' | 'hero'
    show_social_icons: boolean
    social_icons: string | null  // JSON string from DB
    header_text_color: string | null
  }
  page: Page
  cards: Card[]
}
```

Use snake_case for database fields, matching Supabase column names directly.
  </action>
  <verify>
Run `npx tsc --noEmit src/types/page.ts` to verify types compile without errors.
  </verify>
  <done>Page and PublicPageData types exist with correct field definitions</done>
</task>

<task type="auto">
  <name>Task 3: Create fetchPublicPageData helper</name>
  <files>src/lib/supabase/public.ts</files>
  <action>
Create server-side helper to fetch all public page data in one query:

```typescript
// src/lib/supabase/public.ts
import { createClient } from './server'
import type { PublicPageData } from '@/types/page'
import type { Card, HorizontalPosition, POSITION_REVERSE } from '@/types/card'

/**
 * Fetch complete page data for public viewing
 * Returns null if username doesn't exist or page is unpublished
 *
 * Uses Supabase join to fetch profile + page + cards in single request
 * Avoids waterfall fetching for fast SSR
 */
export async function fetchPublicPageData(username: string): Promise<PublicPageData | null> {
  const supabase = await createClient()

  // Single query: profiles -> pages -> cards
  const { data, error } = await supabase
    .from('profiles')
    .select(`
      username,
      display_name,
      bio,
      avatar_url,
      avatar_feather,
      show_avatar,
      show_title,
      title_size,
      show_logo,
      logo_url,
      logo_scale,
      profile_layout,
      show_social_icons,
      social_icons,
      header_text_color,
      pages!inner (
        id,
        user_id,
        is_published,
        theme_settings,
        created_at,
        updated_at,
        cards (
          id,
          page_id,
          card_type,
          title,
          description,
          url,
          content,
          size,
          position_x,
          sort_key,
          is_visible,
          created_at,
          updated_at
        )
      )
    `)
    .eq('username', username.toLowerCase())
    .single()

  // 404 conditions: no profile, no page, or unpublished
  if (error || !data) return null

  const page = Array.isArray(data.pages) ? data.pages[0] : data.pages
  if (!page || !page.is_published) return null

  // Map database cards to Card type (position_x -> position, sort_key -> sortKey)
  const cards: Card[] = (page.cards || []).map((dbCard: Record<string, unknown>) => ({
    id: dbCard.id as string,
    page_id: dbCard.page_id as string,
    card_type: dbCard.card_type as Card['card_type'],
    title: dbCard.title as string | null,
    description: dbCard.description as string | null,
    url: dbCard.url as string | null,
    content: (dbCard.content as Record<string, unknown>) || {},
    size: (dbCard.size as Card['size']) || 'big',
    position: mapPositionFromDb(dbCard.position_x as number | null),
    sortKey: (dbCard.sort_key as string) || 'a0',
    is_visible: dbCard.is_visible as boolean ?? true,
    created_at: dbCard.created_at as string,
    updated_at: dbCard.updated_at as string,
  }))

  return {
    profile: {
      username: data.username,
      display_name: data.display_name,
      bio: data.bio,
      avatar_url: data.avatar_url,
      avatar_feather: data.avatar_feather ?? 0,
      show_avatar: data.show_avatar ?? true,
      show_title: data.show_title ?? true,
      title_size: data.title_size ?? 'large',
      show_logo: data.show_logo ?? false,
      logo_url: data.logo_url,
      logo_scale: data.logo_scale ?? 100,
      profile_layout: data.profile_layout ?? 'classic',
      show_social_icons: data.show_social_icons ?? true,
      social_icons: data.social_icons,
      header_text_color: data.header_text_color,
    },
    page: {
      id: page.id,
      user_id: page.user_id,
      is_published: page.is_published,
      theme_settings: page.theme_settings,
      created_at: page.created_at,
      updated_at: page.updated_at,
    },
    cards,
  }
}

/**
 * Map position_x database value to HorizontalPosition
 */
function mapPositionFromDb(positionX: number | null): HorizontalPosition {
  const POSITION_REVERSE: Record<number, HorizontalPosition> = {
    0: 'left',
    1: 'center',
    2: 'right',
  }
  return POSITION_REVERSE[positionX ?? 0] ?? 'left'
}

type HorizontalPosition = 'left' | 'center' | 'right'
```

Key points:
- Uses `!inner` join to require pages table relationship
- Filters by lowercase username for case-insensitive matching
- Returns null for unpublished pages (triggers 404 in page.tsx)
- Maps snake_case DB fields to camelCase Card type
  </action>
  <verify>
Run `npx tsc --noEmit src/lib/supabase/public.ts` to verify types compile.
Confirm fetchPublicPageData is exported: `grep "export async function fetchPublicPageData" src/lib/supabase/public.ts`
  </verify>
  <done>fetchPublicPageData function exists, compiles, and handles all 404 edge cases</done>
</task>

</tasks>

<verification>
1. Migration file exists: `ls supabase/migrations/20260203_add_is_published.sql`
2. Types compile: `npx tsc --noEmit`
3. Export check: `grep -l "fetchPublicPageData" src/lib/supabase/public.ts`
</verification>

<success_criteria>
- Migration SQL file created with is_published BOOLEAN column and partial index
- Page and PublicPageData types defined with all required fields
- fetchPublicPageData helper fetches profile + page + cards in single query
- Returns null for unpublished or non-existent pages
- All files compile without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/08-public-page/08-01-SUMMARY.md`
</output>
