---
phase: 04-basic-cards
plan: 04
type: execute
wave: 3
depends_on: ["04-02", "04-03"]
files_modified:
  - src/components/editor/editor-panel.tsx
  - src/components/editor/cards-tab.tsx
  - src/app/preview/page.tsx
autonomous: false

must_haves:
  truths:
    - "Preview renders cards using CardRenderer components"
    - "Selecting a card in editor opens property editor"
    - "Property editor changes appear in preview in real-time"
    - "All three card types render correctly in preview"
  artifacts:
    - path: "src/components/editor/editor-panel.tsx"
      provides: "Integrated editor with property panel"
      contains: "CardPropertyEditor"
    - path: "src/app/preview/page.tsx"
      provides: "Preview using CardRenderer"
      contains: "CardRenderer"
  key_links:
    - from: "src/app/preview/page.tsx"
      to: "src/components/cards/card-renderer.tsx"
      via: "CardRenderer import"
      pattern: "import.*CardRenderer"
    - from: "src/components/editor/editor-panel.tsx"
      to: "src/components/editor/card-property-editor.tsx"
      via: "CardPropertyEditor import"
      pattern: "import.*CardPropertyEditor"
---

<objective>
Wire the card components and property editor into the editor and preview system.

Purpose: Complete the integration so that:
1. Preview renders cards with their actual components (not placeholders)
2. Selecting a card opens the property editor in the sidebar
3. Changes flow from editor -> store -> preview in real-time

Output:
- Updated preview page using CardRenderer
- Editor panel showing CardPropertyEditor when card selected
- End-to-end flow verification with human confirmation
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-basic-cards/04-RESEARCH.md

# From Plan 02
@src/components/cards/card-renderer.tsx

# From Plan 03
@src/components/editor/card-property-editor.tsx

# Existing files to update
@src/components/editor/editor-panel.tsx
@src/components/editor/cards-tab.tsx
@src/app/preview/page.tsx
@src/stores/page-store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Preview to Use CardRenderer</name>
  <files>src/app/preview/page.tsx</files>
  <action>
Update the preview page to render cards using CardRenderer instead of the placeholder divs.

Replace the card rendering section in the preview page:

```typescript
// src/app/preview/page.tsx
"use client"

import { useEffect, useState } from "react"
import { CanvasContainer } from "@/components/canvas/canvas-container"
import { CardRenderer } from "@/components/cards/card-renderer"
import type { Card } from "@/types/card"

interface Theme {
  id: string
  name: string
}

interface PageState {
  cards: Card[]
  theme: Theme
}

interface StateUpdateMessage {
  type: "STATE_UPDATE"
  payload: PageState
}

type PreviewMessage = StateUpdateMessage

const defaultState: PageState = {
  cards: [],
  theme: { id: "default", name: "Default" },
}

export default function PreviewPage() {
  const [state, setState] = useState<PageState>(defaultState)
  const [isReady, setIsReady] = useState(false)

  useEffect(() => {
    // Handle incoming messages from parent editor
    const handleMessage = (event: MessageEvent<PreviewMessage>) => {
      // Security: only accept messages from same origin
      if (event.origin !== window.location.origin) {
        return
      }

      if (event.data?.type === "STATE_UPDATE") {
        setState(event.data.payload)
      }
    }

    window.addEventListener("message", handleMessage)

    // Notify parent that preview is ready to receive state
    if (window.parent !== window) {
      window.parent.postMessage(
        { type: "PREVIEW_READY" },
        window.location.origin
      )
    }
    setIsReady(true)

    return () => {
      window.removeEventListener("message", handleMessage)
    }
  }, [])

  const hasCards = state.cards.length > 0

  return (
    <div className="min-h-screen bg-background p-4">
      {/* Debug info - theme name */}
      <div className="fixed bottom-2 right-2 text-xs text-muted-foreground bg-muted px-2 py-1 rounded">
        Theme: {state.theme.name}
      </div>

      {!hasCards ? (
        // Empty state when no cards
        <div className="flex flex-col items-center justify-center min-h-[80vh] text-center">
          <div className="rounded-full bg-muted p-6 mb-4">
            <svg
              className="h-12 w-12 text-muted-foreground"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                strokeWidth={1.5}
                d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"
              />
            </svg>
          </div>
          <h2 className="text-lg font-semibold mb-2">Your page is empty</h2>
          <p className="text-muted-foreground text-sm max-w-[300px]">
            Add cards in the editor to build your link-in-bio page. Changes will appear here in real-time.
          </p>
        </div>
      ) : (
        // Card rendering using CardRenderer
        <CanvasContainer>
          <div className="space-y-4">
            {state.cards.map((card) => (
              <CardRenderer key={card.id} card={card} isPreview />
            ))}
          </div>
        </CanvasContainer>
      )}
    </div>
  )
}
```

Key changes:
- Import CardRenderer from components/cards/card-renderer
- Replace placeholder divs with `<CardRenderer card={card} isPreview />`
- Use proper Card type instead of PreviewCard interface
  </action>
  <verify>
`npx tsc --noEmit` - preview page compiles
`npm run build` - build passes
  </verify>
  <done>Preview renders cards using CardRenderer components with proper styling</done>
</task>

<task type="auto">
  <name>Task 2: Integrate CardPropertyEditor into Editor Panel</name>
  <files>src/components/editor/editor-panel.tsx</files>
  <action>
Update the editor panel to show CardPropertyEditor when a card is selected, replacing or sliding over the cards tab.

```typescript
// src/components/editor/editor-panel.tsx
"use client"

import { Link2, Palette } from "lucide-react"

import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs"
import { cn } from "@/lib/utils"
import { CardsTab } from "./cards-tab"
import { CardPropertyEditor } from "./card-property-editor"
import { usePageStore } from "@/stores/page-store"

interface EmptyStateProps {
  icon: React.ReactNode
  title: string
  description: string
}

function EmptyState({ icon, title, description }: EmptyStateProps) {
  return (
    <div className="flex h-full flex-col items-center justify-center gap-4 p-8 text-center">
      <div className="rounded-full bg-muted p-4">
        {icon}
      </div>
      <div className="space-y-2">
        <h3 className="font-semibold text-lg">{title}</h3>
        <p className="text-muted-foreground text-sm max-w-[280px]">
          {description}
        </p>
      </div>
    </div>
  )
}

export function EditorPanel() {
  const selectedCardId = usePageStore((state) => state.selectedCardId)
  const cards = usePageStore((state) => state.cards)
  const selectCard = usePageStore((state) => state.selectCard)

  // Find the selected card
  const selectedCard = selectedCardId
    ? cards.find((c) => c.id === selectedCardId)
    : null

  return (
    <div className="flex h-full flex-col">
      {selectedCard ? (
        // Show property editor when card is selected
        <CardPropertyEditor
          card={selectedCard}
          onClose={() => selectCard(null)}
        />
      ) : (
        // Show tabs when no card selected
        <Tabs defaultValue="links" className="flex h-full flex-col">
          <div className="border-b px-4 py-2">
            <TabsList className="w-full">
              <TabsTrigger value="links" className="flex-1 gap-2">
                <Link2 className="h-4 w-4" />
                <span className="hidden sm:inline">Links</span>
              </TabsTrigger>
              <TabsTrigger value="design" className="flex-1 gap-2">
                <Palette className="h-4 w-4" />
                <span className="hidden sm:inline">Design</span>
              </TabsTrigger>
            </TabsList>
          </div>

          <TabsContent
            value="links"
            className={cn(
              "flex-1 overflow-hidden",
              "data-[state=inactive]:hidden"
            )}
          >
            <CardsTab />
          </TabsContent>

          <TabsContent
            value="design"
            className={cn(
              "h-full overflow-auto",
              "data-[state=inactive]:hidden"
            )}
          >
            <EmptyState
              icon={<Palette className="h-8 w-8 text-muted-foreground" />}
              title="Customize your design"
              description="Choose colors, fonts, and backgrounds to match your brand and style."
            />
          </TabsContent>
        </Tabs>
      )}
    </div>
  )
}
```

Key changes:
- Import CardPropertyEditor and usePageStore
- Get selectedCardId and find selected card
- Show CardPropertyEditor when card selected, tabs otherwise
- Pass onClose to clear selection
  </action>
  <verify>
`npx tsc --noEmit` - editor panel compiles
  </verify>
  <done>Editor panel shows CardPropertyEditor when a card is selected</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete card editing flow:
1. Three card render components (Hero, Horizontal, Square)
2. Property editor with forms for each card type
3. Image upload to Supabase Storage
4. Real-time preview updates
  </what-built>
  <how-to-verify>
**Prerequisites:**
1. Create 'card-images' bucket in Supabase:
   - Go to Supabase Dashboard -> Storage
   - Click "New bucket"
   - Name: `card-images`
   - Check "Public bucket"
   - Create bucket
2. Add RLS policies for the bucket:
   - Go to bucket -> Policies
   - Add policy: INSERT for authenticated users
   - Add policy: SELECT for all (public)

**Test Steps:**
1. Run `npm run dev` and go to http://localhost:3000
2. Log in and navigate to the editor
3. Add each card type (Hero, Horizontal, Square) via "Add Card" dropdown
4. Verify each card renders differently in the preview:
   - Hero: Large with gradient overlay
   - Horizontal: Wide bar with chevron
   - Square: Tile with image placeholder
5. Click a card to select it - property editor should appear
6. Add a title - verify it appears in preview immediately
7. Upload an image - verify it appears in the card
8. Add a URL - verify the card becomes clickable
9. Test Hero-specific fields (button text, style)
10. Test Square-specific field (show title toggle)
11. Click X to close editor - should return to cards list
12. Save changes and verify they persist after page reload
  </how-to-verify>
  <resume-signal>Type "approved" if all tests pass, or describe issues found</resume-signal>
</task>

</tasks>

<verification>
1. `npm run build` succeeds
2. Preview page imports and uses CardRenderer
3. Editor panel conditionally shows CardPropertyEditor
4. All three card types render with distinct appearances
5. Property editor opens when card selected
6. Form changes appear in preview in real-time
</verification>

<success_criteria>
- Hero Card renders with image background, title, description, and styled button
- Horizontal Link renders with thumbnail, title, and chevron
- Square Card renders with image and optional title overlay
- Clicking card in editor opens property editor
- Title/description/URL changes appear immediately in preview
- Image upload works and shows in card
- Changes persist to database via existing save flow
</success_criteria>

<output>
After completion, create `.planning/phases/04-basic-cards/04-04-SUMMARY.md`
</output>
