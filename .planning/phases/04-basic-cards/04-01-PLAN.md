---
phase: 04-basic-cards
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/card.ts
  - src/lib/supabase/storage.ts
  - src/components/cards/image-upload.tsx
autonomous: true
user_setup:
  - service: supabase-storage
    why: "Image uploads for card content"
    dashboard_config:
      - task: "Create 'card-images' bucket"
        location: "Supabase Dashboard -> Storage -> New Bucket"
        settings: "Public bucket, no file size limit (we validate client-side)"
      - task: "Add RLS policy for authenticated uploads"
        location: "Supabase Dashboard -> Storage -> card-images -> Policies"
        settings: "INSERT for authenticated users, SELECT for all (public)"

must_haves:
  truths:
    - "Card content types are defined for hero, horizontal, square"
    - "Images can be uploaded to Supabase Storage"
    - "ImageUpload component handles file selection and preview"
  artifacts:
    - path: "src/types/card.ts"
      provides: "HeroCardContent, HorizontalLinkContent, SquareCardContent types"
      contains: "export interface HeroCardContent"
    - path: "src/lib/supabase/storage.ts"
      provides: "uploadCardImage function"
      exports: ["uploadCardImage"]
    - path: "src/components/cards/image-upload.tsx"
      provides: "ImageUpload component"
      exports: ["ImageUpload"]
  key_links:
    - from: "src/components/cards/image-upload.tsx"
      to: "src/lib/supabase/storage.ts"
      via: "uploadCardImage import"
      pattern: "import.*uploadCardImage.*from.*storage"
---

<objective>
Create the foundational infrastructure for Phase 4: card content types and image upload capability.

Purpose: Cards need structured content (imageUrl, buttonText, etc.) and the ability to upload images to Supabase Storage. This plan establishes types and upload infrastructure that all card components will use.

Output:
- Extended card types with content schemas per card type
- Supabase Storage upload helper function
- Reusable ImageUpload component with preview and validation
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-basic-cards/04-RESEARCH.md

# Existing files to extend
@src/types/card.ts
@src/lib/supabase/client.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend Card Types with Content Schemas</name>
  <files>src/types/card.ts</files>
  <action>
Extend the existing Card types file to add content interfaces for each basic card type.

Add these interfaces AFTER the existing Card interface:

```typescript
// Content schemas for each card type
export interface HeroCardContent {
  imageUrl?: string
  imageAlt?: string
  buttonText?: string
  buttonStyle?: "primary" | "secondary" | "outline"
}

export interface HorizontalLinkContent {
  imageUrl?: string
  imageAlt?: string
  iconName?: string  // Lucide icon name as alternative to image
}

export interface SquareCardContent {
  imageUrl?: string
  imageAlt?: string
  showTitle?: boolean  // Whether to show title overlay (default true)
}

// Union type for all card content
export type CardContent = HeroCardContent | HorizontalLinkContent | SquareCardContent | Record<string, unknown>

// Helper type guards
export function isHeroContent(content: unknown): content is HeroCardContent {
  return typeof content === 'object' && content !== null
}

export function isHorizontalContent(content: unknown): content is HorizontalLinkContent {
  return typeof content === 'object' && content !== null
}

export function isSquareContent(content: unknown): content is SquareCardContent {
  return typeof content === 'object' && content !== null
}
```

Keep all existing types (CardType, CardSize, Card, CARD_SIZES) unchanged.
  </action>
  <verify>Run `npx tsc --noEmit` - no type errors</verify>
  <done>Card content types exported, type guards available for use in components</done>
</task>

<task type="auto">
  <name>Task 2: Create Supabase Storage Upload Helper</name>
  <files>src/lib/supabase/storage.ts</files>
  <action>
Create a new file with helper functions for uploading images to Supabase Storage.

```typescript
// src/lib/supabase/storage.ts
import { createClient } from "./client"

const BUCKET_NAME = "card-images"
const MAX_FILE_SIZE = 5 * 1024 * 1024 // 5MB

export interface UploadResult {
  url: string
  path: string
}

export async function uploadCardImage(
  file: File,
  cardId: string
): Promise<UploadResult> {
  // Validate file size
  if (file.size > MAX_FILE_SIZE) {
    throw new Error("Image must be less than 5MB")
  }

  // Validate file type
  if (!file.type.startsWith("image/")) {
    throw new Error("File must be an image")
  }

  const supabase = createClient()

  // Generate unique filename: cardId/uuid.ext
  const fileExt = file.name.split(".").pop()?.toLowerCase() || "jpg"
  const fileName = `${cardId}/${crypto.randomUUID()}.${fileExt}`

  const { data, error } = await supabase.storage
    .from(BUCKET_NAME)
    .upload(fileName, file, {
      contentType: file.type,
      upsert: false,
    })

  if (error) {
    console.error("Upload error:", error)
    throw new Error(error.message || "Failed to upload image")
  }

  // Get public URL
  const { data: urlData } = supabase.storage
    .from(BUCKET_NAME)
    .getPublicUrl(data.path)

  return {
    url: urlData.publicUrl,
    path: data.path,
  }
}

export async function deleteCardImage(path: string): Promise<void> {
  const supabase = createClient()

  const { error } = await supabase.storage
    .from(BUCKET_NAME)
    .remove([path])

  if (error) {
    console.error("Delete error:", error)
    throw new Error(error.message || "Failed to delete image")
  }
}
```

Note: This requires the 'card-images' bucket to exist in Supabase Storage. User setup handles bucket creation.
  </action>
  <verify>Run `npx tsc --noEmit` - file compiles without errors</verify>
  <done>uploadCardImage and deleteCardImage functions exported and ready for use</done>
</task>

<task type="auto">
  <name>Task 3: Create ImageUpload Component</name>
  <files>src/components/cards/image-upload.tsx</files>
  <action>
First, install the textarea component (needed for descriptions in property editor later):
```bash
npx shadcn@latest add textarea
```

Then create the ImageUpload component:

```typescript
// src/components/cards/image-upload.tsx
"use client"

import { useRef, useState } from "react"
import Image from "next/image"
import { Loader2, Upload, X } from "lucide-react"
import { toast } from "sonner"

import { Button } from "@/components/ui/button"
import { cn } from "@/lib/utils"
import { uploadCardImage } from "@/lib/supabase/storage"

interface ImageUploadProps {
  value?: string           // Current image URL
  onChange: (url: string | undefined) => void
  cardId: string           // For organizing uploads
  disabled?: boolean
  className?: string
  aspectRatio?: "video" | "square"  // 16:9 or 1:1
}

export function ImageUpload({
  value,
  onChange,
  cardId,
  disabled = false,
  className,
  aspectRatio = "video",
}: ImageUploadProps) {
  const [isUploading, setIsUploading] = useState(false)
  const inputRef = useRef<HTMLInputElement>(null)

  async function handleFileSelect(e: React.ChangeEvent<HTMLInputElement>) {
    const file = e.target.files?.[0]
    if (!file) return

    try {
      setIsUploading(true)
      const result = await uploadCardImage(file, cardId)
      onChange(result.url)
      toast.success("Image uploaded")
    } catch (err) {
      const message = err instanceof Error ? err.message : "Upload failed"
      toast.error(message)
    } finally {
      setIsUploading(false)
      // Reset input so same file can be selected again
      if (inputRef.current) {
        inputRef.current.value = ""
      }
    }
  }

  function handleRemove() {
    onChange(undefined)
    toast.success("Image removed")
    // Note: We don't delete from storage immediately - orphan cleanup can happen later
  }

  const aspectClass = aspectRatio === "square" ? "aspect-square" : "aspect-video"

  return (
    <div className={cn("space-y-2", className)}>
      {value ? (
        // Image preview with remove button
        <div className={cn("relative rounded-lg overflow-hidden bg-muted", aspectClass)}>
          <Image
            src={value}
            alt="Uploaded image"
            fill
            className="object-cover"
            sizes="(max-width: 400px) 100vw, 400px"
          />
          <Button
            type="button"
            variant="destructive"
            size="icon"
            className="absolute top-2 right-2 h-8 w-8"
            onClick={handleRemove}
            disabled={disabled}
          >
            <X className="h-4 w-4" />
            <span className="sr-only">Remove image</span>
          </Button>
        </div>
      ) : (
        // Upload button/dropzone
        <button
          type="button"
          className={cn(
            "w-full border-2 border-dashed rounded-lg",
            "flex flex-col items-center justify-center gap-2",
            "text-muted-foreground hover:text-foreground hover:border-foreground/50",
            "transition-colors cursor-pointer",
            aspectClass,
            disabled && "opacity-50 cursor-not-allowed"
          )}
          onClick={() => inputRef.current?.click()}
          disabled={disabled || isUploading}
        >
          {isUploading ? (
            <>
              <Loader2 className="h-8 w-8 animate-spin" />
              <span className="text-sm">Uploading...</span>
            </>
          ) : (
            <>
              <Upload className="h-8 w-8" />
              <span className="text-sm">Click to upload image</span>
              <span className="text-xs text-muted-foreground">Max 5MB</span>
            </>
          )}
        </button>
      )}

      <input
        ref={inputRef}
        type="file"
        accept="image/*"
        className="hidden"
        onChange={handleFileSelect}
        disabled={disabled || isUploading}
      />
    </div>
  )
}
```

Create the directory first if it doesn't exist:
```bash
mkdir -p src/components/cards
```
  </action>
  <verify>
Run `npm run build` - component compiles
Check that src/components/ui/textarea.tsx exists (from shadcn add)
  </verify>
  <done>ImageUpload component renders upload area, handles file selection, shows preview with remove button</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes - all types valid
2. `npm run build` succeeds - components compile
3. src/components/ui/textarea.tsx exists (shadcn component added)
4. Card content types are exported from src/types/card.ts
5. uploadCardImage function is exported from src/lib/supabase/storage.ts
</verification>

<success_criteria>
- HeroCardContent, HorizontalLinkContent, SquareCardContent types defined
- uploadCardImage uploads to Supabase Storage bucket
- ImageUpload component handles select, upload, preview, remove
- All files compile without errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-basic-cards/04-01-SUMMARY.md`
</output>
