---
phase: 12.71-editor-ux-overhaul
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/preview/inline-editable.tsx
  - src/components/preview/profile-header.tsx
  - src/components/editor/preview-panel.tsx
  - src/components/editor/editor-layout.tsx
  - src/app/preview/page.tsx
autonomous: true

must_haves:
  truths:
    - "Clicking header area in preview opens Header tab in editor panel"
    - "Clicking background/empty area in preview opens Design tab"
    - "InlineEditable component exists as reusable contentEditable wrapper"
  artifacts:
    - path: "src/components/preview/inline-editable.tsx"
      provides: "Reusable contentEditable wrapper with ref-based approach"
      exports: ["InlineEditable"]
    - path: "src/components/preview/profile-header.tsx"
      provides: "Click handlers on header elements to navigate editor"
    - path: "src/components/editor/preview-panel.tsx"
      provides: "Handles UPDATE_PROFILE, INLINE_EDIT_ACTIVE, INLINE_EDIT_DONE messages"
  key_links:
    - from: "src/components/preview/profile-header.tsx"
      to: "src/components/editor/preview-panel.tsx"
      via: "postMessage OPEN_DESIGN_TAB with tab: header"
      pattern: "OPEN_DESIGN_TAB.*header"
    - from: "src/app/preview/page.tsx"
      to: "src/components/editor/preview-panel.tsx"
      via: "postMessage OPEN_DESIGN_TAB with tab: style on background click"
      pattern: "OPEN_DESIGN_TAB.*style"
---

<objective>
Build click-to-edit navigation infrastructure and the InlineEditable component.

Purpose: Foundation for all direct-manipulation features. Clicking elements in the preview navigates the editor panel to the right section. The InlineEditable component is the reusable building block for inline title/bio/text editing in later plans.

Output: Working click-to-navigate for header and background, plus InlineEditable component ready for Plans 05/06.
</objective>

<execution_context>
@/Users/julianmunyard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julianmunyard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/12.71-editor-ux-overhaul/12.71-RESEARCH.md

Key files to reference:
@src/components/editor/preview-panel.tsx (postMessage handler switch statement)
@src/components/editor/editor-layout.tsx (open-design-tab event listener)
@src/app/preview/page.tsx (existing SELECT_CARD and OPEN_DESIGN_TAB patterns)
@src/components/preview/profile-header.tsx (header rendering in preview)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create InlineEditable component and add click-to-navigate handlers</name>
  <files>
    src/components/preview/inline-editable.tsx
    src/components/preview/profile-header.tsx
    src/app/preview/page.tsx
  </files>
  <action>
1. Create `src/components/preview/inline-editable.tsx` — a "use client" component implementing the uncontrolled contentEditable pattern from RESEARCH.md Pattern 2:
   - Props: `value: string`, `onCommit: (value: string) => void`, `multiline?: boolean`, `className?: string`, `placeholder?: string`
   - Use `useRef<HTMLSpanElement>` — sync prop value to `ref.current.innerText` only when NOT focused (`document.activeElement !== ref.current`)
   - On blur: read `ref.current.innerText`, call `onCommit(text)`
   - On keydown Enter (single-line): `preventDefault()` then blur. On Escape: reset to original value then blur
   - On multiline Enter: allow default newline insertion
   - Add `suppressContentEditableWarning`
   - Add `data-placeholder={placeholder}` for CSS-based placeholder styling
   - Export `InlineEditable`

2. In `src/components/preview/profile-header.tsx`, add click handlers:
   - Wrap the display name area with an `onClick` that posts `{ type: 'OPEN_DESIGN_TAB', payload: { tab: 'header' } }` to parent via `window.parent.postMessage(..., window.location.origin)`. Guard with `window.parent !== window` check.
   - Wrap the bio area with the same handler.
   - Wrap the avatar/profile image area with the same handler.
   - Add `cursor-pointer` class and a subtle hover highlight (e.g., `hover:ring-2 hover:ring-blue-400/30 rounded`) to indicate clickability. Only add these styles when inside the editor iframe (check `window.parent !== window`).

3. In `src/app/preview/page.tsx`, add a background click handler:
   - On the outermost page container (the background area), add an onClick that posts `{ type: 'OPEN_DESIGN_TAB', payload: { tab: 'style' } }`.
   - IMPORTANT: Use `e.target === e.currentTarget` check so clicks on cards/content don't trigger the background handler.
   - Only send when inside editor iframe (`window.parent !== window`).
  </action>
  <verify>
    - `npm run build` passes with no TypeScript errors
    - InlineEditable component exports correctly (check import resolves)
    - Clicking header area in preview iframe navigates editor to Header tab
    - Clicking empty background area opens Design/Style tab
  </verify>
  <done>
    - InlineEditable component created with ref-based contentEditable, blur-commit, Escape-cancel
    - Profile header elements are clickable and post OPEN_DESIGN_TAB with tab: header
    - Background click posts OPEN_DESIGN_TAB with tab: style
    - Hover indicators visible only in editor iframe context
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire postMessage handlers for new message types in parent</name>
  <files>
    src/components/editor/preview-panel.tsx
    src/components/editor/editor-layout.tsx
  </files>
  <action>
1. In `src/components/editor/preview-panel.tsx`, add new cases to the message handler switch:
   - `UPDATE_PROFILE`: Extract `{ field, value }` from payload. Update `useProfileStore` with the field/value. This enables inline editing from Plans 05/06 to sync back.
   - `UPDATE_CARD`: Extract `{ cardId, ...fields }` from payload. Call `usePageStore.getState().updateCard(cardId, fields)`. This enables inline text card editing from Plan 06.
   - `DELETE_CARD`: Extract `{ cardId }` from payload. Call the existing delete card action from the page store. This enables the floating toolbar from Plan 07.
   - `DUPLICATE_CARD`: Extract `{ cardId }` from payload. Call the existing duplicate card action. This enables the floating toolbar from Plan 07.
   - `INLINE_EDIT_ACTIVE`: Set a ref/state flag `isInlineEditActive = true`. When true, suppress the `handleDeselect` behavior on the container (see Pitfall 5 in research).
   - `INLINE_EDIT_DONE`: Set `isInlineEditActive = false`.

2. In `src/components/editor/preview-panel.tsx`, guard the existing `handleDeselect` (the onClick on the outer container) to check `!isInlineEditActive` before deselecting. Use a ref for `isInlineEditActive` to avoid stale closures.

3. In `src/components/editor/editor-layout.tsx`, verify the existing `open-design-tab` event listener handles `tab: 'header'` correctly (the Design panel TABS array should already include 'header'). If the handler only switches to the Design tab without selecting a sub-tab, update it to also set the active sub-tab to `event.detail.tab`.
  </action>
  <verify>
    - `npm run build` passes
    - postMessage switch in preview-panel handles UPDATE_PROFILE, UPDATE_CARD, DELETE_CARD, DUPLICATE_CARD, INLINE_EDIT_ACTIVE, INLINE_EDIT_DONE
    - handleDeselect is suppressed during inline edit
    - open-design-tab event navigates to the correct sub-tab (header or style)
  </verify>
  <done>
    - All new postMessage types handled in preview-panel.tsx
    - Deselect suppression works during inline editing
    - Editor layout navigates to correct Design sub-tab on open-design-tab event
    - Foundation ready for Plans 05, 06, and 07 to use these message types
  </done>
</task>

</tasks>

<verification>
- `npm run build` completes with 0 TypeScript errors
- Click header in preview iframe -> editor switches to Design > Header tab
- Click background in preview iframe -> editor switches to Design > Style tab
- InlineEditable component renders and commits text on blur (manual test)
- No console errors in preview iframe
</verification>

<success_criteria>
- Click-to-navigate works for header and background
- InlineEditable component exists and exports correctly
- All 6 new postMessage types handled in preview-panel
- Deselect suppression active during inline edit sessions
- Build passes clean
</success_criteria>

<output>
After completion, create `.planning/phases/12.71-editor-ux-overhaul/12.71-01-SUMMARY.md`
</output>
