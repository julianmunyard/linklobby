---
phase: 12.71-editor-ux-overhaul
plan: 07
type: execute
wave: 2
depends_on: ["12.71-01"]
files_modified:
  - src/app/preview/page.tsx
  - src/components/preview/floating-card-toolbar.tsx
autonomous: true

must_haves:
  truths:
    - "Selecting a card in preview shows a floating toolbar above it"
    - "Floating toolbar has Delete and Duplicate buttons"
    - "Delete button removes the card"
    - "Duplicate button creates a copy of the card"
    - "Floating toolbar only appears in editor iframe, not public page"
  artifacts:
    - path: "src/components/preview/floating-card-toolbar.tsx"
      provides: "Floating quick-action toolbar for selected cards"
      exports: ["FloatingCardToolbar"]
  key_links:
    - from: "src/components/preview/floating-card-toolbar.tsx"
      to: "src/components/editor/preview-panel.tsx"
      via: "postMessage DELETE_CARD, DUPLICATE_CARD"
      pattern: "DELETE_CARD|DUPLICATE_CARD"
---

<objective>
Build the Canva-style floating quick-action toolbar for selected cards.

Purpose: When an artist selects a card in the preview, a small toolbar floats near it with Delete and Duplicate buttons. This eliminates the need to hunt through the editor panel for basic card actions.

Output: Floating toolbar appears on card selection with working Delete/Duplicate actions.
</objective>

<execution_context>
@/Users/julianmunyard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julianmunyard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/12.71-editor-ux-overhaul/12.71-RESEARCH.md
@.planning/phases/12.71-editor-ux-overhaul/12.71-01-SUMMARY.md

Key files to reference:
@src/app/preview/page.tsx (preview iframe, selectedCardId state, SelectableFlowGrid)
@src/components/editor/preview-panel.tsx (DELETE_CARD, DUPLICATE_CARD handlers from Plan 01)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create FloatingCardToolbar component</name>
  <files>src/components/preview/floating-card-toolbar.tsx</files>
  <action>
1. Create `src/components/preview/floating-card-toolbar.tsx` as a "use client" component:
   - Props: `cardId: string`, `onDelete: () => void`, `onDuplicate: () => void`
   - Render a small horizontal bar with:
     a. Duplicate button (Copy icon from lucide-react)
     b. Delete button (Trash2 icon from lucide-react) with red hover state
   - Style with Tailwind:
     - `absolute` positioning (positioned by parent)
     - Small pill shape: `flex items-center gap-1 px-2 py-1 rounded-full`
     - Semi-transparent dark background: `bg-black/80 backdrop-blur-sm`
     - White icon buttons: `text-white hover:text-blue-300` for duplicate, `text-white hover:text-red-400` for delete
     - Small shadow: `shadow-lg`
     - Transition: `animate-in fade-in-0 zoom-in-95` (or simple motion animate)
   - IMPORTANT: Use plain HTML buttons with Tailwind, NOT shadcn/Radix components. The preview iframe is a separate React root that may not have Radix providers (see Pitfall 3 in research).
   - Add `e.stopPropagation()` on both button clicks to prevent card deselection
   - Size: small (24px icons, compact padding). Should not obscure the card.

2. Wire button actions:
   - Delete: `window.parent.postMessage({ type: 'DELETE_CARD', payload: { cardId } }, window.location.origin)`
   - Duplicate: `window.parent.postMessage({ type: 'DUPLICATE_CARD', payload: { cardId } }, window.location.origin)`
  </action>
  <verify>
    - `npm run build` passes
    - FloatingCardToolbar renders with two icon buttons
    - Buttons have correct hover states
    - stopPropagation prevents deselection on click
  </verify>
  <done>
    - FloatingCardToolbar component created with Delete and Duplicate buttons
    - Plain HTML/Tailwind buttons (no Radix dependency)
    - postMessage wiring for both actions
    - Compact, non-obstructive design
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate FloatingCardToolbar into preview card selection</name>
  <files>src/app/preview/page.tsx</files>
  <action>
1. In `src/app/preview/page.tsx`, find where cards are rendered with selection state (look for `selectedCardId` state and the card wrapper that applies selection styling).

2. Inside the card wrapper (the element that shows the selection ring/border), render `FloatingCardToolbar` when the card is selected:
   ```tsx
   {isSelected && isEditorIframe && (
     <div className="absolute -top-10 left-1/2 -translate-x-1/2 z-50">
       <FloatingCardToolbar
         cardId={card.id}
         onDelete={() => postMessage({ type: 'DELETE_CARD', payload: { cardId: card.id } })}
         onDuplicate={() => postMessage({ type: 'DUPLICATE_CARD', payload: { cardId: card.id } })}
       />
     </div>
   )}
   ```
   - Position: centered above the card (`-top-10 left-1/2 -translate-x-1/2`)
   - The card wrapper must have `position: relative` for absolute positioning to work
   - Only render when `isEditorIframe` is true (check `window.parent !== window`)

3. For scatter mode cards (cards with absolute positioning on ScatterCanvas):
   - The toolbar should still appear above the card. Since scatter cards are already absolutely positioned, the toolbar's offset needs to work relative to the card's scatter position.
   - Verify the toolbar doesn't clip outside the viewport â€” if the card is near the top, position the toolbar below the card instead (`top-full mt-2` instead of `-top-10`).

4. Desktop only for now: Check if the viewport is desktop width (>768px) before showing the toolbar. Mobile already has MobileCardTypeDrawer for quick actions. Use a simple `window.innerWidth > 768` check or a media query approach.

5. Ensure the toolbar disappears when:
   - A different card is selected
   - The card is deselected (click on background)
   - The card is deleted (toolbar's parent unmounts naturally)
  </action>
  <verify>
    - `npm run build` passes
    - Select a card in preview -> floating toolbar appears above it
    - Click Delete button -> card is removed
    - Click Duplicate button -> card is duplicated
    - Select different card -> toolbar moves to new card
    - Click background -> toolbar disappears
    - Mobile viewport -> no toolbar shown
    - Toolbar doesn't appear on public page
  </verify>
  <done>
    - FloatingCardToolbar integrated into preview card selection
    - Positioned above selected card, centered
    - Delete and Duplicate actions work via postMessage
    - Desktop-only (mobile uses MobileCardTypeDrawer)
    - Toolbar follows card selection lifecycle
  </done>
</task>

</tasks>

<verification>
- `npm run build` completes with 0 TypeScript errors
- Floating toolbar appears on card selection (desktop only)
- Delete button removes card
- Duplicate button creates card copy
- Toolbar not visible on public page or mobile
- No Radix-related console errors in preview iframe
</verification>

<success_criteria>
- Floating toolbar works for all card types in preview
- Actions (Delete, Duplicate) work via postMessage pipeline
- Desktop-only, editor-only
- Build passes clean
</success_criteria>

<output>
After completion, create `.planning/phases/12.71-editor-ux-overhaul/12.71-07-SUMMARY.md`
</output>
