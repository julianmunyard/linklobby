---
phase: 12.71-editor-ux-overhaul
plan: 07
subsystem: ui
tags: [react, preview, iframe, postmessage, floating-toolbar, lucide]

requires:
  - phase: 12.71-editor-ux-overhaul
    plan: 01
    provides: postMessage handlers for DELETE_CARD/DUPLICATE_CARD in editor

provides:
  - FloatingCardToolbar component (pill-shaped Duplicate + Delete quick actions)
  - Toolbar appears above selected card in preview, desktop editor iframe only
  - DELETE_CARD and DUPLICATE_CARD messages fired to parent editor on action

affects:
  - Future plans that build on card selection affordances in the preview iframe

tech-stack:
  added: []
  patterns:
    - "Floating toolbar: absolute -top-10 left-1/2 -translate-x-1/2 z-50 positioned relative to card wrapper"
    - "Desktop/iframe gate: useState+useEffect to check window.innerWidth > 768 && window.parent !== window at mount"
    - "Plain HTML buttons in preview components — no shadcn/Radix (providers absent in iframe)"

key-files:
  created:
    - src/components/preview/floating-card-toolbar.tsx
  modified:
    - src/components/canvas/preview-sortable-card.tsx
    - src/app/auth/callback/exchange/page.tsx

key-decisions:
  - "Add toolbar to PreviewSortableCard (not preview/page.tsx) — isSelected state already available per card there"
  - "Plain HTML buttons for toolbar — shadcn/Radix components require providers not present in preview iframe"
  - "Desktop-only via useState+useEffect (not CSS) — window.innerWidth not available SSR, needs client check"
  - "showToolbar state initialized false, set true on mount if conditions met — avoids hydration mismatch"

patterns-established:
  - "Floating toolbar pattern: absolute positioned, pill shape, backdrop-blur, postMessage on action"
  - "Iframe-safe components: plain HTML buttons, no provider-dependent UI libraries"

duration: 3min
completed: 2026-02-26
---

# Phase 12.71 Plan 07: Floating Card Toolbar Summary

**Canva-style floating quick-action toolbar above selected cards using postMessage DELETE_CARD/DUPLICATE_CARD to parent editor**

## Performance

- **Duration:** 3 min
- **Started:** 2026-02-26T05:36:38Z
- **Completed:** 2026-02-26T05:39:15Z
- **Tasks:** 2
- **Files modified:** 3

## Accomplishments
- Created `FloatingCardToolbar` — pill-shaped bar with Duplicate (Copy icon) and Delete (Trash2 icon) buttons
- Integrated toolbar into `PreviewSortableCard` — renders above selected card (absolute -top-10) on desktop editor
- Toolbar is invisible on public pages (no iframe), mobile, and scatter mode (SelectableFlowGrid not used)

## Task Commits

Each task was committed atomically:

1. **Task 1: Create FloatingCardToolbar component** - `1448c0b` (feat)
2. **Task 2: Integrate FloatingCardToolbar into preview card selection** - `dd23ee7` (feat)
3. **Deviation fix: Suspense boundary for auth/callback/exchange** - `22b577f` (fix)

**Plan metadata:** (docs commit to follow)

## Files Created/Modified
- `src/components/preview/floating-card-toolbar.tsx` - New component: pill toolbar with Duplicate + Delete actions
- `src/components/canvas/preview-sortable-card.tsx` - Import toolbar, add desktop/iframe gate state, render toolbar when selected
- `src/app/auth/callback/exchange/page.tsx` - Wrapped useSearchParams in Suspense to fix build error

## Decisions Made
- Toolbar integrated into `PreviewSortableCard` rather than `preview/page.tsx` — selection state (`isSelected`) is already available per card in the sortable card component, making it the natural integration point
- Plain HTML `<button>` elements used throughout — shadcn/Radix components depend on providers (ThemeProvider, TooltipProvider) that are absent in the preview iframe context
- `showToolbar` state initialized to `false` and set via `useEffect` — avoids SSR hydration mismatch since `window.innerWidth` and `window.parent` are client-only values

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 2 - Missing Critical] Added Suspense boundary to auth/callback/exchange**
- **Found during:** Build verification
- **Issue:** `useSearchParams()` called without Suspense wrapper — Next.js build fails with static generation error
- **Fix:** Extracted `ExchangeContent` component, wrapped in `<Suspense>` with loading fallback text
- **Files modified:** `src/app/auth/callback/exchange/page.tsx`
- **Verification:** Build completes successfully, `/auth/callback/exchange` generates as static page (○)
- **Committed in:** `22b577f` (separate fix commit)

---

**Total deviations:** 1 auto-fixed (1 missing critical — Next.js requirement)
**Impact on plan:** Fix was necessary for build to pass. No scope creep.

## Issues Encountered
- Pre-existing build lock file from another process required manual removal of `.next/lock` before rebuilding

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- Floating toolbar ships with Plan 07. DELETE_CARD and DUPLICATE_CARD postMessage handlers already wired in Plan 01
- Plan 08+ can build on card selection affordances; toolbar will automatically appear for any card that gains `isSelected=true`
- No blockers

---
*Phase: 12.71-editor-ux-overhaul*
*Completed: 2026-02-26*
