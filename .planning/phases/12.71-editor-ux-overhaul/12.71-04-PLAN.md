---
phase: 12.71-editor-ux-overhaul
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/editor/header-section.tsx
  - src/components/editor/design-panel.tsx
  - src/components/editor/gallery-card-fields.tsx
autonomous: true

must_haves:
  truths:
    - "Profile image uploads are compressed before upload"
    - "Gallery upload does not silently fail when navigating away"
    - "Large iPhone photos are auto-compressed"
  artifacts:
    - path: "src/components/editor/header-section.tsx"
      provides: "Profile image upload with compression"
      contains: "compressImageForUpload"
    - path: "src/components/editor/gallery-card-fields.tsx"
      provides: "Gallery upload with mounted guard"
      contains: "isMountedRef"
  key_links:
    - from: "src/components/editor/header-section.tsx"
      to: "src/lib/image-compression.ts"
      via: "import compressImageForUpload"
      pattern: "compressImageForUpload"
---

<objective>
Add image compression to profile uploads and fix gallery upload silent failure.

Purpose: iPhone photos can be 12MB+. Profile image uploads (avatar, background) are the only upload paths missing compression. Gallery uploads fail silently when user navigates away mid-upload. Both are bugs that need fixing.

Output: All image upload paths use compression; gallery uploads are resilient to unmounting.
</objective>

<execution_context>
@/Users/julianmunyard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julianmunyard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/12.71-editor-ux-overhaul/12.71-RESEARCH.md

Key files to reference:
@src/lib/image-compression.ts (existing compressImageForUpload)
@src/components/editor/header-section.tsx (profile image upload)
@src/components/editor/design-panel.tsx (background image upload)
@src/components/editor/gallery-card-fields.tsx (gallery upload with silent failure)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add compression to profile image uploads</name>
  <files>
    src/components/editor/header-section.tsx
    src/components/editor/design-panel.tsx
  </files>
  <action>
1. In `src/components/editor/header-section.tsx`:
   - Import `compressImageForUpload` from `@/lib/image-compression`
   - Find the `handleCropComplete` (or equivalent) function that receives a cropped blob and uploads it
   - BEFORE the upload call, convert the Blob to a File and compress: `const file = new File([croppedBlob], 'profile-image.jpg', { type: croppedBlob.type }); const compressedBlob = await compressImageForUpload(file)`
   - Pass `compressedBlob` to the upload function instead of `croppedBlob`
   - Do NOT use `as File` cast — create a proper File object from the Blob
   - This matches the pattern already used in `image-upload.tsx`, `gallery-card-fields.tsx`, and `audio-card-fields.tsx`

2. In `src/components/editor/design-panel.tsx`:
   - Check if there's a background image upload handler that DOESN'T already compress
   - If found, add the same compression step before upload
   - If design-panel delegates to a shared upload component that already compresses, skip this file

NOTE: The compressImageForUpload function handles EXIF rotation, WebWorker offloading, and progressive JPEG. Do NOT add manual canvas resize logic — use the existing function.
  </action>
  <verify>
    - `npm run build` passes
    - `grep -r "compressImageForUpload" src/components/editor/header-section.tsx` shows the import and usage
    - Upload a large image (>5MB) as profile photo — verify it completes faster and file is smaller in storage
  </verify>
  <done>
    - Profile image uploads compressed before upload
    - Background image uploads compressed before upload (if applicable)
    - Same compression function used as rest of codebase
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix gallery upload silent failure on unmount</name>
  <files>src/components/editor/gallery-card-fields.tsx</files>
  <action>
1. In `src/components/editor/gallery-card-fields.tsx`:
   - Add a mounted ref at the top of the component: `const isMountedRef = useRef(true)`
   - Add a cleanup effect: `useEffect(() => () => { isMountedRef.current = false }, [])`
   - In the `handleFileSelect` async function, after each async operation (compression, upload), add a guard: `if (!isMountedRef.current) return`
   - This prevents `setIsUploading(false)` and `onChange(...)` from firing on unmounted component

2. Also fix the file input reset timing:
   - Move `fileInputRef.current.value = ''` to the TOP of `handleFileSelect` (synchronous), right after reading `e.target.files`
   - This prevents duplicate uploads if the same file is selected twice rapidly
   - Currently the reset may be at the bottom after async work — move it before any async operations
  </action>
  <verify>
    - `npm run build` passes
    - Start a gallery image upload, then navigate away from the card editor mid-upload — no React console warning about unmounted component
    - Upload same photo twice — no duplicate appears
  </verify>
  <done>
    - Gallery upload guarded with isMountedRef
    - File input reset happens synchronously at start of handler
    - No silent failures or unmounted component warnings
  </done>
</task>

</tasks>

<verification>
- `npm run build` completes with 0 TypeScript errors
- Profile photo upload uses compression
- Gallery upload resilient to unmounting
- No duplicate photo bug on rapid re-selection
</verification>

<success_criteria>
- All image upload paths use compressImageForUpload
- Gallery upload does not fail silently when navigating away
- File input reset prevents duplicate uploads
- Build passes clean
</success_criteria>

<output>
After completion, create `.planning/phases/12.71-editor-ux-overhaul/12.71-04-SUMMARY.md`
</output>
