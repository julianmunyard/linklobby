# Phase 12.6: Security Hardening & Auth Completion - Context

**Gathered:** 2026-02-15
**Status:** Ready for planning

<domain>
## Phase Boundary

Everything security, authentication, and account management that must be hardened before real users hit production. This covers: completing the auth system (OAuth, password reset, email verification, 2FA), API rate limiting across all endpoints, HTTP security headers, input sanitization, CSRF protection, session management, file upload security, and storage quotas. Also includes the cookie consent banner that's already a dependency but not wired up.

**Not in scope:** Billing/subscriptions (Phase 12.5), monitoring/observability (Phase 12.7), deployment/CI (Phase 12.7).

</domain>

<decisions>
## Implementation Decisions

### Authentication Completion
- **Google OAuth** — enable via Supabase Auth providers. Add "Continue with Google" button on login and signup pages. OAuth callback route already exists, just needs provider config + UI button.
- **Email verification** — enable Supabase's built-in email confirmation on signup. Handle the confirmation redirect. Users who haven't verified see a banner prompting them to check their email. Unverified users can still use the app but can't publish their page.
- **Forgot password / password reset** — Supabase built-in flow. Add "Forgot password?" link on login page, reset password form, and handle the recovery redirect.
- **Change password** — add to settings page. Requires current password confirmation.
- **Change email** — add to settings page. Sends verification to new email before switching. Requires password confirmation.
- **2FA / Two-step verification** — TOTP-based (authenticator app). Optional, user enables in settings. Show QR code for setup, require backup codes. Supabase MFA support.
- **Session management** — users can view active sessions (device, last active) and sign out from individual sessions or all sessions.

### Rate Limiting
- **Implementation:** Use Upstash Redis + `@upstash/ratelimit` for serverless-compatible rate limiting.
- **Endpoints to protect:**
  - Login: 5 attempts per 15 minutes per IP
  - Signup: 3 accounts per hour per IP
  - Password reset: 3 requests per 15 minutes per email
  - Email collection (public): 10 submissions per minute per IP
  - Audio upload: 5 uploads per hour per user
  - API routes (general): 60 requests per minute per user
  - Analytics tracking (public): 30 events per minute per IP
  - Profile updates: 20 per minute per user
- **Response:** Return 429 Too Many Requests with Retry-After header
- **Rate limit middleware** — create reusable middleware that wraps API routes

### HTTP Security Headers
- **Content-Security-Policy** — restrict script sources, style sources, frame ancestors. Allow Supabase, YouTube, Vimeo, Spotify, SoundCloud, TikTok embed domains. Allow Superpowered WASM.
- **Strict-Transport-Security** — max-age=31536000; includeSubDomains
- **X-Content-Type-Options** — nosniff
- **X-Frame-Options** — DENY (LinkLobby pages shouldn't be iframed by others)
- **X-XSS-Protection** — 0 (deprecated but harmless)
- **Referrer-Policy** — strict-origin-when-cross-origin
- **Permissions-Policy** — restrict camera, microphone, geolocation etc.
- Add all via Next.js headers config in next.config.ts

### Input Sanitization
- **DOMPurify** — sanitize any user-generated text that could be rendered as HTML (card titles, descriptions, bio). Run on both input (API) and output (render).
- **URL validation** — already exists for links, extend to cover all URL inputs (audio URLs, image URLs, social links)
- **File type validation** — validate MIME types server-side on upload, not just extension. Reject unexpected file types.

### Cookie Consent Banner
- **Already have** `react-cookie-consent` in package.json — wire it up
- Banner appears on public pages when artist has Facebook Pixel or GA enabled
- Theme-aware styling (matches artist's theme)
- "Accept" / "Reject" binary choice
- Pixels only fire after consent is given
- Consent stored in cookie, remembered across visits

### File Upload Security
- **Audio:** Validate MIME type server-side (audio/mpeg, audio/wav, audio/mp3 only). Reject everything else.
- **Images:** Validate MIME type server-side (image/jpeg, image/png, image/webp, image/gif only).
- **Storage quota per user:** Free tier gets 500MB total storage. Track usage in profiles table.
- **Orphaned file cleanup:** When a card is deleted, also delete its associated files from Supabase storage. Add a cleanup function to card deletion logic.

### CSRF Protection
- Next.js + Supabase session cookies provide reasonable CSRF protection by default
- Add explicit CSRF token for any state-changing operations that accept form data
- Verify Origin header on all mutation API routes

### Claude's Discretion
- Exact CSP directive values (balancing security with embed compatibility)
- Rate limit numbers can be tuned (the ones listed are starting points)
- 2FA UI design (QR code display, backup codes format)
- Session management UI layout
- Cookie consent banner exact positioning and animation
- Storage quota tracking implementation details

</decisions>

<specifics>
## Specific Ideas

- Rate limiting should fail open (if Redis is down, allow the request rather than blocking all users)
- 2FA backup codes: generate 10, show once, user must save them. Each code single-use.
- Google OAuth should pre-fill display name from Google profile if user is new
- Session list should show "Current session" badge on the active one
- Storage quota should show a usage bar in settings (like "120MB / 500MB used")
- Password strength meter on signup and change password forms

</specifics>

<deferred>
## Deferred Ideas

- Apple Sign In (requires Apple Developer account setup)
- GitHub OAuth (not relevant for target audience of artists)
- Magic link / passwordless login (nice to have, not launch-critical)
- Hardware security keys / WebAuthn (overkill for v1)
- IP-based suspicious login alerts
- Virus/malware scanning on uploads (complex, can add post-launch)

</deferred>

---

*Phase: 12.6-security-hardening*
*Context gathered: 2026-02-15*
