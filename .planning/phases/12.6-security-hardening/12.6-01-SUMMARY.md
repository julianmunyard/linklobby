---
phase: 12.6-security-hardening
plan: 01
subsystem: infra
tags: [security, csp, csrf, dompurify, xss, headers, sanitization]

# Dependency graph
requires: []
provides:
  - HTTP security headers (CSP, HSTS, X-Content-Type-Options, X-Frame-Options, Referrer-Policy, Permissions-Policy) on all Next.js routes
  - CSRF Origin validation helper (validateCsrfOrigin) applied to all mutation API routes
  - Input sanitization helper (sanitizeText via DOMPurify) applied to all routes storing user text
affects: [all future API routes, 12.6-02, 12.6-03, 12.6-04, 12.6-05, 12.6-06, 12.6-07]

# Tech tracking
tech-stack:
  added: [isomorphic-dompurify, "@types/dompurify"]
  patterns:
    - CSRF validation via Origin vs Host header comparison at top of every mutation handler
    - sanitizeText strips all HTML before DB write (ALLOWED_TAGS=[], ALLOWED_ATTR=[])
    - CSP defined at build time in next.config.ts with isDev toggle for unsafe-eval

key-files:
  created:
    - src/lib/csrf/index.ts
    - src/lib/sanitize/index.ts
  modified:
    - next.config.ts
    - src/app/api/cards/route.ts
    - src/app/api/cards/[id]/route.ts
    - src/app/api/cards/bulk/route.ts
    - src/app/api/theme/route.ts
    - src/app/api/profile/route.ts
    - src/app/api/audio/upload/route.ts
    - src/app/api/audio/delete/route.ts
    - src/app/api/legal/delete-account/route.ts
    - src/app/api/templates/apply/route.ts
    - src/app/api/import/linktree/route.ts

key-decisions:
  - "CSRF via Origin/Host header comparison — no token needed since all requests are same-site; stateless and correct"
  - "Public endpoints (emails, analytics/track, pixels) excluded from CSRF per plan — they accept third-party POSTs"
  - "sanitizeText strips all tags/attrs (ALLOWED_TAGS=[], ALLOWED_ATTR=[]) — plain text fields only"
  - "worker-src 'self' blob: included in CSP for Superpowered AudioWorklet compatibility"
  - "CSP isDev toggle adds unsafe-eval only in development for Next.js dev server"
  - "PATCH handler in delete-account/route.ts also gets CSRF — it's a state-mutation endpoint"

patterns-established:
  - "Pattern: CSRF check is first line of every mutation handler before auth check"
  - "Pattern: sanitizeText applied only to text fields (title, description, bio) — not URLs or structured data"

# Metrics
duration: 3min
completed: 2026-02-25
---

# Phase 12.6 Plan 01: Security Headers, CSRF Validation, and Input Sanitization Summary

**CSP/HSTS/X-Frame-Options on all routes, Origin-header CSRF protection on 10 mutation endpoints, DOMPurify text sanitization on card and profile writes**

## Performance

- **Duration:** 3 min
- **Started:** 2026-02-25T08:02:17Z
- **Completed:** 2026-02-25T08:05:42Z
- **Tasks:** 2
- **Files modified:** 13

## Accomplishments
- Full HTTP security header suite applied globally via next.config.ts (CSP, HSTS, X-Content-Type-Options, X-Frame-Options, Referrer-Policy, Permissions-Policy)
- CSRF Origin validation on all 10 mutation API routes — covers POST/PUT/PATCH/DELETE handlers
- DOMPurify-based sanitizeText strips all HTML from card titles, descriptions, and profile bio/displayName before DB write

## Task Commits

Each task was committed atomically:

1. **Task 1: Install isomorphic-dompurify, create CSRF helper and sanitize helper** - `2880333` (feat)
2. **Task 2: Add security headers to next.config.ts and apply CSRF + sanitization to all mutation API routes** - `5f1acfc` (feat)

**Plan metadata:** (docs commit follows)

## Files Created/Modified
- `src/lib/csrf/index.ts` - validateCsrfOrigin: compares Origin vs Host header, returns boolean
- `src/lib/sanitize/index.ts` - sanitizeText: DOMPurify with ALLOWED_TAGS=[], ALLOWED_ATTR=[] for plain text
- `next.config.ts` - CSP header (with Supabase/YouTube/Vimeo/Spotify/SoundCloud/TikTok/Facebook/GA4/Superpowered), HSTS, X-Content-Type-Options, X-Frame-Options, Referrer-Policy, Permissions-Policy
- `src/app/api/cards/route.ts` - CSRF + sanitize title/description on POST
- `src/app/api/cards/[id]/route.ts` - CSRF on PUT/PATCH/DELETE + sanitize title/description on PUT/PATCH
- `src/app/api/cards/bulk/route.ts` - CSRF on POST
- `src/app/api/theme/route.ts` - CSRF on POST
- `src/app/api/profile/route.ts` - CSRF on POST + sanitize displayName/bio
- `src/app/api/audio/upload/route.ts` - CSRF on POST
- `src/app/api/audio/delete/route.ts` - CSRF on DELETE
- `src/app/api/legal/delete-account/route.ts` - CSRF on POST + PATCH
- `src/app/api/templates/apply/route.ts` - CSRF on POST
- `src/app/api/import/linktree/route.ts` - CSRF on POST

## Decisions Made
- CSRF validation via Origin vs Host comparison — stateless, no token storage, correct for same-site Next.js app
- Public endpoints excluded: `/api/emails` (visitor email signups from public page), `/api/analytics/track`, `/api/pixels/facebook-capi`
- `sanitizeText` strips everything — no HTML allowed in card/profile text fields
- CSP `worker-src 'self' blob:` preserved for Superpowered AudioWorklet
- `isDev` flag adds `unsafe-eval` to script-src in development only (Next.js dev server requires it)
- PATCH on delete-account (account recovery) gets CSRF — it mutates account state

## Deviations from Plan

None - plan executed exactly as written.

Note: `/api/page/route.ts` and `/api/legal/export-data/route.ts` had no mutation handlers (GET only), so no CSRF was needed. The plan mentioned them as targets but their actual implementations have no POST/PUT/PATCH/DELETE.

## Issues Encountered
None.

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- Security headers, CSRF, and sanitization foundations are in place
- All subsequent 12.6 plans (02–07) can build on these helpers
- Any new mutation API routes added in future phases should import validateCsrfOrigin and follow the same first-line CSRF check pattern

---
*Phase: 12.6-security-hardening*
*Completed: 2026-02-25*
