---
phase: 12.6-security-hardening
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/auth/google-oauth-button.tsx
  - src/app/(auth)/login/login-form.tsx
  - src/app/(auth)/signup/signup-form.tsx
  - src/app/(auth)/forgot-password/page.tsx
  - src/app/(auth)/forgot-password/forgot-password-form.tsx
  - src/app/(auth)/reset-password/page.tsx
  - src/app/(auth)/reset-password/reset-password-form.tsx
  - src/app/auth/callback/route.ts
autonomous: true

user_setup:
  - service: google-oauth
    why: "Google OAuth provider for 'Continue with Google' — requires Google Cloud project"
    env_vars: []
    dashboard_config:
      - task: "Create OAuth 2.0 credentials (Client ID + Client Secret) in Google Cloud Console"
        location: "Google Cloud Console -> APIs & Services -> Credentials -> Create Credentials -> OAuth client ID -> Web application"
      - task: "Add authorized redirect URI: https://<your-supabase-project>.supabase.co/auth/v1/callback"
        location: "Google Cloud Console -> APIs & Services -> Credentials -> OAuth 2.0 Client IDs -> Your client -> Authorized redirect URIs"
      - task: "Enable Google provider in Supabase and paste Client ID + Client Secret"
        location: "Supabase Dashboard -> Authentication -> Providers -> Google -> Enable -> paste Client ID and Client Secret"

must_haves:
  truths:
    - "'Continue with Google' button appears on both login and signup pages"
    - "Clicking Google OAuth button initiates Supabase OAuth flow and redirects to Google"
    - "After Google auth, user is redirected to /editor via /auth/callback"
    - "Forgot Password link on login page leads to email input form"
    - "Submitting forgot password form sends Supabase password reset email"
    - "Clicking reset link in email redirects to reset-password page where user sets new password"
    - "Auth callback correctly handles type=recovery by redirecting to /reset-password instead of /editor"
  artifacts:
    - path: "src/components/auth/google-oauth-button.tsx"
      provides: "Reusable Google OAuth button component"
      exports: ["GoogleOAuthButton"]
    - path: "src/app/(auth)/forgot-password/forgot-password-form.tsx"
      provides: "Forgot password form with email input"
      exports: ["ForgotPasswordForm"]
    - path: "src/app/(auth)/reset-password/reset-password-form.tsx"
      provides: "Reset password form with new password + confirm inputs"
      exports: ["ResetPasswordForm"]
  key_links:
    - from: "src/app/(auth)/login/login-form.tsx"
      to: "src/components/auth/google-oauth-button.tsx"
      via: "renders GoogleOAuthButton in login form"
      pattern: "GoogleOAuthButton"
    - from: "src/app/auth/callback/route.ts"
      to: "/reset-password"
      via: "redirects to reset-password when type=recovery"
      pattern: "type.*recovery.*reset-password"
    - from: "src/app/(auth)/forgot-password/forgot-password-form.tsx"
      to: "supabase.auth.resetPasswordForEmail"
      via: "calls Supabase reset API"
      pattern: "resetPasswordForEmail"
---

<objective>
Add Google OAuth login/signup and the complete forgot password / reset password flow.

Purpose: Google OAuth removes friction for signup (critical for conversion). Password reset is essential for any production auth system — users WILL forget passwords. These are independent auth flows that don't depend on other security hardening work.
Output: Google OAuth button on login/signup, forgot-password page, reset-password page, updated auth callback to handle recovery redirects.
</objective>

<execution_context>
@/Users/julianmunyard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julianmunyard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12.6-security-hardening/12.6-RESEARCH.md
@src/app/(auth)/login/login-form.tsx
@src/app/(auth)/signup/signup-form.tsx
@src/app/(auth)/layout.tsx
@src/app/auth/callback/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Google OAuth button and add to login/signup forms</name>
  <files>src/components/auth/google-oauth-button.tsx, src/app/(auth)/login/login-form.tsx, src/app/(auth)/signup/signup-form.tsx</files>
  <action>
**Step 1: Create `src/components/auth/google-oauth-button.tsx`.**

A reusable "Continue with Google" button component. Uses Supabase client-side `signInWithOAuth` — no server action needed, Supabase handles the entire redirect flow.

```typescript
'use client'

import { useState } from 'react'
import { createClient } from '@/lib/supabase/client'
import { Button } from '@/components/ui/button'

export function GoogleOAuthButton() {
  const [isLoading, setIsLoading] = useState(false)

  async function handleGoogleLogin() {
    setIsLoading(true)
    const supabase = createClient()
    await supabase.auth.signInWithOAuth({
      provider: 'google',
      options: {
        redirectTo: `${window.location.origin}/auth/callback`,
      },
    })
    // No need to handle redirect — Supabase does it automatically
    // setIsLoading stays true as page navigates away
  }

  return (
    <Button
      type="button"
      variant="outline"
      className="w-full"
      onClick={handleGoogleLogin}
      disabled={isLoading}
    >
      {isLoading ? 'Redirecting...' : 'Continue with Google'}
    </Button>
  )
}
```

Include a Google "G" SVG icon in the button if the project already has an icon pattern — otherwise keep text-only. Check if the project uses lucide-react or similar icon library; Google icon is typically a custom SVG.

**Step 2: Add GoogleOAuthButton to login form.**

In `src/app/(auth)/login/login-form.tsx`:

1. Import `GoogleOAuthButton` from `@/components/auth/google-oauth-button`
2. Add the button ABOVE the email/password form fields, followed by a visual divider:

```tsx
<GoogleOAuthButton />

<div className="relative my-4">
  <div className="absolute inset-0 flex items-center">
    <span className="w-full border-t" />
  </div>
  <div className="relative flex justify-center text-xs uppercase">
    <span className="bg-card px-2 text-muted-foreground">or</span>
  </div>
</div>
```

3. Add a "Forgot password?" link below the password field:

```tsx
<div className="flex justify-end">
  <Link href="/forgot-password" className="text-sm text-muted-foreground hover:text-primary">
    Forgot password?
  </Link>
</div>
```

**Step 3: Add GoogleOAuthButton to signup form.**

In `src/app/(auth)/signup/signup-form.tsx`:

1. Import `GoogleOAuthButton`
2. Add the same button + divider pattern above the form fields (same as login)
  </action>
  <verify>
- `ls src/components/auth/google-oauth-button.tsx` — exists
- `grep "GoogleOAuthButton" src/app/\(auth\)/login/login-form.tsx` — imported in login
- `grep "GoogleOAuthButton" src/app/\(auth\)/signup/signup-form.tsx` — imported in signup
- `grep "forgot-password" src/app/\(auth\)/login/login-form.tsx` — link present
- `grep "signInWithOAuth" src/components/auth/google-oauth-button.tsx` — OAuth call present
- `npx tsc --noEmit` — no type errors
  </verify>
  <done>
Google OAuth button component created and rendered on both login and signup forms. "Forgot password?" link added to login form. OAuth flow uses Supabase signInWithOAuth with redirect to /auth/callback.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create forgot-password page, reset-password page, and update auth callback for recovery</name>
  <files>src/app/(auth)/forgot-password/page.tsx, src/app/(auth)/forgot-password/forgot-password-form.tsx, src/app/(auth)/reset-password/page.tsx, src/app/(auth)/reset-password/reset-password-form.tsx, src/app/auth/callback/route.ts</files>
  <action>
**Step 1: Create forgot-password page.**

Create `src/app/(auth)/forgot-password/page.tsx`:
```tsx
import { ForgotPasswordForm } from './forgot-password-form'

export default function ForgotPasswordPage() {
  return <ForgotPasswordForm />
}
```

Create `src/app/(auth)/forgot-password/forgot-password-form.tsx`:

A client component with:
- Email input field (validated with zod)
- Submit button that calls `supabase.auth.resetPasswordForEmail(email, { redirectTo })`
- The `redirectTo` should be `${window.location.origin}/auth/callback?next=/reset-password`
- Success state: show "Check your email" message with description "We've sent a password reset link to your email address."
- Error state: show error message
- Link back to login page
- Uses the same Card component pattern as login-form.tsx for visual consistency
- Title: "Reset your password", Description: "Enter your email and we'll send you a reset link"

**Step 2: Create reset-password page.**

Create `src/app/(auth)/reset-password/page.tsx`:
```tsx
import { ResetPasswordForm } from './reset-password-form'

export default function ResetPasswordPage() {
  return <ResetPasswordForm />
}
```

Create `src/app/(auth)/reset-password/reset-password-form.tsx`:

A client component with:
- New password input (min 8 chars, validated with zod)
- Confirm password input (must match)
- Submit button that calls `supabase.auth.updateUser({ password: newPassword })`
- This works because the auth callback already exchanged the recovery code for a session — the user is authenticated when they reach this page
- Success state: show "Password updated" message + auto-redirect to /login after 2 seconds
- Error state: show error message
- Uses same Card component pattern as other auth forms
- Title: "Set new password", Description: "Enter your new password below"

**Step 3: Update auth callback to handle recovery type.**

Modify `src/app/auth/callback/route.ts`:

The current callback always redirects to the `next` query param (defaulting to `/editor`). For password recovery, it should redirect to `/reset-password` instead.

```typescript
export async function GET(request: Request) {
  const { searchParams, origin } = new URL(request.url)
  const code = searchParams.get('code')
  const next = searchParams.get('next') ?? '/editor'
  const type = searchParams.get('type')

  if (code) {
    const supabase = await createClient()
    const { error } = await supabase.auth.exchangeCodeForSession(code)

    if (!error) {
      // Recovery flow: redirect to reset-password page
      if (type === 'recovery') {
        return NextResponse.redirect(`${origin}/reset-password`)
      }
      return NextResponse.redirect(`${origin}${next}`)
    }
  }

  return NextResponse.redirect(`${origin}/login?error=auth_callback_error`)
}
```

The `type` parameter is added by Supabase to the redirect URL when processing a recovery email link.

Also handle `type=signup` (email verification confirmation) — for now, just redirect to `/editor` as normal. This will be enhanced in Plan 04 with email verification.
  </action>
  <verify>
- `ls src/app/\(auth\)/forgot-password/page.tsx src/app/\(auth\)/forgot-password/forgot-password-form.tsx` — forgot-password pages exist
- `ls src/app/\(auth\)/reset-password/page.tsx src/app/\(auth\)/reset-password/reset-password-form.tsx` — reset-password pages exist
- `grep "resetPasswordForEmail" src/app/\(auth\)/forgot-password/forgot-password-form.tsx` — Supabase API called
- `grep "updateUser" src/app/\(auth\)/reset-password/reset-password-form.tsx` — password update called
- `grep "recovery" src/app/auth/callback/route.ts` — recovery type handled in callback
- `grep "reset-password" src/app/auth/callback/route.ts` — redirects to reset-password
- `npx tsc --noEmit` — no type errors
  </verify>
  <done>
Forgot password flow complete: email input form sends reset link via Supabase, auth callback handles recovery type and redirects to reset-password page, reset-password form updates the password. All pages follow existing auth form patterns (Card component, zod validation, react-hook-form).
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. Google OAuth button renders on both login and signup pages
3. Forgot password link visible on login page
4. Forgot password form calls resetPasswordForEmail
5. Auth callback redirects type=recovery to /reset-password
6. Reset password form calls updateUser with new password
7. All new pages use (auth) layout for consistent styling
</verification>

<success_criteria>
- Google OAuth button on login and signup pages
- Forgot password email flow works end-to-end
- Auth callback correctly routes recovery links
- Reset password form updates password
- All pages follow existing visual patterns
- No type errors
</success_criteria>

<output>
After completion, create `.planning/phases/12.6-security-hardening/12.6-03-SUMMARY.md`
</output>
