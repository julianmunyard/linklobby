---
phase: 12.6-security-hardening
plan: 04
subsystem: auth
tags: [supabase, email-verification, password-change, settings, publish-gate, sql-migration]

# Dependency graph
requires:
  - phase: 12.6-03
    provides: Google OAuth + forgot/reset password flows; type=recovery in auth callback
provides:
  - Change password form with re-authentication
  - Change email form with Supabase verification trigger
  - Settings page Account section (Profile / Account / Billing)
  - Email verification page for post-signup flow
  - Auth callback handling for email_change type
  - SQL migration confirming existing users (prevents lockout on feature enable)
  - Database trigger blocking unverified-email users from publishing
  - checkPublishEligibility helper for server-side publish gating
  - /api/page PATCH handler with email verification gate
affects: ["12.6-05", "12.6-06", "12.6-07", "future-publish-ui"]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Re-authenticate before sensitive account changes: signInWithPassword before updateUser"
    - "checkPublishEligibility helper: reusable server/client function for publish gate checks"
    - "Auth callback type routing: recovery -> /reset-password, email_change -> /settings?email_updated=true, default -> /editor"

key-files:
  created:
    - src/components/settings/change-password-form.tsx
    - src/components/settings/change-email-form.tsx
    - src/app/(auth)/verify-email/page.tsx
    - src/lib/supabase/publish-gate.ts
    - supabase/migrations/20260225_confirm_existing_users.sql
  modified:
    - src/app/(dashboard)/settings/page.tsx
    - src/app/auth/callback/route.ts
    - src/app/api/page/route.ts

key-decisions:
  - "Re-authenticate with signInWithPassword before password/email changes — defense against session hijacking"
  - "verify-email page is the post-signup 'check your email' screen, not the callback landing page"
  - "Migration sets email_confirmed_at for ALL existing users before email confirmation is enabled — must run first"
  - "Publish gate is enforced at both API route level (403) and DB trigger (RAISE EXCEPTION) for defense in depth"
  - "PATCH handler added to /api/page for future publish toggle UI"

patterns-established:
  - "Publish gate pattern: checkPublishEligibility(supabase) returns null|errorString, used in API routes before is_published=true updates"
  - "Settings page structure: Profile section / Account section (password+email) / Billing section"

# Metrics
duration: 2min
completed: 2026-02-25
---

# Phase 12.6 Plan 04: Account Management & Email Verification Summary

**Settings Account section with change-password/change-email forms (re-auth required), email verification page, SQL migration for existing user backfill, and publish gate blocking unverified users via API + DB trigger.**

## Performance

- **Duration:** ~2 min
- **Started:** 2026-02-25T08:08:57Z
- **Completed:** 2026-02-25T08:11:10Z
- **Tasks:** 2
- **Files modified:** 8

## Accomplishments

- Settings page expanded with Account section containing ChangePasswordForm and ChangeEmailForm
- Change password requires re-authentication via signInWithPassword before calling updateUser
- Change email triggers Supabase verification to new address; confirmation redirects back to /settings
- SQL migration backfills email_confirmed_at for all existing users so enabling email confirmation doesn't lock them out
- Database trigger (enforce_publish_email_verified) blocks unverified users from publishing at DB level
- /api/page now has PATCH handler with checkPublishEligibility gate (403 on unverified email)

## Task Commits

1. **Task 1: Create change password form, change email form, expand settings page** - `0791275` (feat)
2. **Task 2: Email verification page, auth callback, migration, publish gate** - `112fa7a` (feat)

**Plan metadata:** (pending docs commit)

## Files Created/Modified

- `src/components/settings/change-password-form.tsx` - Re-authenticates with current password then calls updateUser for password change
- `src/components/settings/change-email-form.tsx` - Re-authenticates then calls updateUser with new email; Supabase sends verification
- `src/app/(dashboard)/settings/page.tsx` - Expanded with Profile / Account / Billing sections; passes user.email to forms
- `src/app/(auth)/verify-email/page.tsx` - Post-signup "check your email" page using (auth) centered layout
- `src/app/auth/callback/route.ts` - Added email_change type -> /settings?email_updated=true redirect
- `supabase/migrations/20260225_confirm_existing_users.sql` - Backfills email_confirmed_at; creates enforce_publish_email_verified DB trigger
- `src/lib/supabase/publish-gate.ts` - checkPublishEligibility(supabase): checks user.email_confirmed_at, returns null or error string
- `src/app/api/page/route.ts` - Added PATCH handler with publish gate; rate limited via Plan 01 ratelimit middleware

## Decisions Made

- Re-authenticate before password/email changes: both forms call `signInWithPassword` with the user's current password before any `updateUser` call, protecting against session hijacking.
- Migration must run BEFORE enabling "Confirm email" in Supabase Dashboard. Without it, all existing users (who signed up without confirmation required) would have a null `email_confirmed_at` and be blocked.
- Publish gate enforced at two layers: API route (application-level, good UX error) + DB trigger (security backstop).
- `/api/page` PATCH handler added as the canonical way to toggle `is_published` — future publish UI should use this endpoint.

## Deviations from Plan

None - plan executed exactly as written.

The linter auto-applied Plan 01's rate limiting middleware to the new PATCH handler in `/api/page/route.ts` — this was a consistent, correct addition and not a deviation.

## Issues Encountered

None.

## User Setup Required

**IMPORTANT: Manual migration steps required before enabling email confirmation.**

1. Run the migration via Supabase Dashboard SQL editor or `supabase db push`:
   - File: `supabase/migrations/20260225_confirm_existing_users.sql`
   - This backfills `email_confirmed_at` for all existing users

2. After migration runs, go to:
   - Supabase Dashboard > Authentication > Providers > Email > Enable "Confirm email"

3. From this point forward, new signups will require email verification before accessing the editor. Existing users are unaffected.

## Next Phase Readiness

- Account management section complete; Plans 05 (2FA) and 06 (session management) can build on the Account section pattern
- Publish gate is ready; future publish toggle UI should call `PATCH /api/page` with `{ is_published: true }`
- Auth callback type routing is complete for all current flow types (recovery, email_change, signup/OAuth default)

---
*Phase: 12.6-security-hardening*
*Completed: 2026-02-25*
