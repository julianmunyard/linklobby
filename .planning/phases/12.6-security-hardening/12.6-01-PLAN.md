---
phase: 12.6-security-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - next.config.ts
  - src/lib/csrf/index.ts
  - src/lib/sanitize/index.ts
  - src/app/api/cards/route.ts
  - src/app/api/cards/[id]/route.ts
  - src/app/api/cards/bulk/route.ts
  - src/app/api/theme/route.ts
  - src/app/api/profile/route.ts
  - src/app/api/audio/upload/route.ts
  - src/app/api/audio/delete/route.ts
  - src/app/api/page/route.ts
  - src/app/api/emails/route.ts
  - src/app/api/legal/delete-account/route.ts
  - src/app/api/legal/export-data/route.ts
  - src/app/api/templates/apply/route.ts
  - src/app/api/import/linktree/route.ts
autonomous: true

must_haves:
  truths:
    - "All HTTP responses include CSP, HSTS, X-Content-Type-Options, X-Frame-Options, Referrer-Policy, and Permissions-Policy headers"
    - "CSP allows Supabase, YouTube, Vimeo, Spotify, SoundCloud, TikTok embeds, Facebook Pixel, Google Analytics, and Superpowered WASM"
    - "All mutation API routes (POST/PUT/PATCH/DELETE) validate Origin header against Host header"
    - "CSRF validation does NOT apply to public endpoints (analytics/track, pixels)"
    - "User-generated text (card titles, descriptions, bio) is sanitized before database storage"
  artifacts:
    - path: "next.config.ts"
      provides: "Security headers applied to all routes"
      contains: "Content-Security-Policy"
    - path: "src/lib/csrf/index.ts"
      provides: "CSRF Origin validation helper"
      exports: ["validateCsrfOrigin"]
    - path: "src/lib/sanitize/index.ts"
      provides: "DOMPurify-based text sanitization"
      exports: ["sanitizeText"]
  key_links:
    - from: "src/app/api/cards/route.ts"
      to: "src/lib/csrf/index.ts"
      via: "imports validateCsrfOrigin for POST handler"
      pattern: "validateCsrfOrigin"
    - from: "src/app/api/cards/route.ts"
      to: "src/lib/sanitize/index.ts"
      via: "sanitizes card title/description before insert"
      pattern: "sanitizeText"
    - from: "next.config.ts"
      to: "all responses"
      via: "headers() function returns security headers"
      pattern: "Content-Security-Policy"
---

<objective>
Add HTTP security headers to all responses, CSRF origin validation to all mutation API routes, and input sanitization to all routes that store user-generated text.

Purpose: These three concerns are foundational hardening that protect against XSS, clickjacking, CSRF, and injection attacks. They touch existing files but don't depend on any other phase 12.6 work.
Output: Security headers in next.config.ts, CSRF helper in src/lib/csrf/, sanitize helper in src/lib/sanitize/, and all mutation API routes updated with CSRF + sanitization.
</objective>

<execution_context>
@/Users/julianmunyard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julianmunyard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12.6-security-hardening/12.6-RESEARCH.md
@next.config.ts
@src/app/api/cards/route.ts
@src/app/api/cards/[id]/route.ts
@src/app/api/theme/route.ts
@src/app/api/profile/route.ts
@src/app/api/audio/upload/route.ts
@src/app/api/audio/delete/route.ts
@src/app/api/page/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install isomorphic-dompurify, create CSRF helper and sanitize helper</name>
  <files>src/lib/csrf/index.ts, src/lib/sanitize/index.ts</files>
  <action>
**Step 1: Install isomorphic-dompurify.**

```bash
npm install isomorphic-dompurify
npm install -D @types/dompurify
```

**Step 2: Create `src/lib/csrf/index.ts`.**

CSRF validation helper that checks the Origin header against the Host header. This prevents cross-origin form submissions to mutation API routes.

```typescript
export function validateCsrfOrigin(request: Request): boolean {
  const origin = request.headers.get('origin')
  const host = request.headers.get('host')

  if (!origin || !host) return false

  try {
    const originHost = new URL(origin).host
    return originHost === host
  } catch {
    return false
  }
}
```

Export as named export. No default export.

**Step 3: Create `src/lib/sanitize/index.ts`.**

Text sanitization helper using isomorphic-dompurify. Strips ALL HTML tags — this app stores plain text only for user-generated content (card titles, descriptions, bio, display name).

```typescript
import DOMPurify from 'isomorphic-dompurify'

/** Strip all HTML tags from user input. For plain-text fields only. */
export function sanitizeText(input: string): string {
  return DOMPurify.sanitize(input, { ALLOWED_TAGS: [], ALLOWED_ATTR: [] })
}
```

This works on both server (Node.js via jsdom internally) and client (browser DOM). In Vercel serverless, each invocation is fresh so no memory concerns.
  </action>
  <verify>
- `ls src/lib/csrf/index.ts src/lib/sanitize/index.ts` — both exist
- `grep "validateCsrfOrigin" src/lib/csrf/index.ts` — export exists
- `grep "sanitizeText" src/lib/sanitize/index.ts` — export exists
- `grep "isomorphic-dompurify" package.json` — dependency installed
- `npx tsc --noEmit` — no type errors
  </verify>
  <done>
CSRF validation helper and sanitize helper created. isomorphic-dompurify installed. Both helpers export named functions ready for use in API routes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add security headers to next.config.ts and apply CSRF + sanitization to all mutation API routes</name>
  <files>next.config.ts, src/app/api/cards/route.ts, src/app/api/cards/[id]/route.ts, src/app/api/cards/bulk/route.ts, src/app/api/theme/route.ts, src/app/api/profile/route.ts, src/app/api/audio/upload/route.ts, src/app/api/audio/delete/route.ts, src/app/api/page/route.ts, src/app/api/emails/route.ts, src/app/api/legal/delete-account/route.ts, src/app/api/legal/export-data/route.ts, src/app/api/templates/apply/route.ts, src/app/api/import/linktree/route.ts</files>
  <action>
**Step 1: Add security headers to `next.config.ts`.**

Modify the existing `headers()` function to add a catch-all route with security headers AFTER the existing WASM-specific headers. Keep the existing WASM Content-Type headers intact.

Add a new entry to the headers array:

```typescript
{
  source: '/(.*)',
  headers: [
    {
      key: 'Strict-Transport-Security',
      value: 'max-age=31536000; includeSubDomains',
    },
    {
      key: 'X-Content-Type-Options',
      value: 'nosniff',
    },
    {
      key: 'X-Frame-Options',
      value: 'DENY',
    },
    {
      key: 'Referrer-Policy',
      value: 'strict-origin-when-cross-origin',
    },
    {
      key: 'Permissions-Policy',
      value: 'camera=(), microphone=(), geolocation=()',
    },
    {
      key: 'Content-Security-Policy',
      value: cspHeader,
    },
  ],
},
```

Define `cspHeader` as a const before the `nextConfig` object:

```typescript
const isDev = process.env.NODE_ENV === 'development'

const cspHeader = `
  default-src 'self';
  script-src 'self' 'unsafe-inline'${isDev ? " 'unsafe-eval'" : ''}
    https://*.supabase.co
    https://connect.facebook.net
    https://www.googletagmanager.com
    https://www.google-analytics.com;
  style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
  img-src 'self' blob: data: https://*.supabase.co https://i.ytimg.com
    https://i.vimeocdn.com https://p16-sign-sg.tiktokcdn.com
    https://www.facebook.com https://www.google-analytics.com;
  font-src 'self' https://fonts.gstatic.com;
  connect-src 'self' https://*.supabase.co https://www.google-analytics.com
    https://graph.facebook.com wss://*.supabase.co;
  frame-src https://www.youtube.com https://player.vimeo.com
    https://open.spotify.com https://w.soundcloud.com
    https://www.tiktok.com;
  media-src 'self' blob: https://*.supabase.co;
  worker-src 'self' blob:;
  object-src 'none';
  base-uri 'self';
  frame-ancestors 'none';
  upgrade-insecure-requests;
`.replace(/\s+/g, ' ').trim()
```

CRITICAL: Include `worker-src 'self' blob:` — without this, the Superpowered AudioWorklet processor (loaded as a blob worker) will break. Do NOT include `wasm-unsafe-eval` in script-src — the WASM loads fine with default `'self'` since it's served from same origin.

**Step 2: Apply CSRF validation to all mutation API routes.**

For each of the following routes, add `validateCsrfOrigin` check at the top of POST/PUT/PATCH/DELETE handlers:

```typescript
import { validateCsrfOrigin } from '@/lib/csrf'

// At the top of the mutation handler, before any auth or business logic:
if (!validateCsrfOrigin(request)) {
  return NextResponse.json({ error: 'CSRF validation failed' }, { status: 403 })
}
```

Routes to add CSRF validation to (mutation handlers only):
- `src/app/api/cards/route.ts` — POST handler
- `src/app/api/cards/[id]/route.ts` — PUT and DELETE handlers
- `src/app/api/cards/bulk/route.ts` — POST handler
- `src/app/api/theme/route.ts` — POST/PUT handler
- `src/app/api/profile/route.ts` — POST/PUT handler
- `src/app/api/audio/upload/route.ts` — POST handler
- `src/app/api/audio/delete/route.ts` — POST/DELETE handler
- `src/app/api/page/route.ts` — POST/PUT handler
- `src/app/api/emails/route.ts` — POST handler (the one that saves email submissions from public pages — wait, this is a PUBLIC endpoint. Do NOT add CSRF to this one.)
- `src/app/api/legal/delete-account/route.ts` — POST/DELETE handler
- `src/app/api/legal/export-data/route.ts` — POST handler
- `src/app/api/templates/apply/route.ts` — POST handler
- `src/app/api/import/linktree/route.ts` — POST handler

Do NOT add CSRF to these public/third-party endpoints:
- `src/app/api/analytics/track/route.ts` — public analytics tracking
- `src/app/api/pixels/facebook-capi/route.ts` — server-side pixel event
- `src/app/api/pixels/test-event/route.ts` — pixel testing
- `src/app/api/emails/route.ts` — public email collection from visitor pages

**Step 3: Apply input sanitization to routes that store user text.**

In routes that accept user text and store it in the database, wrap the text fields with `sanitizeText()` before inserting/updating:

```typescript
import { sanitizeText } from '@/lib/sanitize'
```

Routes that need sanitization on text fields:
- `src/app/api/cards/route.ts` POST — sanitize `title`, `description`, `content` fields if present in the body
- `src/app/api/cards/[id]/route.ts` PUT — sanitize `title`, `description`, `content` fields
- `src/app/api/profile/route.ts` POST/PUT — sanitize `display_name`, `bio` fields
- `src/app/api/page/route.ts` POST/PUT — sanitize `title`, `description` fields if present

Apply sanitization AFTER parsing the request body but BEFORE the database insert/update. Only sanitize string fields that exist in the body (don't break if field is undefined).

Pattern:
```typescript
const body = await request.json()
if (body.title) body.title = sanitizeText(body.title)
if (body.description) body.description = sanitizeText(body.description)
```
  </action>
  <verify>
- `grep "Content-Security-Policy" next.config.ts` — CSP header present
- `grep "Strict-Transport-Security" next.config.ts` — HSTS present
- `grep "worker-src" next.config.ts` — blob: allowed for AudioWorklet
- `grep "validateCsrfOrigin" src/app/api/cards/route.ts` — CSRF check in cards route
- `grep "validateCsrfOrigin" src/app/api/profile/route.ts` — CSRF check in profile route
- `grep "sanitizeText" src/app/api/cards/route.ts` — sanitization in cards route
- `grep "sanitizeText" src/app/api/profile/route.ts` — sanitization in profile route
- `grep -L "validateCsrfOrigin" src/app/api/analytics/track/route.ts` — CSRF NOT in analytics (public endpoint)
- `npx tsc --noEmit` — no type errors
  </verify>
  <done>
Security headers added to all HTTP responses via next.config.ts. CSP allows all required embed domains and Superpowered WASM. CSRF origin validation added to all authenticated mutation API routes. Input sanitization applied to all routes that store user-generated text. Public endpoints (analytics, email collection, pixels) are NOT CSRF-gated.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. Security headers present in next.config.ts headers() function
3. CSP includes worker-src blob: (critical for Superpowered audio)
4. CSP includes frame-src for all embed providers (YouTube, Vimeo, Spotify, SoundCloud, TikTok)
5. CSRF validation present in all authenticated mutation routes
6. CSRF NOT present in public endpoints (analytics/track, emails, pixels)
7. sanitizeText applied before database writes for user text fields
8. `npm run build` succeeds (CSP doesn't break static generation — no nonces used)
</verification>

<success_criteria>
- All responses include 6 security headers (CSP, HSTS, X-Content-Type-Options, X-Frame-Options, Referrer-Policy, Permissions-Policy)
- CSP correctly allows all third-party embeds and Superpowered WASM
- All authenticated mutation routes validate CSRF origin
- User text is sanitized before storage
- No type errors
</success_criteria>

<output>
After completion, create `.planning/phases/12.6-security-hardening/12.6-01-SUMMARY.md`
</output>
