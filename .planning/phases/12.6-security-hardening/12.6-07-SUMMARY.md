---
phase: 12.6-security-hardening
plan: 07
subsystem: api
tags: [storage, mime-validation, quota, supabase, file-upload]

# Dependency graph
requires:
  - phase: 12.6-01
    provides: CSRF validation and sanitization used in all API routes
  - phase: 12.6-02
    provides: Rate limiting applied to all API routes including audio upload/delete
provides:
  - Server-side MIME validation on audio uploads (415 on invalid type)
  - Image MIME validation in storage utility (all 3 upload functions)
  - 500MB per-user storage quota enforced on audio upload (413 on exceed)
  - storage_used_bytes column in profiles table (via migration)
  - Storage usage tracking: increment on upload, decrement on delete
  - Orphaned file cleanup when cards are deleted (audio + images)
  - StorageUsageBar component for settings page
affects: [settings page, audio upload flow, card deletion, profile storage]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Quota check: query profiles.storage_used_bytes before upload, reject 413 if exceeded"
    - "Storage decrement: query Supabase Storage .list() metadata BEFORE deletion to get authoritative file size"
    - "Orphaned file cleanup: try/catch wraps storage cleanup after DB delete so storage failure never affects API response"
    - "MIME validation: allowlist-based check (ALLOWED_AUDIO_TYPES / ALLOWED_IMAGE_TYPES) rather than loose prefix check"

key-files:
  created:
    - supabase/migrations/20260225_storage_quota.sql
    - src/components/settings/storage-usage-bar.tsx
  modified:
    - src/app/api/audio/upload/route.ts
    - src/app/api/audio/delete/route.ts
    - src/app/api/cards/[id]/route.ts
    - src/app/(dashboard)/settings/page.tsx
    - src/lib/supabase/storage.ts

key-decisions:
  - "Use finalBuffer.length (post-conversion size) not file.size for storage increment — more accurate for non-MP3 uploads that get re-encoded"
  - "Query Storage .list() metadata BEFORE deletion to get authoritative file size — never trust client-sent sizes"
  - "Wrap orphaned file cleanup in try/catch — card already deleted from DB, storage failure must not block the 200 response"
  - "ALLOWED_IMAGE_TYPES replaces loose startsWith('image/') check — prevents SVG/TIFF/exotic types that could cause rendering issues"

patterns-established:
  - "Storage quota pattern: check quota before heavy operations, use server-authoritative sizes for tracking"
  - "Orphaned resource cleanup: always attempt cleanup after DB delete, never let cleanup failure propagate"

# Metrics
duration: 2min
completed: 2026-02-25
---

# Phase 12.6 Plan 07: Storage Quota & MIME Validation Summary

**Server-side MIME allowlists on audio/image uploads, 500MB per-user quota tracked in profiles.storage_used_bytes, orphaned file cleanup on card delete, and settings storage usage bar**

## Performance

- **Duration:** 2 min
- **Started:** 2026-02-25T08:25:30Z
- **Completed:** 2026-02-25T08:27:54Z
- **Tasks:** 2
- **Files modified:** 7

## Accomplishments
- Audio upload now validates MIME type server-side (ALLOWED_AUDIO_TYPES allowlist, 415 on invalid)
- Image uploads in storage utility now validate MIME type (ALLOWED_IMAGE_TYPES, all 3 upload functions updated)
- 500MB per-user quota enforced: rejects with 413 before reading file into memory
- storage_used_bytes tracked in profiles: incremented on upload (finalBuffer.length), decremented on audio delete (authoritative size from Storage metadata)
- Card DELETE cleans up associated audio + image files from Supabase Storage, decrements quota
- StorageUsageBar component with green/yellow/red thresholds, rendered in Settings > Storage section

## Task Commits

Each task was committed atomically:

1. **Task 1: MIME validation, quota migration, and quota enforcement** - `f1dc539` (feat)
2. **Task 2: Orphaned file cleanup, storage decrement, and usage bar** - `0736a9e` (feat)

**Plan metadata:** (docs commit follows)

## Files Created/Modified
- `supabase/migrations/20260225_storage_quota.sql` - Adds storage_used_bytes BIGINT column to profiles
- `src/app/api/audio/upload/route.ts` - MIME validation (415), quota check (413), usage increment
- `src/app/api/audio/delete/route.ts` - Get file size from Storage metadata before delete, decrement usage
- `src/app/api/cards/[id]/route.ts` - Orphaned file cleanup for card-audio/ and card-images/ on card DELETE
- `src/lib/supabase/storage.ts` - ALLOWED_IMAGE_TYPES constant, strict MIME check in all 3 image upload functions
- `src/components/settings/storage-usage-bar.tsx` - Progress bar component with color thresholds
- `src/app/(dashboard)/settings/page.tsx` - Import StorageUsageBar, fetch storage_used_bytes, render Storage section

## Decisions Made
- Used `finalBuffer.length` (post-MP3-conversion size) not `file.size` for the storage increment — more accurate when non-MP3 files get re-encoded and may be larger or smaller than the original upload
- Query Supabase Storage `.list()` metadata before deletion to obtain the authoritative file size — never accept file sizes from the client
- Wrapped orphaned file cleanup in try/catch in the card DELETE handler — the card is already removed from the DB at that point, so a storage API failure must not change the 200 response
- Replaced the loose `startsWith('image/')` check in `uploadCardImage` with the strict allowlist — this prevents SVG, TIFF, BMP, AVIF, and other types that could cause rendering or security concerns

## Deviations from Plan

None — plan executed exactly as written.

## Issues Encountered
None.

## User Setup Required

For defense-in-depth, configure bucket-level MIME restrictions in the Supabase Dashboard:
- Storage → `card-images` bucket → Policies → Add allowed MIME types: `image/jpeg, image/png, image/webp, image/gif`
- Storage → `profile-images` bucket → Policies → Add allowed MIME types: `image/jpeg, image/png, image/webp, image/gif`

This provides server-enforced restrictions that cannot be bypassed even if client-side validation is circumvented. The SQL migration (`20260225_storage_quota.sql`) must be applied to Supabase via `supabase db push` or the Supabase Dashboard SQL editor.

## Next Phase Readiness
- Phase 12.6 security hardening is complete (all 7 plans done)
- Storage quota and MIME validation are in place for production safety
- `profiles.storage_used_bytes` column migration must be applied to Supabase before deploying
- No blockers for the next phase

---
*Phase: 12.6-security-hardening*
*Completed: 2026-02-25*
