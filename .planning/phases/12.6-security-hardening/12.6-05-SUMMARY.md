---
phase: 12.6-security-hardening
plan: 05
subsystem: auth
tags: [2fa, totp, mfa, backup-codes, bcryptjs, supabase-mfa, middleware, aal2]

# Dependency graph
requires:
  - phase: 12.6-01
    provides: CSRF validation (validateCsrfOrigin) used in backup-codes routes
  - phase: 12.6-02
    provides: Rate limiting (loginRatelimit, generalApiRatelimit) used in backup-codes routes
provides:
  - TOTP 2FA enrollment UI (QR code + secret + TOTP verify) in settings
  - Backup codes: 10 generated, bcrypt-hashed, stored in mfa_backup_codes table
  - TwoFactorStatus component for settings page (shows enrolled state, disable, regenerate)
  - MFA challenge page /mfa-challenge for post-login aal2 verification
  - Middleware enforces aal2 for users with TOTP enrolled — redirects aal1 to /mfa-challenge
  - Backup code bypass cookie (mfa_backup_verified, httpOnly, 24h) for non-TOTP auth
affects: [any future auth changes, settings page additions, middleware changes]

# Tech tracking
tech-stack:
  added: [bcryptjs, @types/bcryptjs]
  patterns: [httpOnly cookie for backup code MFA bypass, supabase mfa.getAuthenticatorAssuranceLevel in middleware, bcrypt constant-time comparison for backup codes]

key-files:
  created:
    - supabase/migrations/20260225_mfa_backup_codes.sql
    - src/app/api/auth/backup-codes/route.ts
    - src/app/api/auth/backup-codes/verify/route.ts
    - src/components/auth/two-factor-setup.tsx
    - src/components/auth/two-factor-verify.tsx
    - src/app/(auth)/mfa-challenge/page.tsx
    - src/app/(auth)/mfa-challenge/mfa-challenge-form.tsx
  modified:
    - src/middleware.ts
    - src/lib/supabase/middleware.ts
    - src/app/(dashboard)/settings/page.tsx
    - src/app/api/auth/signout/route.ts

key-decisions:
  - "bcryptjs (pure JS) used instead of native bcrypt — no node-gyp compilation on Vercel"
  - "httpOnly cookie mfa_backup_verified for backup code session bypass — Supabase cannot upgrade AAL via backup codes"
  - "middleware.ts gets supabase client from updateSession (not a second createServerClient) for MFA check"
  - "loginRatelimit (5/15min) on backup-code verify — brute-force sensitive, each attempt consumes a real code"
  - "/mfa-challenge added to protectedPaths to require auth, excluded from MFA redirect to prevent loops"
  - "mfa_backup_verified cookie cleared on sign-out in signout route"

patterns-established:
  - "MFA AAL check: supabase.auth.mfa.getAuthenticatorAssuranceLevel() in middleware, currentLevel=aal1+nextLevel=aal2 triggers redirect"
  - "Backup codes: 10x crypto.randomBytes(5).toString('hex').toUpperCase(), bcrypt salt 10, stored hashed, compared constant-time"
  - "TOTP enrollment: mfa.enroll() -> show QR+secret -> mfa.challenge() -> mfa.verify() -> generate backup codes"

# Metrics
duration: 3min
completed: 2026-02-25
---

# Phase 12.6 Plan 05: TOTP 2FA with Backup Codes and Middleware Enforcement Summary

**TOTP two-factor authentication with bcrypt-hashed backup codes, settings UI, MFA challenge page, and middleware AAL2 enforcement using Supabase MFA APIs**

## Performance

- **Duration:** ~3 min
- **Started:** 2026-02-25T00:35:53Z
- **Completed:** 2026-02-25T00:38:53Z
- **Tasks:** 3
- **Files modified:** 11

## Accomplishments
- Full TOTP enrollment flow: QR code display, TOTP verification, backup code generation in settings
- mfa_backup_codes table with RLS + bcrypt-hashed storage + single-use enforcement
- MFA challenge page with TOTP and backup code modes, httpOnly cookie bypass
- Middleware enforces AAL2 for enrolled users — aal1 sessions redirected to /mfa-challenge
- Sign-out clears mfa_backup_verified bypass cookie

## Task Commits

Each task was committed atomically:

1. **Task 1: mfa_backup_codes table, backup codes API routes, 2FA setup/status components** - `3231721` (feat)
2. **Task 2: MFA challenge page and Security section in settings** - `51961ed` (feat)
3. **Task 3: Middleware MFA AAL enforcement with redirect loop protection** - `b9e103a` (feat)

**Plan metadata:** (docs commit follows)

## Files Created/Modified
- `supabase/migrations/20260225_mfa_backup_codes.sql` - mfa_backup_codes table, index, RLS enabled (no public policies)
- `src/app/api/auth/backup-codes/route.ts` - POST: generates 10 bcrypt-hashed backup codes, CSRF + generalApiRatelimit
- `src/app/api/auth/backup-codes/verify/route.ts` - POST: verifies backup code, marks used, sets mfa_backup_verified cookie, CSRF + loginRatelimit
- `src/components/auth/two-factor-setup.tsx` - TwoFactorSetup: idle -> qr_code -> backup_codes -> complete enrollment flow
- `src/components/auth/two-factor-verify.tsx` - TwoFactorStatus: shows 2FA status, disable, regenerate backup codes
- `src/app/(auth)/mfa-challenge/page.tsx` - MFA challenge page shell in (auth) layout
- `src/app/(auth)/mfa-challenge/mfa-challenge-form.tsx` - MfaChallengeForm: TOTP and backup code modes
- `src/middleware.ts` - MFA AAL enforcement: redirects aal1+nextLevel=aal2 to /mfa-challenge
- `src/lib/supabase/middleware.ts` - Returns supabase client for middleware MFA check
- `src/app/(dashboard)/settings/page.tsx` - Security section added with TwoFactorStatus
- `src/app/api/auth/signout/route.ts` - Clears mfa_backup_verified cookie on sign-out

## Decisions Made
- **bcryptjs not bcrypt:** Pure JS implementation avoids node-gyp compilation failures on Vercel Edge
- **httpOnly cookie for backup code bypass:** Supabase MFA APIs can only upgrade AAL via TOTP verify, not backup codes. The mfa_backup_verified cookie is the pragmatic solution — httpOnly + SameSite=Strict + 24h expiry
- **loginRatelimit on backup code verify:** Each attempt is brute-force sensitive (each code is single-use, compare is bcrypt which is slow by design). 5/15min is appropriate
- **updateSession returns supabase client:** Avoids creating a second Supabase client in middleware — reuses the same authenticated client that already validated the JWT

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered
None - all Supabase MFA APIs are available on the client version in use.

## User Setup Required
None - no external service configuration required. Supabase MFA (TOTP) is enabled by default in Supabase projects.

## Next Phase Readiness
- 2FA implementation complete for Plan 05
- Plans 06 and 07 of Phase 12.6 can proceed
- The mfa_backup_codes table migration needs to be run in production: `supabase db push` or apply migration manually

---
*Phase: 12.6-security-hardening*
*Completed: 2026-02-25*
