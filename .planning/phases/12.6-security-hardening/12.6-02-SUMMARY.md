---
phase: 12.6-security-hardening
plan: 02
subsystem: api
tags: [ratelimit, upstash, redis, security, rate-limiting, api, nextjs]

# Dependency graph
requires:
  - phase: 12.6-01
    provides: CSRF validation already in place on mutation routes; this plan builds on that structure

provides:
  - Upstash Redis rate limiting library with 7 pre-configured sliding window instances
  - checkRateLimit helper with fail-open (Redis timeout) behavior
  - Rate limits applied to all 16 API routes
  - IP extraction helper for public endpoint rate limiting
  - 429 responses with Retry-After header

affects:
  - 12.6-03 (backup code routes should use loginRatelimit/generalApiRatelimit per mapping in plan)
  - Any future API routes added to the project

# Tech tracking
tech-stack:
  added:
    - "@upstash/ratelimit ^2.0.8 — sliding window rate limiting"
    - "@upstash/redis ^1.36.2 — serverless Redis client"
  patterns:
    - "Fail-open rate limiting: null limiter when env vars missing, timeout check when Redis down"
    - "checkRateLimit helper abstracts fail-open logic — call site is a clean 2-liner"
    - "Authenticated routes keyed by user.id, public routes keyed by client IP"
    - "Rate limit check after auth, before business logic"

key-files:
  created:
    - src/lib/ratelimit/index.ts
  modified:
    - src/app/api/cards/route.ts
    - src/app/api/cards/[id]/route.ts
    - src/app/api/cards/bulk/route.ts
    - src/app/api/theme/route.ts
    - src/app/api/profile/route.ts
    - src/app/api/audio/upload/route.ts
    - src/app/api/audio/delete/route.ts
    - src/app/api/page/route.ts
    - src/app/api/emails/route.ts
    - src/app/api/analytics/track/route.ts
    - src/app/api/analytics/stats/route.ts
    - src/app/api/legal/delete-account/route.ts
    - src/app/api/templates/apply/route.ts
    - src/app/api/import/linktree/route.ts
    - src/app/api/mailchimp/sync/route.ts
    - src/app/api/auth/signout/route.ts

key-decisions:
  - "Conditional Redis.fromEnv(): only called when UPSTASH_REDIS_REST_URL env var exists — prevents import-time crashes in dev/CI without Upstash configured"
  - "createRatelimit() returns null when redis is null — checkRateLimit allows all requests when limiter is null"
  - "reason !== 'timeout' for fail-open: Upstash returns {success:false, reason:'timeout'} on Redis unavailability — we let those through"
  - "cards/route.ts GET uses createClient() directly to get user.id for rate limit key, since fetchUserPage() only returns {id}"
  - "analytics/track.ts: IP reuse for both rate limit key and visitor hash (avoids second header read)"
  - "auth/signout: rate limit only applied when user session exists; unauthenticated signout still proceeds"

patterns-established:
  - "Rate limit pattern: const rl = await checkRateLimit(limiter, key); if (!rl.allowed) return rl.response!"
  - "Public endpoint pattern: const ip = getClientIp(request); checkRateLimit(publicLimiter, ip)"
  - "Auth + rate limit order: auth check first (to get user.id), rate limit second, business logic third"

# Metrics
duration: 5min
completed: 2026-02-25
---

# Phase 12.6 Plan 02: Rate Limiting Summary

**Upstash Redis sliding-window rate limiting applied to all 16 API routes — auth endpoints get user-keyed limits, public endpoints get IP-keyed limits, with fail-open behavior when Redis is unavailable**

## Performance

- **Duration:** 5 min
- **Started:** 2026-02-25T08:07:52Z
- **Completed:** 2026-02-25T08:12:54Z
- **Tasks:** 2
- **Files modified:** 17 (1 created + 16 modified)

## Accomplishments

- Installed @upstash/ratelimit and @upstash/redis; created `src/lib/ratelimit/index.ts` with 7 sliding-window instances and fail-open guards
- Applied rate limiting to all 16 API routes with correct limiter selection per endpoint type
- Public routes (/api/emails, /api/analytics/track) rate-limited by client IP; authenticated routes rate-limited by user.id
- Audio upload gets stricter 5/hour limit; all other authenticated routes get 60/minute general limit

## Task Commits

1. **Task 1: Install Upstash and create rate limit instances** - `0984ace` (feat)
2. **Task 2: Apply rate limits to all API routes** - `fe264ad` (feat)

## Files Created/Modified

- `src/lib/ratelimit/index.ts` - Core module: 7 Ratelimit instances, checkRateLimit helper, getClientIp, rateLimitResponse
- `src/app/api/cards/route.ts` - generalApiRatelimit on GET + POST
- `src/app/api/cards/[id]/route.ts` - generalApiRatelimit on PUT, PATCH, DELETE
- `src/app/api/cards/bulk/route.ts` - generalApiRatelimit on POST
- `src/app/api/theme/route.ts` - generalApiRatelimit on GET + POST
- `src/app/api/profile/route.ts` - generalApiRatelimit on GET + POST
- `src/app/api/audio/upload/route.ts` - audioUploadRatelimit (5/hour) on POST
- `src/app/api/audio/delete/route.ts` - generalApiRatelimit on DELETE
- `src/app/api/page/route.ts` - generalApiRatelimit on GET + PATCH
- `src/app/api/emails/route.ts` - emailCollectionRatelimit (10/min) by IP
- `src/app/api/analytics/track/route.ts` - analyticsRatelimit (30/min) by IP
- `src/app/api/analytics/stats/route.ts` - generalApiRatelimit on GET
- `src/app/api/legal/delete-account/route.ts` - generalApiRatelimit on POST + PATCH
- `src/app/api/templates/apply/route.ts` - generalApiRatelimit on POST
- `src/app/api/import/linktree/route.ts` - generalApiRatelimit on POST
- `src/app/api/mailchimp/sync/route.ts` - generalApiRatelimit on POST
- `src/app/api/auth/signout/route.ts` - generalApiRatelimit on POST (when session exists)

## Decisions Made

- **Conditional Redis client creation**: `Redis.fromEnv()` only called when `UPSTASH_REDIS_REST_URL` is set — prevents import-time crashes in dev/CI environments without Upstash configured. When env var is absent, all limiters are `null` and `checkRateLimit` allows all requests through.
- **`reason !== 'timeout'` for fail-open**: Upstash timeout returns `{success: false, reason: 'timeout'}` — we treat this as allowed to avoid blocking users during Redis outages.
- **`createClient()` in GET handlers**: Routes that previously only used `fetchUserPage()` now also call `createClient().auth.getUser()` directly to obtain `user.id` for the rate limit key, since `fetchUserPage()` only returns `{id: string}`.
- **auth/signout rate limit**: Only applied when a valid session exists (soft guard). Unauthenticated signout still proceeds normally since it's a no-op.

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] page/route.ts had undiscovered PATCH handler**

- **Found during:** Task 2 (applying rate limits to page/route.ts)
- **Issue:** Initial file read showed only a GET handler; re-read after linter modification revealed a PATCH handler also exists (was added by a prior plan). The PATCH handler also needed rate limiting.
- **Fix:** Applied generalApiRatelimit to both GET and PATCH handlers.
- **Files modified:** src/app/api/page/route.ts
- **Verification:** TypeScript type check passes
- **Committed in:** fe264ad (Task 2 commit)

**2. [Rule 3 - Blocking] linktree/route.ts duplicate createClient() after auth refactor**

- **Found during:** Task 2 (linktree route update)
- **Issue:** Original route called `createClient()` lower in the handler body to get the supabase client for storage operations. After adding auth+rate-limit at the top, there were two `createClient()` calls creating two Supabase client instances per request.
- **Fix:** Removed the lower duplicate `createClient()` call, using the already-created supabase instance from the auth check.
- **Files modified:** src/app/api/import/linktree/route.ts
- **Verification:** TypeScript type check passes, single client instance per request
- **Committed in:** fe264ad (Task 2 commit)

---

**Total deviations:** 2 auto-fixed (1 bug, 1 blocking)
**Impact on plan:** Both auto-fixes necessary for correctness. No scope creep.

## Issues Encountered

None - plan executed cleanly after minor structural adjustments.

## User Setup Required

**External services require manual configuration.**

Upstash Redis environment variables must be added before rate limiting is active in production:

| Variable | Source |
|---|---|
| `UPSTASH_REDIS_REST_URL` | Upstash Console -> Create Database -> REST URL |
| `UPSTASH_REDIS_REST_TOKEN` | Upstash Console -> Create Database -> REST Token |

Until these are set, rate limiting is disabled (fail-open — all requests allowed through). The app functions normally without them; they only need to be set before launching to production.

## Next Phase Readiness

- Rate limiting infrastructure complete and active for all API routes
- Plan 03 (Google OAuth + password reset) already complete
- Remaining plans: 04 (email verification), 05 (2FA backup codes), 06 (audit logs), 07 (final hardening)
- Backup code routes (Plan 05) should use `loginRatelimit` (brute force sensitive) per the limiter mapping in this plan's task 2 notes

---
*Phase: 12.6-security-hardening*
*Completed: 2026-02-25*
