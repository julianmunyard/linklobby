---
phase: 09-platform-integrations
plan: 03
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - src/components/cards/music-card.tsx
  - src/components/editor/music-card-fields.tsx
autonomous: true

must_haves:
  truths:
    - "Spotify embeds render and play in music cards"
    - "Apple Music embeds render and play in music cards"
    - "SoundCloud embeds render and play in music cards"
    - "Audiomack embeds render and play in music cards"
    - "Bandcamp embeds render with fallback until album ID is available"
    - "Music card editor allows pasting URLs and auto-detects platform"
  artifacts:
    - path: "src/components/cards/music-card.tsx"
      provides: "Music card component rendering platform embeds"
      exports: ["MusicCard"]
    - path: "src/components/editor/music-card-fields.tsx"
      provides: "Editor fields for music card configuration"
      exports: ["MusicCardFields"]
  key_links:
    - from: "src/components/cards/music-card.tsx"
      to: "src/lib/platform-embed.ts"
      via: "getEmbedUrl import"
      pattern: "getEmbedUrl"
    - from: "src/components/editor/music-card-fields.tsx"
      to: "src/lib/platform-embed.ts"
      via: "detectPlatform and fetchPlatformEmbed"
      pattern: "detectPlatform|fetchPlatformEmbed"
---

<objective>
Create the Music Card component and editor fields for embedding music from Spotify, Apple Music, SoundCloud, Bandcamp, and Audiomack.

Purpose: This is the core vertical slice for music platform integrations - the component that renders embeds and the editor that configures them.

Output: Working music card that displays platform embeds, and editor fields that auto-detect platforms from pasted URLs.
</objective>

<execution_context>
@/Users/julianmunyard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julianmunyard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/09-platform-integrations/09-CONTEXT.md
@.planning/phases/09-platform-integrations/09-RESEARCH.md
@src/types/card.ts
@src/lib/platform-embed.ts
@src/components/cards/video-card.tsx
@src/components/editor/video-card-fields.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MusicCard component</name>
  <files>src/components/cards/music-card.tsx</files>
  <action>
Create the music card component following the video-card.tsx pattern:

```typescript
// src/components/cards/music-card.tsx
'use client'

import { useState } from 'react'
import Image from 'next/image'
import { Music, Play } from 'lucide-react'
import { SiSpotify, SiApplemusic, SiSoundcloud, SiBandcamp, SiAudiomack } from 'react-icons/si'
import { useThemeStore } from '@/stores/theme-store'
import { getEmbedUrl } from '@/lib/platform-embed'
import type { Card, MusicCardContent, MusicPlatform } from '@/types/card'
import { isMusicContent } from '@/types/card'

// Platform icon mapping
const PLATFORM_ICONS: Record<MusicPlatform, React.ComponentType<{ className?: string }>> = {
  spotify: SiSpotify,
  'apple-music': SiApplemusic,
  soundcloud: SiSoundcloud,
  bandcamp: SiBandcamp,
  audiomack: SiAudiomack,
}

// Platform colors for accents
const PLATFORM_COLORS: Record<MusicPlatform, string> = {
  spotify: '#1DB954',
  'apple-music': '#FA243C',
  soundcloud: '#FF5500',
  bandcamp: '#629AA9',
  audiomack: '#FFA500',
}

// Embed heights per platform (Spotify compact=152, full=352, etc)
const EMBED_HEIGHTS: Record<MusicPlatform, number> = {
  spotify: 352,
  'apple-music': 175,  // Apple Music album embed height
  soundcloud: 166,     // Single track height
  bandcamp: 120,       // Slim player
  audiomack: 252,      // Standard height
}

interface MusicCardProps {
  card: Card
  isPreview?: boolean
}

export function MusicCard({ card, isPreview = false }: MusicCardProps) {
  const themeId = useThemeStore((state) => state.themeId)
  const [isPlaying, setIsPlaying] = useState(false)
  const [loadError, setLoadError] = useState(false)

  // Type guard for content
  if (!isMusicContent(card.content)) {
    return <MusicCardPlaceholder />
  }

  const content = card.content as MusicCardContent
  const { platform, embedUrl, embedIframeUrl, thumbnailUrl, title } = content

  // No platform/URL configured yet
  if (!platform || !embedUrl) {
    return <MusicCardPlaceholder />
  }

  const PlatformIcon = PLATFORM_ICONS[platform]
  const platformColor = PLATFORM_COLORS[platform]
  const embedHeight = EMBED_HEIGHTS[platform]

  // Get iframe URL
  const iframeUrl = embedIframeUrl || getEmbedUrl(embedUrl, platform)

  // Error state
  if (loadError) {
    return (
      <div className="relative w-full rounded-xl overflow-hidden bg-muted flex flex-col items-center justify-center p-6 text-center"
           style={{ minHeight: embedHeight }}>
        <PlatformIcon className="h-10 w-10 mb-3" style={{ color: platformColor }} />
        <p className="text-sm text-muted-foreground mb-2">Content unavailable</p>
        <a
          href={embedUrl}
          target="_blank"
          rel="noopener noreferrer"
          className="text-xs text-primary hover:underline"
        >
          Open on {platform.replace('-', ' ')}
        </a>
      </div>
    )
  }

  // Click-to-load pattern (performance optimization)
  if (!isPlaying) {
    return (
      <button
        onClick={() => setIsPlaying(true)}
        className="relative w-full rounded-xl overflow-hidden bg-muted group cursor-pointer block"
        style={{ minHeight: embedHeight }}
        aria-label={`Play ${title || 'music'} on ${platform}`}
      >
        {/* Thumbnail or gradient background */}
        {thumbnailUrl ? (
          <Image
            src={thumbnailUrl}
            alt={title || 'Music thumbnail'}
            fill
            className="object-cover"
            sizes="(max-width: 768px) 100vw, 600px"
          />
        ) : (
          <div
            className="absolute inset-0"
            style={{
              background: `linear-gradient(135deg, ${platformColor}20 0%, ${platformColor}05 100%)`
            }}
          />
        )}

        {/* Platform icon + play button */}
        <div className="absolute inset-0 flex flex-col items-center justify-center">
          <PlatformIcon
            className="h-12 w-12 mb-3 opacity-60"
            style={{ color: platformColor }}
          />
          <div className="w-12 h-12 rounded-full bg-black/40 backdrop-blur-sm flex items-center justify-center transition-transform group-hover:scale-110 border border-white/20">
            <Play className="h-5 w-5 text-white ml-0.5" fill="currentColor" />
          </div>
          {title && (
            <p className="mt-3 text-sm text-white/80 max-w-[80%] truncate">
              {title}
            </p>
          )}
        </div>
      </button>
    )
  }

  // Active embed
  return (
    <div className="relative w-full rounded-xl overflow-hidden">
      <iframe
        src={iframeUrl}
        width="100%"
        height={embedHeight}
        frameBorder="0"
        allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"
        loading="lazy"
        onError={() => setLoadError(true)}
        title={title || `${platform} embed`}
        style={{ borderRadius: 'inherit' }}
      />
    </div>
  )
}

// Placeholder when no music configured
function MusicCardPlaceholder() {
  return (
    <div className="relative w-full aspect-video rounded-xl overflow-hidden bg-muted flex items-center justify-center">
      <div className="text-center text-muted-foreground">
        <Music className="h-12 w-12 mx-auto mb-2" />
        <p>Add music URL</p>
        <p className="text-xs mt-1">Spotify, Apple Music, SoundCloud, Bandcamp, Audiomack</p>
      </div>
    </div>
  )
}
```

**Platform-specific notes from RESEARCH.md:**

1. **Spotify:** Uses `open.spotify.com/embed/track/ID` format. Height 352 for full, 152 for compact.

2. **Apple Music:** Uses `embed.music.apple.com/COUNTRY/album/...` format. No programmatic pause.

3. **SoundCloud:** Uses widget URL with params: `w.soundcloud.com/player/?url=...&auto_play=false`

4. **Bandcamp:** Needs album ID. For now, show placeholder if no bandcampAlbumId. Add note that full Bandcamp support requires page scraping.

5. **Audiomack:** Uses `audiomack.com/embed/song/ARTIST/TITLE` format.

**Styling notes:**
- Follow existing card patterns (rounded-xl, overflow-hidden)
- Platform icons from react-icons (Si* prefix)
- Click-to-load pattern like video card for performance
- Error state shows platform icon with "Content unavailable" and link to original
  </action>
  <verify>
1. File exists: `ls src/components/cards/music-card.tsx`
2. TypeScript compiles: `npx tsc --noEmit`
3. Component exports MusicCard: `grep -n "export function MusicCard" src/components/cards/music-card.tsx`
  </verify>
  <done>
MusicCard component renders embeds for all 5 music platforms with click-to-load pattern, error handling, and platform-specific styling.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create MusicCardFields editor component</name>
  <files>src/components/editor/music-card-fields.tsx</files>
  <action>
Create the editor fields component following video-card-fields.tsx pattern:

```typescript
// src/components/editor/music-card-fields.tsx
'use client'

import { useState } from 'react'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { Loader2, AlertCircle, CheckCircle2 } from 'lucide-react'
import { SiSpotify, SiApplemusic, SiSoundcloud, SiBandcamp, SiAudiomack } from 'react-icons/si'
import { detectPlatform, fetchPlatformEmbed } from '@/lib/platform-embed'
import type { MusicCardContent, MusicPlatform } from '@/types/card'

// Platform display info
const PLATFORM_INFO: Record<MusicPlatform, { name: string; icon: React.ComponentType<{ className?: string }> }> = {
  spotify: { name: 'Spotify', icon: SiSpotify },
  'apple-music': { name: 'Apple Music', icon: SiApplemusic },
  soundcloud: { name: 'SoundCloud', icon: SiSoundcloud },
  bandcamp: { name: 'Bandcamp', icon: SiBandcamp },
  audiomack: { name: 'Audiomack', icon: SiAudiomack },
}

interface MusicCardFieldsProps {
  content: MusicCardContent
  onChange: (updates: Record<string, unknown>) => void
  cardId: string
}

export function MusicCardFields({ content, onChange, cardId }: MusicCardFieldsProps) {
  const [urlInput, setUrlInput] = useState(content.embedUrl || '')
  const [isLoading, setIsLoading] = useState(false)
  const [error, setError] = useState<string | null>(null)

  // Handle URL input blur - detect platform and fetch metadata
  async function handleUrlBlur() {
    const url = urlInput.trim()

    // Clear if empty
    if (!url) {
      onChange({
        platform: undefined,
        embedUrl: undefined,
        embedIframeUrl: undefined,
        thumbnailUrl: undefined,
        title: undefined,
      })
      setError(null)
      return
    }

    setIsLoading(true)
    setError(null)

    try {
      // Detect platform from URL
      const detected = detectPlatform(url)

      if (!detected) {
        setError('URL not recognized. Supported: Spotify, Apple Music, SoundCloud, Bandcamp, Audiomack')
        return
      }

      const { platform } = detected

      // Check if it's a music platform
      const musicPlatforms: MusicPlatform[] = ['spotify', 'apple-music', 'soundcloud', 'bandcamp', 'audiomack']
      if (!musicPlatforms.includes(platform as MusicPlatform)) {
        setError(`${platform} is not a music platform. Use Video card for videos.`)
        return
      }

      // Fetch metadata via oEmbed (if available)
      const embedInfo = await fetchPlatformEmbed(url, platform)

      onChange({
        platform,
        embedUrl: url,
        embedIframeUrl: embedInfo.embedUrl,
        thumbnailUrl: embedInfo.thumbnailUrl,
        title: embedInfo.title,
      })

    } catch (err) {
      const message = err instanceof Error ? err.message : 'Failed to load music'
      setError(message)
    } finally {
      setIsLoading(false)
    }
  }

  // Current platform info for display
  const currentPlatform = content.platform ? PLATFORM_INFO[content.platform] : null
  const PlatformIcon = currentPlatform?.icon

  return (
    <div className="space-y-4">
      {/* URL Input */}
      <div className="space-y-2">
        <Label htmlFor="musicUrl">Music URL</Label>
        <div className="relative">
          <Input
            id="musicUrl"
            type="url"
            placeholder="Paste Spotify, Apple Music, SoundCloud, Bandcamp, or Audiomack URL"
            value={urlInput}
            onChange={(e) => setUrlInput(e.target.value)}
            onBlur={handleUrlBlur}
            onKeyDown={(e) => e.key === 'Enter' && handleUrlBlur()}
            disabled={isLoading}
            className="pr-10"
          />
          {isLoading && (
            <div className="absolute right-3 top-1/2 -translate-y-1/2">
              <Loader2 className="h-4 w-4 animate-spin text-muted-foreground" />
            </div>
          )}
        </div>
        <p className="text-xs text-muted-foreground">
          Paste a link to a track, album, or playlist
        </p>
      </div>

      {/* Platform Detection Result */}
      {content.platform && currentPlatform && (
        <div className="flex items-center gap-2 p-3 rounded-lg bg-muted/50">
          {PlatformIcon && <PlatformIcon className="h-5 w-5" />}
          <div className="flex-1 min-w-0">
            <p className="text-sm font-medium">{currentPlatform.name}</p>
            {content.title && (
              <p className="text-xs text-muted-foreground truncate">{content.title}</p>
            )}
          </div>
          <CheckCircle2 className="h-4 w-4 text-green-500 flex-shrink-0" />
        </div>
      )}

      {/* Bandcamp Note */}
      {content.platform === 'bandcamp' && !content.bandcampAlbumId && (
        <div className="p-3 rounded-lg bg-amber-500/10 border border-amber-500/20">
          <p className="text-xs text-amber-600 dark:text-amber-400">
            Bandcamp embeds require additional processing. The embed may take a moment to load.
          </p>
        </div>
      )}

      {/* Error Display */}
      {error && (
        <div className="flex items-start gap-2 text-sm text-destructive">
          <AlertCircle className="h-4 w-4 flex-shrink-0 mt-0.5" />
          <span>{error}</span>
        </div>
      )}

      {/* Supported Platforms Help */}
      {!content.platform && !error && (
        <div className="text-xs text-muted-foreground space-y-1">
          <p>Supported platforms:</p>
          <div className="flex flex-wrap gap-2">
            {Object.entries(PLATFORM_INFO).map(([key, { name, icon: Icon }]) => (
              <span key={key} className="flex items-center gap-1">
                <Icon className="h-3 w-3" />
                {name}
              </span>
            ))}
          </div>
        </div>
      )}
    </div>
  )
}
```

**Key behaviors:**
1. URL is parsed on blur or Enter key
2. Platform is auto-detected from URL
3. oEmbed is called to get thumbnail and title (when available)
4. Error shown if URL not recognized or not a music platform
5. Success state shows platform icon, name, and title
6. Bandcamp shows note about embed processing
  </action>
  <verify>
1. File exists: `ls src/components/editor/music-card-fields.tsx`
2. TypeScript compiles: `npx tsc --noEmit`
3. Component exports MusicCardFields: `grep -n "export function MusicCardFields" src/components/editor/music-card-fields.tsx`
  </verify>
  <done>
MusicCardFields component provides URL input with platform auto-detection, oEmbed metadata fetching, and error handling.
  </done>
</task>

</tasks>

<verification>
- [ ] MusicCard renders placeholder when no URL configured
- [ ] MusicCard shows click-to-play state with platform icon and thumbnail
- [ ] MusicCard loads iframe when play button clicked
- [ ] MusicCard shows error state with platform icon and link when embed fails
- [ ] MusicCardFields auto-detects platform from URL
- [ ] MusicCardFields shows loading state during oEmbed fetch
- [ ] MusicCardFields shows error for unsupported URLs
- [ ] MusicCardFields shows success state with platform and title
- [ ] TypeScript compiles without errors
</verification>

<success_criteria>
1. Music card renders correctly for all 5 platforms
2. Click-to-load pattern works (thumbnail -> iframe)
3. Error handling shows graceful fallback
4. Editor auto-detects platform from URL patterns
5. oEmbed metadata (thumbnail, title) displayed when available
6. No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/09-platform-integrations/09-03-SUMMARY.md`
</output>
