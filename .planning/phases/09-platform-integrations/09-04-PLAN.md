---
phase: 09-platform-integrations
plan: 04
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - src/components/cards/video-card.tsx
  - src/lib/video-embed.ts
autonomous: true

must_haves:
  truths:
    - "TikTok videos display in 9:16 vertical aspect ratio"
    - "Instagram Reels display in 9:16 vertical aspect ratio"
    - "Instagram posts embed and play in video cards"
    - "Vertical embeds center within card and constrain to max-width"
  artifacts:
    - path: "src/components/cards/video-card.tsx"
      provides: "Video card with vertical embed support"
      contains: "VerticalEmbedContainer"
    - path: "src/lib/video-embed.ts"
      provides: "Instagram URL parsing"
      contains: "instagram"
  key_links:
    - from: "src/components/cards/video-card.tsx"
      to: "isVerticalPlatform"
      via: "aspect ratio detection"
      pattern: "isVerticalPlatform|9:16|177\\.78"
---

<objective>
Add vertical 9:16 aspect ratio support to video card for TikTok and Instagram Reels content.

Purpose: Per CONTEXT.md, "9:16 vertical content (Reels, TikTok) gets its own tall card treatment." This plan extends the existing video card to handle vertical aspect ratios properly.

Output: Video card that detects vertical content and renders in proper 9:16 container, plus Instagram embed support in video-embed.ts.
</objective>

<execution_context>
@/Users/julianmunyard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julianmunyard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/09-platform-integrations/09-CONTEXT.md
@.planning/phases/09-platform-integrations/09-RESEARCH.md
@src/components/cards/video-card.tsx
@src/lib/video-embed.ts
@src/lib/platform-embed.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Instagram support to video-embed.ts</name>
  <files>src/lib/video-embed.ts</files>
  <action>
Extend video-embed.ts to handle Instagram posts and reels:

1. Update the service type to include 'instagram':
   ```typescript
   service: 'youtube' | 'vimeo' | 'tiktok' | 'instagram'
   ```

2. Update parseVideoUrl to detect Instagram URLs:
   ```typescript
   // Before calling getVideoId, check for Instagram
   const instagramMatch = url.match(/instagram\.com\/(p|reel|reels)\/([a-zA-Z0-9_-]+)/)
   if (instagramMatch) {
     return await getInstagramInfo(instagramMatch[2], instagramMatch[1] === 'reel' || instagramMatch[1] === 'reels')
   }
   ```

3. Add getInstagramInfo function:
   ```typescript
   async function getInstagramInfo(postId: string, isReel: boolean): Promise<VideoEmbedInfo> {
     // Instagram doesn't have reliable public oEmbed without access token
     // Return basic info with direct embed URL
     return {
       id: postId,
       service: 'instagram',
       thumbnailUrl: '', // No reliable thumbnail without API access
       embedUrl: `https://www.instagram.com/p/${postId}/embed/`,
       // Mark as vertical if it's a reel
       isVertical: isReel,
     }
   }
   ```

4. Update VideoEmbedInfo interface to include `isVertical` flag:
   ```typescript
   export interface VideoEmbedInfo {
     id: string
     service: 'youtube' | 'vimeo' | 'tiktok' | 'instagram'
     thumbnailUrl: string
     embedUrl: string
     title?: string
     isVertical?: boolean  // True for TikTok and Instagram Reels
   }
   ```

5. Update getTikTokInfo to set isVertical: true:
   ```typescript
   async function getTikTokInfo(url: string): Promise<VideoEmbedInfo> {
     const videoIdMatch = url.match(/\/video\/([0-9]+)/)
     const videoId = videoIdMatch?.[1] || url

     return {
       id: videoId,
       service: 'tiktok',
       thumbnailUrl: '',
       embedUrl: url,
       isVertical: true,  // TikTok videos are always 9:16
     }
   }
   ```

**Notes:**
- Instagram oEmbed requires access token - we skip that and use direct embed
- Instagram posts (not reels) are typically square but can be any ratio - treat regular posts as standard, only reels as vertical
- TikTok is always vertical (9:16)
  </action>
  <verify>
1. TypeScript compiles: `npx tsc --noEmit`
2. Instagram service added: `grep -n "instagram" src/lib/video-embed.ts`
3. isVertical field added: `grep -n "isVertical" src/lib/video-embed.ts`
  </verify>
  <done>
video-embed.ts handles Instagram URLs and returns isVertical flag for TikTok and Instagram Reels.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update VideoCard for vertical aspect ratio</name>
  <files>src/components/cards/video-card.tsx</files>
  <action>
Modify VideoCard to render vertical content in 9:16 container:

1. Update VideoCardContent type in card.ts to include isVertical:
   - This should be persisted when URL is parsed
   - In `types/card.ts`, add to VideoCardContent:
     ```typescript
     embedIsVertical?: boolean  // True for TikTok and Instagram Reels
     ```

2. Create VerticalEmbedContainer component within video-card.tsx:
   ```typescript
   // Container for 9:16 vertical content (TikTok, Instagram Reels)
   function VerticalEmbedContainer({ children }: { children: React.ReactNode }) {
     return (
       // Center the container and constrain max width
       <div className="relative w-full flex justify-center">
         {/* Max width matches TikTok's embed max (325px) */}
         <div className="relative w-full max-w-[325px]">
           {/* 9:16 aspect ratio: 16/9 * 100 = 177.78% */}
           <div className="relative w-full pb-[177.78%]">
             <div className="absolute inset-0">
               {children}
             </div>
           </div>
         </div>
       </div>
     )
   }
   ```

3. Update VideoCardEmbed to use VerticalEmbedContainer when embedService is 'tiktok' or 'instagram' and content.embedIsVertical is true:

   In the isPlaying state (iframe render):
   ```typescript
   // Check if this is vertical content
   const isVertical = content.embedIsVertical ||
     content.embedService === 'tiktok' ||
     (content.embedService === 'instagram' && content.embedUrl?.includes('/reel'))

   if (isVertical) {
     return (
       <VerticalEmbedContainer>
         <iframe
           src={getEmbedUrl()}
           className="w-full h-full rounded-xl"
           allow="..."
           allowFullScreen
           title={title || 'Video'}
         />
       </VerticalEmbedContainer>
     )
   }
   ```

   In the thumbnail/play state:
   ```typescript
   if (isVertical) {
     return (
       <VerticalEmbedContainer>
         <button
           onClick={() => setIsPlaying(true)}
           className="relative w-full h-full overflow-hidden bg-muted group cursor-pointer block rounded-xl"
           aria-label={`Play ${title || 'video'}`}
         >
           {/* Same content as current thumbnail view */}
         </button>
       </VerticalEmbedContainer>
     )
   }
   ```

4. Update getEmbedUrl to handle Instagram:
   ```typescript
   const getEmbedUrl = () => {
     // YouTube
     if (embedService === 'youtube' && embedUrl.includes('watch?v=')) {
       return `https://www.youtube.com/embed/${embedVideoId}`
     }
     // TikTok - use v2 embed
     if (embedService === 'tiktok' && embedVideoId) {
       return `https://www.tiktok.com/embed/v2/${embedVideoId}`
     }
     // Instagram - already in embed format or construct it
     if (embedService === 'instagram') {
       if (embedUrl.includes('/embed/')) return embedUrl
       const postId = embedUrl.match(/\/(p|reel|reels)\/([a-zA-Z0-9_-]+)/)?.[2]
       if (postId) return `https://www.instagram.com/p/${postId}/embed/`
     }
     return embedUrl
   }
   ```

5. Update VideoCardFields to store embedIsVertical when parsing URL:
   - In video-card-fields.tsx, after parseVideoUrl succeeds:
   ```typescript
   onChange({
     embedUrl: videoInfo.embedUrl,
     embedService: videoInfo.service,
     embedVideoId: videoInfo.id,
     embedThumbnailUrl: videoInfo.thumbnailUrl,
     embedIsVertical: videoInfo.isVertical,  // Add this
   })
   ```

**Styling notes:**
- Vertical container centers content and limits max-width to 325px (TikTok's max)
- 177.78% padding-bottom creates 9:16 aspect ratio
- Container should work within both big and small card sizes
- Rounded corners apply to iframe via className
  </action>
  <verify>
1. TypeScript compiles: `npx tsc --noEmit`
2. VerticalEmbedContainer exists: `grep -n "VerticalEmbedContainer" src/components/cards/video-card.tsx`
3. Instagram handling in getEmbedUrl: `grep -n "instagram" src/components/cards/video-card.tsx`
4. isVertical detection: `grep -n "isVertical" src/components/cards/video-card.tsx`
  </verify>
  <done>
VideoCard detects vertical content and renders TikTok/Instagram Reels in proper 9:16 aspect ratio container with centered layout.
  </done>
</task>

</tasks>

<verification>
- [ ] Instagram post URLs are detected and parsed by video-embed.ts
- [ ] Instagram reel URLs are detected as vertical content
- [ ] TikTok URLs are detected as vertical content
- [ ] Vertical content renders in 9:16 aspect ratio container
- [ ] Vertical container is centered with max-width 325px
- [ ] Regular video content (YouTube, Vimeo) still renders in 16:9
- [ ] Video card editor stores embedIsVertical flag
- [ ] TypeScript compiles without errors
</verification>

<success_criteria>
1. TikTok videos display in tall 9:16 container
2. Instagram Reels display in tall 9:16 container
3. Instagram regular posts display in standard container
4. YouTube/Vimeo videos unchanged (16:9)
5. Vertical embeds centered within card bounds
6. Click-to-load pattern works for all services
7. No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/09-platform-integrations/09-04-SUMMARY.md`
</output>
