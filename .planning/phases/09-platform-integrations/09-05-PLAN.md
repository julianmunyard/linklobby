---
phase: 09-platform-integrations
plan: 05
type: execute
wave: 3
depends_on: ["09-02", "09-03", "09-04"]
files_modified:
  - src/components/preview/card-renderer.tsx
  - src/components/editor/card-property-editor.tsx
  - src/components/cards/music-card.tsx
  - src/components/cards/video-card.tsx
autonomous: true

must_haves:
  truths:
    - "Music cards appear in the card type selector"
    - "Music cards render in preview when selected"
    - "Music card editor fields appear in property panel"
    - "Only one embed plays at a time across all cards"
  artifacts:
    - path: "src/components/preview/card-renderer.tsx"
      provides: "Renders music cards"
      contains: "case 'music'"
    - path: "src/components/editor/card-property-editor.tsx"
      provides: "Music card editor integration"
      contains: "MusicCardFields"
  key_links:
    - from: "src/components/preview/card-renderer.tsx"
      to: "src/components/cards/music-card.tsx"
      via: "MusicCard import and render"
      pattern: "import.*MusicCard"
    - from: "src/components/cards/music-card.tsx"
      to: "src/components/providers/embed-provider.tsx"
      via: "useEmbedPlayback hook"
      pattern: "useEmbedPlayback|useOptionalEmbedPlayback"
---

<objective>
Integrate music card into the editor and wire up playback coordination across all embeds.

Purpose: Complete the music card feature by connecting it to the editor UI and implementing one-at-a-time playback coordination.

Output: Music cards appear in card type selector, render in preview, have working editor fields, and coordinate playback with other embeds.
</objective>

<execution_context>
@/Users/julianmunyard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julianmunyard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/09-platform-integrations/09-CONTEXT.md
@.planning/phases/09-platform-integrations/09-RESEARCH.md
@src/components/preview/card-renderer.tsx
@src/components/editor/card-property-editor.tsx
@src/components/cards/music-card.tsx
@src/components/cards/video-card.tsx
@src/components/providers/embed-provider.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate MusicCard into CardRenderer and PropertyEditor</name>
  <files>src/components/preview/card-renderer.tsx, src/components/editor/card-property-editor.tsx</files>
  <action>
**In src/components/preview/card-renderer.tsx:**

1. Import MusicCard at top:
   ```typescript
   import { MusicCard } from '@/components/cards/music-card'
   ```

2. Add case 'music' in the switch statement that routes to card components:
   ```typescript
   case 'music':
     return <MusicCard card={card} isPreview={isPreview} />
   ```

**In src/components/editor/card-property-editor.tsx:**

1. Import MusicCardFields:
   ```typescript
   import { MusicCardFields } from '@/components/editor/music-card-fields'
   ```

2. Add music to the card type selector/picker. Look for where card types are listed (usually an array or toggle group) and add:
   ```typescript
   { type: 'music', label: 'Music', icon: Music }
   ```
   Import Music icon from lucide-react if not already imported.

3. Add case 'music' in the field rendering switch:
   ```typescript
   case 'music':
     return (
       <MusicCardFields
         content={card.content as MusicCardContent}
         onChange={handleContentChange}
         cardId={card.id}
       />
     )
   ```
   Import MusicCardContent type if needed.

**Also update any card type arrays/lists elsewhere:**
- Check for CARD_TYPE_ICONS or similar mappings
- Check for card type labels/descriptions
- Add music to any exhaustive lists

**Use react-icons for consistent styling:**
```typescript
import { SiSpotify } from 'react-icons/si'
// Or use the generic Music icon from lucide-react
import { Music } from 'lucide-react'
```
  </action>
  <verify>
1. Card type 'music' renders: `grep -n "case 'music'" src/components/preview/card-renderer.tsx`
2. MusicCardFields integrated: `grep -n "MusicCardFields" src/components/editor/card-property-editor.tsx`
3. TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
Music card appears in card type selector, renders via CardRenderer, and shows MusicCardFields in property editor.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire playback coordination into music and video cards</name>
  <files>src/components/cards/music-card.tsx, src/components/cards/video-card.tsx</files>
  <action>
**In src/components/cards/music-card.tsx:**

1. Import the playback hook:
   ```typescript
   import { useOptionalEmbedPlayback } from '@/components/providers/embed-provider'
   ```

2. Use the hook at the start of the component:
   ```typescript
   const playback = useOptionalEmbedPlayback()
   ```

3. Register/unregister on mount/unmount. Add useEffect:
   ```typescript
   import { useEffect, useRef } from 'react'

   // Ref to track iframe for potential pause
   const iframeRef = useRef<HTMLIFrameElement>(null)

   // Register with playback coordination
   useEffect(() => {
     if (!playback || !card.id) return

     const pauseFn = () => {
       // Reset to thumbnail state (simplest way to "pause")
       setIsPlaying(false)
     }

     playback.registerEmbed(card.id, pauseFn)

     return () => {
       playback.unregisterEmbed(card.id)
     }
   }, [playback, card.id])
   ```

4. When user clicks play, notify the context:
   ```typescript
   const handlePlay = () => {
     setIsPlaying(true)
     playback?.setActiveEmbed(card.id)
   }
   ```
   Update the onClick to use handlePlay instead of direct setIsPlaying.

**In src/components/cards/video-card.tsx:**

Apply the same pattern to VideoCardEmbed:

1. Import the hook:
   ```typescript
   import { useOptionalEmbedPlayback } from '@/components/providers/embed-provider'
   ```

2. Add to VideoCardEmbed props or get card ID from parent. Since VideoCardEmbed is a sub-component, you may need to pass cardId as prop.

3. Add the same registration pattern:
   ```typescript
   const playback = useOptionalEmbedPlayback()

   useEffect(() => {
     if (!playback || !cardId) return

     const pauseFn = () => {
       setIsPlaying(false)
     }

     playback.registerEmbed(cardId, pauseFn)

     return () => {
       playback.unregisterEmbed(cardId)
     }
   }, [playback, cardId])
   ```

4. When play button clicked, notify context:
   ```typescript
   const handlePlay = () => {
     setIsPlaying(true)
     playback?.setActiveEmbed(cardId)
   }
   ```

**Important notes:**
- Use useOptionalEmbedPlayback (not useEmbedPlayback) so cards work on public pages where provider might not exist
- The simplest pause implementation is reverting to thumbnail state
- For more advanced control (Spotify/SoundCloud APIs), add in future iteration
- This implements "best effort" coordination per RESEARCH.md

**VideoCardUpload (uploaded videos) consideration:**
- Uploaded videos play via native <video> element
- Could add ref and video.pause() for better coordination
- Optional enhancement - thumbnail reset is acceptable for v1
  </action>
  <verify>
1. Music card imports useOptionalEmbedPlayback: `grep -n "useOptionalEmbedPlayback" src/components/cards/music-card.tsx`
2. Video card imports useOptionalEmbedPlayback: `grep -n "useOptionalEmbedPlayback" src/components/cards/video-card.tsx`
3. Register/unregister pattern present: `grep -n "registerEmbed\|unregisterEmbed" src/components/cards/music-card.tsx`
4. setActiveEmbed called on play: `grep -n "setActiveEmbed" src/components/cards/music-card.tsx`
5. TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
Music and video cards register with playback coordination context. Starting one embed resets others to thumbnail state.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add music to cards tab and verify full flow</name>
  <files>src/components/editor/cards-tab.tsx (or wherever card type buttons are)</files>
  <action>
Find where the "Add Card" buttons are defined (likely cards-tab.tsx or similar) and add music:

1. Look for the card type buttons/list:
   ```bash
   grep -rn "hero.*horizontal\|video.*gallery" src/components/editor/
   ```

2. Add music card button with icon:
   ```typescript
   {
     type: 'music',
     label: 'Music',
     icon: Music,  // from lucide-react, or use SiSpotify from react-icons
     description: 'Embed Spotify, Apple Music, SoundCloud',
   }
   ```

3. Ensure the button calls the same addCard action as other types.

**Full flow verification:**

After making changes, manually verify:
1. Click "Add Music Card" button -> music card appears in preview
2. Select music card -> MusicCardFields appear in property panel
3. Paste a Spotify URL -> platform detected, thumbnail loads
4. Click play -> iframe loads
5. Add a video card, click play -> music card resets to thumbnail

**Edge cases to test:**
- Empty URL shows placeholder
- Invalid URL shows error
- Multiple music cards coordinate correctly
- Music + video cards coordinate together
  </action>
  <verify>
1. Music card type in card list: `grep -rn "'music'" src/components/editor/`
2. App builds: `npm run build`
3. Manual test: Add music card in editor UI
  </verify>
  <done>
Music card fully integrated: appears in Add Card menu, renders in preview, editable in property panel, coordinates playback with other embeds.
  </done>
</task>

</tasks>

<verification>
- [ ] Music appears in card type selector/Add Card menu
- [ ] Clicking Add Music creates a music card placeholder
- [ ] Selecting music card shows MusicCardFields in property panel
- [ ] Pasting Spotify URL auto-detects platform
- [ ] Music card plays when clicked
- [ ] Starting video card pauses music card (thumbnail reset)
- [ ] Starting music card pauses video card
- [ ] Multiple music cards only one plays at a time
- [ ] TypeScript compiles without errors
- [ ] App builds successfully
</verification>

<success_criteria>
1. Music card accessible via Add Card UI
2. Music card renders in preview (placeholder, thumbnail, playing states)
3. Music card editor fields work (URL detection, metadata display)
4. Playback coordination works across all embed types
5. No TypeScript errors
6. Build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/09-platform-integrations/09-05-SUMMARY.md`
</output>
