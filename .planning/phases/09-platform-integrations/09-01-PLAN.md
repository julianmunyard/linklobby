---
phase: 09-platform-integrations
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/platform-embed.ts
  - src/types/card.ts
  - src/stores/page-store.ts
autonomous: true

must_haves:
  truths:
    - "Platform is auto-detected from any supported URL"
    - "Music card type exists with proper content schema"
    - "Store correctly creates music cards with defaults"
  artifacts:
    - path: "src/lib/platform-embed.ts"
      provides: "URL detection and oEmbed fetching for all platforms"
      exports: ["detectPlatform", "fetchPlatformEmbed", "getEmbedUrl", "PLATFORM_PATTERNS"]
    - path: "src/types/card.ts"
      provides: "MusicCardContent type and type guards"
      contains: "MusicCardContent"
    - path: "src/stores/page-store.ts"
      provides: "Music card defaults in addCard"
      contains: "case 'music'"
  key_links:
    - from: "src/lib/platform-embed.ts"
      to: "PLATFORM_PATTERNS"
      via: "regex matching"
      pattern: "detectPlatform.*regex"
    - from: "src/stores/page-store.ts"
      to: "src/types/card.ts"
      via: "MusicCardContent import"
      pattern: "MusicCardContent"
---

<objective>
Create the platform detection module and music card types for Phase 9 Platform Integrations.

Purpose: Establish the foundation for all platform embeds with unified URL detection, oEmbed fetching, and proper TypeScript types for music cards.

Output: `platform-embed.ts` with URL detection for all supported platforms, `MusicCardContent` type, and store updates for music card creation.
</objective>

<execution_context>
@/Users/julianmunyard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julianmunyard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-platform-integrations/09-CONTEXT.md
@.planning/phases/09-platform-integrations/09-RESEARCH.md
@src/types/card.ts
@src/lib/video-embed.ts
@src/stores/page-store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create platform-embed.ts with URL detection and oEmbed</name>
  <files>src/lib/platform-embed.ts</files>
  <action>
Create a unified platform detection module that handles all supported platforms:

**Platforms to support:**
- Music: spotify, apple-music, soundcloud, bandcamp, audiomack
- Video: youtube, vimeo, tiktok (already in video-embed.ts but needed for detection)
- Social: instagram (post/reel embeds)

**Implementation:**

1. Define `EmbedPlatform` type union covering all platforms

2. Define `PLATFORM_PATTERNS` array with regex patterns for each platform:
   - Spotify: `open.spotify.com/(track|album|playlist|artist)/ID`
   - Apple Music: `(embed.)?music.apple.com/COUNTRY/(album|playlist|artist)/NAME/ID`
   - SoundCloud: `soundcloud.com/USER/(sets/)?TRACK`
   - Bandcamp: `ARTIST.bandcamp.com/(album|track)/SLUG`
   - Audiomack: `audiomack.com/(song|album)/ARTIST/TITLE`
   - Instagram: `instagram.com/(p|reel|reels)/ID`
   - TikTok: `tiktok.com/@USER/video/ID`
   - YouTube/Vimeo: delegate to get-video-id

3. Create `detectPlatform(url: string)` function:
   - Returns `{ platform: EmbedPlatform; match: RegExpMatchArray } | null`
   - For YouTube/Vimeo, use get-video-id first, then check our patterns
   - Return null for unrecognized URLs

4. Create `isVerticalPlatform(platform: EmbedPlatform)` helper:
   - Returns true for 'tiktok' and 'instagram' (9:16 content)

5. Create `fetchPlatformEmbed(url: string, platform: EmbedPlatform)` async function:
   - Returns `EmbedInfo` with embedUrl, thumbnailUrl, title, aspectRatio
   - Call appropriate oEmbed endpoints per platform:
     - Spotify: `https://open.spotify.com/oembed?url=...`
     - SoundCloud: `https://soundcloud.com/oembed?url=...&format=json`
     - Audiomack: `https://audiomack.com/oembed?url=...`
   - For platforms without oEmbed (Bandcamp, Apple Music, Instagram): return basic info
   - Handle errors gracefully - return fallback with platform icon

6. Create `getEmbedUrl(url: string, platform: EmbedPlatform)` function:
   - Spotify: replace `open.spotify.com/` with `open.spotify.com/embed/`
   - Apple Music: replace `music.apple.com/` with `embed.music.apple.com/`
   - SoundCloud: construct `https://w.soundcloud.com/player/?url=...&auto_play=false&hide_related=true`
   - Bandcamp: construct `https://bandcamp.com/EmbeddedPlayer/...` (needs album ID - return URL as-is for now)
   - Audiomack: construct `https://audiomack.com/embed/...`
   - TikTok: `https://www.tiktok.com/embed/v2/{videoId}`
   - Instagram: `https://www.instagram.com/p/{postId}/embed/`

**Important notes from RESEARCH.md:**
- Instagram oEmbed requires access token - skip oEmbed, use direct embed URL
- Bandcamp requires album ID from page meta - handle in separate flow later
- TikTok oEmbed returns blockquote - use direct iframe URL instead
- Apple Music doesn't support programmatic pause - note in comments

**Do NOT:**
- Replace video-embed.ts - it works for video card
- Make this module dependent on React (pure TypeScript utilities)
  </action>
  <verify>
Create a test file `src/lib/__tests__/platform-embed.test.ts` with tests for:
- detectPlatform returns correct platform for each URL type
- isVerticalPlatform returns true for tiktok/instagram
- getEmbedUrl constructs correct URLs

Run: `npm test platform-embed` (or add tests inline and verify manually)
  </verify>
  <done>
`platform-embed.ts` exports detectPlatform, fetchPlatformEmbed, getEmbedUrl, isVerticalPlatform, PLATFORM_PATTERNS and correctly identifies all supported platform URLs.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add MusicCardContent type and store defaults</name>
  <files>src/types/card.ts, src/stores/page-store.ts</files>
  <action>
**In src/types/card.ts:**

1. Add 'music' to CardType union

2. Add 'music' to CARD_TYPE_SIZING with `['big', 'small']`

3. Add 'music' to CARD_TYPES_NO_IMAGE array (uses embed thumbnail, not upload)

4. Define `MusicPlatform` type:
   ```typescript
   export type MusicPlatform = 'spotify' | 'apple-music' | 'soundcloud' | 'bandcamp' | 'audiomack'
   ```

5. Define `MusicCardContent` interface:
   ```typescript
   export interface MusicCardContent {
     platform?: MusicPlatform
     embedUrl?: string           // Original URL pasted by user
     embedIframeUrl?: string     // Constructed iframe src
     thumbnailUrl?: string       // From oEmbed (if available)
     title?: string              // From oEmbed (if available)
     // Bandcamp-specific (requires page fetch)
     bandcampAlbumId?: string
     bandcampTrackId?: string
   }
   ```

6. Add type guard:
   ```typescript
   export function isMusicContent(content: unknown): content is MusicCardContent {
     return typeof content === 'object' && content !== null
   }
   ```

7. Update CardContent union to include MusicCardContent

**In src/stores/page-store.ts:**

1. Import MusicCardContent type

2. Add case 'music' in addCard action's content defaults:
   ```typescript
   case 'music':
     content = {
       platform: undefined,
       embedUrl: undefined,
     } satisfies MusicCardContent
     break
   ```

3. Add 'music' to any card type lists/switches that need it

**Do NOT:**
- Add video platforms to MusicPlatform - those stay in video-embed.ts
- Change existing video card logic
  </action>
  <verify>
1. TypeScript compiles without errors: `npm run build` or `npx tsc --noEmit`
2. Grep for MusicCardContent in card.ts: `grep -n "MusicCardContent" src/types/card.ts`
3. Grep for 'music' case in page-store: `grep -n "case 'music'" src/stores/page-store.ts`
  </verify>
  <done>
MusicCardContent type exists with proper fields, type guard works, store creates music cards with correct defaults, TypeScript compiles.
  </done>
</task>

</tasks>

<verification>
- [ ] `npm run build` completes without TypeScript errors
- [ ] `detectPlatform` correctly identifies Spotify, Apple Music, SoundCloud, Bandcamp, Audiomack URLs
- [ ] `detectPlatform` correctly identifies Instagram post/reel URLs
- [ ] `isVerticalPlatform` returns true for tiktok and instagram
- [ ] `getEmbedUrl` returns correct iframe URLs for each platform
- [ ] MusicCardContent type exists with platform, embedUrl, embedIframeUrl, thumbnailUrl, title fields
- [ ] Store's addCard creates music cards with correct default content
</verification>

<success_criteria>
1. Platform detection works for all 10+ platform URL patterns
2. MusicCardContent type properly defines music embed data structure
3. Store correctly initializes music cards
4. No TypeScript errors
5. Existing video card functionality unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/09-platform-integrations/09-01-SUMMARY.md`
</output>
