---
phase: 10-fan-tools
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/card.ts
  - src/components/editor/schedule-tab.tsx
  - src/components/editor/editor-panel.tsx
  - src/components/editor/schedule-card-item.tsx
  - src/components/preview/preview-sortable-card.tsx
  - src/lib/supabase/public.ts
autonomous: true

must_haves:
  truths:
    - "Artist can set publish date for any card"
    - "Artist can set expiry date for any card"
    - "Scheduled cards show badge in editor indicating timing"
    - "Expired cards auto-hide from public page"
    - "Schedule tab shows all cards with timing"
  artifacts:
    - path: "src/types/card.ts"
      provides: "ScheduledCardContent fields (publishAt, expireAt)"
      contains: "publishAt"
    - path: "src/components/editor/schedule-tab.tsx"
      provides: "Schedule tab showing all timed cards"
      exports: ["ScheduleTab"]
    - path: "src/components/editor/schedule-card-item.tsx"
      provides: "Individual scheduled card display with date inputs"
      exports: ["ScheduleCardItem"]
  key_links:
    - from: "src/components/editor/editor-panel.tsx"
      to: "src/components/editor/schedule-tab.tsx"
      via: "TabsContent for schedule tab"
      pattern: "ScheduleTab"
    - from: "src/lib/supabase/public.ts"
      to: "card.content.publishAt"
      via: "filter by publish/expire dates"
      pattern: "publishAt|expireAt"
---

<objective>
Create link scheduling infrastructure allowing artists to control when cards appear on their public page.

Purpose: Artists need to coordinate releases and promotions with timing. Scheduled links let them prepare content ahead of time and have it go live automatically.

Output: Scheduling fields on cards, Schedule tab overview, public page filtering by schedule.
</objective>

<execution_context>
@/Users/julianmunyard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julianmunyard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-fan-tools/10-CONTEXT.md
@.planning/phases/10-fan-tools/10-RESEARCH.md

# Key existing files
@src/types/card.ts
@src/components/editor/editor-panel.tsx
@src/lib/supabase/public.ts
@src/components/preview/preview-sortable-card.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add scheduling fields to card content type</name>
  <files>
    src/types/card.ts
  </files>
  <action>
Add scheduling fields to card content types in `src/types/card.ts`:

Create new interface `ScheduledContent`:
```typescript
export interface ScheduledContent {
  publishAt?: string      // ISO 8601 UTC timestamp - null = published immediately
  expireAt?: string       // ISO 8601 UTC timestamp - null = never expires
}
```

This is a mixin interface - any card content type can optionally include these fields.

Add to CardContent union comment that all content types can include ScheduledContent fields.

Create helper functions:
```typescript
export function isScheduled(content: Record<string, unknown>): boolean {
  return !!(content.publishAt || content.expireAt)
}

export function getScheduleStatus(content: Record<string, unknown>): 'scheduled' | 'active' | 'expired' | null {
  const now = new Date().toISOString()
  const publishAt = content.publishAt as string | undefined
  const expireAt = content.expireAt as string | undefined

  if (!publishAt && !expireAt) return null
  if (publishAt && publishAt > now) return 'scheduled'
  if (expireAt && expireAt < now) return 'expired'
  return 'active'
}
```
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>ScheduledContent interface and helper functions exist in card types</done>
</task>

<task type="auto">
  <name>Task 2: Create Schedule tab and card item components</name>
  <files>
    src/components/editor/schedule-tab.tsx
    src/components/editor/schedule-card-item.tsx
    src/components/editor/editor-panel.tsx
  </files>
  <action>
Create `src/components/editor/schedule-card-item.tsx`:
- Props: card (Card), onUpdate (function to update card content)
- Display card title/type with small preview icon
- Show current schedule status badge: "Scheduled for [date]", "Expires [date]", "Expired", or "Always visible"
- Two datetime-local inputs:
  - "Publish at" - when card becomes visible (convert local input to UTC for storage)
  - "Expires at" - when card hides (convert local input to UTC for storage)
- Clear buttons next to each input to remove scheduling
- Display dates in browser's local timezone using Intl.DateTimeFormat
- On change: update card.content via onUpdate, preserving other content fields

Create `src/components/editor/schedule-tab.tsx`:
- Import usePageStore for cards
- Get all cards sorted by sortKey
- Divide into sections:
  - "Scheduled" - cards with publishAt in future
  - "Active" - cards currently visible (no schedule or within window)
  - "Expired" - cards with expireAt in past
- Empty state if no cards have scheduling: "No scheduled content yet. Set timing on any card to control when it appears."
- Each section shows ScheduleCardItem for relevant cards
- ScrollArea for overflow

Update `src/components/editor/editor-panel.tsx`:
- Add new tab: value="schedule", label="Schedule" with Calendar icon
- Add TabsContent for schedule tab rendering ScheduleTab component
- Tab order: Cards, Design, Schedule, Settings (if exists)
  </action>
  <verify>
1. Schedule tab appears in editor
2. Cards display with current schedule status
3. Datetime inputs update card content
4. Changes reflect in store immediately
  </verify>
  <done>Schedule tab shows all cards with timing controls, updates work correctly</done>
</task>

<task type="auto">
  <name>Task 3: Schedule badges and public page filtering</name>
  <files>
    src/components/preview/preview-sortable-card.tsx
    src/components/editor/cards-tab.tsx
    src/lib/supabase/public.ts
  </files>
  <action>
Update `src/components/preview/preview-sortable-card.tsx`:
- Import getScheduleStatus from card types
- Add schedule badge display below/beside card:
  - 'scheduled': Blue badge with Calendar icon "Scheduled [formatted date]"
  - 'expired': Gray badge "Expired"
  - 'active' with expireAt: Orange badge "Expires [date]"
  - null: no badge
- Badge uses Intl.DateTimeFormat for local timezone display
- Badge only shows in editor mode (isEditing prop or context)

Update `src/components/editor/cards-tab.tsx` (cards list in sidebar):
- Add small schedule indicator next to each card in the list
- Clock icon for scheduled, warning icon for expired
- Tooltip with full date details

Update `src/lib/supabase/public.ts` (or wherever fetchPublicPageData lives):
- Add filtering logic for scheduled cards:
```typescript
const now = new Date().toISOString()
const visibleCards = cards.filter(card => {
  if (!card.is_visible) return false

  const content = card.content as Record<string, unknown>
  const publishAt = content.publishAt as string | undefined
  const expireAt = content.expireAt as string | undefined

  // Check publish date - if set and in future, hide
  if (publishAt && publishAt > now) return false

  // Check expiry date - if set and in past, hide
  if (expireAt && expireAt < now) return false

  return true
})
```
  </action>
  <verify>
1. Scheduled cards show blue "Scheduled" badge in editor
2. Expired cards show gray "Expired" badge in editor
3. Public page only shows cards within their schedule window
4. npm run build completes
  </verify>
  <done>Schedule badges visible in editor, public page correctly filters by schedule</done>
</task>

</tasks>

<verification>
1. TypeScript compilation passes: `npx tsc --noEmit`
2. Schedule tab shows all cards with timing
3. Datetime inputs work with proper timezone handling
4. Badges display correctly for scheduled/expired cards
5. Public page filters out scheduled-future and expired cards
6. Build completes: `npm run build`
</verification>

<success_criteria>
- Artist can set publish date via Schedule tab
- Artist can set expiry date via Schedule tab
- Editor shows clear badges indicating card timing status
- Public page automatically hides future-scheduled and expired cards
- Dates display in user's local timezone
</success_criteria>

<output>
After completion, create `.planning/phases/10-fan-tools/10-03-SUMMARY.md`
</output>
