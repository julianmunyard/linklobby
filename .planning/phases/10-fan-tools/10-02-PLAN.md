---
phase: 10-fan-tools
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/fan-tools/csv-export.ts
  - src/lib/fan-tools/mailchimp.ts
  - src/app/api/emails/export/route.ts
  - src/app/api/mailchimp/sync/route.ts
  - src/components/fan-tools/qr-code-dialog.tsx
  - src/components/fan-tools/email-export.tsx
  - src/components/fan-tools/mailchimp-settings.tsx
  - src/components/editor/settings-panel.tsx
  - package.json
autonomous: true

user_setup:
  - service: mailchimp
    why: "Optional email list sync"
    env_vars:
      - name: MAILCHIMP_API_KEY
        source: "Mailchimp Dashboard -> Account -> Extras -> API keys"
      - name: MAILCHIMP_SERVER_PREFIX
        source: "Last part of your Mailchimp API key (e.g., 'us19' from 'xxx-us19')"

must_haves:
  truths:
    - "Artist can generate QR code for their page URL"
    - "Artist can download QR code as PNG or SVG"
    - "Artist can export collected emails as CSV"
    - "Artist can optionally sync emails to Mailchimp"
  artifacts:
    - path: "src/components/fan-tools/qr-code-dialog.tsx"
      provides: "QR code generation modal with download"
      exports: ["QRCodeDialog"]
    - path: "src/lib/fan-tools/csv-export.ts"
      provides: "CSV generation utility"
      exports: ["exportEmailsToCSV"]
    - path: "src/app/api/emails/export/route.ts"
      provides: "GET endpoint for fetching emails"
      exports: ["GET"]
  key_links:
    - from: "src/components/fan-tools/email-export.tsx"
      to: "/api/emails/export"
      via: "fetch GET for email list"
      pattern: "fetch.*api/emails/export"
    - from: "src/app/api/mailchimp/sync/route.ts"
      to: "src/lib/fan-tools/mailchimp.ts"
      via: "import addSubscriber"
      pattern: "addSubscriber"
---

<objective>
Create QR code generation and email management tools including CSV export and Mailchimp integration.

Purpose: Artists need to promote their pages offline (QR for flyers, merch) and manage their fan email list with export and optional CRM sync.

Output: QR code dialog with download options, CSV export functionality, Mailchimp sync capability.
</objective>

<execution_context>
@/Users/julianmunyard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julianmunyard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-fan-tools/10-CONTEXT.md
@.planning/phases/10-fan-tools/10-RESEARCH.md

# Key existing files
@src/components/editor/design-panel.tsx  # Settings pattern
@src/lib/supabase/client.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create QR code dialog</name>
  <files>
    package.json
    src/components/fan-tools/qr-code-dialog.tsx
  </files>
  <action>
Install required packages:
```bash
npm install react-qr-code @mailchimp/mailchimp_marketing
```

Create `src/components/fan-tools/qr-code-dialog.tsx`:
- Props: pageUrl (string), username (string), open (boolean), onOpenChange (function)
- Use Dialog from shadcn/ui
- Render QRCode from react-qr-code with ref for SVG access
- Size: 256px display, configurable via dropdown (256/512/1024)
- Level: "M" for medium error correction
- Color options: black on white (default), white on black, theme colors

Download functions:
- downloadSVG(): Serialize SVG and create blob download
- downloadPNG(): Convert SVG to canvas, export at selected size (minimum 1024px for print)

UI:
- QR code preview in center
- Size dropdown (Screen: 256, Print: 512, Large Print: 1024)
- Color scheme dropdown
- Two download buttons: "Download SVG" and "Download PNG"
- Filename format: `{username}-qr.{ext}`
  </action>
  <verify>
1. npm install completes without errors
2. Component renders QR code
3. Download buttons trigger file downloads
  </verify>
  <done>QR code dialog renders with working SVG and PNG download at multiple sizes</done>
</task>

<task type="auto">
  <name>Task 2: Email export API and CSV utility</name>
  <files>
    src/lib/fan-tools/csv-export.ts
    src/app/api/emails/export/route.ts
    src/components/fan-tools/email-export.tsx
  </files>
  <action>
Create `src/lib/fan-tools/csv-export.ts`:
- Function `exportEmailsToCSV(emails: CollectedEmail[], filename: string)`
- CSV header: Email, Name, Collected At
- Proper escaping for commas, quotes, unicode
- Create Blob with text/csv mime type
- Trigger download via temporary anchor element

Create `src/app/api/emails/export/route.ts`:
- GET endpoint requiring auth (use fetchUserPage pattern from existing routes)
- Query param: pageId
- Fetch all collected_emails for the authenticated user's page
- Return JSON array of emails: [{ email, name, collected_at }]
- Return 401 if not authenticated
- Return 403 if page doesn't belong to user

Create `src/components/fan-tools/email-export.tsx`:
- Props: pageId (string)
- Fetch email count on mount (for display)
- Button "Export {count} Emails as CSV"
- On click: fetch from /api/emails/export, then call exportEmailsToCSV
- Loading state while fetching
- Disabled state if count is 0
- Toast notification on successful export
  </action>
  <verify>
1. API returns emails for authenticated user's page
2. CSV downloads with proper formatting
3. Export button shows correct count
  </verify>
  <done>Email export API works and CSV downloads with proper formatting</done>
</task>

<task type="auto">
  <name>Task 3: Mailchimp sync and settings integration</name>
  <files>
    src/lib/fan-tools/mailchimp.ts
    src/app/api/mailchimp/sync/route.ts
    src/components/fan-tools/mailchimp-settings.tsx
    src/components/editor/settings-panel.tsx
  </files>
  <action>
Create `src/lib/fan-tools/mailchimp.ts`:
- Configure mailchimp client with env vars (MAILCHIMP_API_KEY, MAILCHIMP_SERVER_PREFIX)
- Export `addSubscriber(listId: string, email: string, firstName?: string)` function
- Handle "Member Exists" (status 400) gracefully - return success with alreadyExists flag
- Throw on other errors

Create `src/app/api/mailchimp/sync/route.ts`:
- POST endpoint requiring auth
- Body: { pageId, listId }
- Fetch unsynced emails for page (synced_to_mailchimp = false)
- Call addSubscriber for each email
- Update synced_to_mailchimp = true and mailchimp_sync_at = now() for successful syncs
- Return { synced: number, failed: number, alreadyExists: number }

Create `src/components/fan-tools/mailchimp-settings.tsx`:
- Props: pageId (string)
- Input for Mailchimp List ID (store in localStorage per page for now)
- "Sync to Mailchimp" button
- Shows last sync timestamp if available
- Display sync results: "Synced X emails (Y already existed)"
- Error state if API fails
- Note: "Configure MAILCHIMP_API_KEY in environment variables"

Update `src/components/editor/settings-panel.tsx` (or create if doesn't exist):
- Add "Fan Tools" section with collapsible header
- Include QRCodeDialog trigger button ("Generate QR Code")
- Include EmailExport component
- Include MailchimpSettings component
- Pass pageId and username from context
  </action>
  <verify>
1. Mailchimp sync API processes emails
2. Settings panel shows all fan tools
3. QR code dialog opens from settings
4. npm run build completes
  </verify>
  <done>Mailchimp sync functional, all fan tools accessible from settings panel</done>
</task>

</tasks>

<verification>
1. QR code renders and downloads as SVG and PNG
2. Email export downloads CSV with proper formatting
3. Mailchimp sync syncs emails (requires env vars)
4. All tools accessible from settings panel
5. Build completes: `npm run build`
</verification>

<success_criteria>
- QR code dialog generates code for page URL
- QR downloads in SVG and PNG at multiple sizes
- CSV export includes all collected emails
- Mailchimp sync processes unsynced emails
- All tools accessible from editor settings panel
</success_criteria>

<output>
After completion, create `.planning/phases/10-fan-tools/10-02-SUMMARY.md`
</output>
