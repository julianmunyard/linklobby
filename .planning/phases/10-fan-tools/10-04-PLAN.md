---
phase: 10-fan-tools
plan: 04
type: execute
wave: 2
depends_on: ["10-03"]
files_modified:
  - src/types/card.ts
  - src/components/cards/release-card.tsx
  - src/components/editor/release-card-fields.tsx
  - src/components/editor/cards-tab.tsx
  - src/components/editor/card-property-editor.tsx
  - src/components/preview/card-renderer.tsx
  - src/stores/page-store.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "Artist can add a release card with album art and release date"
    - "Release card shows countdown timer when countdown enabled"
    - "Release card shows pre-save button before release"
    - "Release card auto-converts to music card when release goes live"
    - "Artist can toggle countdown on/off per release"
  artifacts:
    - path: "src/types/card.ts"
      provides: "ReleaseCardContent interface with release-specific fields"
      contains: "ReleaseCardContent"
    - path: "src/components/cards/release-card.tsx"
      provides: "Release card with countdown and pre-save"
      exports: ["ReleaseCard"]
    - path: "src/components/editor/release-card-fields.tsx"
      provides: "Editor fields for release card customization"
      exports: ["ReleaseCardFields"]
  key_links:
    - from: "src/components/cards/release-card.tsx"
      to: "react-countdown"
      via: "Countdown component import"
      pattern: "from 'react-countdown'"
    - from: "src/components/cards/release-card.tsx"
      to: "src/stores/page-store.ts"
      via: "updateCard action on countdown complete"
      pattern: "updateCard"
---

<objective>
Create release card functionality for pre-release content with countdown timer and automatic conversion to music card.

Purpose: Artists releasing new music need a way to build anticipation with countdowns and pre-save links, then seamlessly transition to streaming embeds when live.

Output: New 'release' card type with countdown timer, pre-save button, album art, and auto-conversion logic.
</objective>

<execution_context>
@/Users/julianmunyard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julianmunyard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-fan-tools/10-CONTEXT.md
@.planning/phases/10-fan-tools/10-RESEARCH.md

# Key existing files
@src/types/card.ts
@src/components/cards/music-card.tsx  # Pattern for music embeds
@src/lib/platform-embed.ts  # isMusicPlatform detection
@.planning/phases/10-fan-tools/10-03-PLAN.md  # Depends on scheduling infrastructure
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install countdown and create release card types</name>
  <files>
    package.json
    src/types/card.ts
  </files>
  <action>
Install react-countdown:
```bash
npm install react-countdown
```

Add to `src/types/card.ts`:

Add 'release' to CardType union.

Create ReleaseCardContent interface:
```typescript
export interface ReleaseCardContent extends ScheduledContent {
  // Core release info
  albumArtUrl?: string           // Uploaded album art
  albumArtStoragePath?: string   // For deletion
  releaseTitle?: string          // Album/single name
  artistName?: string            // Artist name (if different from profile)

  // Countdown
  showCountdown?: boolean        // Default true for new release cards
  releaseDate?: string           // ISO 8601 UTC - when release goes live

  // Pre-save
  preSaveUrl?: string            // Link to pre-save page (feature.fm, smarturl, etc.)
  preSaveButtonText?: string     // Default "Pre-save"

  // Music card conversion
  musicUrl?: string              // Spotify/Apple Music URL for post-release
  // When release date passes, card converts to music type using this URL

  // Styling
  textColor?: string
  fuzzyText?: FuzzyTextSettings
}
```

Add 'release' to CARD_TYPE_SIZING: `['big', 'small']`
Add type guard `isReleaseContent()`
Add to CardContent union

Note: ReleaseCardContent extends ScheduledContent so it inherits publishAt/expireAt from Plan 03.
  </action>
  <verify>
1. npm install completes
2. TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>react-countdown installed, ReleaseCardContent type defined with all fields</done>
</task>

<task type="auto">
  <name>Task 2: Create release card component with countdown</name>
  <files>
    src/components/cards/release-card.tsx
  </files>
  <action>
Create `src/components/cards/release-card.tsx`:

Props: card (Card), isEditing (boolean), onConvert (optional callback)

Structure:
1. Album art image (large, prominent)
2. Release title and artist name overlay
3. Countdown timer (if showCountdown && releaseDate in future)
4. Pre-save button (if preSaveUrl exists && before release date)
5. "Out Now" badge + streaming link (if past release date)

Countdown implementation using react-countdown:
```typescript
import Countdown from 'react-countdown'

const renderer = ({ days, hours, minutes, seconds, completed }) => {
  if (completed) {
    // Trigger conversion
    return <span className="text-lg font-bold">Out Now!</span>
  }

  return (
    <div className="flex gap-3 justify-center">
      {days > 0 && (
        <div className="text-center">
          <span className="text-3xl font-bold">{days}</span>
          <span className="text-xs block uppercase tracking-wide">days</span>
        </div>
      )}
      <div className="text-center">
        <span className="text-3xl font-bold">{String(hours).padStart(2, '0')}</span>
        <span className="text-xs block uppercase tracking-wide">hours</span>
      </div>
      <div className="text-center">
        <span className="text-3xl font-bold">{String(minutes).padStart(2, '0')}</span>
        <span className="text-xs block uppercase tracking-wide">min</span>
      </div>
      <div className="text-center">
        <span className="text-3xl font-bold">{String(seconds).padStart(2, '0')}</span>
        <span className="text-xs block uppercase tracking-wide">sec</span>
      </div>
    </div>
  )
}
```

Conversion logic:
- On countdown complete OR on initial render if past releaseDate:
- Check if musicUrl is a valid music platform URL (use isMusicPlatform from platform-embed.ts)
- If valid, trigger card type conversion to 'music' with appropriate MusicCardContent
- Call onConvert callback if provided

Styling:
- Dark overlay on album art for text readability
- Countdown uses bold monospace-style numbers
- Pre-save button styled as prominent CTA
- "Coming Soon" label above countdown
- Use theme colors via CSS variables
  </action>
  <verify>
1. Component renders with album art and countdown
2. Countdown ticks down correctly
3. Pre-save button links to preSaveUrl
4. No TypeScript errors
  </verify>
  <done>Release card renders with countdown timer, album art, and pre-save button</done>
</task>

<task type="auto">
  <name>Task 3: Release card editor and integration</name>
  <files>
    src/components/editor/release-card-fields.tsx
    src/components/editor/cards-tab.tsx
    src/components/editor/card-property-editor.tsx
    src/components/preview/card-renderer.tsx
    src/stores/page-store.ts
  </files>
  <action>
Create `src/components/editor/release-card-fields.tsx`:
- Image upload for album art (reuse ImageUpload component pattern)
- Input for releaseTitle
- Input for artistName (optional, placeholder: "Leave blank to use profile name")
- Datetime-local input for releaseDate (with UTC conversion like Schedule tab)
- Switch for showCountdown (default true)
- Input for preSaveUrl
- Input for preSaveButtonText (default "Pre-save")
- Input for musicUrl (labeled "Streaming URL (Spotify, Apple Music, etc.)")
- Help text: "When release goes live, this card will automatically show the music player"
- All fields use form.watch() for optimistic preview

Update `src/components/editor/cards-tab.tsx`:
- Add 'release' to card picker with Disc icon (or Album icon)
- Label: "Release"

Update `src/components/editor/card-property-editor.tsx`:
- Import and render ReleaseCardFields when card_type === 'release'

Update `src/components/preview/card-renderer.tsx`:
- Import ReleaseCard
- Add case for 'release' in switch statement
- Pass card, isEditing, and onConvert callback
- onConvert: use updateCard from store to change card_type to 'music' and migrate content

Update `src/stores/page-store.ts`:
- Add default content for 'release' in addCard action:
```typescript
release: {
  showCountdown: true,
  preSaveButtonText: 'Pre-save',
}
```

- Add `convertReleaseToMusic(cardId: string)` action:
  - Get card by ID
  - Extract musicUrl from content
  - Detect platform using isMusicPlatform
  - Build MusicCardContent with platform, embedUrl, etc.
  - Update card: card_type = 'music', content = new MusicCardContent
  </action>
  <verify>
1. Release card appears in card picker
2. Editor fields work with live preview
3. Album art uploads correctly
4. Release date input stores UTC
5. Card conversion works when countdown completes
6. npm run build completes
  </verify>
  <done>Release card fully integrated with editor, countdown, and auto-conversion to music card</done>
</task>

</tasks>

<verification>
1. TypeScript compilation passes: `npx tsc --noEmit`
2. Release card appears in card picker
3. Card renders with album art, countdown, pre-save button
4. Countdown ticks down correctly
5. Card converts to music card when past release date
6. Build completes: `npm run build`
</verification>

<success_criteria>
- Artist can add release card from card picker
- Card displays album art, title, artist name
- Countdown timer shows when enabled and before release
- Pre-save button links to external pre-save URL
- Card auto-converts to music card when release goes live (if musicUrl provided)
- Artist can toggle countdown visibility
</success_criteria>

<output>
After completion, create `.planning/phases/10-fan-tools/10-04-SUMMARY.md`
</output>
