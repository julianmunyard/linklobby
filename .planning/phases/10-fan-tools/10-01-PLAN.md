---
phase: 10-fan-tools
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/card.ts
  - src/types/fan-tools.ts
  - src/app/api/emails/route.ts
  - src/components/cards/email-collection-card.tsx
  - src/components/editor/email-collection-fields.tsx
  - src/components/editor/cards-tab.tsx
  - src/components/preview/card-renderer.tsx
  - src/stores/page-store.ts
autonomous: true

must_haves:
  truths:
    - "Artist can add an email collection card to their page"
    - "Visitors can submit their email through the card"
    - "Submitted emails are stored in the database"
    - "Email collection card appears in card picker and renders in preview"
  artifacts:
    - path: "src/types/fan-tools.ts"
      provides: "CollectedEmail type and EmailCollectionCardContent interface"
      exports: ["CollectedEmail", "EmailCollectionCardContent"]
    - path: "src/app/api/emails/route.ts"
      provides: "POST endpoint for email submission"
      exports: ["POST"]
    - path: "src/components/cards/email-collection-card.tsx"
      provides: "Email collection form card component"
      exports: ["EmailCollectionCard"]
    - path: "src/components/editor/email-collection-fields.tsx"
      provides: "Editor fields for customizing email card"
      exports: ["EmailCollectionFields"]
  key_links:
    - from: "src/components/cards/email-collection-card.tsx"
      to: "/api/emails"
      via: "fetch POST on form submit"
      pattern: "fetch.*api/emails"
    - from: "src/components/preview/card-renderer.tsx"
      to: "src/components/cards/email-collection-card.tsx"
      via: "switch case for email-collection type"
      pattern: "case.*email-collection"
---

<objective>
Create email collection functionality allowing artists to capture fan emails through an inline form card.

Purpose: Artists need to own their fan data. Email collection is the foundation of fan engagement and addresses a major competitive gap.

Output: New 'email-collection' card type with form, API endpoint for submission, and database storage.
</objective>

<execution_context>
@/Users/julianmunyard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julianmunyard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-fan-tools/10-CONTEXT.md
@.planning/phases/10-fan-tools/10-RESEARCH.md

# Key existing files
@src/types/card.ts
@src/stores/page-store.ts
@src/components/preview/card-renderer.tsx
@src/components/editor/cards-tab.tsx
@src/components/auth/signup-form.tsx  # Pattern for React Hook Form + Zod
</context>

<tasks>

<task type="auto">
  <name>Task 1: Email collection types and database schema</name>
  <files>
    src/types/fan-tools.ts
    src/types/card.ts
  </files>
  <action>
Create new file `src/types/fan-tools.ts` with:
- `CollectedEmail` interface: id, page_id, email, name (optional), collected_at, source_card_id (optional), synced_to_mailchimp, mailchimp_sync_at
- `EmailCollectionCardContent` interface extending card content: heading (string, default "Stay in the loop"), subheading (optional), buttonText (default "Subscribe"), showNameField (boolean), successMessage (default "Thanks for subscribing!")

Update `src/types/card.ts`:
- Add 'email-collection' to CardType union
- Add 'email-collection' to CARD_TYPE_SIZING with `null` (always full width)
- Add 'email-collection' to CARD_TYPES_NO_IMAGE array
- Add type guard `isEmailCollectionContent()`
- Add EmailCollectionCardContent to CardContent union

Create SQL migration in comments (user will run manually):
```sql
CREATE TABLE collected_emails (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  page_id UUID NOT NULL REFERENCES pages(id) ON DELETE CASCADE,
  email VARCHAR(255) NOT NULL,
  name VARCHAR(255),
  collected_at TIMESTAMPTZ DEFAULT NOW(),
  source_card_id UUID REFERENCES cards(id) ON DELETE SET NULL,
  synced_to_mailchimp BOOLEAN DEFAULT FALSE,
  mailchimp_sync_at TIMESTAMPTZ,
  UNIQUE(page_id, email)
);

CREATE INDEX idx_collected_emails_page_id ON collected_emails(page_id);
ALTER TABLE collected_emails ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view their page emails" ON collected_emails
  FOR SELECT USING (page_id IN (SELECT id FROM pages WHERE user_id = auth.uid()));

CREATE POLICY "Public can insert emails" ON collected_emails
  FOR INSERT WITH CHECK (true);
```
  </action>
  <verify>TypeScript compiles without errors: `npx tsc --noEmit`</verify>
  <done>EmailCollectionCardContent type exists, CardType includes 'email-collection', SQL migration documented for user</done>
</task>

<task type="auto">
  <name>Task 2: Email collection API endpoint</name>
  <files>
    src/app/api/emails/route.ts
  </files>
  <action>
Create POST endpoint at `/api/emails` that:

1. Accepts JSON body: { email: string, name?: string, pageId: string, cardId?: string }
2. Validates email with Zod schema (z.string().email())
3. Uses Supabase client to insert into collected_emails table
4. Handles duplicate emails gracefully (UNIQUE constraint) - return 200 with { success: true, alreadySubscribed: true }
5. Returns 200 with { success: true } on new subscription
6. Returns 400 with { error: string } on validation failure

Use existing Supabase patterns from `src/lib/supabase/client.ts`. This endpoint is PUBLIC (no auth required) since visitors submit emails.

Follow the existing API route patterns from `src/app/api/cards/route.ts` for error handling structure.
  </action>
  <verify>curl -X POST http://localhost:3000/api/emails -H "Content-Type: application/json" -d '{"email":"test@example.com","pageId":"test-page-id"}' returns JSON response</verify>
  <done>POST /api/emails accepts email submissions and stores in database</done>
</task>

<task type="auto">
  <name>Task 3: Email collection card and editor integration</name>
  <files>
    src/components/cards/email-collection-card.tsx
    src/components/editor/email-collection-fields.tsx
    src/components/editor/cards-tab.tsx
    src/components/editor/card-property-editor.tsx
    src/components/preview/card-renderer.tsx
    src/stores/page-store.ts
  </files>
  <action>
Create `src/components/cards/email-collection-card.tsx`:
- Props: card (Card), pageId (string), isEditing (boolean)
- Display heading, optional subheading from card.content
- Form with email input (always) and name input (if showNameField)
- Submit button with buttonText from content
- Use React Hook Form + Zod validation (pattern from signup-form.tsx)
- On submit: POST to /api/emails with pageId and cardId
- Show success message after submission (or error message on failure)
- When isEditing=true, show form but disable submission (preview only)
- Style to match existing card aesthetics (use ThemedCardWrapper if needed)

Create `src/components/editor/email-collection-fields.tsx`:
- Input for heading (default "Stay in the loop")
- Input for subheading (optional)
- Input for buttonText (default "Subscribe")
- Switch for showNameField (default false)
- Input for successMessage (default "Thanks for subscribing!")
- All fields use form.watch() for optimistic preview updates

Update `src/components/editor/cards-tab.tsx`:
- Add 'email-collection' to card picker with Mail icon
- Label: "Email Collection"

Update `src/components/editor/card-property-editor.tsx`:
- Import and render EmailCollectionFields when card_type === 'email-collection'

Update `src/components/preview/card-renderer.tsx`:
- Import EmailCollectionCard
- Add case for 'email-collection' in switch statement
- Pass card, pageId (from context), and isEditing prop

Update `src/stores/page-store.ts`:
- Add default content for 'email-collection' in addCard action:
  { heading: "Stay in the loop", buttonText: "Subscribe", showNameField: false, successMessage: "Thanks for subscribing!" }
  </action>
  <verify>
1. In editor, click Add Card and see "Email Collection" option
2. Add email collection card - appears in preview with form
3. Edit card properties - preview updates live
4. npm run build completes without errors
  </verify>
  <done>Email collection card fully integrated into editor and preview with customizable fields</done>
</task>

</tasks>

<verification>
1. TypeScript compilation passes: `npx tsc --noEmit`
2. Email collection card appears in card picker
3. Card renders with customizable heading, button text
4. Form validates email format
5. API endpoint accepts submissions
6. Build completes: `npm run build`
</verification>

<success_criteria>
- Artist can add email collection card from card picker
- Card displays form with email field (and optional name field)
- Visitor can submit email and see success message
- API stores email in database
- Editor fields allow customizing heading, button text, success message
</success_criteria>

<output>
After completion, create `.planning/phases/10-fan-tools/10-01-SUMMARY.md`
</output>
