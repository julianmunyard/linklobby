---
phase: 11-analytics-pixels-legal
plan: 04
type: execute
wave: 2
depends_on: ["11-02"]
files_modified:
  - src/components/pixels/facebook-pixel.tsx
  - src/components/pixels/google-analytics.tsx
  - src/app/api/pixels/facebook-capi/route.ts
  - src/app/api/pixels/test-event/route.ts
  - src/components/analytics/pixel-config.tsx
  - src/components/editor/insights-tab.tsx
  - src/app/[username]/page.tsx
  - src/app/api/page/route.ts
autonomous: true
user_setup:
  - service: facebook-pixel
    why: "Facebook Pixel tracking for ad retargeting"
    env_vars:
      - name: FACEBOOK_CAPI_TOKEN
        source: "Facebook Events Manager -> Settings -> Generate Access Token"
    dashboard_config:
      - task: "Create Facebook Pixel"
        location: "Facebook Events Manager -> Connect Data Sources -> Web -> Facebook Pixel"
  - service: google-analytics
    why: "Google Analytics GA4 tracking"
    dashboard_config:
      - task: "Create GA4 property and get Measurement ID"
        location: "Google Analytics Admin -> Create Property -> Get Measurement ID (G-XXXXXXXXXX)"

must_haves:
  truths:
    - "Artist can paste Facebook Pixel ID in Insights tab and it tracks page views on public page"
    - "Artist can paste GA4 Measurement ID in Insights tab and it tracks page views on public page"
    - "Pixels only load after visitor accepts cookies via consent banner"
    - "Artist can send a test event to verify pixel is working"
    - "Card clicks fire ViewContent events to both Facebook Pixel and GA4"
    - "Facebook Conversions API sends server-side events with event_id deduplication"
  artifacts:
    - path: "src/components/pixels/facebook-pixel.tsx"
      provides: "Client-side Facebook Pixel integration"
      min_lines: 30
    - path: "src/components/pixels/google-analytics.tsx"
      provides: "Client-side GA4 integration"
      min_lines: 20
    - path: "src/app/api/pixels/facebook-capi/route.ts"
      provides: "Server-side Facebook Conversions API endpoint"
      exports: ["POST"]
    - path: "src/components/analytics/pixel-config.tsx"
      provides: "Pixel ID input form with test mode in Insights tab"
      min_lines: 40
  key_links:
    - from: "src/app/[username]/page.tsx"
      to: "src/components/pixels/facebook-pixel.tsx"
      via: "Conditional rendering after consent"
      pattern: "FacebookPixel|facebook-pixel"
    - from: "src/components/pixels/facebook-pixel.tsx"
      to: "/api/pixels/facebook-capi"
      via: "Dual tracking - browser pixel + server CAPI"
      pattern: "facebook-capi"
    - from: "src/components/analytics/pixel-config.tsx"
      to: "/api/page"
      via: "Saves pixel IDs to page settings"
      pattern: "api/page"
---

<objective>
Integrate Facebook Pixel and Google Analytics GA4 into public pages with cookie consent gating, server-side Conversions API for Facebook, test event verification, and pixel configuration UI in the Insights tab.

Purpose: Artists need pixel tracking for ad campaigns. Facebook Pixel and GA4 are the two most important tracking tools for retargeting and understanding audience behavior. Server-side CAPI ensures iOS accuracy.
Output: Pixel config in Insights tab, conditional pixel loading on public pages, CAPI server endpoint, test event verification.
</objective>

<execution_context>
@/Users/julianmunyard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julianmunyard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-analytics-pixels-legal/11-RESEARCH.md
@.planning/phases/11-analytics-pixels-legal/11-02-SUMMARY.md
@src/app/[username]/page.tsx
@src/app/[username]/layout.tsx
@src/components/legal/cookie-consent-banner.tsx
@src/app/api/page/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create pixel components and Conversions API endpoint</name>
  <files>
    src/components/pixels/facebook-pixel.tsx
    src/components/pixels/google-analytics.tsx
    src/app/api/pixels/facebook-capi/route.ts
    src/app/api/pixels/test-event/route.ts
  </files>
  <action>
    1. Create `src/components/pixels/facebook-pixel.tsx`:
       - 'use client' component
       - Props: `pixelId: string`
       - On mount, inject Facebook Pixel base code via script (standard fbq init pattern)
       - Call fbq('init', pixelId) and fbq('track', 'PageView')
       - Export `trackFbEvent(eventName: string, params: Record<string, unknown>, eventId: string)` function that calls fbq('track', ...) and also sends to CAPI endpoint
       - The CAPI fetch sends: event_name, event_id (for deduplication), custom_data, user_data (client_user_agent from navigator.userAgent, fbc/fbp cookies if present)
       - Add TypeScript declaration for window.fbq (declare global interface Window)
       - Component renders null (script injection only)

    2. Create `src/components/pixels/google-analytics.tsx`:
       - 'use client' component
       - Props: `measurementId: string`
       - Use @next/third-parties GoogleAnalytics component if available, or inject gtag.js manually:
         - Load https://www.googletagmanager.com/gtag/js?id={measurementId} via Script component
         - Initialize: window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', measurementId)
       - Export `trackGaEvent(eventName: string, params: Record<string, unknown>)` function that calls gtag('event', ...)
       - Add TypeScript declarations for window.gtag and window.dataLayer
       - Component renders null

    3. Create `src/app/api/pixels/facebook-capi/route.ts`:
       - POST handler for Facebook Conversions API
       - Accept: event_name, event_id, custom_data, user_data from request body
       - Read FACEBOOK_CAPI_TOKEN from process.env (if not set, return 200 with { skipped: true })
       - Read pixel_id from request body (artist's pixel ID, not env var - each artist has their own)
       - Get real IP from x-forwarded-for header
       - Get real UA from request headers
       - Send to Facebook Graph API: POST https://graph.facebook.com/v19.0/{pixel_id}/events?access_token={token}
       - Body: { data: [{ event_name, event_time, event_id, event_source_url (from referer header), action_source: 'website', user_data: { client_ip_address: ip, client_user_agent: ua, fbc, fbp }, custom_data }] }
       - Return response from Facebook or { success: true } on success
       - Gracefully handle errors (log but don't crash)

    4. Create `src/app/api/pixels/test-event/route.ts`:
       - POST handler for sending test events
       - Accept: pixelType ('facebook' | 'google'), pixelId from body
       - For Facebook: send a test PageView event via CAPI with test_event_code parameter
       - For Google: return instructions to check GA4 Realtime report (can't programmatically verify GA4)
       - Return { success: true, message: 'Test event sent. Check Facebook Events Manager / GA4 Realtime for verification.' }
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Facebook Pixel component injects fbq script
    - GA4 component injects gtag script
    - CAPI route accepts POST and sends to Facebook Graph API
    - Test event route sends verification events
  </verify>
  <done>
    Facebook Pixel and GA4 client components ready for conditional rendering. CAPI server endpoint handles server-side event forwarding with deduplication. Test event endpoint enables pixel verification.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create pixel config UI and wire pixels into public pages</name>
  <files>
    src/components/analytics/pixel-config.tsx
    src/components/editor/insights-tab.tsx
    src/app/[username]/page.tsx
    src/app/api/page/route.ts
  </files>
  <action>
    1. Create `src/components/analytics/pixel-config.tsx`:
       - 'use client' component
       - Props: `pageId: string`
       - State: facebookPixelId (string), gaMeasurementId (string), isSaving (boolean), testResult (string | null)
       - On mount, fetch current pixel settings from page data (stored in page.theme_settings or a new pixel_settings JSONB column - prefer using existing theme_settings.pixels sub-object to avoid schema changes)
       - Two input sections:
         a. **Facebook Pixel**: Input for Pixel ID (placeholder: "Enter your Facebook Pixel ID"), helper text "Find this in Facebook Events Manager", Save button, Test button
         b. **Google Analytics**: Input for Measurement ID (placeholder: "G-XXXXXXXXXX"), helper text "Find this in GA4 Admin", Save button, Test button
       - Save: PATCH /api/page with pixel settings stored in theme_settings.pixels: { facebookPixelId, gaMeasurementId }
       - Test: POST /api/pixels/test-event, show success/failure toast
       - Visual: Use shadcn Card for each pixel section, Input + Button layout, toast for feedback
       - Section header: "Tracking Pixels" with subtitle "Connect your ad platforms to track visitor behavior"

    2. Modify `src/components/editor/insights-tab.tsx` (created in Plan 03):
       - Add PixelConfig component below the card leaderboard section
       - Separated by a section divider
       - Pass pageId to PixelConfig

    3. Modify `src/app/[username]/page.tsx`:
       - Import FacebookPixel and GoogleAnalytics components
       - Extract pixel settings from page.theme_settings.pixels (facebookPixelId, gaMeasurementId)
       - Create a new client component `PixelLoader` (can be in the same file or separate):
         - 'use client' component that listens for 'consent-granted' custom event
         - State: hasConsent (check localStorage for linklobby-consent cookie on mount)
         - If hasConsent is true, render FacebookPixel and/or GoogleAnalytics components
         - If not, listen for consent-granted event, then set hasConsent = true
         - CRITICAL: Never render pixel components before consent
       - Add PixelLoader to the page, passing pixelId and measurementId props
       - Also wire card click tracking: when ClickTracker detects a card click, call trackFbEvent('ViewContent', { content_ids: [cardId], content_type: 'card' }, eventId) and trackGaEvent('card_click', { card_id: cardId })

    4. Modify `src/app/api/page/route.ts`:
       - Ensure the PATCH handler can accept and save theme_settings.pixels sub-object
       - If the route already handles theme_settings updates, this should work automatically since it's JSONB
       - If not, add handling for merging pixels into existing theme_settings
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - PixelConfig renders in Insights tab with input fields
    - Pixels only load after consent (check PixelLoader logic)
    - Card clicks trigger ViewContent events on both platforms
    - Page API route saves pixel settings
    - `npm run build` succeeds
  </verify>
  <done>
    Artists can configure Facebook Pixel and GA4 in the Insights tab. Pixels load on public pages only after cookie consent. Card clicks fire ViewContent events to both platforms. Test mode verifies pixel connectivity.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. Pixel config inputs appear in Insights tab
3. Pixel IDs save to page settings via API
4. Public pages load pixels only after consent acceptance
5. Facebook CAPI endpoint receives and forwards events
6. Test event button sends verification event
7. Card clicks trigger events on both Facebook and GA4
8. Build succeeds with `npm run build`
</verification>

<success_criteria>
- Facebook Pixel tracks PageView and ViewContent events on public pages
- GA4 tracks page_view and card_click events on public pages
- Pixels NEVER load before cookie consent (GDPR compliant)
- Facebook CAPI provides server-side backup tracking with event_id deduplication
- Artist can verify pixel setup via test event button
- Pixel IDs persist in page settings
</success_criteria>

<output>
After completion, create `.planning/phases/11-analytics-pixels-legal/11-04-SUMMARY.md`
</output>
