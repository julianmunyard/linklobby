---
phase: 11-analytics-pixels-legal
plan: 05
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - src/lib/legal/export-user-data.ts
  - src/app/api/legal/export-data/route.ts
  - src/app/api/legal/delete-account/route.ts
  - supabase/migrations/account_deletion_columns.sql
  - src/components/settings/data-privacy-section.tsx
  - src/components/editor/settings-tab.tsx
autonomous: true

must_haves:
  truths:
    - "Artist can download a ZIP file containing all their data (profile, page, cards, analytics, images)"
    - "ZIP file includes a README explaining contents"
    - "Artist can request account deletion from Settings"
    - "Account is disabled immediately but data retained for 30 days"
    - "Artist can recover account by logging in during 30-day grace period"
    - "Deletion confirmation requires typing username to prevent accidents"
  artifacts:
    - path: "src/lib/legal/export-user-data.ts"
      provides: "ZIP file generation with all user data"
      exports: ["exportUserData"]
    - path: "src/app/api/legal/export-data/route.ts"
      provides: "GET endpoint that streams ZIP download"
      exports: ["GET"]
    - path: "src/app/api/legal/delete-account/route.ts"
      provides: "POST for deletion, PATCH for recovery"
      exports: ["POST", "PATCH"]
    - path: "src/components/settings/data-privacy-section.tsx"
      provides: "Data export button and account deletion UI"
      min_lines: 60
  key_links:
    - from: "src/components/settings/data-privacy-section.tsx"
      to: "/api/legal/export-data"
      via: "Download button triggers ZIP download"
      pattern: "api/legal/export-data"
    - from: "src/components/settings/data-privacy-section.tsx"
      to: "/api/legal/delete-account"
      via: "Delete button triggers account deletion"
      pattern: "api/legal/delete-account"
    - from: "src/components/editor/settings-tab.tsx"
      to: "src/components/settings/data-privacy-section.tsx"
      via: "DataPrivacySection rendered in Settings tab"
      pattern: "DataPrivacySection|data-privacy"
---

<objective>
Implement GDPR data export (ZIP download of all user data) and account deletion with 30-day grace period recovery. Add the data & privacy section to the Settings tab.

Purpose: GDPR compliance requires users to be able to export all their data and delete their account. The 30-day grace period follows industry best practices and prevents accidental permanent data loss.
Output: Data export ZIP download, account deletion flow with recovery, Settings tab UI.
</objective>

<execution_context>
@/Users/julianmunyard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julianmunyard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-analytics-pixels-legal/11-RESEARCH.md
@.planning/phases/11-analytics-pixels-legal/11-01-SUMMARY.md
@src/components/editor/settings-tab.tsx
@src/lib/supabase/server.ts
@src/lib/supabase/storage.ts
@supabase/schema.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create data export and account deletion API routes</name>
  <files>
    src/lib/legal/export-user-data.ts
    src/app/api/legal/export-data/route.ts
    src/app/api/legal/delete-account/route.ts
    supabase/migrations/account_deletion_columns.sql
  </files>
  <action>
    1. Create `supabase/migrations/account_deletion_columns.sql`:
       - ALTER TABLE profiles ADD COLUMN IF NOT EXISTS deleted_at TIMESTAMPTZ DEFAULT NULL
       - ALTER TABLE profiles ADD COLUMN IF NOT EXISTS deletion_scheduled_for TIMESTAMPTZ DEFAULT NULL
       - ALTER TABLE profiles ADD COLUMN IF NOT EXISTS is_active BOOLEAN DEFAULT TRUE
       - Add comment noting user must run this in Supabase SQL Editor

    2. Create `src/lib/legal/export-user-data.ts`:
       - Export `exportUserData(userId: string, supabase: SupabaseClient): Promise<ReadableStream>` that returns a streaming response
       - Use JSZip (not archiver - better for in-memory operations and edge compatibility): `npm install jszip`
       - Fetch all user data:
         a. Profile data: SELECT * FROM profiles WHERE id = userId
         b. Page data: SELECT * FROM pages WHERE user_id = userId
         c. Cards data: SELECT * FROM cards WHERE page_id = (user's page id)
         d. Analytics summary: aggregated page views and card clicks (counts only, NOT raw visitor hashes - privacy protection for other visitors)
         e. Collected emails: SELECT * FROM collected_emails WHERE page_id = (user's page id) (if table exists)
       - For each data type, add as JSON file in ZIP:
         - profile.json, page-config.json, cards.json, analytics-summary.json, emails.json
       - Fetch user images from Supabase storage:
         - List files in user's storage bucket/folder
         - Download each and add to images/ directory in ZIP
       - Add README.txt explaining contents (what each file contains, data format, export date)
       - Return ZIP as Uint8Array via jszip.generateAsync({ type: 'uint8array' })

    3. Create `src/app/api/legal/export-data/route.ts`:
       - GET handler, authenticated (require session)
       - Call exportUserData with userId and supabase client
       - Return Response with ZIP data, headers:
         - Content-Type: application/zip
         - Content-Disposition: attachment; filename="linklobby-data-export-{date}.zip"
       - Handle errors gracefully, return 500 with error message

    4. Create `src/app/api/legal/delete-account/route.ts`:
       - POST handler (initiate deletion):
         - Authenticated, require session
         - Accept body: { confirmUsername: string }
         - Verify confirmUsername matches actual username (prevent accidental deletion)
         - Set deleted_at = NOW(), deletion_scheduled_for = NOW() + 30 days, is_active = false on profile
         - Unpublish the user's page (set is_published = false)
         - Sign out user via supabase.auth.admin.deleteUser is too aggressive - just mark as inactive
         - Return { success: true, message: 'Account scheduled for deletion in 30 days', deletionDate: deletion_scheduled_for }
       - PATCH handler (recover account):
         - Authenticated (user logged in during grace period)
         - Check if deleted_at is set and deletion_scheduled_for > now
         - If yes: clear deleted_at, deletion_scheduled_for, set is_active = true
         - Return { success: true, message: 'Account restored successfully' }
         - If grace period expired: return 400 { error: 'Account cannot be recovered' }
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - jszip is in package.json
    - SQL migration file has valid ALTER TABLE statements
    - Export route returns application/zip content type
    - Delete route validates username confirmation
    - Recovery route checks grace period
  </verify>
  <done>
    Data export generates ZIP with all user data. Account deletion sets 30-day grace period with username confirmation. Recovery endpoint allows canceling deletion during grace period.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create data & privacy UI section in Settings tab</name>
  <files>
    src/components/settings/data-privacy-section.tsx
    src/components/editor/settings-tab.tsx
  </files>
  <action>
    1. Create `src/components/settings/data-privacy-section.tsx`:
       - 'use client' component
       - Props: `username: string`
       - Three sections:

       a. **Download Your Data** section:
          - Description: "Download a ZIP file containing all your profile data, page configuration, cards, analytics, and uploaded images."
          - Button: "Download My Data" with Download icon
          - On click: window.location.href = '/api/legal/export-data' (triggers browser download)
          - Loading state while download initiates
          - Note: "Export includes profile, page settings, cards, analytics summary, and images in their original format."

       b. **Delete Account** section (visually separated, danger zone styling):
          - Description: "Permanently delete your account and all associated data. Your page will be unpublished immediately. Account data will be permanently deleted after 30 days."
          - "Delete Account" button (destructive variant, red)
          - On click: open AlertDialog confirmation
          - AlertDialog content:
            - Title: "Delete your account?"
            - Description: "This will immediately unpublish your page and schedule your account for permanent deletion in 30 days. You can recover your account by logging in before the deletion date."
            - Input: "Type your username to confirm" with validation (must match exactly)
            - Cancel button and "Delete Account" destructive button (disabled until username matches)
          - On confirm: POST /api/legal/delete-account with { confirmUsername }
          - On success: redirect to login page with toast message
          - On error: show error toast

       c. **Recovery notice** (only shown if account is in deletion state):
          - Warning banner: "Your account is scheduled for deletion on {date}. Click below to cancel."
          - "Cancel Deletion" button
          - On click: PATCH /api/legal/delete-account
          - On success: refresh page, show success toast

       - Use shadcn components: Card, Button, AlertDialog, Input, Separator
       - Danger zone section: red/destructive border or background tint

    2. Modify `src/components/editor/settings-tab.tsx`:
       - Import DataPrivacySection
       - Add a new Collapsible section at the bottom of settings tab: "Data & Privacy"
       - Pass username (already available from pageInfo state)
       - Add Separator before the section
       - Use Shield icon for the collapsible trigger
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - DataPrivacySection renders in Settings tab
    - Download button points to export-data API
    - Delete dialog requires username confirmation
    - Recovery section conditionally shows
    - `npm run build` succeeds
  </verify>
  <done>
    Settings tab has Data & Privacy section with data export download button, account deletion with username confirmation and 30-day grace period, and recovery option during grace period.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. Data export downloads a ZIP file with profile, page, cards, analytics, and images
3. ZIP contains README.txt explaining contents
4. Account deletion requires username confirmation
5. Account is marked inactive immediately, deletion scheduled for 30 days
6. Recovery works during grace period
7. Settings tab shows Data & Privacy section
8. Build succeeds with `npm run build`
</verification>

<success_criteria>
- GDPR data export provides complete user data in portable ZIP format
- Account deletion follows 30-day grace period pattern
- Username confirmation prevents accidental deletion
- Recovery is possible during grace period
- UI is clear about what happens and when
- Analytics summary in export contains aggregated counts (not other visitors' data)
</success_criteria>

<output>
After completion, create `.planning/phases/11-analytics-pixels-legal/11-05-SUMMARY.md`
</output>
