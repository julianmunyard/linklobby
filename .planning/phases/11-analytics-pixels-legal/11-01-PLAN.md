---
phase: 11-analytics-pixels-legal
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/analytics_tables.sql
  - src/lib/analytics/visitor-hash.ts
  - src/lib/analytics/track-event.ts
  - src/app/api/analytics/track/route.ts
  - src/app/api/analytics/stats/route.ts
  - src/app/[username]/page.tsx
  - src/components/public/click-tracker.tsx
autonomous: true

must_haves:
  truths:
    - "Page views are recorded when visitors load a public page"
    - "Card clicks are recorded when visitors click cards on a public page"
    - "Unique visitors are counted using privacy-safe hashed fingerprints (not cookies)"
    - "Analytics stats API returns unique visitors, total views, and per-card click counts with CTR"
  artifacts:
    - path: "supabase/migrations/analytics_tables.sql"
      provides: "analytics_page_views and analytics_card_clicks tables"
      contains: "CREATE TABLE analytics_page_views"
    - path: "src/lib/analytics/visitor-hash.ts"
      provides: "Privacy-safe visitor hash from IP + UA + daily salt"
      exports: ["createVisitorHash"]
    - path: "src/app/api/analytics/track/route.ts"
      provides: "POST endpoint for recording page views and card clicks"
      exports: ["POST"]
    - path: "src/app/api/analytics/stats/route.ts"
      provides: "GET endpoint for fetching analytics data with time filtering"
      exports: ["GET"]
    - path: "src/components/public/click-tracker.tsx"
      provides: "Client component that tracks card clicks on public page"
  key_links:
    - from: "src/app/[username]/page.tsx"
      to: "/api/analytics/track"
      via: "ClickTracker component sends page view on mount"
      pattern: "ClickTracker|click-tracker"
    - from: "src/components/public/click-tracker.tsx"
      to: "/api/analytics/track"
      via: "fetch POST on card click and page load"
      pattern: "fetch.*api/analytics/track"
    - from: "src/app/api/analytics/track/route.ts"
      to: "supabase analytics tables"
      via: "INSERT into analytics_page_views or analytics_card_clicks"
      pattern: "analytics_page_views|analytics_card_clicks"
---

<objective>
Create the analytics tracking foundation: database tables for page views and card clicks, server-side tracking API with privacy-safe visitor hashing, stats API for fetching aggregated analytics data, and client-side click tracking on public pages.

Purpose: This is the data layer that all analytics features depend on. Without recorded events, the Insights dashboard, pixel tracking, and data export have nothing to show.
Output: Working analytics pipeline from public page visit -> API -> database -> stats query.
</objective>

<execution_context>
@/Users/julianmunyard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julianmunyard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-analytics-pixels-legal/11-RESEARCH.md
@src/app/[username]/page.tsx
@src/lib/supabase/server.ts
@src/lib/supabase/public.ts
@supabase/schema.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create analytics database schema and tracking API</name>
  <files>
    supabase/migrations/analytics_tables.sql
    src/lib/analytics/visitor-hash.ts
    src/lib/analytics/track-event.ts
    src/app/api/analytics/track/route.ts
    src/app/api/analytics/stats/route.ts
  </files>
  <action>
    1. Create `supabase/migrations/analytics_tables.sql` with:
       - `analytics_page_views` table: time (TIMESTAMPTZ NOT NULL), page_id (UUID NOT NULL REFERENCES pages(id) ON DELETE CASCADE), visitor_hash (TEXT NOT NULL), pathname (TEXT NOT NULL), referrer (TEXT), user_agent (TEXT)
       - `analytics_card_clicks` table: time (TIMESTAMPTZ NOT NULL), card_id (UUID NOT NULL REFERENCES cards(id) ON DELETE CASCADE), page_id (UUID NOT NULL REFERENCES pages(id) ON DELETE CASCADE), visitor_hash (TEXT NOT NULL)
       - Enable RLS on both tables. Policy: INSERT allowed by anyone (anon role for public tracking). SELECT only by page owner (auth.uid() matches page user_id).
       - Create indexes: (page_id, time DESC) on page_views, (card_id, time DESC) on card_clicks
       - NOTE: Do NOT use TimescaleDB create_hypertable - use standard Postgres tables. TimescaleDB extension may not be enabled on the user's Supabase instance. Standard tables with proper indexes are sufficient for the traffic levels expected. Add a comment noting TimescaleDB can be enabled later for scale.
       - Add SQL as a checkpoint:human-action note in the migration file header (user must run this manually in Supabase SQL Editor)

    2. Create `src/lib/analytics/visitor-hash.ts`:
       - Export `createVisitorHash(ip: string | null, userAgent: string | null): string`
       - Use Node.js crypto.createHash('sha256') with input: `${ip}|${userAgent}|${dailySalt}` where dailySalt is `new Date().toDateString()`
       - This produces a privacy-safe hash that changes daily (no persistent tracking)
       - Return hex digest

    3. Create `src/lib/analytics/track-event.ts`:
       - Export helper types: `TrackPageViewPayload { pageId: string, pathname: string }` and `TrackCardClickPayload { cardId: string, pageId: string }`
       - Export `trackPageView(payload)` and `trackCardClick(payload)` functions that POST to `/api/analytics/track`

    4. Create `src/app/api/analytics/track/route.ts`:
       - POST handler accepts JSON body with `type` field ('page_view' or 'card_click')
       - For page_view: extract pageId, pathname from body. Get IP from x-forwarded-for header, UA from user-agent header. Create visitor hash. Insert into analytics_page_views.
       - For card_click: extract cardId, pageId from body. Create visitor hash. Insert into analytics_card_clicks.
       - Use createClient from '@/lib/supabase/server' for database access
       - Return 200 with { success: true }. Swallow errors gracefully (tracking should never break the user experience) - return 200 even on DB errors but log the error.

    5. Create `src/app/api/analytics/stats/route.ts`:
       - GET handler, authenticated (require session via getUser())
       - Query params: pageId (required), days (optional, default 7, accept 7/30/0 where 0 = all time)
       - Fetch page ownership verification (page.user_id must match session user)
       - Query unique visitors: COUNT(DISTINCT visitor_hash) from analytics_page_views filtered by page_id and time range
       - Query total views: COUNT(*) from same
       - Query per-card stats: JOIN cards with analytics_card_clicks, COUNT(DISTINCT visitor_hash) as clicks per card, calculate CTR = (clicks / uniqueVisitors) * 100, sort by clicks DESC (leaderboard)
       - Query time-series: Group page views by day (DATE_TRUNC), return array of { date, views, visitors } for charting
       - Return JSON: { uniqueVisitors, totalViews, cardStats: [{ id, title, cardType, clicks, ctr }], timeSeries: [{ date, views, visitors }] }
  </action>
  <verify>
    - `npx tsc --noEmit` passes (no type errors)
    - SQL file exists with valid CREATE TABLE statements
    - API routes have proper exports (POST for track, GET for stats)
    - visitor-hash.ts exports createVisitorHash
  </verify>
  <done>
    Analytics tracking API accepts page view and card click events, stores them in database tables, and stats API returns aggregated data with time filtering. Visitor hashing uses privacy-safe daily-rotating salt.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire click tracking into public pages</name>
  <files>
    src/components/public/click-tracker.tsx
    src/app/[username]/page.tsx
  </files>
  <action>
    1. Create `src/components/public/click-tracker.tsx`:
       - 'use client' component
       - Props: `pageId: string`, `cards: Array<{ id: string }>` (minimal card data)
       - On mount (useEffect), send page view tracking: POST /api/analytics/track with type 'page_view', pageId, pathname from window.location.pathname
       - Expose a click handler via context or callback: when a card is clicked, send POST /api/analytics/track with type 'card_click', cardId, pageId
       - Use a simple approach: add click event listener to document that checks for `data-card-id` attribute on clicked elements (or their parents up to 5 levels). This avoids modifying every card component.
       - Wrap in try/catch and use navigator.sendBeacon as fallback for click tracking (more reliable for navigation away)
       - The component renders nothing visible (return null or a hidden div)

    2. Modify `src/app/[username]/page.tsx`:
       - Import ClickTracker component
       - Pass pageId (from page data) and minimal cards array to ClickTracker
       - Add data-card-id={card.id} attributes to card wrapper elements. Check how cards are rendered in the static flow grid / public page renderer and ensure each card's outermost clickable element has this attribute.
       - Look at `src/components/public/static-flow-grid.tsx` and ensure card wrappers include data-card-id. If the attribute needs to be added in static-flow-grid.tsx instead, add it there.
       - ClickTracker should be placed inside the page component (not layout) so it has access to pageId.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - ClickTracker component exists and is imported in public page
    - data-card-id attributes are present on card wrapper elements
    - Build succeeds: `npm run build` completes without errors
  </verify>
  <done>
    Visiting a public page records a page view. Clicking any card records a card click. All tracking is non-blocking and gracefully handles failures.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. SQL migration file contains valid table definitions with RLS policies
3. Tracking API route handles both page_view and card_click event types
4. Stats API returns uniqueVisitors, totalViews, cardStats with CTR, and timeSeries data
5. Public page includes ClickTracker component
6. Build succeeds with `npm run build`
</verification>

<success_criteria>
- Analytics tracking pipeline is complete: public page visit -> API -> database
- Stats API supports time period filtering (7 days, 30 days, all time)
- Per-card click tracking with CTR calculation
- Privacy-safe visitor hashing with daily salt rotation
- Non-blocking tracking that never breaks user experience
</success_criteria>

<output>
After completion, create `.planning/phases/11-analytics-pixels-legal/11-01-SUMMARY.md`
</output>
