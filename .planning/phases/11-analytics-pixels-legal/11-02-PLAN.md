---
phase: 11-analytics-pixels-legal
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/legal/cookie-consent-banner.tsx
  - src/app/[username]/layout.tsx
  - src/lib/legal/privacy-policy-generator.ts
  - src/app/privacy/page.tsx
  - src/app/terms/page.tsx
  - src/components/public/public-page-renderer.tsx
autonomous: true

must_haves:
  truths:
    - "Visitors see a theme-aware cookie consent banner after scrolling on public pages"
    - "Visitors can accept or reject all cookies with equal prominence buttons"
    - "Consent preference persists in localStorage across visits"
    - "Public pages have a privacy policy footer link that shows auto-generated content"
    - "Public pages have a terms of service footer link"
    - "Privacy policy content reflects which features the artist has enabled (pixels, email collection)"
  artifacts:
    - path: "src/components/legal/cookie-consent-banner.tsx"
      provides: "Theme-aware cookie consent popup with accept/reject"
      min_lines: 50
    - path: "src/lib/legal/privacy-policy-generator.ts"
      provides: "Auto-generated privacy policy based on enabled features"
      exports: ["generatePrivacyPolicy"]
    - path: "src/app/privacy/page.tsx"
      provides: "Privacy policy page route"
    - path: "src/app/terms/page.tsx"
      provides: "Terms of service page route"
  key_links:
    - from: "src/app/[username]/layout.tsx"
      to: "src/components/legal/cookie-consent-banner.tsx"
      via: "CookieConsentBanner rendered in public page layout"
      pattern: "CookieConsentBanner"
    - from: "src/components/public/public-page-renderer.tsx"
      to: "/privacy and /terms"
      via: "Footer links to legal pages"
      pattern: "privacy|terms"
---

<objective>
Build the legal compliance foundation: theme-aware cookie consent banner for public pages, auto-generated privacy policy based on enabled features, and terms of service page. This must exist before pixels can be loaded.

Purpose: GDPR/CCPA compliance is required before loading any tracking pixels. Cookie consent must be in place first. Privacy policy and ToS are legal requirements for any site collecting data.
Output: Cookie consent banner on public pages, privacy policy page, terms of service page, footer links.
</objective>

<execution_context>
@/Users/julianmunyard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julianmunyard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-analytics-pixels-legal/11-CONTEXT.md
@.planning/phases/11-analytics-pixels-legal/11-RESEARCH.md
@src/app/[username]/layout.tsx
@src/app/[username]/page.tsx
@src/components/public/public-page-renderer.tsx
@src/stores/theme-store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create cookie consent banner and wire into public pages</name>
  <files>
    src/components/legal/cookie-consent-banner.tsx
    src/app/[username]/layout.tsx
  </files>
  <action>
    1. Install react-cookie-consent: `npm install react-cookie-consent`

    2. Create `src/components/legal/cookie-consent-banner.tsx`:
       - 'use client' component
       - Props: `themeColors?: { background: string, text: string, accent: string, border: string }` (optional, for theme matching)
       - State: showBanner (boolean, starts false), visible after user scrolls 100px
       - Use IntersectionObserver or scroll event listener to detect scroll > 100px, then show banner
       - Use react-cookie-consent `CookieConsent` component with:
         - cookieName: "linklobby-consent" (localStorage key)
         - location: none (we position it ourselves in bottom-right corner)
         - enableDeclineButton: true
         - buttonText: "Accept All"
         - declineButtonText: "Reject All"
         - Equal prominence for both buttons (same size, same border treatment)
         - onAccept callback: dispatch custom event 'consent-granted' (pixels listen for this)
         - onDecline callback: dispatch custom event 'consent-declined'
       - Style the banner to match theme colors if provided:
         - Background: theme card background or fallback dark (#1a1a1a)
         - Text: theme text color or fallback white
         - Accept button: theme accent color background
         - Reject button: transparent background with border
         - Border radius: 12px
         - Max width: 380px
         - Position: fixed, bottom-right corner (bottom-4 right-4), z-index: 50
         - Box shadow for floating effect
       - If consent was already given/rejected (check cookie), don't show banner at all
       - Text: "We use cookies to help analyze page traffic. You can accept or reject all cookies."
       - Include small "Cookie Preferences" link text at bottom for future granular control

    3. Modify `src/app/[username]/layout.tsx`:
       - Import CookieConsentBanner
       - Add CookieConsentBanner inside the layout div, after {children}
       - Pass theme colors from CSS variables or as props. Since theme is injected server-side via ThemeInjector in the page component, the banner can read CSS custom properties at runtime. Pass no props initially and have the banner read `getComputedStyle(document.documentElement).getPropertyValue('--theme-background')` etc. in a useEffect to get theme colors.
       - This ensures the banner inherits whatever theme the artist has set.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - CookieConsentBanner is imported and rendered in layout
    - react-cookie-consent is in package.json dependencies
    - Banner reads theme CSS variables for styling
  </verify>
  <done>
    Public pages show a theme-matched cookie consent banner in bottom-right corner after user scrolls. Accept/reject buttons have equal prominence. Consent state persisted in cookie. Custom events dispatched for pixel loading.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create privacy policy generator and legal pages</name>
  <files>
    src/lib/legal/privacy-policy-generator.ts
    src/app/privacy/page.tsx
    src/app/terms/page.tsx
    src/components/public/public-page-renderer.tsx
  </files>
  <action>
    1. Create `src/lib/legal/privacy-policy-generator.ts`:
       - Export interface `PrivacyPolicyConfig { hasFacebookPixel: boolean, hasGoogleAnalytics: boolean, collectsEmails: boolean, siteName: string, siteUrl: string }`
       - Export `generatePrivacyPolicy(config: PrivacyPolicyConfig): string` that returns Markdown string
       - Sections (always included): Introduction, Information We Collect, How We Use Your Information, Cookie Policy, Your Rights (GDPR + CCPA), Data Retention, Contact Information
       - Conditional sections (only if feature enabled):
         - hasFacebookPixel: "Facebook Pixel" section explaining what data is collected and linking to Facebook's privacy policy
         - hasGoogleAnalytics: "Google Analytics" section explaining GA4 tracking
         - collectsEmails: "Email Collection" section explaining email storage and Mailchimp sync
       - Always include: "We track page views and link clicks using privacy-safe anonymous identifiers. No personal data is stored for analytics purposes."
       - Include "Last Updated" date based on current date
       - Return as formatted Markdown string

    2. Create `src/app/privacy/page.tsx`:
       - Server component
       - Accept optional searchParams for `username` query parameter
       - If username provided, fetch the user's page settings to determine which features are enabled (check for facebook_pixel_id, ga_measurement_id in page/profile settings, check if email collection cards exist)
       - Generate privacy policy using generatePrivacyPolicy with detected features
       - If no username, generate generic LinkLobby privacy policy (all features listed)
       - Render the Markdown as HTML using a simple Markdown-to-JSX approach (can use dangerouslySetInnerHTML with a basic markdown parser, or manually structure the sections as JSX)
       - Clean, readable layout: max-w-3xl mx-auto, proper heading hierarchy, adequate spacing
       - Include metadata export for SEO

    3. Create `src/app/terms/page.tsx`:
       - Server component with static terms of service content
       - Sections: Agreement to Terms, Description of Service, User Accounts, User Content, Acceptable Use, Intellectual Property, Termination, Disclaimer of Warranties, Limitation of Liability, Changes to Terms, Contact Information
       - Content should be specific to LinkLobby (link-in-bio page builder for artists)
       - Same clean layout as privacy page
       - Include metadata export for SEO

    4. Modify `src/components/public/public-page-renderer.tsx`:
       - Add a small footer section at the very bottom of the public page
       - Footer contains: "Privacy Policy" and "Terms of Service" links
       - Links point to /privacy?username={username} and /terms respectively
       - Footer styling: text-xs, muted color (theme text at 50% opacity), centered, padding-bottom, margin-top auto
       - Footer should use theme text color at reduced opacity for subtlety
       - "Powered by LinkLobby" can be added here too (for free tier branding later)
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Privacy policy generator produces different output based on config flags
    - /privacy and /terms routes exist and render content
    - Public page renderer includes footer with legal links
    - `npm run build` succeeds
  </verify>
  <done>
    Privacy policy is auto-generated based on which features the artist uses. Terms of service page exists with LinkLobby-specific content. Public pages show footer links to both legal pages.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. Cookie consent banner appears after scrolling on public pages
3. Accept/Reject buttons have equal visual prominence
4. Consent state persists across page loads
5. Privacy policy content changes based on enabled features
6. Footer links visible on public pages
7. Build succeeds with `npm run build`
</verification>

<success_criteria>
- Cookie consent banner is theme-aware and GDPR-compliant (equal prominence accept/reject)
- Privacy policy auto-generates based on enabled features
- Terms of service page exists with platform-specific content
- Public pages have footer links to legal pages
- Consent events dispatched for pixel components to listen to
</success_criteria>

<output>
After completion, create `.planning/phases/11-analytics-pixels-legal/11-02-SUMMARY.md`
</output>
