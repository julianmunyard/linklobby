---
phase: 07-theme-system
plan: 07
type: execute
wave: 5
depends_on: ["07-06"]
files_modified:
  - src/components/editor/background-controls.tsx
  - src/components/editor/theme-panel.tsx
  - src/components/preview/page-background.tsx
  - src/lib/storage.ts
  - src/app/[username]/page.tsx
autonomous: false

must_haves:
  truths:
    - "User can set solid color page background"
    - "User can upload image as page background"
    - "User can set video URL as page background (muted autoplay loop)"
    - "Background displays correctly in preview and public page"
  artifacts:
    - path: "src/components/editor/background-controls.tsx"
      provides: "Background type selection and configuration"
      exports: ["BackgroundControls"]
    - path: "src/components/preview/page-background.tsx"
      provides: "Background renderer (solid, image, video)"
      exports: ["PageBackground"]
    - path: "src/lib/storage.ts"
      provides: "Image upload utilities including background upload"
      exports: ["uploadBackgroundImage"]
  key_links:
    - from: "src/components/editor/background-controls.tsx"
      to: "src/stores/theme-store.ts"
      via: "useThemeStore setBackground"
      pattern: "setBackground"
    - from: "src/components/preview/page-background.tsx"
      to: "src/stores/theme-store.ts"
      via: "useThemeStore background"
      pattern: "useThemeStore"
    - from: "src/components/editor/background-controls.tsx"
      to: "src/lib/storage.ts"
      via: "uploadBackgroundImage import"
      pattern: "uploadBackgroundImage"
---

<objective>
Create background controls (solid, image, video) and human verification checkpoint.

Purpose: Artists need background customization to complete their visual identity. Video backgrounds add delight.
Output: BackgroundControls UI, PageBackground renderer, checkpoint for visual verification.
</objective>

<execution_context>
@/Users/julianmunyard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julianmunyard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/07-theme-system/07-CONTEXT.md
@.planning/phases/07-theme-system/07-RESEARCH.md

# Prior plan references
@src/stores/theme-store.ts
@src/types/theme.ts
@src/components/editor/theme-panel.tsx

# Image upload patterns (check if exists, create if needed)
@src/lib/storage.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BackgroundControls component</name>
  <files>
    src/components/editor/background-controls.tsx
    src/lib/storage.ts
  </files>
  <action>
Create background type selector and configuration UI.

Per CONTEXT.md: "Backgrounds: Solid color + image + video (autoplay muted loop)"

**First, ensure src/lib/storage.ts exists with uploadBackgroundImage function:**

If storage.ts doesn't exist, create it. If it exists, add the uploadBackgroundImage function.

```typescript
// src/lib/storage.ts
import { createClient } from '@/lib/supabase/client'

export async function uploadBackgroundImage(file: File): Promise<string> {
  const supabase = createClient()

  // Get current user
  const { data: { user } } = await supabase.auth.getUser()
  if (!user) throw new Error('Not authenticated')

  // Generate unique filename
  const ext = file.name.split('.').pop()
  const filename = `${user.id}/backgrounds/${Date.now()}.${ext}`

  // Upload to Supabase storage
  const { data, error } = await supabase.storage
    .from('images')
    .upload(filename, file, {
      cacheControl: '3600',
      upsert: false
    })

  if (error) throw error

  // Get public URL
  const { data: { publicUrl } } = supabase.storage
    .from('images')
    .getPublicUrl(data.path)

  return publicUrl
}
```

**Then create BackgroundControls component:**

```typescript
'use client'

import { useState } from 'react'
import { useThemeStore } from '@/stores/theme-store'
import { Label } from '@/components/ui/label'
import { Input } from '@/components/ui/input'
import { Button } from '@/components/ui/button'
import { ToggleGroup, ToggleGroupItem } from '@/components/ui/toggle-group'
import { ColorPicker } from '@/components/ui/color-picker'
import { Loader2, Upload, Image, Video, Paintbrush } from 'lucide-react'
import type { BackgroundConfig } from '@/types/theme'

export function BackgroundControls() {
  const { background, setBackground } = useThemeStore()
  const [isUploading, setIsUploading] = useState(false)
  const [videoUrl, setVideoUrl] = useState(background.type === 'video' ? background.value : '')

  const handleTypeChange = (type: BackgroundConfig['type']) => {
    if (!type) return

    if (type === 'solid') {
      setBackground({ type: 'solid', value: background.type === 'solid' ? background.value : '#0a0a0a' })
    } else if (type === 'image') {
      setBackground({ type: 'image', value: background.type === 'image' ? background.value : '' })
    } else if (type === 'video') {
      setBackground({ type: 'video', value: videoUrl || '' })
    }
  }

  const handleColorChange = (color: string) => {
    setBackground({ type: 'solid', value: color })
  }

  const handleImageUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0]
    if (!file) return

    setIsUploading(true)
    try {
      // Upload to Supabase storage
      const { uploadBackgroundImage } = await import('@/lib/storage')
      const url = await uploadBackgroundImage(file)
      setBackground({ type: 'image', value: url })
    } catch (error) {
      console.error('Background upload failed:', error)
    } finally {
      setIsUploading(false)
    }
  }

  const handleVideoUrlChange = (url: string) => {
    setVideoUrl(url)
    if (background.type === 'video') {
      setBackground({ type: 'video', value: url })
    }
  }

  const handleVideoUrlBlur = () => {
    if (background.type === 'video' && videoUrl) {
      setBackground({ type: 'video', value: videoUrl })
    }
  }

  return (
    <div className="space-y-4">
      {/* Background Type Selector */}
      <div>
        <Label className="text-xs font-medium text-muted-foreground mb-2 block">Background Type</Label>
        <ToggleGroup
          type="single"
          value={background.type}
          onValueChange={(value) => handleTypeChange(value as BackgroundConfig['type'])}
          className="justify-start"
        >
          <ToggleGroupItem value="solid" className="flex items-center gap-2">
            <Paintbrush className="w-4 h-4" />
            <span className="text-xs">Solid</span>
          </ToggleGroupItem>
          <ToggleGroupItem value="image" className="flex items-center gap-2">
            <Image className="w-4 h-4" />
            <span className="text-xs">Image</span>
          </ToggleGroupItem>
          <ToggleGroupItem value="video" className="flex items-center gap-2">
            <Video className="w-4 h-4" />
            <span className="text-xs">Video</span>
          </ToggleGroupItem>
        </ToggleGroup>
      </div>

      {/* Solid Color Picker */}
      {background.type === 'solid' && (
        <ColorPicker
          label="Color"
          color={background.value}
          onChange={handleColorChange}
        />
      )}

      {/* Image Upload */}
      {background.type === 'image' && (
        <div className="space-y-2">
          <Label className="text-xs">Background Image</Label>
          {background.value ? (
            <div className="relative aspect-video rounded overflow-hidden">
              <img
                src={background.value}
                alt="Background preview"
                className="w-full h-full object-cover"
              />
              <Button
                variant="secondary"
                size="sm"
                className="absolute bottom-2 right-2"
                onClick={() => document.getElementById('bg-image-input')?.click()}
              >
                Change
              </Button>
            </div>
          ) : (
            <Button
              variant="outline"
              className="w-full h-20 flex flex-col items-center justify-center gap-2"
              onClick={() => document.getElementById('bg-image-input')?.click()}
              disabled={isUploading}
            >
              {isUploading ? (
                <Loader2 className="w-5 h-5 animate-spin" />
              ) : (
                <>
                  <Upload className="w-5 h-5" />
                  <span className="text-xs">Upload Image</span>
                </>
              )}
            </Button>
          )}
          <input
            id="bg-image-input"
            type="file"
            accept="image/*"
            className="hidden"
            onChange={handleImageUpload}
          />
        </div>
      )}

      {/* Video URL */}
      {background.type === 'video' && (
        <div className="space-y-2">
          <Label className="text-xs">Video URL</Label>
          <Input
            placeholder="https://example.com/video.mp4"
            value={videoUrl}
            onChange={(e) => handleVideoUrlChange(e.target.value)}
            onBlur={handleVideoUrlBlur}
          />
          <p className="text-xs text-muted-foreground">
            Enter a direct video URL (MP4). Video will autoplay muted on loop.
          </p>
          {videoUrl && (
            <div className="aspect-video rounded overflow-hidden bg-muted">
              <video
                src={videoUrl}
                className="w-full h-full object-cover"
                muted
                loop
                playsInline
                autoPlay
              />
            </div>
          )}
        </div>
      )}
    </div>
  )
}
```

Key features:
- Toggle between solid, image, video
- Color picker for solid
- Image upload with preview
- Video URL input with preview
  </action>
  <verify>
Run `npx tsc --noEmit`. Check export: `grep "export function BackgroundControls" src/components/editor/background-controls.tsx`. Check storage: `grep "export async function uploadBackgroundImage" src/lib/storage.ts`
  </verify>
  <done>
BackgroundControls created with solid color, image upload, and video URL options. Storage utility for background image upload added.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create PageBackground component and integrate</name>
  <files>
    src/components/preview/page-background.tsx
    src/components/editor/theme-panel.tsx
  </files>
  <action>
**Create PageBackground renderer (src/components/preview/page-background.tsx):**

```typescript
'use client'

import { useEffect, useRef } from 'react'
import { useThemeStore } from '@/stores/theme-store'

export function PageBackground() {
  const { background } = useThemeStore()
  const videoRef = useRef<HTMLVideoElement>(null)

  // Intersection Observer for video performance
  useEffect(() => {
    const video = videoRef.current
    if (!video || background.type !== 'video') return

    const observer = new IntersectionObserver(
      ([entry]) => {
        if (entry.isIntersecting) {
          video.play().catch(() => {
            // Autoplay blocked, silently fail
          })
        } else {
          video.pause()
        }
      },
      { threshold: 0.1 }
    )

    observer.observe(video)
    return () => observer.disconnect()
  }, [background.type])

  if (background.type === 'solid') {
    return (
      <div
        className="fixed inset-0 -z-10"
        style={{ backgroundColor: background.value }}
      />
    )
  }

  if (background.type === 'image' && background.value) {
    return (
      <div
        className="fixed inset-0 -z-10 bg-cover bg-center bg-no-repeat"
        style={{ backgroundImage: `url(${background.value})` }}
      />
    )
  }

  if (background.type === 'video' && background.value) {
    return (
      <video
        ref={videoRef}
        className="fixed inset-0 -z-10 w-full h-full object-cover"
        src={background.value}
        muted
        loop
        playsInline
        autoPlay
      />
    )
  }

  // Fallback to theme background color
  return (
    <div className="fixed inset-0 -z-10 bg-theme-background" />
  )
}
```

**Add Background section to ThemePanel:**

Add a fifth section (not tab) at the bottom of ThemePanel for background controls:

```typescript
import { BackgroundControls } from './background-controls'

// After the Tabs component, add:
<div className="mt-4 pt-4 border-t border-border">
  <h5 className="text-xs font-medium text-muted-foreground mb-3">Page Background</h5>
  <BackgroundControls />
</div>
```
  </action>
  <verify>
Run `npm run dev`. Navigate to editor > Design > Theme. Scroll down to see Background section. Test solid color, image upload, and video URL.
  </verify>
  <done>
PageBackground component renders solid, image, or video backgrounds. BackgroundControls integrated into ThemePanel.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete theme system with:
- Three themes (Mac OS, Sleek Modern, Instagram Reels)
- Theme selection in Design tab
- Color customization with palette presets
- Font selection with curated fonts
- Style controls (border radius, shadows, blur)
- Background controls (solid, image, video)
- Theme-aware cards with Mac OS traffic lights and glass effects
- Profile header following theme
- ThemeApplicator applying CSS variables
  </what-built>
  <how-to-verify>
1. Navigate to http://localhost:3000/editor
2. Open Design tab
3. Expand Theme section

**Test Theme Selection:**
4. Click each theme card (Mac OS, Sleek Modern, Instagram Reels)
5. Verify preview updates with each theme
6. Check Mac OS shows traffic lights on cards
7. Check Sleek Modern shows glass blur effect
8. Check Instagram Reels shows standard styling

**Test Color Customization:**
9. Go to Colors tab
10. Click a palette preset - colors should update
11. Pick a custom color with color picker
12. Verify "Custom" indicator appears
13. Click Reset - should return to theme defaults

**Test Font Selection:**
14. Go to Fonts tab
15. Select different heading font
16. Select different body font
17. Adjust heading size slider
18. Verify preview shows font changes

**Test Style Controls:**
19. Go to Style tab
20. Adjust border radius slider
21. Toggle shadows on/off
22. For Sleek Modern, adjust blur slider
23. Verify preview shows style changes

**Test Background:**
24. Scroll to Page Background section
25. Select Solid - pick a color
26. Select Image - upload an image
27. Select Video - enter a video URL
28. Verify background displays in preview

**Test Persistence:**
29. Refresh the page
30. Verify theme settings persisted
  </how-to-verify>
  <resume-signal>Type "approved" if theme system works correctly, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. All theme selection works (Mac OS, Sleek Modern, Instagram Reels)
2. Mac OS cards show traffic lights
3. Sleek Modern cards show glass blur
4. Color customization works with presets and custom colors
5. Font selection works for heading and body
6. Style controls adjust border radius, shadows, blur
7. Background types work (solid, image, video)
8. Theme persists across page refresh
9. Preview updates instantly on all changes
</verification>

<success_criteria>
- Complete theme system functional
- All three themes visually distinct
- Color, font, style customization working
- Background controls functional
- Human verification passed
</success_criteria>

<output>
After completion, create `.planning/phases/07-theme-system/07-07-SUMMARY.md`
</output>
