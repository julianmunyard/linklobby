---
phase: 07-theme-system
plan: 04
type: execute
wave: 2
depends_on: ["07-01", "07-02"]
files_modified:
  - package.json
  - src/components/ui/color-picker.tsx
  - src/hooks/use-debounced-callback.ts
  - src/components/editor/color-customizer.tsx
  - src/components/editor/theme-panel.tsx
autonomous: true

must_haves:
  truths:
    - "User can pick custom colors using color picker popover"
    - "User can select from preset palettes per theme"
    - "Custom color changes apply instantly to preview"
  artifacts:
    - path: "src/components/ui/color-picker.tsx"
      provides: "Reusable color picker with popover"
      exports: ["ColorPicker"]
    - path: "src/hooks/use-debounced-callback.ts"
      provides: "Debounce hook for performance"
      exports: ["useDebouncedCallback"]
    - path: "src/components/editor/color-customizer.tsx"
      provides: "Color palette editor with presets and custom colors"
      exports: ["ColorCustomizer"]
  key_links:
    - from: "src/components/editor/color-customizer.tsx"
      to: "src/stores/theme-store.ts"
      via: "useThemeStore setColor, setPalette"
      pattern: "setColor|setPalette"
    - from: "src/components/editor/theme-panel.tsx"
      to: "src/components/editor/color-customizer.tsx"
      via: "ColorCustomizer import in Colors tab"
      pattern: "ColorCustomizer"
    - from: "src/components/ui/color-picker.tsx"
      to: "src/hooks/use-debounced-callback.ts"
      via: "useDebouncedCallback import"
      pattern: "useDebouncedCallback"
---

<objective>
Install react-colorful and create color customization UI with palette presets and free color picker.

Purpose: Artists need to customize theme colors beyond presets. This enables full color control while providing easy starting points.
Output: ColorPicker component, ColorCustomizer with presets and individual color fields, integrated into ThemePanel Colors tab.
</objective>

<execution_context>
@/Users/julianmunyard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julianmunyard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/07-theme-system/07-CONTEXT.md
@.planning/phases/07-theme-system/07-RESEARCH.md

# Reference from prior plans
@src/stores/theme-store.ts
@src/lib/themes/index.ts
@src/types/theme.ts

# Component patterns
@src/components/ui/popover.tsx
@src/components/editor/theme-panel.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install react-colorful and create ColorPicker component</name>
  <files>
    package.json
    src/components/ui/color-picker.tsx
    src/hooks/use-debounced-callback.ts
  </files>
  <action>
Install react-colorful:
```bash
npm install react-colorful
```

First, create the debounce hook:

```typescript
// src/hooks/use-debounced-callback.ts
import { useCallback, useRef } from 'react'

export function useDebouncedCallback<T extends (...args: Parameters<T>) => void>(
  callback: T,
  delay: number
): T {
  const timeoutRef = useRef<NodeJS.Timeout | null>(null)

  return useCallback(
    ((...args: Parameters<T>) => {
      if (timeoutRef.current) {
        clearTimeout(timeoutRef.current)
      }
      timeoutRef.current = setTimeout(() => {
        callback(...args)
      }, delay)
    }) as T,
    [callback, delay]
  )
}
```

Then create reusable ColorPicker component following the pattern from RESEARCH.md:

```typescript
'use client'

import { HexColorPicker, HexColorInput } from 'react-colorful'
import { Popover, PopoverContent, PopoverTrigger } from '@/components/ui/popover'
import { Button } from '@/components/ui/button'
import { Label } from '@/components/ui/label'
import { cn } from '@/lib/utils'
import { useState, useCallback } from 'react'
import { useDebouncedCallback } from '@/hooks/use-debounced-callback'

interface ColorPickerProps {
  color: string
  onChange: (color: string) => void
  label: string
  className?: string
}

export function ColorPicker({ color, onChange, label, className }: ColorPickerProps) {
  // Local state for responsive UI while picking
  const [localColor, setLocalColor] = useState(color)

  // Debounce store updates to avoid excessive re-renders
  const debouncedOnChange = useDebouncedCallback(onChange, 100)

  const handleColorChange = useCallback((newColor: string) => {
    setLocalColor(newColor)
    debouncedOnChange(newColor)
  }, [debouncedOnChange])

  // Sync local state when prop changes (e.g., palette selection)
  if (color !== localColor && !document.activeElement?.closest('.color-picker-popover')) {
    setLocalColor(color)
  }

  return (
    <div className={cn("flex items-center gap-3", className)}>
      <Label className="text-sm min-w-[80px]">{label}</Label>
      <Popover>
        <PopoverTrigger asChild>
          <Button
            variant="outline"
            className="w-10 h-10 p-0 border-2 rounded-md"
            style={{ backgroundColor: localColor }}
          >
            <span className="sr-only">Pick color for {label}</span>
          </Button>
        </PopoverTrigger>
        <PopoverContent className="w-auto p-3 color-picker-popover" align="start">
          <HexColorPicker color={localColor} onChange={handleColorChange} />
          <HexColorInput
            color={localColor}
            onChange={handleColorChange}
            prefixed
            className="mt-2 w-full px-2 py-1 text-sm border rounded bg-background"
          />
        </PopoverContent>
      </Popover>
      <span className="text-xs text-muted-foreground font-mono">{localColor}</span>
    </div>
  )
}
```

Key features:
- Local state for responsive picker updates
- Debounced onChange to reduce store thrashing
- Shows current hex value
- Accessible with sr-only label
  </action>
  <verify>
Run `npm install react-colorful` then `npx tsc --noEmit`. Check package.json includes react-colorful. Check export: `grep "export function ColorPicker" src/components/ui/color-picker.tsx`. Check hook: `grep "export function useDebouncedCallback" src/hooks/use-debounced-callback.ts`
  </verify>
  <done>
react-colorful installed. useDebouncedCallback hook created. ColorPicker component created with popover, hex input, and debounced updates.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ColorCustomizer component</name>
  <files>
    src/components/editor/color-customizer.tsx
  </files>
  <action>
Create the color customization panel with palette presets and individual color pickers.

Per CONTEXT.md:
- "2-3 preset palettes per theme"
- "Palettes + free picker - Start from preset palette, unlock free color picker for each field if wanted"
- "Moderate palette (5-6 colors) - Background, card bg, text, accent, border, link"

```typescript
'use client'

import { useThemeStore } from '@/stores/theme-store'
import { THEMES, getTheme } from '@/lib/themes'
import { ColorPicker } from '@/components/ui/color-picker'
import { Button } from '@/components/ui/button'
import { cn } from '@/lib/utils'
import { Check, RotateCcw } from 'lucide-react'
import type { ColorPalette } from '@/types/theme'

const COLOR_LABELS: Record<keyof ColorPalette, string> = {
  background: 'Background',
  cardBg: 'Card',
  text: 'Text',
  accent: 'Accent',
  border: 'Border',
  link: 'Link',
}

export function ColorCustomizer() {
  const { themeId, paletteId, colors, setColor, setPalette, resetToThemeDefaults } = useThemeStore()
  const theme = getTheme(themeId)

  if (!theme) return null

  return (
    <div className="space-y-4">
      {/* Palette Presets */}
      <div>
        <h5 className="text-xs font-medium text-muted-foreground mb-2">Palettes</h5>
        <div className="flex flex-wrap gap-2">
          {theme.palettes.map((palette) => {
            const isSelected = paletteId === palette.id

            return (
              <button
                key={palette.id}
                onClick={() => setPalette(palette.id)}
                className={cn(
                  "relative flex gap-0.5 h-7 rounded overflow-hidden border-2 transition-all",
                  isSelected ? "border-accent" : "border-transparent hover:border-muted"
                )}
                title={palette.name}
              >
                {/* Mini color swatches */}
                {Object.values(palette.colors).slice(0, 4).map((color, i) => (
                  <div
                    key={i}
                    className="w-5 h-full"
                    style={{ backgroundColor: color }}
                  />
                ))}
                {isSelected && (
                  <div className="absolute inset-0 flex items-center justify-center bg-black/30">
                    <Check className="w-3 h-3 text-white" />
                  </div>
                )}
              </button>
            )
          })}

          {/* Custom indicator */}
          {paletteId === null && (
            <div className="flex items-center text-xs text-muted-foreground px-2">
              Custom
            </div>
          )}
        </div>
      </div>

      {/* Individual Color Pickers */}
      <div>
        <div className="flex items-center justify-between mb-2">
          <h5 className="text-xs font-medium text-muted-foreground">Colors</h5>
          <Button
            variant="ghost"
            size="sm"
            className="h-6 text-xs"
            onClick={resetToThemeDefaults}
          >
            <RotateCcw className="w-3 h-3 mr-1" />
            Reset
          </Button>
        </div>
        <div className="space-y-3">
          {(Object.keys(COLOR_LABELS) as Array<keyof ColorPalette>).map((key) => (
            <ColorPicker
              key={key}
              label={COLOR_LABELS[key]}
              color={colors[key]}
              onChange={(value) => setColor(key, value)}
            />
          ))}
        </div>
      </div>
    </div>
  )
}
```

Key features:
- Shows palette presets as clickable mini-swatches
- Selected palette has checkmark indicator
- "Custom" label appears when user has modified colors
- Six color pickers for all palette colors
- Reset button returns to theme defaults
- Instant update on color change
  </action>
  <verify>
Run `npx tsc --noEmit`. Check export: `grep "export function ColorCustomizer" src/components/editor/color-customizer.tsx`
  </verify>
  <done>
ColorCustomizer created with palette presets, individual color pickers, and reset functionality.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate ColorCustomizer into ThemePanel</name>
  <files>
    src/components/editor/theme-panel.tsx
  </files>
  <action>
Update ThemePanel to render ColorCustomizer in the Colors tab.

Replace the placeholder in the Colors TabsContent:

```typescript
import { ColorCustomizer } from './color-customizer'

// In the Colors TabsContent:
<TabsContent value="colors" className="mt-3">
  <ColorCustomizer />
</TabsContent>
```

Full updated component with proper imports.
  </action>
  <verify>
Run `npm run dev`. Navigate to editor > Design tab > Theme section > Colors tab. Verify palette presets visible and color pickers work.
  </verify>
  <done>
ColorCustomizer integrated into ThemePanel Colors tab. Users can select palettes and customize individual colors.
  </done>
</task>

</tasks>

<verification>
1. `npm run dev` runs without errors
2. react-colorful appears in package.json dependencies
3. Navigate to editor > Design > Theme > Colors tab
4. Palette presets visible as color swatches
5. Clicking palette applies those colors
6. Six color pickers visible (Background, Card, Text, Accent, Border, Link)
7. Picking a color shows in the picker and updates preview
8. After custom color pick, paletteId shows "Custom"
9. Reset button restores theme defaults
</verification>

<success_criteria>
- react-colorful installed
- useDebouncedCallback hook created and working
- ColorPicker component works with popover and debounced updates
- ColorCustomizer shows palette presets per theme
- Individual color pickers for all 6 colors
- Palette selection applies colors instantly
- Custom color changes set paletteId to null
- Reset button returns to theme defaults
</success_criteria>

<output>
After completion, create `.planning/phases/07-theme-system/07-04-SUMMARY.md`
</output>
