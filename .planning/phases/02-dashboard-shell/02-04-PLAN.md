---
phase: 02-dashboard-shell
plan: 04
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/app/(dashboard)/preview/page.tsx
  - src/components/dashboard/dashboard-header.tsx
  - src/app/(dashboard)/editor/page.tsx

autonomous: true

must_haves:
  truths:
    - "Preview route receives state updates via postMessage"
    - "Header shows username and public URL"
    - "Header shows save status indicator"
  artifacts:
    - path: "src/app/(dashboard)/preview/page.tsx"
      provides: "Preview route for iframe"
      min_lines: 30
      contains: "postMessage"
    - path: "src/components/dashboard/dashboard-header.tsx"
      provides: "Header with username, URL, save status"
      min_lines: 25
  key_links:
    - from: "src/app/(dashboard)/preview/page.tsx"
      to: "window"
      via: "addEventListener for message events"
      pattern: "addEventListener.*message"
---

<objective>
Create the preview route that receives state via postMessage, and the dashboard header showing username, public URL, and save status.

Purpose: Enable live preview synchronization and provide user context in the dashboard.
Output: Working preview route, header with user info and save status.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-dashboard-shell/02-RESEARCH.md
@.planning/phases/02-dashboard-shell/02-01-SUMMARY.md

@src/stores/page-store.ts
@src/app/(dashboard)/editor/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create preview route for iframe</name>
  <files>src/app/(dashboard)/preview/page.tsx</files>
  <action>
Create the preview route that receives page state via postMessage:

src/app/(dashboard)/preview/page.tsx:
```typescript
"use client"

import { useEffect, useState } from "react"

// Match types from page-store.ts
interface Card {
  id: string
  type: string
  position: { x: number; y: number }
  content: Record<string, unknown>
}

interface Theme {
  id: string
  name: string
}

interface PreviewState {
  cards: Card[]
  theme: Theme
}

export default function PreviewPage() {
  const [state, setState] = useState<PreviewState>({
    cards: [],
    theme: { id: "default", name: "Default" },
  })

  useEffect(() => {
    const handleMessage = (event: MessageEvent) => {
      // Security: Only accept messages from same origin
      if (event.origin !== window.location.origin) return

      if (event.data.type === "STATE_UPDATE") {
        setState(event.data.payload)
      }
    }

    window.addEventListener("message", handleMessage)

    // Notify parent that preview is ready
    window.parent?.postMessage({ type: "PREVIEW_READY" }, window.location.origin)

    return () => window.removeEventListener("message", handleMessage)
  }, [])

  // Render preview based on state
  // For Phase 2, show placeholder. Actual card rendering comes in Phase 4+.
  return (
    <div className="min-h-screen bg-background p-4">
      {state.cards.length === 0 ? (
        <div className="flex flex-col items-center justify-center min-h-[80vh] text-center">
          <div className="rounded-full bg-muted p-6 mb-4">
            <svg
              className="h-12 w-12 text-muted-foreground"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                strokeWidth={1.5}
                d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"
              />
            </svg>
          </div>
          <h2 className="text-xl font-semibold mb-2">Your page preview</h2>
          <p className="text-muted-foreground text-sm max-w-[300px]">
            Add cards in the editor to see them appear here. Your visitors will see this view.
          </p>
        </div>
      ) : (
        <div className="space-y-4">
          {/* Placeholder card rendering - actual implementation in Phase 4+ */}
          {state.cards.map((card) => (
            <div
              key={card.id}
              className="border rounded-lg p-4 bg-card"
              style={{
                position: "absolute",
                left: card.position.x,
                top: card.position.y,
              }}
            >
              <p className="text-sm text-muted-foreground">
                {card.type} card (ID: {card.id})
              </p>
            </div>
          ))}
        </div>
      )}

      {/* Debug: Show current theme */}
      <div className="fixed bottom-4 right-4 text-xs text-muted-foreground">
        Theme: {state.theme.name}
      </div>
    </div>
  )
}
```

Key patterns:
- postMessage listener with origin check for security
- Notifies parent when ready (PREVIEW_READY message)
- Placeholder rendering for cards (actual implementation later)
- Shows current theme for debugging
  </action>
  <verify>
Run `npm run dev` and open http://localhost:3000/preview in browser:
- Page should render with empty state message
- No console errors
- Open browser DevTools Console and run:
```javascript
window.postMessage({ type: 'STATE_UPDATE', payload: { cards: [], theme: { id: 'test', name: 'Test Theme' } } }, '*')
```
Theme debug text should update to "Theme: Test Theme"
  </verify>
  <done>Preview route receives postMessage updates and renders placeholder state</done>
</task>

<task type="auto">
  <name>Task 2: Create DashboardHeader component</name>
  <files>src/components/dashboard/dashboard-header.tsx</files>
  <action>
Create the header component showing username, public URL, and save status:

src/components/dashboard/dashboard-header.tsx:
```typescript
"use client"

import { Copy, ExternalLink, Check, Loader2 } from "lucide-react"
import { useState } from "react"
import { Button } from "@/components/ui/button"
import {
  Tooltip,
  TooltipContent,
  TooltipTrigger,
} from "@/components/ui/tooltip"
import { usePageStore } from "@/stores/page-store"
import { toast } from "sonner"

interface DashboardHeaderProps {
  username: string
}

export function DashboardHeader({ username }: DashboardHeaderProps) {
  const [copied, setCopied] = useState(false)
  const hasChanges = usePageStore((state) => state.hasChanges)

  const publicUrl = `linklobby.com/${username}`
  const fullUrl = `https://${publicUrl}`

  const copyUrl = async () => {
    try {
      await navigator.clipboard.writeText(fullUrl)
      setCopied(true)
      toast.success("URL copied to clipboard")
      setTimeout(() => setCopied(false), 2000)
    } catch {
      toast.error("Failed to copy URL")
    }
  }

  return (
    <div className="flex items-center justify-between flex-1">
      <div className="flex items-center gap-3">
        {/* Username and URL */}
        <div className="flex items-center gap-2">
          <span className="font-semibold">{username}</span>
          <span className="text-muted-foreground">|</span>
          <code className="text-sm text-muted-foreground bg-muted px-2 py-0.5 rounded">
            {publicUrl}
          </code>
        </div>

        {/* Copy URL button */}
        <Tooltip>
          <TooltipTrigger asChild>
            <Button
              variant="ghost"
              size="sm"
              className="h-8 w-8 p-0"
              onClick={copyUrl}
            >
              {copied ? (
                <Check className="h-4 w-4 text-green-500" />
              ) : (
                <Copy className="h-4 w-4" />
              )}
              <span className="sr-only">Copy URL</span>
            </Button>
          </TooltipTrigger>
          <TooltipContent>Copy public URL</TooltipContent>
        </Tooltip>

        {/* View public page link */}
        <Tooltip>
          <TooltipTrigger asChild>
            <Button
              variant="ghost"
              size="sm"
              className="h-8 w-8 p-0"
              asChild
            >
              <a href={`/${username}`} target="_blank" rel="noopener noreferrer">
                <ExternalLink className="h-4 w-4" />
                <span className="sr-only">View public page</span>
              </a>
            </Button>
          </TooltipTrigger>
          <TooltipContent>View public page</TooltipContent>
        </Tooltip>
      </div>

      {/* Save status */}
      <div className="flex items-center gap-2">
        {hasChanges && (
          <div className="flex items-center gap-2 text-sm text-muted-foreground">
            <div className="h-2 w-2 rounded-full bg-yellow-500 animate-pulse" />
            <span>Unsaved changes</span>
          </div>
        )}

        {/* Save button - functionality will be wired in later phases */}
        <Button size="sm" disabled={!hasChanges}>
          Save
        </Button>
      </div>
    </div>
  )
}
```

Key patterns:
- Shows username and formatted public URL
- Copy URL button with success feedback
- External link to public page (opens in new tab)
- Unsaved changes indicator (yellow pulsing dot)
- Save button disabled when no changes
  </action>
  <verify>
File compiles: `npx tsc --noEmit src/components/dashboard/dashboard-header.tsx`
  </verify>
  <done>DashboardHeader shows username, URL, copy button, save status indicator</done>
</task>

<task type="auto">
  <name>Task 3: Update editor page to use new components</name>
  <files>src/app/(dashboard)/editor/page.tsx</files>
  <action>
Update the editor page to integrate all the new components:

src/app/(dashboard)/editor/page.tsx:
```typescript
import { createClient } from "@/lib/supabase/server"
import { redirect } from "next/navigation"
import { TooltipProvider } from "@/components/ui/tooltip"
import { DashboardHeader } from "@/components/dashboard/dashboard-header"
import { EditorLayout } from "@/components/editor/editor-layout"

export default async function EditorPage() {
  const supabase = await createClient()

  // Get current user (validated by middleware, but double-check)
  const {
    data: { user },
  } = await supabase.auth.getUser()

  if (!user) {
    redirect("/login")
  }

  // Get user's profile
  const { data: profile } = await supabase
    .from("profiles")
    .select("username, display_name")
    .eq("id", user.id)
    .single()

  if (!profile?.username) {
    // Edge case: user exists but no profile (shouldn't happen with triggers)
    redirect("/signup")
  }

  return (
    <TooltipProvider>
      <div className="h-[calc(100vh-3.5rem)] flex flex-col">
        {/* Header content injected into layout header slot */}
        <DashboardHeader username={profile.username} />

        {/* Main editor area */}
        <div className="flex-1 overflow-hidden">
          <EditorLayout />
        </div>
      </div>
    </TooltipProvider>
  )
}
```

Wait - the header should be in the layout header slot, not in the page. Let me revise.

Actually, we need to update the dashboard layout to accept header content. Since the layout already has a header area with SidebarTrigger, we should use a different approach.

Updated approach - update src/app/(dashboard)/layout.tsx to pass username to a slot, OR keep header in page but position it properly.

For simplicity, let's keep the current layout and have the page render in the main area. The DashboardHeader will render inside the page content.

Final src/app/(dashboard)/editor/page.tsx:
```typescript
import { createClient } from "@/lib/supabase/server"
import { redirect } from "next/navigation"
import { TooltipProvider } from "@/components/ui/tooltip"
import { DashboardHeader } from "@/components/dashboard/dashboard-header"
import { EditorLayout } from "@/components/editor/editor-layout"

export default async function EditorPage() {
  const supabase = await createClient()

  const {
    data: { user },
  } = await supabase.auth.getUser()

  if (!user) {
    redirect("/login")
  }

  const { data: profile } = await supabase
    .from("profiles")
    .select("username")
    .eq("id", user.id)
    .single()

  if (!profile?.username) {
    redirect("/signup")
  }

  return (
    <TooltipProvider>
      <div className="flex flex-col h-[calc(100vh-3.5rem)]">
        {/* Editor header with username, URL, save status */}
        <div className="flex items-center h-12 px-4 border-b bg-background">
          <DashboardHeader username={profile.username} />
        </div>

        {/* Split-screen editor */}
        <div className="flex-1 overflow-hidden">
          <EditorLayout />
        </div>
      </div>
    </TooltipProvider>
  )
}
```

Note: The layout has a 3.5rem (56px) header with SidebarTrigger. The page content sits below that. The editor has its own 48px header row for DashboardHeader, then the split-screen fills the rest.
  </action>
  <verify>
Run `npm run dev` and visit http://localhost:3000/editor:
1. Should see sidebar on left
2. Editor area shows:
   - Header row with username, URL, copy button, save button
   - Split-screen below with:
     - Left: Tabs (Cards, Design, Insights) with empty states
     - Right: Preview area with placeholder
3. Drag the divider between panels - should resize
4. Switch tabs - each shows different empty state
5. Toggle mobile/desktop preview - preview area should resize
  </verify>
  <done>Editor page integrates DashboardHeader, EditorLayout with split-screen view</done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. /editor page shows:
   - Sidebar with navigation
   - Header with username, public URL, copy button, save button
   - Split-screen: editor tabs left, preview right
3. /preview route loads and can receive postMessage updates
4. Mobile/desktop toggle changes preview size
5. Unsaved changes indicator shows when store has changes
</verification>

<success_criteria>
- Preview route receives state via postMessage
- Preview shows empty state placeholder for cards
- DashboardHeader shows username and linklobby.com/username URL
- Copy URL button works with toast feedback
- Save status shows "Unsaved changes" when hasChanges is true
- Editor page combines all components into working dashboard
</success_criteria>

<output>
After completion, create `.planning/phases/02-dashboard-shell/02-04-SUMMARY.md`
</output>
