---
phase: 01-foundation
plan: 03
type: execute
wave: 2
depends_on: ["01-01", "01-02"]
files_modified:
  - src/middleware.ts
  - src/app/(auth)/signup/page.tsx
  - src/app/(auth)/signup/signup-form.tsx
  - src/app/(auth)/login/page.tsx
  - src/app/(auth)/login/login-form.tsx
  - src/app/(dashboard)/editor/page.tsx
  - src/app/(dashboard)/settings/page.tsx
  - src/app/(dashboard)/settings/username-form.tsx
  - src/app/auth/callback/route.ts
autonomous: true

must_haves:
  truths:
    - "User can sign up with email, password, and username"
    - "User can log in with email and password"
    - "Session persists across browser sessions"
    - "Unauthenticated users are redirected from /editor to /login"
    - "User can change username after signup"
  artifacts:
    - path: "src/middleware.ts"
      provides: "Auth protection and session refresh"
      contains: "updateSession"
    - path: "src/app/(auth)/signup/signup-form.tsx"
      provides: "Signup form with username"
      exports: ["SignupForm"]
    - path: "src/app/(auth)/login/login-form.tsx"
      provides: "Login form"
      exports: ["LoginForm"]
    - path: "src/app/(dashboard)/settings/username-form.tsx"
      provides: "Username change form"
      exports: ["UsernameForm"]
  key_links:
    - from: "src/app/(auth)/signup/signup-form.tsx"
      to: "supabase.auth.signUp"
      via: "client signUp call with username in options.data"
      pattern: "options:\\s*\\{\\s*data:"
    - from: "src/middleware.ts"
      to: "src/lib/supabase/middleware.ts"
      via: "updateSession import"
      pattern: "import.*updateSession"
    - from: "src/middleware.ts"
      to: "/login redirect"
      via: "NextResponse.redirect for unauthenticated users"
      pattern: "NextResponse.redirect.*login"
---

<objective>
Implement complete authentication flow: signup with username claiming, login, session persistence, protected routes, and username changes.

Purpose: Enable users to create accounts, claim usernames, and access the protected dashboard.
Output: Working auth flow satisfying AUTH-01, AUTH-02, AUTH-03, AUTH-04 requirements.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
@.planning/phases/01-foundation/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement middleware for auth protection and session refresh</name>
  <files>
    - src/middleware.ts
    - src/app/auth/callback/route.ts
  </files>
  <action>
Create `src/middleware.ts`:

```typescript
import { type NextRequest, NextResponse } from 'next/server'
import { updateSession } from '@/lib/supabase/middleware'

export async function middleware(request: NextRequest) {
  const { supabaseResponse, user } = await updateSession(request)

  // Protected routes - redirect to login if not authenticated
  const protectedPaths = ['/editor', '/settings']
  const isProtectedRoute = protectedPaths.some(path =>
    request.nextUrl.pathname.startsWith(path)
  )

  if (isProtectedRoute && !user) {
    const loginUrl = new URL('/login', request.url)
    loginUrl.searchParams.set('redirect', request.nextUrl.pathname)
    return NextResponse.redirect(loginUrl)
  }

  // Auth routes - redirect to editor if already authenticated
  const authPaths = ['/login', '/signup']
  const isAuthRoute = authPaths.some(path =>
    request.nextUrl.pathname === path
  )

  if (isAuthRoute && user) {
    return NextResponse.redirect(new URL('/editor', request.url))
  }

  return supabaseResponse
}

export const config = {
  matcher: [
    // Match all paths except static files and API routes
    '/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)',
  ],
}
```

Create `src/app/auth/callback/route.ts` (for OAuth flows, also handles email confirmation links):

```typescript
import { createClient } from '@/lib/supabase/server'
import { NextResponse } from 'next/server'

export async function GET(request: Request) {
  const { searchParams, origin } = new URL(request.url)
  const code = searchParams.get('code')
  const next = searchParams.get('next') ?? '/editor'

  if (code) {
    const supabase = await createClient()
    const { error } = await supabase.auth.exchangeCodeForSession(code)

    if (!error) {
      return NextResponse.redirect(`${origin}${next}`)
    }
  }

  // Return to login with error
  return NextResponse.redirect(`${origin}/login?error=auth_callback_error`)
}
```

CRITICAL: The middleware uses `getUser()` (via updateSession) to validate tokens, never `getSession()`.
  </action>
  <verify>
```bash
# Check file exists and has expected content
grep -l "updateSession" /Users/julianmunyard/LinkLobby/src/middleware.ts
# Should return the file path

# TypeScript check
cd /Users/julianmunyard/LinkLobby && npx tsc --noEmit
```
  </verify>
  <done>
Middleware protects /editor and /settings routes, redirects unauthenticated users to /login, redirects authenticated users away from /login and /signup. Auth callback route handles code exchange.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement signup and login forms</name>
  <files>
    - src/app/(auth)/signup/page.tsx
    - src/app/(auth)/signup/signup-form.tsx
    - src/app/(auth)/login/page.tsx
    - src/app/(auth)/login/login-form.tsx
  </files>
  <action>
Create `src/app/(auth)/signup/signup-form.tsx`:

```typescript
'use client'

import { useState } from 'react'
import { useForm } from 'react-hook-form'
import { zodResolver } from '@hookform/resolvers/zod'
import { z } from 'zod'
import { createClient } from '@/lib/supabase/client'
import { useRouter } from 'next/navigation'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import Link from 'next/link'

const signupSchema = z.object({
  email: z.string().email('Invalid email address'),
  password: z.string().min(8, 'Password must be at least 8 characters'),
  username: z.string()
    .min(3, 'Username must be at least 3 characters')
    .max(30, 'Username must be at most 30 characters')
    .regex(/^[a-z0-9_-]+$/, 'Username can only contain lowercase letters, numbers, underscores, and hyphens'),
})

type SignupFormData = z.infer<typeof signupSchema>

export function SignupForm() {
  const router = useRouter()
  const supabase = createClient()
  const [error, setError] = useState<string | null>(null)

  const { register, handleSubmit, formState: { errors, isSubmitting } } = useForm<SignupFormData>({
    resolver: zodResolver(signupSchema),
  })

  async function onSubmit(data: SignupFormData) {
    setError(null)

    // First check username availability (for better UX)
    const { data: available } = await supabase.rpc('check_username_available', {
      desired_username: data.username.toLowerCase()
    })

    if (!available) {
      setError('Username is already taken')
      return
    }

    const { error: signUpError } = await supabase.auth.signUp({
      email: data.email,
      password: data.password,
      options: {
        data: {
          username: data.username.toLowerCase(),
        },
      },
    })

    if (signUpError) {
      if (signUpError.message.includes('duplicate key') ||
          signUpError.message.includes('unique constraint') ||
          signUpError.message.includes('already registered')) {
        setError('Email or username is already taken')
      } else {
        setError(signUpError.message)
      }
      return
    }

    router.push('/editor')
    router.refresh()
  }

  return (
    <Card>
      <CardHeader className="text-center">
        <CardTitle className="text-2xl">Create your page</CardTitle>
        <CardDescription>Claim your linklobby.com/username</CardDescription>
      </CardHeader>
      <CardContent>
        <form onSubmit={handleSubmit(onSubmit)} className="space-y-4">
          <div className="space-y-2">
            <Label htmlFor="email">Email</Label>
            <Input
              id="email"
              type="email"
              placeholder="you@example.com"
              {...register('email')}
            />
            {errors.email && <p className="text-sm text-destructive">{errors.email.message}</p>}
          </div>

          <div className="space-y-2">
            <Label htmlFor="username">Username</Label>
            <div className="flex items-center gap-2">
              <span className="text-sm text-muted-foreground">linklobby.com/</span>
              <Input
                id="username"
                placeholder="yourname"
                {...register('username')}
                className="flex-1"
              />
            </div>
            {errors.username && <p className="text-sm text-destructive">{errors.username.message}</p>}
          </div>

          <div className="space-y-2">
            <Label htmlFor="password">Password</Label>
            <Input
              id="password"
              type="password"
              placeholder="At least 8 characters"
              {...register('password')}
            />
            {errors.password && <p className="text-sm text-destructive">{errors.password.message}</p>}
          </div>

          {error && (
            <div className="p-3 rounded-md bg-destructive/10 text-destructive text-sm">
              {error}
            </div>
          )}

          <Button type="submit" disabled={isSubmitting} className="w-full">
            {isSubmitting ? 'Creating account...' : 'Create account'}
          </Button>

          <p className="text-center text-sm text-muted-foreground">
            Already have an account?{' '}
            <Link href="/login" className="text-primary hover:underline">
              Log in
            </Link>
          </p>
        </form>
      </CardContent>
    </Card>
  )
}
```

Update `src/app/(auth)/signup/page.tsx`:

```typescript
import { SignupForm } from './signup-form'

export default function SignupPage() {
  return <SignupForm />
}
```

Create `src/app/(auth)/login/login-form.tsx`:

```typescript
'use client'

import { useState } from 'react'
import { useForm } from 'react-hook-form'
import { zodResolver } from '@hookform/resolvers/zod'
import { z } from 'zod'
import { createClient } from '@/lib/supabase/client'
import { useRouter, useSearchParams } from 'next/navigation'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import Link from 'next/link'

const loginSchema = z.object({
  email: z.string().email('Invalid email address'),
  password: z.string().min(1, 'Password is required'),
})

type LoginFormData = z.infer<typeof loginSchema>

export function LoginForm() {
  const router = useRouter()
  const searchParams = useSearchParams()
  const supabase = createClient()
  const [error, setError] = useState<string | null>(null)

  const redirect = searchParams.get('redirect') || '/editor'

  const { register, handleSubmit, formState: { errors, isSubmitting } } = useForm<LoginFormData>({
    resolver: zodResolver(loginSchema),
  })

  async function onSubmit(data: LoginFormData) {
    setError(null)

    const { error: signInError } = await supabase.auth.signInWithPassword({
      email: data.email,
      password: data.password,
    })

    if (signInError) {
      setError('Invalid email or password')
      return
    }

    router.push(redirect)
    router.refresh()
  }

  return (
    <Card>
      <CardHeader className="text-center">
        <CardTitle className="text-2xl">Welcome back</CardTitle>
        <CardDescription>Log in to your LinkLobby account</CardDescription>
      </CardHeader>
      <CardContent>
        <form onSubmit={handleSubmit(onSubmit)} className="space-y-4">
          <div className="space-y-2">
            <Label htmlFor="email">Email</Label>
            <Input
              id="email"
              type="email"
              placeholder="you@example.com"
              {...register('email')}
            />
            {errors.email && <p className="text-sm text-destructive">{errors.email.message}</p>}
          </div>

          <div className="space-y-2">
            <Label htmlFor="password">Password</Label>
            <Input
              id="password"
              type="password"
              {...register('password')}
            />
            {errors.password && <p className="text-sm text-destructive">{errors.password.message}</p>}
          </div>

          {error && (
            <div className="p-3 rounded-md bg-destructive/10 text-destructive text-sm">
              {error}
            </div>
          )}

          <Button type="submit" disabled={isSubmitting} className="w-full">
            {isSubmitting ? 'Logging in...' : 'Log in'}
          </Button>

          <p className="text-center text-sm text-muted-foreground">
            Don&apos;t have an account?{' '}
            <Link href="/signup" className="text-primary hover:underline">
              Sign up
            </Link>
          </p>
        </form>
      </CardContent>
    </Card>
  )
}
```

Update `src/app/(auth)/login/page.tsx`:

```typescript
import { Suspense } from 'react'
import { LoginForm } from './login-form'

export default function LoginPage() {
  return (
    <Suspense fallback={<div>Loading...</div>}>
      <LoginForm />
    </Suspense>
  )
}
```

Note: Suspense boundary needed because LoginForm uses useSearchParams().
  </action>
  <verify>
```bash
cd /Users/julianmunyard/LinkLobby && npx tsc --noEmit
# Should pass without errors

npm run dev
# Visit http://localhost:3000/signup - should show signup form
# Visit http://localhost:3000/login - should show login form
```
  </verify>
  <done>
Signup form collects email, password, and username. Login form collects email and password. Both use React Hook Form with Zod validation. Forms show appropriate error states.
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement protected editor page and username change</name>
  <files>
    - src/app/(dashboard)/editor/page.tsx
    - src/app/(dashboard)/settings/page.tsx
    - src/app/(dashboard)/settings/username-form.tsx
  </files>
  <action>
Update `src/app/(dashboard)/editor/page.tsx`:

```typescript
import { createClient } from '@/lib/supabase/server'
import { redirect } from 'next/navigation'
import Link from 'next/link'
import { Button } from '@/components/ui/button'

export default async function EditorPage() {
  const supabase = await createClient()

  // Get current user (validated by middleware, but double-check)
  const { data: { user } } = await supabase.auth.getUser()

  if (!user) {
    redirect('/login')
  }

  // Get user's profile
  const { data: profile } = await supabase
    .from('profiles')
    .select('username, display_name')
    .eq('id', user.id)
    .single()

  return (
    <div className="min-h-screen p-8">
      <header className="flex items-center justify-between mb-8">
        <div>
          <h1 className="text-2xl font-bold">Dashboard</h1>
          <p className="text-muted-foreground">
            linklobby.com/{profile?.username}
          </p>
        </div>
        <div className="flex items-center gap-4">
          <Button variant="outline" asChild>
            <Link href="/settings">Settings</Link>
          </Button>
          <form action="/api/auth/signout" method="post">
            <Button variant="ghost" type="submit">
              Log out
            </Button>
          </form>
        </div>
      </header>

      <main className="flex items-center justify-center min-h-[60vh]">
        <div className="text-center">
          <h2 className="text-xl font-semibold mb-2">Welcome, {profile?.username}!</h2>
          <p className="text-muted-foreground mb-4">
            Your page editor will be built in Phase 2.
          </p>
          <p className="text-sm text-muted-foreground">
            Auth working: {user.email}
          </p>
        </div>
      </main>
    </div>
  )
}
```

Create `src/app/(dashboard)/settings/page.tsx`:

```typescript
import { createClient } from '@/lib/supabase/server'
import { redirect } from 'next/navigation'
import Link from 'next/link'
import { Button } from '@/components/ui/button'
import { UsernameForm } from './username-form'

export default async function SettingsPage() {
  const supabase = await createClient()

  const { data: { user } } = await supabase.auth.getUser()

  if (!user) {
    redirect('/login')
  }

  const { data: profile } = await supabase
    .from('profiles')
    .select('username')
    .eq('id', user.id)
    .single()

  return (
    <div className="min-h-screen p-8">
      <header className="flex items-center justify-between mb-8">
        <div>
          <h1 className="text-2xl font-bold">Settings</h1>
        </div>
        <Button variant="outline" asChild>
          <Link href="/editor">Back to Editor</Link>
        </Button>
      </header>

      <main className="max-w-md">
        <UsernameForm currentUsername={profile?.username || ''} />
      </main>
    </div>
  )
}
```

Create `src/app/(dashboard)/settings/username-form.tsx`:

```typescript
'use client'

import { useState } from 'react'
import { useForm } from 'react-hook-form'
import { zodResolver } from '@hookform/resolvers/zod'
import { z } from 'zod'
import { createClient } from '@/lib/supabase/client'
import { useRouter } from 'next/navigation'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'

const usernameSchema = z.object({
  username: z.string()
    .min(3, 'Username must be at least 3 characters')
    .max(30, 'Username must be at most 30 characters')
    .regex(/^[a-z0-9_-]+$/, 'Username can only contain lowercase letters, numbers, underscores, and hyphens'),
})

type UsernameFormData = z.infer<typeof usernameSchema>

interface UsernameFormProps {
  currentUsername: string
}

export function UsernameForm({ currentUsername }: UsernameFormProps) {
  const router = useRouter()
  const supabase = createClient()
  const [error, setError] = useState<string | null>(null)
  const [success, setSuccess] = useState(false)

  const { register, handleSubmit, formState: { errors, isSubmitting } } = useForm<UsernameFormData>({
    resolver: zodResolver(usernameSchema),
    defaultValues: {
      username: currentUsername,
    },
  })

  async function onSubmit(data: UsernameFormData) {
    setError(null)
    setSuccess(false)

    if (data.username.toLowerCase() === currentUsername.toLowerCase()) {
      setError('New username is the same as current')
      return
    }

    // Use the update_username RPC function
    const { error: updateError } = await supabase.rpc('update_username', {
      new_username: data.username.toLowerCase()
    })

    if (updateError) {
      if (updateError.message.includes('already taken')) {
        setError('Username is already taken')
      } else {
        setError(updateError.message)
      }
      return
    }

    setSuccess(true)
    router.refresh()
  }

  return (
    <Card>
      <CardHeader>
        <CardTitle>Change Username</CardTitle>
        <CardDescription>
          Your public URL will change to linklobby.com/{'{new-username}'}
        </CardDescription>
      </CardHeader>
      <CardContent>
        <form onSubmit={handleSubmit(onSubmit)} className="space-y-4">
          <div className="space-y-2">
            <Label htmlFor="username">Username</Label>
            <div className="flex items-center gap-2">
              <span className="text-sm text-muted-foreground">linklobby.com/</span>
              <Input
                id="username"
                {...register('username')}
                className="flex-1"
              />
            </div>
            {errors.username && <p className="text-sm text-destructive">{errors.username.message}</p>}
          </div>

          {error && (
            <div className="p-3 rounded-md bg-destructive/10 text-destructive text-sm">
              {error}
            </div>
          )}

          {success && (
            <div className="p-3 rounded-md bg-green-500/10 text-green-500 text-sm">
              Username updated successfully!
            </div>
          )}

          <Button type="submit" disabled={isSubmitting}>
            {isSubmitting ? 'Updating...' : 'Update Username'}
          </Button>
        </form>
      </CardContent>
    </Card>
  )
}
```

Create `src/app/api/auth/signout/route.ts` for logout:

```typescript
import { createClient } from '@/lib/supabase/server'
import { NextResponse } from 'next/server'

export async function POST() {
  const supabase = await createClient()
  await supabase.auth.signOut()

  return NextResponse.redirect(new URL('/login', process.env.NEXT_PUBLIC_SITE_URL || 'http://localhost:3000'))
}
```

Add NEXT_PUBLIC_SITE_URL to .env.local:

```bash
# Add this line to .env.local
NEXT_PUBLIC_SITE_URL=http://localhost:3000
```
  </action>
  <verify>
```bash
cd /Users/julianmunyard/LinkLobby && npx tsc --noEmit
# Should pass

npm run dev
# 1. Visit http://localhost:3000/editor - should redirect to /login (unauthenticated)
# 2. Sign up at /signup with a test account
# 3. Should redirect to /editor showing username
# 4. Visit /settings - should show username change form
# 5. Click "Log out" - should redirect to /login
# 6. Visit /editor again - should redirect to /login
# 7. Log in - should redirect to /editor
```
  </verify>
  <done>
Protected editor page shows user info. Settings page allows username changes via update_username RPC. Logout functionality works via API route. Full auth flow complete.
  </done>
</task>

</tasks>

<verification>
Complete auth flow test:

1. **Signup (AUTH-01, AUTH-02):**
   - Visit /signup
   - Enter email, password, username
   - Submit -> redirects to /editor
   - Profile and page auto-created (check Supabase dashboard)

2. **Session Persistence (AUTH-03):**
   - Close browser completely
   - Reopen and visit /editor
   - Should still be logged in (not redirected to /login)

3. **Protected Routes:**
   - Log out
   - Visit /editor -> redirects to /login
   - Visit /settings -> redirects to /login

4. **Username Change (AUTH-04):**
   - Log in and visit /settings
   - Change username to new value
   - Check Supabase dashboard: profiles.username AND pages.username both updated

5. **Login:**
   - Log out
   - Visit /login
   - Enter credentials
   - Submit -> redirects to /editor
</verification>

<success_criteria>
- AUTH-01: User can sign up with email and password (signUp form works)
- AUTH-02: User claims username during signup (passed in options.data, trigger creates profile)
- AUTH-03: User session persists across browser sessions (middleware refreshes tokens)
- AUTH-04: User can change username after signup (settings page with update_username RPC)
- Middleware protects /editor and /settings routes
- Authenticated users redirected away from /login and /signup
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-03-SUMMARY.md`
</output>
