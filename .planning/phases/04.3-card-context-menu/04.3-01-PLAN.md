---
phase: 04.3-card-context-menu
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/stores/page-store.ts
  - src/hooks/use-history.ts
  - src/components/editor/history-hotkeys.tsx
  - src/components/canvas/flow-grid.tsx
autonomous: true

must_haves:
  truths:
    - "Ctrl/Cmd+Z undoes the last card operation"
    - "Ctrl/Cmd+Shift+Z redoes the last undone operation"
    - "Undo/redo buttons show correct disabled state"
    - "History is paused during drag operations"
    - "Rapid field edits are batched into single undo entry"
  artifacts:
    - path: "src/stores/page-store.ts"
      provides: "Temporal middleware wrapping Zustand store"
      contains: "temporal("
    - path: "src/hooks/use-history.ts"
      provides: "Hook exposing undo/redo state and actions"
      exports: ["useHistory"]
    - path: "src/components/editor/history-hotkeys.tsx"
      provides: "Keyboard shortcut registration component"
      exports: ["HistoryHotkeys"]
  key_links:
    - from: "src/hooks/use-history.ts"
      to: "src/stores/page-store.ts"
      via: "usePageStore.temporal.getState()"
      pattern: "usePageStore\\.temporal"
    - from: "src/components/canvas/flow-grid.tsx"
      to: "src/hooks/use-history.ts"
      via: "pause/resume on drag"
      pattern: "(pause|resume)\\("
---

<objective>
Implement undo/redo infrastructure for the page editor using zundo temporal middleware.

Purpose: Enable artists to safely experiment with their page layout knowing they can undo any mistake. This removes friction from the creative process and makes the editor feel professional.

Output: Working undo/redo via keyboard shortcuts (Ctrl/Cmd+Z, Ctrl/Cmd+Shift+Z), with proper throttling to batch rapid edits and pause/resume during drag operations.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04.3-card-context-menu/04.3-RESEARCH.md

# Existing files to modify
@src/stores/page-store.ts
@src/components/canvas/flow-grid.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and wrap store with temporal middleware</name>
  <files>
    package.json
    src/stores/page-store.ts
  </files>
  <action>
    1. Install dependencies:
       ```bash
       npm install zundo react-hotkeys-hook lodash.throttle
       npm install -D @types/lodash.throttle
       ```

    2. Modify `src/stores/page-store.ts` to wrap with zundo temporal middleware:
       - Import `temporal` from 'zundo' and `throttle` from 'lodash.throttle'
       - Wrap the existing store creation with `temporal()`
       - Configure `partialize` to track ONLY `cards` array (exclude `selectedCardId`, `hasChanges`, `lastSavedAt`, `theme`)
       - Configure `handleSet` with 500ms throttle (trailing: true, leading: false) to batch rapid field edits
       - Set `limit: 50` for history depth
       - Keep all existing actions and state unchanged - temporal wraps the existing store

    Key points from RESEARCH.md:
    - Use `partialize: (state) => ({ cards: state.cards })` to avoid tracking UI state in history
    - Throttle prevents every keystroke creating history entry
    - 50 entry limit is reasonable for session-based undo
  </action>
  <verify>
    - `npm run build` succeeds with no type errors
    - `usePageStore.temporal` is accessible in browser console
    - `usePageStore.temporal.getState()` has `undo`, `redo`, `pause`, `resume`, `pastStates`, `futureStates`
  </verify>
  <done>
    Store is wrapped with temporal middleware, throttling is configured, and undo/redo actions are available on `usePageStore.temporal`
  </done>
</task>

<task type="auto">
  <name>Task 2: Create useHistory hook and HistoryHotkeys component</name>
  <files>
    src/hooks/use-history.ts
    src/components/editor/history-hotkeys.tsx
  </files>
  <action>
    1. Create `src/hooks/use-history.ts`:
       ```typescript
       import { useStore } from 'zustand'
       import { usePageStore } from '@/stores/page-store'

       export function useHistory() {
         // Get actions (non-reactive)
         const { undo, redo, clear, pause, resume } = usePageStore.temporal.getState()

         // Subscribe to state (reactive) for button disabled states
         const canUndo = useStore(usePageStore.temporal, (s) => s.pastStates.length > 0)
         const canRedo = useStore(usePageStore.temporal, (s) => s.futureStates.length > 0)

         return { undo, redo, clear, pause, resume, canUndo, canRedo }
       }
       ```

    2. Create `src/components/editor/history-hotkeys.tsx`:
       - Import `useHotkeys` from 'react-hotkeys-hook'
       - Import `useHistory` hook and `toast` from 'sonner'
       - Register `ctrl+z, meta+z` for undo with `preventDefault: true`
       - Register `ctrl+shift+z, meta+shift+z` for redo with `preventDefault: true`
       - Use `enableOnFormTags: false` to let native undo work in text fields
       - Show brief toast ("Undone" / "Redone") on keyboard shortcuts (2s duration)
       - Return null (invisible component for hotkey registration)

    Key insight: Separating the hook from the hotkeys component allows other components to access undo/redo state (for buttons) without registering hotkeys.
  </action>
  <verify>
    - `npm run build` succeeds
    - Hook exports `useHistory` with correct types
    - HistoryHotkeys component compiles without errors
  </verify>
  <done>
    useHistory hook provides undo/redo state and actions; HistoryHotkeys component registers keyboard shortcuts
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate hotkeys and pause history during drag</name>
  <files>
    src/components/editor/editor-client-wrapper.tsx
    src/components/canvas/flow-grid.tsx
  </files>
  <action>
    1. Add HistoryHotkeys to the editor:
       - Open `src/components/editor/editor-client-wrapper.tsx`
       - Import and render `<HistoryHotkeys />` inside the client wrapper (near PostMessageBridge)
       - This ensures hotkeys are registered when editor is active

    2. Pause history during drag in `src/components/canvas/flow-grid.tsx`:
       - Import `useHistory` from '@/hooks/use-history'
       - Get `pause` and `resume` from useHistory()
       - Call `pause()` at start of `handleDragStart`
       - Call `resume()` at end of `handleDragEnd` (after reorder logic)
       - This prevents intermediate drag states from polluting history

    Why pause during drag: Without this, undo during drag creates corrupted state. The user should undo the entire reorder operation, not intermediate positions.
  </action>
  <verify>
    - Dev server starts without errors
    - Pressing Ctrl+Z / Cmd+Z in editor (with no text field focused) shows "Undone" toast
    - Pressing Ctrl+Shift+Z / Cmd+Shift+Z shows "Redone" toast
    - Dragging a card and dropping it, then pressing Ctrl+Z, restores original order
    - History doesn't record every pixel of drag movement
  </verify>
  <done>
    Keyboard shortcuts work for undo/redo, and drag operations create single atomic history entries
  </done>
</task>

</tasks>

<verification>
After all tasks:
1. Add a card, then Ctrl+Z - card is removed, "Undone" toast appears
2. Ctrl+Shift+Z - card reappears, "Redone" toast appears
3. Edit a card's title rapidly - multiple keystrokes batch into single undo entry
4. Drag card to new position, Ctrl+Z - card returns to original position
5. No console errors during any of these operations
</verification>

<success_criteria>
- [ ] Dependencies installed (zundo, react-hotkeys-hook, lodash.throttle)
- [ ] page-store.ts wrapped with temporal middleware
- [ ] Only `cards` array tracked in history (not selectedCardId, hasChanges, theme)
- [ ] useHistory hook exports undo, redo, canUndo, canRedo, pause, resume
- [ ] Ctrl/Cmd+Z triggers undo with toast
- [ ] Ctrl/Cmd+Shift+Z triggers redo with toast
- [ ] Drag operations pause history, create single entry on drop
- [ ] npm run build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/04.3-card-context-menu/04.3-01-SUMMARY.md`
</output>
