---
phase: 04.3-card-context-menu
plan: 01
subsystem: editor
tags: [undo-redo, zustand, zundo, keyboard-shortcuts]
dependency-graph:
  requires: [04-04]
  provides: [temporal-middleware, history-hook, keyboard-shortcuts]
  affects: [04.3-02]
tech-stack:
  added: [zundo, react-hotkeys-hook, lodash.throttle]
  patterns: [temporal-middleware, throttled-state-tracking]
key-files:
  created:
    - src/hooks/use-history.ts
    - src/components/editor/history-hotkeys.tsx
  modified:
    - package.json
    - src/stores/page-store.ts
    - src/components/canvas/flow-grid.tsx
    - src/components/editor/editor-client-wrapper.tsx
decisions:
  - id: zundo-temporal-middleware
    description: Wrap Zustand store with zundo temporal() for undo/redo
    rationale: Native integration with Zustand, minimal API surface
  - id: partialize-cards-only
    description: Only track cards array in history, not UI state
    rationale: selectedCardId, hasChanges, theme are UI state, not undoable operations
  - id: throttle-500ms
    description: Throttle history updates by 500ms
    rationale: Batch rapid field edits into single undo entry
  - id: history-limit-50
    description: Limit history to 50 entries
    rationale: Reasonable for session-based undo without memory concerns
  - id: pause-during-drag
    description: Pause history during drag operations
    rationale: Prevents intermediate drag states from polluting history
metrics:
  duration: 2m19s
  completed: 2026-01-26
---

# Phase 04.3 Plan 01: Undo/Redo Infrastructure Summary

**One-liner:** Zundo temporal middleware for undo/redo with 500ms throttle, keyboard shortcuts (Ctrl/Cmd+Z/Shift+Z), and drag pause/resume

## What Was Built

### 1. Store Temporal Middleware (src/stores/page-store.ts)
Wrapped the existing Zustand store with zundo's `temporal()` middleware:
- **partialize:** Only tracks `cards` array, excludes UI state (selectedCardId, hasChanges, theme)
- **handleSet:** 500ms throttle with trailing:true batches rapid field edits
- **limit:** 50 entries of history depth
- `usePageStore.temporal` now exposes: undo, redo, pause, resume, pastStates, futureStates

### 2. useHistory Hook (src/hooks/use-history.ts)
Clean abstraction for accessing undo/redo functionality:
```typescript
const { undo, redo, pause, resume, canUndo, canRedo } = useHistory()
```
- Actions (undo, redo, pause, resume) are stable references from getState()
- canUndo/canRedo are reactive subscriptions for UI disabled states

### 3. HistoryHotkeys Component (src/components/editor/history-hotkeys.tsx)
Keyboard shortcut registration using react-hotkeys-hook:
- Ctrl+Z / Cmd+Z triggers undo
- Ctrl+Shift+Z / Cmd+Shift+Z triggers redo
- `enableOnFormTags: false` lets native undo work in text fields
- Toast notifications ("Undone" / "Redone") for feedback

### 4. Integration
- HistoryHotkeys added to EditorClientWrapper for global registration
- FlowGrid pauses history on drag start, resumes on drag end
- Ensures reorder creates single atomic history entry

## Files Changed

| File | Change |
|------|--------|
| package.json | Added zundo, react-hotkeys-hook, lodash.throttle deps |
| src/stores/page-store.ts | Wrapped with temporal() middleware |
| src/hooks/use-history.ts | New hook exposing history actions/state |
| src/components/editor/history-hotkeys.tsx | New component for keyboard shortcuts |
| src/components/editor/editor-client-wrapper.tsx | Added HistoryHotkeys |
| src/components/canvas/flow-grid.tsx | pause/resume during drag |

## Decisions Made

| Decision | Rationale |
|----------|-----------|
| zundo over zustand-middleware-xstate | Native Zustand integration, simpler API |
| partialize cards only | UI state like selection shouldn't be undoable |
| 500ms trailing throttle | Batch typing without losing final state |
| 50 entry limit | Session-based undo doesn't need infinite history |
| Separate hook from hotkeys | Other components can access canUndo/canRedo for buttons |

## Deviations from Plan

None - plan executed exactly as written.

## Commits

| Hash | Message |
|------|---------|
| b44aa96 | feat(04.3-01): wrap page store with temporal middleware for undo/redo |
| 3cd5769 | feat(04.3-01): create useHistory hook and HistoryHotkeys component |
| 27b77a4 | feat(04.3-01): integrate hotkeys and pause history during drag |

## Next Phase Readiness

**Phase 04.3 Plan 02: Context Menu** is unblocked:
- Undo/redo infrastructure is complete
- useHistory hook available for context menu undo/redo items
- canUndo/canRedo can disable menu items appropriately

---
*Completed: 2026-01-26*
