---
phase: 04.3-card-context-menu
plan: 02
type: execute
wave: 2
depends_on: ["04.3-01"]
files_modified:
  - src/components/editor/card-property-editor.tsx
  - src/components/editor/card-type-picker.tsx
  - src/components/dashboard/dashboard-header.tsx
  - src/stores/page-store.ts
autonomous: true

must_haves:
  truths:
    - "User can tap card type tiles to switch between Hero, Horizontal, Square"
    - "Switching card type preserves all content (title, description, URL, image)"
    - "Duplicate creates a copy below the original card"
    - "Delete removes the card and shows toast with Undo button"
    - "Clicking Undo in toast restores the deleted card"
    - "Undo/Redo buttons in header show disabled state correctly"
  artifacts:
    - path: "src/components/editor/card-type-picker.tsx"
      provides: "Visual tile picker for card types"
      exports: ["CardTypePicker"]
    - path: "src/components/editor/card-property-editor.tsx"
      provides: "Card editing with type picker, duplicate, delete"
      contains: "CardTypePicker"
    - path: "src/components/dashboard/dashboard-header.tsx"
      provides: "Header with undo/redo buttons"
      contains: "Undo2"
    - path: "src/stores/page-store.ts"
      provides: "duplicateCard action"
      contains: "duplicateCard"
  key_links:
    - from: "src/components/editor/card-property-editor.tsx"
      to: "src/stores/page-store.ts"
      via: "updateCard for type switch"
      pattern: "updateCard\\(.*card_type"
    - from: "src/components/editor/card-property-editor.tsx"
      to: "src/hooks/use-history.ts"
      via: "undo() in delete toast"
      pattern: "undo\\(\\)"
    - from: "src/components/dashboard/dashboard-header.tsx"
      to: "src/hooks/use-history.ts"
      via: "undo/redo button onClick"
      pattern: "(undo|redo)\\(\\)"
---

<objective>
Add card type switching, duplicate, and delete actions to the property editor, plus undo/redo buttons to the header.

Purpose: Complete the card manipulation UX - artists can convert card types via visual picker, duplicate cards, and delete with instant undo. The undo/redo buttons in the header provide discoverability (especially on mobile) alongside keyboard shortcuts.

Output: Property editor with icon tile picker for card types, Duplicate/Delete buttons, and header with Undo/Redo buttons.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04.3-card-context-menu/04.3-CONTEXT.md
@.planning/phases/04.3-card-context-menu/04.3-RESEARCH.md
@.planning/phases/04.3-card-context-menu/04.3-01-SUMMARY.md

# Existing files to modify
@src/components/editor/card-property-editor.tsx
@src/components/dashboard/dashboard-header.tsx
@src/stores/page-store.ts
@src/types/card.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CardTypePicker component and add duplicateCard action</name>
  <files>
    src/components/editor/card-type-picker.tsx
    src/stores/page-store.ts
  </files>
  <action>
    1. Create `src/components/editor/card-type-picker.tsx`:
       - Define CONVERTIBLE_CARD_TYPES: only hero, horizontal, square (regular link cards)
       - Each type has: type, icon (Lucide), label
         - hero: RectangleHorizontal icon, "Hero"
         - horizontal: Minus icon, "Horizontal"
         - square: Square icon, "Square"
       - Props: `currentType: CardType`, `onChange: (type: CardType) => void`
       - Render 3-column grid of buttons
       - Selected type shows border-primary and bg-primary/10
       - Each button shows icon (h-6 w-6) and label text (text-xs)
       - Use cn() for conditional classes

    2. Add `duplicateCard` action to `src/stores/page-store.ts`:
       - Add to interface: `duplicateCard: (id: string) => void`
       - Implementation:
         - Find the card to duplicate
         - Create new card with:
           - New UUID
           - Same card_type, title, description, url, content, size, position
           - New sortKey positioned AFTER the original (use generateAppendKey or position after original)
           - New timestamps
         - Add to cards array
         - Select the new card (set selectedCardId)
         - Set hasChanges: true

    Why only hero/horizontal/square are convertible: Per CONTEXT.md, dropdown is a container (not a link card) and cannot convert. Future complex cards (video, gallery, game, audio) will have their own rules.
  </action>
  <verify>
    - `npm run build` succeeds
    - CardTypePicker renders 3 tiles with correct icons
    - duplicateCard action is available on usePageStore
  </verify>
  <done>
    CardTypePicker component renders visual tiles for card type selection; duplicateCard action creates copy of card
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate type picker and actions into property editor</name>
  <files>
    src/components/editor/card-property-editor.tsx
  </files>
  <action>
    1. Import new dependencies:
       - CardTypePicker from './card-type-picker'
       - useHistory from '@/hooks/use-history'
       - toast from 'sonner'
       - Copy, Trash2 icons from 'lucide-react'

    2. Get store actions and history:
       - Get `duplicateCard` and `removeCard` from usePageStore
       - Get `undo` from useHistory()

    3. Add card type picker section (before Image upload):
       - Only show for convertible types (hero, horizontal, square)
       - Label: "Card Type"
       - Render CardTypePicker with currentType={card.card_type}
       - onChange: call updateCard(card.id, { card_type: newType })
       - Content is preserved automatically (unified schema)

    4. Add action buttons section (at bottom of form, after type-specific fields):
       - Use flex row with gap-2
       - Duplicate button:
         - variant="outline", size="sm"
         - Copy icon + "Duplicate" text
         - onClick: duplicateCard(card.id), then onClose() to show new card
       - Delete button:
         - variant="destructive", size="sm"
         - Trash2 icon + "Delete" text
         - onClick: handleDelete function

    5. Implement handleDelete:
       - Call removeCard(card.id)
       - Call onClose() to close editor
       - Show toast with undo action:
         ```typescript
         toast('Card deleted', {
           action: {
             label: 'Undo',
             onClick: () => {
               undo()
               toast('Card restored')
             }
           },
           duration: 5000,
         })
         ```

    Key insight from CONTEXT.md: Delete is immediate with no confirmation dialog. Undo via toast is the modern pattern.
  </action>
  <verify>
    - Dev server shows card type picker when editing hero/horizontal/square cards
    - Switching type updates card immediately in preview
    - Duplicate creates new card and selects it
    - Delete removes card and shows toast with Undo button
    - Clicking Undo in toast restores the card
  </verify>
  <done>
    Property editor has type picker for card conversion, Duplicate button, and Delete button with undo toast
  </done>
</task>

<task type="auto">
  <name>Task 3: Add undo/redo buttons to dashboard header</name>
  <files>
    src/components/dashboard/dashboard-header.tsx
  </files>
  <action>
    1. Import new dependencies:
       - Undo2, Redo2 icons from 'lucide-react'
       - useHistory from '@/hooks/use-history'

    2. Get history state and actions:
       - const { undo, redo, canUndo, canRedo } = useHistory()

    3. Add undo/redo buttons in the right side section, BEFORE the "Unsaved changes" indicator:
       - Use flex row with small gap (gap-1)
       - Undo button:
         - Tooltip: "Undo (Ctrl+Z)"
         - variant="ghost", size="sm", className="h-7 w-7 p-0"
         - Undo2 icon (h-3.5 w-3.5)
         - disabled={!canUndo}
         - onClick: undo(), toast('Undone', { duration: 2000 })
       - Redo button:
         - Tooltip: "Redo (Ctrl+Shift+Z)"
         - variant="ghost", size="sm", className="h-7 w-7 p-0"
         - Redo2 icon (h-3.5 w-3.5)
         - disabled={!canRedo}
         - onClick: redo(), toast('Redone', { duration: 2000 })

    4. Add visual separator (border-r h-4) between undo/redo and unsaved indicator

    Button styling matches existing Copy/ExternalLink buttons in header (ghost, h-7 w-7 p-0, icon h-3.5 w-3.5).

    Placement rationale: Near Save button so undo/redo feel like part of the save workflow. Visible on mobile where keyboard shortcuts aren't available.
  </action>
  <verify>
    - Undo button visible in header, disabled when no history
    - Redo button visible in header, disabled when no future states
    - Clicking Undo/Redo shows toast and updates state
    - Buttons enable/disable reactively as history changes
    - Tooltips show keyboard shortcuts
  </verify>
  <done>
    Dashboard header has Undo/Redo buttons with correct disabled states and tooltips
  </done>
</task>

</tasks>

<verification>
Complete user flow verification:

1. **Type conversion:**
   - Select a Hero card
   - Tap "Horizontal" in type picker
   - Card changes to Horizontal in preview, content preserved
   - Ctrl+Z restores to Hero

2. **Duplicate:**
   - Select any card
   - Click Duplicate
   - New card appears below original, is selected
   - Both cards have same content

3. **Delete with undo:**
   - Select a card
   - Click Delete
   - Card disappears, toast shows "Card deleted" with Undo
   - Click Undo in toast
   - Card reappears

4. **Header buttons:**
   - Add a card - Undo button enables
   - Click Undo - card removed, Redo button enables
   - Click Redo - card reappears

5. **Keyboard + button consistency:**
   - Ctrl+Z and Undo button do same thing
   - Ctrl+Shift+Z and Redo button do same thing
</verification>

<success_criteria>
- [ ] CardTypePicker shows 3 tiles for hero/horizontal/square
- [ ] Type picker only appears for convertible card types
- [ ] Switching type preserves title, description, URL, image, content
- [ ] duplicateCard action creates copy positioned after original
- [ ] Duplicate selects the new card
- [ ] Delete removes card immediately (no confirmation)
- [ ] Delete shows toast with Undo action
- [ ] Undo in toast restores deleted card
- [ ] Undo/Redo buttons in header with correct icons
- [ ] Buttons disabled when not applicable
- [ ] Tooltips show keyboard shortcuts
- [ ] npm run build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/04.3-card-context-menu/04.3-02-SUMMARY.md`
</output>
