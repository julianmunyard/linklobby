---
phase: 12-audio-system
plan: 04
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - src/components/cards/audio-card.tsx
  - src/components/editor/audio-card-fields.tsx
  - src/components/cards/card-renderer.tsx
  - src/components/editor/card-property-editor.tsx
  - src/components/editor/cards-tab.tsx
autonomous: true

must_haves:
  truths:
    - "Audio card renders in the card renderer with themed wrapper"
    - "Audio card appears in the Add Card dropdown menu"
    - "Artist can upload audio tracks via the editor fields"
    - "Artist can set album art, track title, artist name for each track"
    - "Artist can add multiple tracks to a single audio card"
    - "Artist can configure reverb parameters via modal"
    - "Artist can toggle between waveform and progress bar display"
    - "Artist can toggle looping on/off"
    - "Artist can customize 3 player colors (border, element bg, foreground)"
  artifacts:
    - path: "src/components/cards/audio-card.tsx"
      provides: "Audio card component for card renderer"
      exports: ["AudioCard"]
    - path: "src/components/editor/audio-card-fields.tsx"
      provides: "Editor fields for audio card configuration"
      exports: ["AudioCardFields"]
  key_links:
    - from: "src/components/cards/card-renderer.tsx"
      to: "src/components/cards/audio-card.tsx"
      via: "import AudioCard, render in switch case 'audio'"
      pattern: "case .audio."
    - from: "src/components/editor/card-property-editor.tsx"
      to: "src/components/editor/audio-card-fields.tsx"
      via: "import AudioCardFields, render when card_type is 'audio'"
      pattern: "AudioCardFields"
    - from: "src/components/editor/cards-tab.tsx"
      to: "audio card type in CARD_TYPES array"
      via: "Add audio to card type menu"
      pattern: "type.*audio.*label.*Audio"
---

<objective>
Create the audio card component, editor fields, and wire into the existing card renderer and editor systems.

Purpose: This plan connects the audio types (Plan 01) and UI components (Plan 03) to the existing card system. After this plan, artists can add audio cards, upload tracks, configure settings, and see the audio player render on their page.

Output: AudioCard component in CardRenderer, AudioCardFields in property editor, audio option in Add Card menu.
</objective>

<execution_context>
@/Users/julianmunyard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julianmunyard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-audio-system/12-CONTEXT.md
@.planning/phases/12-audio-system/12-RESEARCH.md
@.planning/phases/12-audio-system/12-01-SUMMARY.md
@src/components/cards/card-renderer.tsx
@src/components/editor/card-property-editor.tsx
@src/components/editor/cards-tab.tsx
@src/types/card.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AudioCard component and wire into CardRenderer</name>
  <files>
    src/components/cards/audio-card.tsx
    src/components/cards/card-renderer.tsx
  </files>
  <action>
**Create `src/components/cards/audio-card.tsx`:**
```typescript
interface AudioCardProps {
  card: Card
  isPreview?: boolean   // true in editor preview, false on public page
}
```

The AudioCard component:
1. Extract `AudioCardContent` from `card.content` using the `isAudioContent` type guard
2. If no tracks, show an empty state: "No audio uploaded yet" with an upload hint
3. If tracks exist, render the `AudioPlayer` component (from Plan 03) with:
   - `tracks` from content
   - `albumArtUrl` from content
   - `showWaveform` from content (default true)
   - `looping` from content (default false)
   - `reverbConfig` from content
   - `playerColors` from content
   - `cardId` = card.id
   - `isEditing` = isPreview (show editor-only controls in preview)
4. Album art: If `albumArtUrl` exists, show square image. Use Next.js `Image` component or `img` tag.
5. The card should fill its container width (audio cards are always full width per CARD_TYPE_SIZING).

**Update `src/components/cards/card-renderer.tsx`:**
1. Add import: `import { AudioCard } from "./audio-card"`
2. Add case in the switch statement:
```typescript
case "audio":
  cardContent = <AudioCard card={card} isPreview={isPreview} />
  break
```
3. Remove the `audio` from the default fallback comment ("coming soon")

This wires audio cards into the existing themed card wrapper system. The `ThemedCardWrapper` will handle theme-specific styling (Plan 05 does the theme-specific player adaptations).
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. CardRenderer has `case "audio"` with AudioCard import
3. AudioCard renders AudioPlayer when tracks exist
4. AudioCard shows empty state when no tracks
  </verify>
  <done>
AudioCard component renders in CardRenderer with ThemedCardWrapper. Shows AudioPlayer when tracks exist, empty state when no tracks. Supports all AudioCardContent fields.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create AudioCardFields editor and wire into editor system</name>
  <files>
    src/components/editor/audio-card-fields.tsx
    src/components/editor/card-property-editor.tsx
    src/components/editor/cards-tab.tsx
  </files>
  <action>
**Create `src/components/editor/audio-card-fields.tsx`:**
```typescript
interface AudioCardFieldsProps {
  content: Partial<AudioCardContent>
  onChange: (updates: Record<string, unknown>) => void
  cardId: string
}
```

Editor sections (use shadcn components, following existing field component patterns like `ReleaseCardFields`):

**1. Track Upload Section:**
- "Upload Track" button that opens a file input (accept audio/*)
- File size validation (100MB max) with error message
- Upload progress indicator (use state to track upload)
- After upload: call `/api/audio/upload` with FormData (file, cardId, trackId=crypto.randomUUID())
- On success: add track to `content.tracks` array with url, storagePath, title (from filename), artist (empty), duration (from response or 0)
- Each uploaded track shows in a list with: title input, artist input, delete button
- Track title and artist are editable inline (Input components)
- Delete track: remove from tracks array, call Supabase storage delete
- Drag to reorder tracks (optional -- can be deferred, just use up/down buttons or simple list order)

**2. Album Art Section:**
- ImageUpload component (reuse existing) for square album art
- On upload: store URL in `content.albumArtUrl` and path in `content.albumArtStoragePath`
- On remove: clear both fields

**3. Player Display Toggle:**
- Switch: "Show Waveform" (on) vs "Progress Bar" (off)
- Maps to `content.showWaveform` boolean

**4. Looping Toggle:**
- Switch: "Loop Playback"
- Maps to `content.looping` boolean

**5. Reverb Configuration:**
- Button: "Configure Reverb" opens `ReverbConfigModal`
- On save: updates `content.reverbConfig`
- Show current reverb status: "Reverb: On (Room Size: 0.5)" or "Reverb: Off"

**6. Player Colors:**
- Three `ColorPicker` components (reuse existing from shadcn):
  - "Border Color" -> `content.playerColors.borderColor`
  - "Element Background" -> `content.playerColors.elementBgColor`
  - "Accent Color" -> `content.playerColors.foregroundColor`
- Each has a reset/clear button to return to theme defaults (set to undefined)

**Update `src/components/editor/card-property-editor.tsx`:**
1. Add import: `import { AudioCardFields } from "./audio-card-fields"`
2. Add import: `import type { AudioCardContent } from "@/types/card"`
3. Add conditional render block (following the pattern of other card types):
```typescript
{card.card_type === "audio" && (
  <AudioCardFields
    content={currentContent as Partial<AudioCardContent>}
    onChange={handleContentChange}
    cardId={card.id}
  />
)}
```
Place this in the same area as other type-specific fields (after the Mac-specific fields, before the image upload).

**Update `src/components/editor/cards-tab.tsx`:**
1. Find the `CARD_TYPES` array
2. Add `{ type: "audio" as CardType, label: "Audio Player" }` -- place it after "Music Card" entry
3. Add `Music2` or `Headphones` icon import from lucide-react for the audio card in the dropdown menu (optional, follow existing pattern)
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. AudioCardFields renders in property editor when audio card selected
3. Audio card appears in Add Card dropdown
4. Track upload, album art upload, display toggle, looping toggle, reverb config, and color pickers all present
  </verify>
  <done>
AudioCardFields provides full editor for audio cards: track upload with title/artist editing, album art, waveform/progress toggle, looping toggle, reverb configuration modal, and 3 player color pickers. Audio card appears in Add Card menu. Property editor renders AudioCardFields for audio card type.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. Adding an audio card from the editor creates a card with correct default content
3. Audio card renders in preview (empty state initially, player when tracks uploaded)
4. AudioCardFields has all editor controls (upload, album art, toggles, reverb config, colors)
5. CardRenderer handles audio case with ThemedCardWrapper
6. Audio appears in Add Card dropdown menu
</verification>

<success_criteria>
- AudioCard renders in CardRenderer switch with themed wrapper
- AudioCardFields provides complete editing interface
- Track upload, album art, display toggles, reverb config, color pickers all functional
- Audio card in Add Card menu
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/12-audio-system/12-04-SUMMARY.md`
</output>
