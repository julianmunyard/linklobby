---
phase: 12-audio-system
plan: 03
type: execute
wave: 2
depends_on: ["12-01", "12-02"]
files_modified:
  - src/components/audio/audio-player.tsx
  - src/components/audio/player-controls.tsx
  - src/components/audio/varispeed-slider.tsx
  - src/components/audio/reverb-knob.tsx
  - src/components/audio/reverb-config-modal.tsx
  - src/components/audio/waveform-display.tsx
  - src/components/audio/track-list.tsx
autonomous: true

must_haves:
  truths:
    - "Audio player renders play/pause toggle, album art, varispeed slider, reverb knob, progress bar or waveform, time display, and track info"
    - "Varispeed slider works with both Natural and TimeStretch modes (0.5x to 1.5x)"
    - "Reverb knob allows visitors to control wet/dry mix with a rotary knob UI"
    - "Reverb config modal gives artists full control over reverb parameters (mix, width, damp, roomSize, predelay)"
    - "Waveform display shows pre-computed peaks with playback position indicator"
    - "Track list shows all tracks with current track highlighted, tap to switch"
    - "Progress bar is scrubbable via click/drag"
  artifacts:
    - path: "src/components/audio/audio-player.tsx"
      provides: "Base audio player component assembling all sub-components"
      exports: ["AudioPlayer"]
    - path: "src/components/audio/varispeed-slider.tsx"
      provides: "Varispeed slider with Natural/TimeStretch toggle"
      exports: ["VarispeedSlider"]
    - path: "src/components/audio/reverb-knob.tsx"
      provides: "Rotary knob for visitor reverb mix control"
      exports: ["ReverbKnob"]
    - path: "src/components/audio/reverb-config-modal.tsx"
      provides: "Full reverb parameter editor for artists"
      exports: ["ReverbConfigModal"]
    - path: "src/components/audio/waveform-display.tsx"
      provides: "Waveform visualization or progress bar with scrub"
      exports: ["WaveformDisplay"]
    - path: "src/components/audio/track-list.tsx"
      provides: "Multi-track list with current track highlighting"
      exports: ["TrackList"]
  key_links:
    - from: "src/components/audio/audio-player.tsx"
      to: "src/audio/hooks/useAudioPlayer.ts"
      via: "useAudioPlayer hook for playback state and controls"
      pattern: "useAudioPlayer"
    - from: "src/components/audio/varispeed-slider.tsx"
      to: "src/audio/hooks/useAudioPlayer.ts"
      via: "setSpeed and setVarispeedMode callbacks"
      pattern: "setSpeed|setVarispeedMode"
    - from: "src/components/audio/reverb-knob.tsx"
      to: "src/audio/hooks/useAudioPlayer.ts"
      via: "setReverbMix callback"
      pattern: "setReverbMix"
---

<objective>
Create all audio player UI components -- the visual interface visitors interact with on audio cards.

Purpose: These components are the user-facing audio controls. The varispeed slider and reverb knob are LinkLobby's core differentiators. The consistent base layout ensures all themes can skin these elements without rearranging them.

Output: AudioPlayer base component with play/pause, album art, varispeed slider, reverb knob, waveform/progress bar, time display, track info, and track list. Plus the ReverbConfigModal for the artist editor.
</objective>

<execution_context>
@/Users/julianmunyard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julianmunyard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-audio-system/12-CONTEXT.md
@.planning/phases/12-audio-system/12-RESEARCH.md
@.planning/phases/12-audio-system/12-01-SUMMARY.md
@.planning/phases/12-audio-system/12-02-SUMMARY.md

Port UI patterns from Munyard Mixer:
- /Users/julianmunyard/Documents/ESSENTIAL WEBSITES/NEW MUNYARD MIXER/app/components/VarispeedSlider.tsx
- /Users/julianmunyard/Documents/ESSENTIAL WEBSITES/NEW MUNYARD MIXER/app/components/ReverbConfigModal.tsx
- /Users/julianmunyard/Documents/ESSENTIAL WEBSITES/NEW MUNYARD MIXER/app/components/EffectKnob.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create base player controls (play/pause, progress/waveform, time display)</name>
  <files>
    src/components/audio/player-controls.tsx
    src/components/audio/waveform-display.tsx
  </files>
  <action>
**Create `src/components/audio/player-controls.tsx`:**
Play/pause toggle button component:
```typescript
interface PlayerControlsProps {
  isPlaying: boolean
  isLoaded: boolean
  isLoading: boolean
  onTogglePlay: () => void
  foregroundColor?: string    // Icon color (from PlayerColors)
  elementBgColor?: string     // Button background (from PlayerColors)
  className?: string
}
```
- Renders a circular button with Play (triangle) or Pause (two bars) icon
- Uses Lucide `Play` and `Pause` icons
- Shows loading spinner when isLoading
- Disabled when not loaded and not loading
- Accepts color props for theme customization: foregroundColor for icon, elementBgColor for button background
- Minimum touch target: 44px (h-11 w-11)

**Create `src/components/audio/waveform-display.tsx`:**
Dual-mode display -- waveform visualization OR progress bar:
```typescript
interface WaveformDisplayProps {
  showWaveform: boolean       // true = waveform, false = progress bar
  waveformData?: number[]     // Array of 0-1 peak values
  progress: number            // 0-1 current playback position
  currentTime: number         // seconds
  duration: number            // seconds
  onSeek: (position: number) => void  // 0-1
  foregroundColor?: string    // Active/played color
  elementBgColor?: string     // Inactive/unplayed color
  className?: string
}
```

**Waveform mode:**
- Render waveform as vertical bars using SVG or div elements
- Each bar height proportional to its peak value
- Bars before current position use foregroundColor (played)
- Bars after current position use elementBgColor (unplayed)
- Click/drag on waveform to seek (calculate position from click X relative to container width)
- Smooth transition as playback progresses

**Progress bar mode:**
- Simple horizontal bar with filled portion showing progress
- Filled portion uses foregroundColor, unfilled uses elementBgColor
- Scrub handle (small circle) at current position
- Click/drag to seek (same calculation as waveform)

**Time display:**
- Below the waveform/progress bar, show `currentTime / duration` in `mm:ss` format
- Use foregroundColor for text
- Format helper: `function formatTime(seconds: number): string` -> "0:00" format

Both modes support drag-to-scrub:
- onMouseDown/onTouchStart: start scrubbing, add mousemove/touchmove listener
- onMouseMove/onTouchMove: calculate position, call onSeek
- onMouseUp/onTouchEnd: stop scrubbing
- Use refs to avoid stale closures during drag
  </action>
  <verify>
`npx tsc --noEmit` passes. Components export correct interfaces with color props.
  </verify>
  <done>
PlayerControls renders play/pause toggle with loading state and theme colors. WaveformDisplay renders either waveform bars or progress bar with scrub-to-seek, time display, and theme color support.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create varispeed slider, reverb knob, reverb config modal, and track list</name>
  <files>
    src/components/audio/varispeed-slider.tsx
    src/components/audio/reverb-knob.tsx
    src/components/audio/reverb-config-modal.tsx
    src/components/audio/track-list.tsx
    src/components/audio/audio-player.tsx
  </files>
  <action>
**Create `src/components/audio/varispeed-slider.tsx`:**
Port from Munyard Mixer's `VarispeedSlider.tsx`:
```typescript
interface VarispeedSliderProps {
  speed: number                  // 0.5-1.5
  mode: VarispeedMode            // 'natural' | 'timestretch'
  onSpeedChange: (speed: number) => void
  onModeChange: (mode: VarispeedMode) => void
  foregroundColor?: string
  elementBgColor?: string
  className?: string
}
```
- Horizontal slider from 0.5x to 1.5x
- Center detent at 1.0x (snap to 1.0 when close)
- Speed value displayed above slider (e.g., "1.0x")
- Small toggle below slider: "Natural" vs "Time-Stretch" using a simple toggle or two small buttons
- Natural mode: vinyl-style pitch+speed change
- TimeStretch mode: speed changes, pitch stays constant
- Use shadcn Slider component or custom range input with theme colors
- Slider track uses elementBgColor, filled/thumb uses foregroundColor

**Create `src/components/audio/reverb-knob.tsx`:**
Port from Munyard Mixer's `EffectKnob.tsx` pattern:
```typescript
interface ReverbKnobProps {
  mix: number               // 0-1
  onMixChange: (mix: number) => void
  foregroundColor?: string
  elementBgColor?: string
  className?: string
}
```
- Rotary knob UI with tick marks around the circumference
- Drag to rotate (clockwise = increase, counterclockwise = decrease)
- Range: 0 (dry) to 1 (wet)
- Tick marks rendered as small lines radiating from center
- Knob indicator line shows current position
- Use SVG for the knob circle and ticks
- Mouse/touch drag: calculate angle from center, map to 0-1 value
- Keep size compact (48-64px diameter) to fit in player layout
- Background circle uses elementBgColor, ticks and indicator use foregroundColor
- Label "Reverb" below knob in small text

**Create `src/components/audio/reverb-config-modal.tsx`:**
Port from Munyard Mixer's `ReverbConfigModal.tsx`:
```typescript
interface ReverbConfigModalProps {
  config: ReverbConfig
  onSave: (config: ReverbConfig) => void
  trigger?: React.ReactNode
}
```
- Modal dialog (use shadcn Dialog) for the artist editor
- Sliders for: mix (0-1), width (0-1), damp (0-1), roomSize (0-1), predelayMs (0-200)
- Enable/disable toggle for reverb
- Preview button to hear changes (if audio is loaded)
- Save/Cancel buttons
- Labels and descriptions for each parameter:
  - Mix: "Wet/dry balance" (0=dry, 1=fully wet)
  - Width: "Stereo spread" (0=mono, 1=full stereo)
  - Damp: "High frequency absorption" (0=bright, 1=muffled)
  - Room Size: "Reverb decay length" (0=small room, 1=cathedral)
  - Pre-delay: "Delay before reverb onset (ms)"
- Use shadcn Slider components
- This is the EDITOR modal -- not shown to visitors. Visitors only see the simple ReverbKnob.

**Create `src/components/audio/track-list.tsx`:**
```typescript
interface TrackListProps {
  tracks: AudioTrack[]
  currentTrackIndex: number
  onTrackSelect: (index: number) => void
  foregroundColor?: string
  elementBgColor?: string
  className?: string
}
```
- Vertical list of tracks below the player
- Each track shows: index number, title, artist, duration (formatted mm:ss)
- Current track highlighted with foregroundColor background or border
- Tap/click to switch tracks
- Compact layout -- each track row ~36-40px height
- Only render if tracks.length > 1 (single track cards don't need a list)

**Create `src/components/audio/audio-player.tsx`:**
Base player component that assembles all sub-components:
```typescript
interface AudioPlayerProps {
  tracks: AudioTrack[]
  albumArtUrl?: string
  showWaveform?: boolean
  looping?: boolean
  reverbConfig?: ReverbConfig
  playerColors?: PlayerColors
  cardId: string
  isEditing?: boolean         // In editor = show reverb config button
  onContentChange?: (updates: Record<string, unknown>) => void  // For editor updates
  className?: string
}
```

Layout structure (consistent across all themes):
```
[Album Art (square)] [Play/Pause]
[Track Title - Artist Name - Duration]
[Varispeed Slider ---- | Natural/TimeStretch toggle]
[Waveform/Progress Bar ---- | Time: 0:00 / 3:45]
[Reverb Knob (with ticks)]
[Track List (if multi-track)]
```

Specific layout:
- Top row: Square album art (80x80px) on left, play/pause button right of it, track title + artist + duration to the right
- Below: Varispeed slider (full width) with mode toggle
- Below: Waveform or progress bar (full width) with time display
- Right side or below progress: Reverb knob
- Below all controls: Track list (if multi-track)

Use the `useAudioPlayer` hook for playback state.
If `isEditing` is true, show a gear/settings icon next to the reverb knob that opens `ReverbConfigModal`.
When ReverbConfigModal saves, call `onContentChange({ reverbConfig: newConfig })`.

Pass `playerColors` fields to all sub-components as color props.
Default colors come from CSS variables (theme defaults) when playerColors fields are undefined.
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. AudioPlayer component renders all sub-components
3. VarispeedSlider has both modes
4. ReverbKnob is rotary with tick marks
5. TrackList highlights current track
6. All components accept color customization props
  </verify>
  <done>
Complete audio player UI: play/pause, waveform/progress bar with scrub, varispeed slider with mode toggle, reverb knob with ticks, reverb config modal for editor, track list for multi-track cards. All components accept PlayerColors for theme customization. Layout is consistent and ready for theme skinning.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. AudioPlayer assembles all sub-components in consistent layout
3. Play/pause toggle works
4. Waveform and progress bar modes both render
5. Varispeed slider ranges 0.5x-1.5x with Natural/TimeStretch toggle
6. Reverb knob is rotary with tick marks
7. Reverb config modal has all parameters
8. Track list renders for multi-track, hidden for single track
9. All components support PlayerColors customization
</verification>

<success_criteria>
- All 7 audio UI components created and exported
- Consistent layout structure maintained
- Varispeed slider with dual mode toggle
- Rotary reverb knob with tick marks
- Scrubbable waveform and progress bar
- All components accept theme color props
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/12-audio-system/12-03-SUMMARY.md`
</output>
