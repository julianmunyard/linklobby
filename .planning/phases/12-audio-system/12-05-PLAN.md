---
phase: 12-audio-system
plan: 05
type: execute
wave: 3
depends_on: ["12-03", "12-04"]
files_modified:
  - src/components/cards/audio-card.tsx
  - src/components/cards/themed-card-wrapper.tsx
  - src/components/cards/ipod-classic-layout.tsx
  - src/components/cards/macintosh-card.tsx
  - src/components/cards/receipt-layout.tsx
  - src/components/cards/vcr-menu-layout.tsx
  - src/lib/analytics/track-event.ts
  - src/components/public/click-tracker.tsx
  - src/app/api/analytics/track/route.ts
autonomous: false

must_haves:
  truths:
    - "Audio player renders with correct visual style for each theme (Instagram Reels, Macintosh, System Settings, Receipt, iPod Classic, VCR)"
    - "iPod Classic click wheel is functional for audio cards (scroll=varispeed, play/pause button, fwd/back buttons)"
    - "Macintosh audio player uses Pix Chicago font and pixel-art style controls"
    - "Receipt audio player uses monospace font with black-on-white styling"
    - "VCR audio player has LED counter for time and chunky transport buttons"
    - "Audio plays are tracked via analytics (type: 'audio_play') and visible in insights"
    - "Audio cards render correctly on public pages for visitors"
    - "Visitors can play, pause, scrub but never autoplay"
    - "One-at-a-time playback works across audio cards and music embeds"
  artifacts:
    - path: "src/lib/analytics/track-event.ts"
      provides: "trackAudioPlay function for analytics"
      exports: ["trackAudioPlay"]
    - path: "src/components/public/click-tracker.tsx"
      provides: "Updated click tracker with audio_play support"
  key_links:
    - from: "src/components/cards/audio-card.tsx"
      to: "src/lib/analytics/track-event.ts"
      via: "trackAudioPlay called on play button press"
      pattern: "trackAudioPlay"
    - from: "src/app/api/analytics/track/route.ts"
      to: "analytics_interactions table"
      via: "audio_play interaction type inserted to database"
      pattern: "audio_play"
    - from: "src/components/cards/ipod-classic-layout.tsx"
      to: "src/components/audio/audio-player.tsx"
      via: "iPod layout renders audio player inside LCD screen with click wheel controls"
      pattern: "AudioPlayer|audio"
---

<objective>
Apply theme-specific styling to audio players, add analytics tracking for audio plays, and perform end-to-end verification.

Purpose: This plan completes the audio system by adding the visual theme adaptations that make each theme's audio player unique (iPod click wheel, Macintosh pixel art, VCR LED display, etc.), wiring analytics tracking, and verifying the complete system works end-to-end.

Output: Theme-adapted audio players for all 6 themes, audio play analytics tracking, complete working audio system.
</objective>

<execution_context>
@/Users/julianmunyard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julianmunyard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-audio-system/12-CONTEXT.md
@.planning/phases/12-audio-system/12-RESEARCH.md
@.planning/phases/12-audio-system/12-01-SUMMARY.md
@.planning/phases/12-audio-system/12-02-SUMMARY.md
@.planning/phases/12-audio-system/12-03-SUMMARY.md
@.planning/phases/12-audio-system/12-04-SUMMARY.md
@src/components/cards/themed-card-wrapper.tsx
@src/components/cards/ipod-classic-layout.tsx
@src/components/cards/macintosh-card.tsx
@src/components/cards/receipt-layout.tsx
@src/components/cards/vcr-menu-layout.tsx
@src/lib/analytics/track-event.ts
@src/components/public/click-tracker.tsx
@src/app/api/analytics/track/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Theme-specific audio player adaptations for all 6 themes</name>
  <files>
    src/components/cards/audio-card.tsx
    src/components/cards/themed-card-wrapper.tsx
    src/components/cards/ipod-classic-layout.tsx
    src/components/cards/macintosh-card.tsx
    src/components/cards/receipt-layout.tsx
    src/components/cards/vcr-menu-layout.tsx
  </files>
  <action>
Read each theme layout file to understand existing patterns, then adapt audio player rendering for each theme. The CONTEXT.md specifies:

**Same base layout, different visual styling.** Themes skin elements, not rearrange them. All themes use the same AudioPlayer component with CSS class overrides and font changes.

**Approach:** Add a `themeId` prop to AudioPlayer (or detect from context). Apply theme-specific CSS classes to sub-components. The AudioPlayer component should accept a `themeVariant` prop that controls styling.

**Instagram Reels (default):**
- Clean, simple controls. Standard card border style.
- No special adaptations needed -- this IS the base styling.
- Simple play/pause toggle, slider, knob -- minimal and sharp.

**Macintosh:**
- Read `src/components/cards/macintosh-card.tsx` for existing patterns
- Audio player renders inside the large window card (MacintoshCard component)
- Use **Pix Chicago font** (already loaded in the project for Macintosh theme) for time/labels
- Pixelated play button (use a pixel-art triangle/bars icon, or scale down and use image-rendering: pixelated)
- Chunky slider track (3-4px height instead of 2px, beveled 3D look matching Mac card shadows)
- Full retro Mac commitment in all elements
- Apply `font-[var(--font-pix-chicago)]` or equivalent class

**System Settings:**
- Read `src/components/cards/system-settings-card.tsx` for existing patterns
- Full **Poolsuite treatment** -- Ishmeria/ChiKareGo fonts for labels
- Cream inner box, thin borders, retro aesthetic
- All 3 color customization fields apply
- Match the multi-layer framing (cream outer box, white inner box) from existing System Settings cards

**Receipt:**
- Read `src/components/cards/receipt-layout.tsx` for existing patterns
- Uses the existing receipt monospace font
- Simple **black controls** (buttons, slider, knob) on paper-like background
- Clean, minimal, monochrome
- No fancy styling -- just rendered in receipt's black-on-white mono aesthetic
- Override all player colors to black on white when in receipt theme
- **Use `receipt-divider` dashed separator pattern** between player sections (same as Release Card):
  - `<div className="receipt-divider">{'-'.repeat(60)}</div>` above and below the audio player area
  - Dashes between album art/track info, controls, and track list sections
  - Match the exact same `.receipt-divider` CSS class (monospace, 50% opacity, 10px, negative margins for bleed)
  - Section headers in `** ASTERISK **` format (e.g., `** NOW PLAYING **`)
  - All text uppercase, monospace, matching the thermal receipt printer aesthetic

**iPod Classic:**
- Read `src/components/cards/ipod-classic-layout.tsx` for existing patterns
- Player renders **inside the iPod LCD screen area**
- **Click wheel is functional:**
  - Scroll wheel (circular gesture) adjusts varispeed
  - Center play/pause button works
  - Forward/back buttons navigate tracks in multi-track cards
  - Menu button could go back to card view
- This is the most complex theme adaptation:
  - Detect when card is audio type in the iPod layout
  - Render audio player controls within the LCD screen area
  - Wire click wheel buttons to audio player actions
  - Now Playing screen layout: album art (small, centered), track title, artist, time bar below
- The iPod screen is small -- compact layout with smaller controls
- Use the existing iPod LCD font styling

**VCR:**
- Read `src/components/cards/vcr-menu-layout.tsx` for existing patterns
- **VHS tape deck look**
- Chunky transport-style buttons (play, pause, stop, ff, rew)
- **LED counter** for time display -- use a 7-segment-style font or CSS recreation
  - Can use a monospace font with letter-spacing and glow effect: `text-shadow: 0 0 5px currentColor`
  - Or a dedicated LED font if available
- Tape-style progress bar (simulate tape reel position)
- Simpler retro controls -- chunky buttons and sliders in VCR color scheme
- Transport buttons layout: [<< ] [> / ||] [>> ] [Stop] -- classic VCR transport bar

For each theme, the adaptation should be done via:
1. CSS class variants on existing player components (preferred)
2. OR conditional rendering within the AudioPlayer based on themeId
3. OR wrapper components per theme if complexity requires it

Use `useThemeStore` to detect current theme. The AudioPlayer can read the current themeId and apply variant classes.
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. Audio card renders with correct styling for each theme
3. iPod click wheel buttons are wired to audio player actions
4. Macintosh player uses pixel font
5. Receipt player is black-on-white monospace
6. VCR player has LED time counter
  </verify>
  <done>
Audio player adapts visually for all 6 themes while maintaining the same base layout structure. iPod click wheel functional for audio. Macintosh uses pixel art controls. Receipt uses monospace black-on-white. VCR has LED counter and transport buttons. System Settings uses Poolsuite fonts. Instagram Reels uses clean default styling.
  </done>
</task>

<task type="auto">
  <name>Task 2: Audio analytics tracking and end-to-end wiring</name>
  <files>
    src/lib/analytics/track-event.ts
    src/components/public/click-tracker.tsx
    src/app/api/analytics/track/route.ts
    src/components/cards/audio-card.tsx
  </files>
  <action>
**Update `src/lib/analytics/track-event.ts`:**
Add `trackAudioPlay` function:
```typescript
export interface TrackAudioPlayPayload {
  cardId: string
  pageId: string
  trackTitle?: string
  duration?: number
}

export async function trackAudioPlay(payload: TrackAudioPlayPayload): Promise<void> {
  try {
    await fetch('/api/analytics/track', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        type: 'audio_play',
        ...payload
      })
    })
  } catch (error) {
    console.debug('Failed to track audio play:', error)
  }
}
```

Also update `TrackInteractionPayload` to include `'audio_play'` in the interactionType union:
```typescript
interactionType: 'game_play' | 'gallery_view' | 'audio_play'
```

**Update `src/app/api/analytics/track/route.ts`:**
Add handling for `type === 'audio_play'` -- insert into `analytics_interactions` table with `interaction_type: 'audio_play'`. Follow the exact same pattern as `game_play` and `gallery_view` interactions.

Update the interaction type validation to accept `'audio_play'`:
```typescript
if (interactionType !== 'game_play' && interactionType !== 'gallery_view' && interactionType !== 'audio_play') {
```

**Update `src/components/public/click-tracker.tsx`:**
Add `data-audio-play` attribute tracking support:
```typescript
// Check for audio play tracking
const audioPlayId = element.getAttribute('data-audio-play')
if (audioPlayId) {
  trackInteraction({
    cardId: audioPlayId,
    pageId,
    interactionType: 'audio_play'
  })
  break
}
```

**Update `src/components/cards/audio-card.tsx`:**
Add `data-audio-play={card.id}` attribute to the play button or the audio card wrapper. When a visitor presses play, the click tracker will detect the `data-audio-play` attribute and fire the analytics event.

Alternatively (and preferably), call `trackAudioPlay` directly from the `handlePlay` callback in the AudioPlayer:
```typescript
// In AudioPlayer or AudioCard
const handlePlay = () => {
  audioPlayer.play()
  // Track audio play for analytics (only on public pages, not in editor)
  if (!isEditing && pageId) {
    trackAudioPlay({
      cardId: card.id,
      pageId: card.page_id,
      trackTitle: currentTrack?.title,
      duration: currentTrack?.duration
    })
  }
}
```

This is cleaner than the click tracker approach because it fires exactly when audio actually starts playing, not on every click.

**Verify end-to-end wiring:**
- Audio card can be added from editor
- Tracks can be uploaded
- Player renders with correct theme styling
- Play/pause/seek work
- Varispeed slider controls speed
- Reverb knob controls wet/dry
- One-at-a-time playback with music embeds
- Analytics tracking fires on play
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. `trackAudioPlay` function exists in track-event.ts
3. Analytics API route handles 'audio_play' interaction type
4. AudioCard calls trackAudioPlay on play (not in editor mode)
5. No TypeScript errors
  </verify>
  <done>
Audio plays tracked via analytics_interactions table with 'audio_play' interaction type. trackAudioPlay fires when visitor presses play on public page. Analytics API route handles the new interaction type. Click tracker also supports data-audio-play attribute fallback.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete audio system: engine, upload, player UI, themed players for all 6 themes, editor fields, analytics tracking. Audio cards can be created, configured, and played by visitors.
  </what-built>
  <how-to-verify>
1. Open the editor at http://localhost:3000/editor
2. Add an audio card from the "Add Card" menu
3. Upload an audio file (MP3 or WAV)
4. Verify the audio player renders in the preview
5. Click play -- audio should play, pause button should appear
6. Drag the progress bar / waveform to seek
7. Adjust the varispeed slider -- speed should change
8. Toggle between Natural and TimeStretch modes
9. Turn the reverb knob -- reverb amount should change
10. Open reverb config (gear icon) -- all parameters should be adjustable
11. Upload a second track -- track list should appear below player
12. Set album art -- should display as square image
13. Toggle waveform/progress bar -- display should switch
14. Toggle looping -- track should loop when enabled
15. Customize player colors (border, element bg, accent) -- colors should update
16. Switch themes (Instagram Reels, Macintosh, System Settings, Receipt, iPod, VCR) -- audio player should adapt styling
17. On iPod theme, verify click wheel buttons work for audio playback
18. View public page -- audio card should render and be playable by visitors
19. Check that playing audio pauses any music embeds (one-at-a-time)
20. Test on mobile -- touch controls should work for all interactions
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. All 6 themes render audio player with correct visual styling
2. iPod click wheel functional for audio control
3. Analytics tracking fires on audio play
4. One-at-a-time playback works across audio and music embeds
5. Public page renders audio cards correctly for visitors
6. No autoplay -- visitors must press play
7. Complete editor workflow: add card -> upload tracks -> configure -> preview
</verification>

<success_criteria>
- Audio player renders with theme-specific styling for all 6 themes
- iPod click wheel controls audio playback
- Audio plays tracked in analytics
- End-to-end workflow complete: create, upload, configure, play, track
- Human verification confirms system works correctly
</success_criteria>

<output>
After completion, create `.planning/phases/12-audio-system/12-05-SUMMARY.md`
</output>
