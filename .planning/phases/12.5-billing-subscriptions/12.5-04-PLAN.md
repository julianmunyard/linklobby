---
phase: 12.5-billing-subscriptions
plan: 04
type: execute
wave: 3
depends_on: ["12.5-02", "12.5-03"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "Full billing flow verified end-to-end: pricing page -> checkout -> webhook -> subscription active"
    - "Plan badge updates after subscription change"
    - "Pro features appear on public page after upgrade"
    - "Pro features stripped from public page after downgrade"
    - "Branding footer visibility toggles correctly based on plan"
---

<objective>
Human verification of the complete billing and subscription system.

Purpose: Billing involves real money and external service integration. Human verification ensures the checkout flow, webhook processing, plan gating, and UI all work correctly before shipping to production.
Output: Verified billing system ready for production.
</objective>

<execution_context>
@/Users/julianmunyard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julianmunyard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/12.5-billing-subscriptions/12.5-01-SUMMARY.md
@.planning/phases/12.5-billing-subscriptions/12.5-02-SUMMARY.md
@.planning/phases/12.5-billing-subscriptions/12.5-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build verification and env var validation</name>
  <files></files>
  <action>
Run the following checks before human verification:

1. `npx tsc --noEmit` — full type check
2. `npm run build` — production build succeeds
3. Verify all billing files exist:
   - `ls src/lib/stripe/client.ts src/lib/stripe/plans.ts src/lib/stripe/subscription.ts`
   - `ls src/lib/supabase/admin.ts`
   - `ls src/app/api/webhooks/stripe/route.ts src/app/api/billing/checkout/route.ts src/app/api/billing/portal/route.ts`
   - `ls src/app/pricing/page.tsx`
   - `ls src/components/billing/pro-gate.tsx src/components/billing/plan-badge.tsx src/components/billing/upgrade-modal.tsx src/components/billing/pricing-table.tsx`
4. Verify critical patterns:
   - `grep "request.text()" src/app/api/webhooks/stripe/route.ts` — raw body, not JSON
   - `grep "constructEvent" src/app/api/webhooks/stripe/route.ts` — signature verification
   - `grep "webhook_events" src/app/api/webhooks/stripe/route.ts` — idempotency
   - `grep "createAdminClient" src/app/api/webhooks/stripe/route.ts` — service role client
   - `grep "trial_period_days" src/app/api/billing/checkout/route.ts` — 7-day trial
   - `grep "hasProAccess" src/components/public/public-page-renderer.tsx` — gating prop

If any check fails, fix the issue before proceeding to human verification.
  </action>
  <verify>
- `npx tsc --noEmit` exits 0
- `npm run build` exits 0
- All file existence checks pass
- All grep pattern checks pass
  </verify>
  <done>Build passes, all files exist, all critical patterns verified.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Stripe billing system: pricing page, checkout flow with 7-day no-card trial, webhook handler, subscription sync, plan badges, ProGate editor badges, public page feature stripping, branding footer gating, Pro-only theme fallback.</what-built>
  <how-to-verify>
**Prerequisites:**
- Stripe test mode API keys configured in .env.local
- Stripe CLI installed and listening: `stripe listen --forward-to localhost:3000/api/webhooks/stripe`
- Database migration applied (run SQL from `supabase/migrations/20260225_billing_tables.sql` in Supabase SQL editor)
- Stripe test products/prices created (Pro Monthly, Pro Annual, Artist Monthly, Artist Annual)

**Test 1: Pricing Page**
1. Visit http://localhost:3000/pricing (logged out)
2. Verify: 3 tiers displayed with feature comparison
3. Toggle monthly/annual — prices should change
4. Click "Upgrade to Pro" — should redirect to login (not Stripe, since not authenticated)

**Test 2: Checkout Flow (logged in)**
1. Log in as a free user
2. Visit /pricing
3. Click "Upgrade to Pro" (monthly)
4. Verify: redirected to Stripe Checkout page with $12/mo and 7-day trial
5. Use Stripe test card: 4242 4242 4242 4242, any future expiry, any CVC
6. Complete checkout
7. Verify: redirected back to /settings/billing?success=true
8. Check Stripe CLI terminal — should show webhook events processed

**Test 3: Plan Badge**
1. After upgrade, check sidebar — badge should show "Pro" (amber)
2. Check editor header — badge should show "Pro"
3. Click badge — should navigate to /pricing

**Test 4: Pro Features (Editor)**
1. Before upgrade (as free user): open editor, check email collection card settings — should show Pro badge overlay
2. After upgrade: same settings should NOT show Pro badge

**Test 5: Public Page Gating**
1. As free user: add an email collection card and check public page — card should NOT appear
2. After upgrade: same card should appear on public page
3. Free user: "Powered by LinkLobby" should appear in footer
4. Pro user: "Powered by LinkLobby" should NOT appear

**Test 6: Customer Portal**
1. As subscribed user, go to Settings
2. Click "Manage Billing"
3. Verify: opens Stripe Customer Portal
4. Portal should show subscription details, payment method, cancel option

**Test 7: Theme Gating**
1. As free user: select a Pro-only theme in editor — should show Pro badge
2. Check public page — should fall back to default theme (not the Pro theme)
3. After upgrade: public page should show the Pro theme
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues found.</resume-signal>
</task>

</tasks>

<verification>
1. Production build succeeds with no errors
2. All billing files present and correctly structured
3. Human has verified end-to-end flow works
</verification>

<success_criteria>
- Build and type check pass
- Human has tested and approved the full billing flow
- All 7 test scenarios pass
</success_criteria>

<output>
After completion, create `.planning/phases/12.5-billing-subscriptions/12.5-04-SUMMARY.md`
</output>
