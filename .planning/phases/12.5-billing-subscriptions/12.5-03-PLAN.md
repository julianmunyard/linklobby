---
phase: 12.5-billing-subscriptions
plan: 03
type: execute
wave: 2
depends_on: ["12.5-01"]
files_modified:
  - src/components/billing/pro-gate.tsx
  - src/components/editor/card-property-editor.tsx
  - src/components/editor/cards-tab.tsx
  - src/components/editor/design-panel.tsx
  - src/components/public/public-page-renderer.tsx
  - src/components/public/static-flow-grid.tsx
  - src/components/public/static-scatter-canvas.tsx
  - src/components/public/static-phone-home-layout.tsx
  - src/components/public/static-macintosh-layout.tsx
  - src/components/public/static-ipod-classic-layout.tsx
  - src/components/public/static-vcr-menu-layout.tsx
  - src/components/public/static-receipt-layout.tsx
  - src/components/public/static-word-art-layout.tsx
  - src/components/public/static-chaotic-zine-layout.tsx
  - src/components/public/static-artifact-layout.tsx
  - src/app/[username]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Pro features in editor show a Pro badge overlay but remain fully interactive"
    - "Free users' public pages do NOT render email collection cards, QR code cards, or release mode cards"
    - "Free users' public pages show 'Powered by LinkLobby' footer; Pro/Artist pages do not"
    - "Free users can preview Pro-only themes in editor but see upgrade prompt when publishing"
    - "getUserPlan is called once at public page render time and gates all Pro features"
  artifacts:
    - path: "src/components/billing/pro-gate.tsx"
      provides: "Editor wrapper that adds Pro badge overlay without blocking interaction"
      exports: ["ProGate"]
    - path: "src/app/[username]/page.tsx"
      provides: "Public page route with plan-aware feature stripping"
      contains: "getUserPlan"
  key_links:
    - from: "src/components/billing/pro-gate.tsx"
      to: "src/components/editor/card-property-editor.tsx"
      via: "wraps Pro-only editor controls"
      pattern: "ProGate"
    - from: "src/app/[username]/page.tsx"
      to: "src/lib/stripe/subscription.ts"
      via: "calls getUserPlan to determine feature access"
      pattern: "getUserPlan"
    - from: "src/components/public/public-page-renderer.tsx"
      to: "LegalFooter"
      via: "conditionally renders footer based on hasProAccess prop"
      pattern: "hasProAccess"
---

<objective>
Implement the soft-lock paywall: ProGate component for editor badges, public page feature stripping for free users, and theme gating.

Purpose: This is the core monetization enforcement. Free users see Pro badges everywhere in the editor (creating desire to upgrade) but can still interact with all features. On the public page, Pro features are stripped for free users. This creates the "taste everything, pay to publish" model defined in CONTEXT.md.
Output: ProGate component, editor integration for all Pro features, public page gating for cards/branding/themes.
</objective>

<execution_context>
@/Users/julianmunyard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julianmunyard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12.5-billing-subscriptions/12.5-RESEARCH.md
@.planning/phases/12.5-billing-subscriptions/12.5-CONTEXT.md
@.planning/phases/12.5-billing-subscriptions/12.5-01-SUMMARY.md
@src/lib/stripe/plans.ts
@src/lib/stripe/subscription.ts
@src/components/public/public-page-renderer.tsx
@src/components/editor/card-property-editor.tsx
@src/components/editor/cards-tab.tsx
@src/app/[username]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: ProGate component and editor integration</name>
  <files>src/components/billing/pro-gate.tsx, src/components/editor/card-property-editor.tsx, src/components/editor/cards-tab.tsx, src/components/editor/design-panel.tsx</files>
  <action>
**Step 1: Create `src/components/billing/pro-gate.tsx`.**

Follow research Pattern 6. Client component ('use client').

Props:
- `children: React.ReactNode`
- `requiredTier?: 'pro' | 'artist'` (default: 'pro')
- `currentTier: PlanTier`
- `feature?: string` — optional feature name for the badge tooltip
- `className?: string`
- `onUpgradeClick?: () => void` — optional callback when Pro badge is clicked (opens upgrade modal)

Behavior:
- If `currentTier >= requiredTier` (i.e., user has access), render children normally with no badge
- If user does NOT have access, render children wrapped in a `relative` div with a small Pro badge in the top-right corner
- The Pro badge: `absolute top-0.5 right-0.5 z-10`, amber pill with Crown icon and "Pro" text (or "Artist" if requiredTier is artist)
- Badge is clickable — calls `onUpgradeClick` if provided
- Children remain fully interactive (no pointer-events blocking, no opacity reduction) — this is the soft-lock model
- Use `cn()` for class merging

Also export a simpler `ProBadge` inline component (just the badge, no wrapper) for use in card type drawers and list items:
```tsx
export function ProBadge({ className }: { className?: string }) {
  return (
    <span className={cn('inline-flex items-center gap-0.5 rounded-full bg-amber-500 px-1.5 py-0.5 text-[10px] font-semibold text-white', className)}>
      <Crown className="h-2.5 w-2.5" />
      Pro
    </span>
  )
}
```

**Step 2: Wrap Pro features in the editor with ProGate.**

Read the following files to understand where Pro features are configured:
- `src/components/editor/card-property-editor.tsx` — card-specific editor fields
- `src/components/editor/cards-tab.tsx` — card type list/drawer
- `src/components/editor/design-panel.tsx` — theme and design controls

Then wrap Pro-only features:

**In `card-property-editor.tsx`:**
- Find where email_collection card fields are rendered. Wrap the email collection section in `<ProGate currentTier={planTier} feature="Email Collection">`.
- Find where release mode card fields are rendered. Wrap in `<ProGate currentTier={planTier} feature="Release Mode">`.
- Find where link scheduling fields are rendered. Wrap in `<ProGate currentTier={planTier} feature="Link Scheduling">`.
- The component needs a `planTier` prop. Add it to the component's props interface and pass it from the parent.

**In `cards-tab.tsx`:**
- Find where card types are listed. Add `ProBadge` next to email_collection and release card types in the card type list/drawer.

**In `design-panel.tsx`:**
- This is where theme gating applies. For Pro-only themes, add a `ProBadge` indicator. This can be done by:
  1. Define a `PRO_THEMES` array in `src/lib/stripe/plans.ts` listing theme IDs that require Pro. Suggested Pro themes: `'lanyard-badge'`, `'departures-board'`, `'chaotic-zine'`, `'artifact'` (the most visually distinctive ones). Export this from plans.ts.
  2. In the ThemePresets component (imported by design-panel), show a Pro badge on Pro-only themes.
  3. Since ThemePresets is a separate component, you may need to read `src/components/editor/theme-presets.tsx` to understand where to add the badge. Add `ProBadge` next to the theme name/thumbnail for themes in `PRO_THEMES`.

For the `planTier` prop threading: the editor page needs to fetch the plan tier and pass it down. Read `src/app/(dashboard)/editor/page.tsx` to see how to thread it. If the editor uses stores/context, consider creating a lightweight `usePlanTier()` hook or adding it to an existing store. The simplest approach: fetch in the editor's server component and pass as a prop to the client editor shell, which passes to card-property-editor and design-panel.

NOTE: Be careful about prop drilling depth. If it's more than 2 levels deep, consider a small React context `PlanTierProvider` that wraps the editor and provides `planTier` via `usePlanTier()` hook. Create `src/contexts/plan-tier-context.tsx` if needed.
  </action>
  <verify>
- `ls src/components/billing/pro-gate.tsx` — component exists
- `grep "ProGate" src/components/editor/card-property-editor.tsx` — wraps email collection fields
- `grep "ProBadge" src/components/editor/cards-tab.tsx` — badge on Pro card types
- `grep "PRO_THEMES" src/lib/stripe/plans.ts` — Pro theme list defined
- `npx tsc --noEmit` — no type errors
  </verify>
  <done>
ProGate component renders Pro badge overlay without blocking interaction. ProBadge provides inline badge for lists. Editor card property fields for email collection, release mode, and link scheduling are wrapped in ProGate. Card type list shows ProBadge on Pro-only types. Pro-only themes identified and marked in theme presets.
  </done>
</task>

<task type="auto">
  <name>Task 2: Public page feature stripping and branding gating</name>
  <files>src/app/[username]/page.tsx, src/components/public/public-page-renderer.tsx, src/components/public/static-flow-grid.tsx, src/components/public/static-scatter-canvas.tsx, src/components/public/static-phone-home-layout.tsx, src/components/public/static-macintosh-layout.tsx, src/components/public/static-ipod-classic-layout.tsx, src/components/public/static-vcr-menu-layout.tsx, src/components/public/static-receipt-layout.tsx, src/components/public/static-word-art-layout.tsx, src/components/public/static-chaotic-zine-layout.tsx, src/components/public/static-artifact-layout.tsx</files>
  <action>
**Step 1: Add plan check to public page route.**

Read `src/app/[username]/page.tsx` (the dynamic route that serves public pages). In this server component, after fetching the page data, call `getUserPlan(page.user_id)` to get the page owner's plan tier. Pass `hasProAccess: isPro(planTier)` as a prop to `PublicPageRenderer`.

Import `getUserPlan`, `isPro` from `@/lib/stripe/subscription`.

**Step 2: Filter Pro-only cards from public page.**

In `src/app/[username]/page.tsx` (or wherever cards are fetched), filter out Pro-only card types for free users BEFORE passing to the renderer. Pro-only card types:
- `email_collection` — requires Pro
- Cards with `schedule_start` or `schedule_end` set (link scheduling) — strip the scheduling, show the card normally (scheduling just doesn't activate)
- `release` card type — requires Pro (release mode)

```typescript
const filteredCards = hasProAccess
  ? cards
  : cards.filter(card => {
      // Strip email collection and release cards for free users
      if (card.card_type === 'email_collection') return false
      if (card.card_type === 'release') return false
      return true
    }).map(card => ({
      ...card,
      // Strip scheduling metadata for free users
      schedule_start: null,
      schedule_end: null,
    }))
```

Pass `filteredCards` to PublicPageRenderer instead of raw cards.

**Step 3: Gate "Powered by LinkLobby" footer.**

Read `src/components/public/public-page-renderer.tsx`. The `LegalFooter` component includes "Powered by LinkLobby" text. Add a `hasProAccess` prop to `PublicPageRendererProps`.

Modify the footer rendering:
- The legal links (Privacy Policy, Terms of Service) should ALWAYS show (legal requirement)
- The "Powered by LinkLobby" text should only show when `!hasProAccess`
- Refactor: split "Powered by LinkLobby" out of LegalFooter or add conditional rendering inside it

Pass `hasProAccess` from the LegalFooter's parent. Update LegalFooter props to accept `hasProAccess: boolean`.

**IMPORTANT:** The "Powered by LinkLobby" footer exists in MULTIPLE layout files (static-macintosh-layout, static-ipod-classic-layout, etc. — 8 files total). Each of these needs the same change. The `hasProAccess` prop must be threaded through `PublicPageRenderer` to all layout components that render the footer.

For each layout file that contains "Powered by LinkLobby":
1. Add `hasProAccess?: boolean` to its props interface
2. Pass it from PublicPageRenderer
3. Conditionally render the "Powered by LinkLobby" text

Layout files to update:
- `static-flow-grid.tsx` (if it has the footer)
- `static-scatter-canvas.tsx` (if it has the footer)
- `static-vcr-menu-layout.tsx`
- `static-ipod-classic-layout.tsx`
- `static-receipt-layout.tsx`
- `static-macintosh-layout.tsx`
- `static-word-art-layout.tsx`
- `static-phone-home-layout.tsx`
- `static-chaotic-zine-layout.tsx`
- `static-artifact-layout.tsx`

Check each file — the footer may be rendered in different ways. Some may use the LegalFooter component from public-page-renderer, others may have inline footer markup.

**Step 4: Theme gating on publish.**

Theme gating is soft: free users can preview any theme but can't publish with a Pro-only theme. This doesn't need to block the save/publish API — instead, when a free user visits their public page with a Pro-only theme, the public page should fall back to a default free theme.

In `src/app/[username]/page.tsx`, after getting the plan tier and theme:
```typescript
import { PRO_THEMES } from '@/lib/stripe/plans'

// If free user is using a Pro-only theme, fall back to default
const effectiveThemeId = (!hasProAccess && PRO_THEMES.includes(themeId))
  ? 'instagram-reels'  // default free theme
  : themeId
```

Pass `effectiveThemeId` to the renderer instead of the raw `themeId`.
  </action>
  <verify>
- `grep "getUserPlan" src/app/\\[username\\]/page.tsx` — plan check on public page
- `grep "hasProAccess" src/components/public/public-page-renderer.tsx` — prop received
- `grep "email_collection" src/app/\\[username\\]/page.tsx` — card type filtered
- `grep "Powered by LinkLobby" src/components/public/public-page-renderer.tsx` — conditional rendering
- `grep "PRO_THEMES" src/app/\\[username\\]/page.tsx` — theme fallback
- `grep "hasProAccess" src/components/public/static-macintosh-layout.tsx` — prop threaded to layouts
- `npx tsc --noEmit` — no type errors
  </verify>
  <done>
Public page calls getUserPlan once and strips Pro features for free users. Email collection and release cards are filtered out. Link scheduling metadata is stripped. "Powered by LinkLobby" footer only appears for free users across all layout files. Pro-only themes fall back to instagram-reels on free users' public pages. Legal links always display regardless of plan.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. ProGate wraps email collection, release mode, and scheduling fields in editor
3. ProBadge appears on Pro-only card types and themes in editor
4. Public page for free user does not show email collection or release cards
5. Public page for free user shows "Powered by LinkLobby"
6. Public page for Pro user does NOT show "Powered by LinkLobby"
7. Free user with Pro theme gets fallback theme on public page
</verification>

<success_criteria>
- ProGate component shows badge overlay without blocking interaction
- All Pro features in editor have visible Pro badge for free users
- Public page strips Pro-only cards for free users
- Branding footer conditional on plan tier across all layout files
- Pro-only theme fallback on public page for free users
- All files type-check
</success_criteria>

<output>
After completion, create `.planning/phases/12.5-billing-subscriptions/12.5-03-SUMMARY.md`
</output>
