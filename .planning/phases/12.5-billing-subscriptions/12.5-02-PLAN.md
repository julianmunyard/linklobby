---
phase: 12.5-billing-subscriptions
plan: 02
type: execute
wave: 2
depends_on: ["12.5-01"]
files_modified:
  - src/app/pricing/page.tsx
  - src/app/pricing/layout.tsx
  - src/components/billing/pricing-table.tsx
  - src/components/billing/plan-badge.tsx
  - src/components/billing/upgrade-modal.tsx
  - src/components/dashboard/app-sidebar.tsx
  - src/components/dashboard/dashboard-header.tsx
  - src/app/(dashboard)/settings/page.tsx
autonomous: true

must_haves:
  truths:
    - "Visitors can view /pricing page with 3-tier comparison and monthly/annual toggle"
    - "Clicking 'Get Started' or 'Upgrade' on pricing page initiates Stripe Checkout flow"
    - "Plan badge appears in sidebar and editor header showing current tier"
    - "Clicking plan badge navigates to /pricing"
    - "Settings page shows current plan, billing period, and 'Manage Billing' button"
    - "Upgrade modal appears with tier comparison when triggered"
  artifacts:
    - path: "src/app/pricing/page.tsx"
      provides: "Public pricing page with 3-tier comparison"
      exports: ["default"]
    - path: "src/components/billing/pricing-table.tsx"
      provides: "Reusable feature comparison table with monthly/annual toggle"
      exports: ["PricingTable"]
    - path: "src/components/billing/plan-badge.tsx"
      provides: "Tier pill badge component"
      exports: ["PlanBadge"]
    - path: "src/components/billing/upgrade-modal.tsx"
      provides: "Modal with pricing table for contextual upgrade prompts"
      exports: ["UpgradeModal"]
  key_links:
    - from: "src/components/billing/pricing-table.tsx"
      to: "/api/billing/checkout"
      via: "fetch POST to create Checkout session on upgrade click"
      pattern: "fetch.*api/billing/checkout"
    - from: "src/components/billing/plan-badge.tsx"
      to: "/pricing"
      via: "Link component navigating to pricing page"
      pattern: "href.*pricing"
    - from: "src/app/(dashboard)/settings/page.tsx"
      to: "/api/billing/portal"
      via: "fetch POST to create Portal session on 'Manage Billing' click"
      pattern: "fetch.*api/billing/portal"
---

<objective>
Build all billing UI: public pricing page, plan badge for sidebar/header, upgrade modal, and billing section in settings.

Purpose: Users need a way to discover plans, upgrade, and manage their subscription. The pricing page is public (visible to logged-out visitors). The plan badge provides constant visibility of current tier with a one-click path to upgrade. Settings billing section provides minimal in-app management with Stripe Customer Portal for heavy lifting.
Output: /pricing page, PricingTable, PlanBadge, UpgradeModal components, billing section in settings, sidebar/header badge integration.
</objective>

<execution_context>
@/Users/julianmunyard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julianmunyard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12.5-billing-subscriptions/12.5-RESEARCH.md
@.planning/phases/12.5-billing-subscriptions/12.5-CONTEXT.md
@.planning/phases/12.5-billing-subscriptions/12.5-01-SUMMARY.md
@src/lib/stripe/plans.ts
@src/lib/stripe/subscription.ts
@src/components/dashboard/app-sidebar.tsx
@src/components/dashboard/dashboard-header.tsx
@src/app/(dashboard)/settings/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: PricingTable, PlanBadge, and UpgradeModal components</name>
  <files>src/components/billing/pricing-table.tsx, src/components/billing/plan-badge.tsx, src/components/billing/upgrade-modal.tsx</files>
  <action>
**Step 1: Create `src/components/billing/pricing-table.tsx`.**

A client component ('use client') that displays the 3-tier comparison table. Props:
- `currentTier?: PlanTier` — highlights current plan (optional, null for logged-out visitors)
- `onSelectPlan?: (priceId: string) => void` — callback when user clicks upgrade (if not provided, redirects to /pricing)

Features:
- Monthly/Annual toggle (use `useState<'monthly' | 'annual'>('monthly')`)
- 3 columns: Free, Pro ($12/mo or $9.58/mo billed annually), Artist ($20/mo or $16/mo billed annually)
- Show annual savings as badge ("Save 20%")
- Feature comparison rows from `PLANS` config — import from `@/lib/stripe/plans`
- Each feature row: checkmark or dash per tier
- CTA button per tier: "Current Plan" (disabled, muted) for current tier, "Get Started Free" for free, "Upgrade to Pro" / "Upgrade to Artist" for paid tiers
- When CTA clicked on paid tier: call `onSelectPlan` with the correct price ID (monthly or annual based on toggle)
- If no `onSelectPlan` provided and user clicks upgrade, call the checkout API directly:
  ```typescript
  const res = await fetch('/api/billing/checkout', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ priceId }),
  })
  if (res.status === 401) {
    // Logged-out visitor — redirect to login with return path
    window.location.href = '/login?next=/pricing'
    return
  }
  const { url, error } = await res.json()
  if (url) window.location.href = url
  ```
- **IMPORTANT:** The checkout API returns 401 for unauthenticated users. PricingTable MUST handle this explicitly by redirecting to `/login?next=/pricing` so the user can authenticate and return to complete their upgrade.
- Style with Tailwind: dark background, card-like columns, Pro column slightly elevated/highlighted as "Most Popular"
- Responsive: stack vertically on mobile

Feature rows to display (readable labels):
- All card types (free: check, pro: check, artist: check)
- Themes & templates (all: check)
- Basic analytics (all: check)
- Audio players (all: check)
- Scatter mode (all: check)
- Remove branding (free: dash, pro: check, artist: check)
- Email collection (free: dash, pro: check, artist: check)
- QR codes (free: dash, pro: check, artist: check)
- Facebook Pixel / GA (free: dash, pro: check, artist: check)
- Link scheduling (free: dash, pro: check, artist: check)
- Release mode (free: dash, pro: check, artist: check)
- Pro themes (free: dash, pro: check, artist: check)
- Custom domain (free: dash, pro: dash, artist: check) — "Coming soon" badge
- Geo analytics (free: dash, pro: dash, artist: check) — "Coming soon" badge
- Priority support (free: dash, pro: dash, artist: check)

Use lucide-react icons: `Check` for included, `Minus` for not included.

**Step 2: Create `src/components/billing/plan-badge.tsx`.**

Follow research Pattern: Plan Badge. A small pill that shows the current tier.

Props: `{ tier: PlanTier }`

- Render as a Next.js `Link` to `/pricing`
- Style: rounded-full pill with tier-specific colors:
  - free: `bg-muted text-muted-foreground`
  - pro: `bg-amber-500/20 text-amber-600 dark:text-amber-400`
  - artist: `bg-purple-500/20 text-purple-600 dark:text-purple-400`
- Text: "Free" / "Pro" / "Artist"
- Hover: opacity transition
- Size: text-xs, px-2 py-0.5

**Step 3: Create `src/components/billing/upgrade-modal.tsx`.**

A modal (Dialog from `@/components/ui/dialog`) that shows the pricing table in a modal context. Used for contextual upgrade prompts (e.g., when user clicks a Pro badge in the editor).

Props:
- `open: boolean`
- `onOpenChange: (open: boolean) => void`
- `currentTier: PlanTier`
- `feature?: string` — optional feature name that triggered the prompt (e.g., "Email Collection")

Content:
- DialogHeader: "Upgrade to unlock {feature}" (or "Upgrade your plan" if no feature)
- DialogDescription: "Get access to premium features with a 7-day free trial. No credit card required."
- Body: `<PricingTable currentTier={currentTier} />` — reuse the pricing table
- DialogFooter: "Not now" close button

Style: max-w-4xl for the dialog to fit the pricing table. On mobile, make it nearly full-screen.
  </action>
  <verify>
- `ls src/components/billing/pricing-table.tsx src/components/billing/plan-badge.tsx src/components/billing/upgrade-modal.tsx` — all exist
- `grep "PricingTable" src/components/billing/pricing-table.tsx` — component exported
- `grep "PlanBadge" src/components/billing/plan-badge.tsx` — component exported
- `grep "UpgradeModal" src/components/billing/upgrade-modal.tsx` — component exported
- `grep "/pricing" src/components/billing/plan-badge.tsx` — links to pricing page
- `grep "api/billing/checkout" src/components/billing/pricing-table.tsx` — checkout API call
- `grep "401\|login.*next" src/components/billing/pricing-table.tsx` — 401 handling redirects to login
- `npx tsc --noEmit` — no type errors
  </verify>
  <done>
PricingTable shows 3-tier comparison with monthly/annual toggle and checkout integration. PlanBadge renders a tier-colored pill linking to /pricing. UpgradeModal wraps PricingTable in a dialog for contextual upgrade prompts. All components type-check.
  </done>
</task>

<task type="auto">
  <name>Task 2: Public pricing page, billing settings section, sidebar and header badge integration</name>
  <files>src/app/pricing/page.tsx, src/app/pricing/layout.tsx, src/app/(dashboard)/settings/page.tsx, src/components/dashboard/app-sidebar.tsx, src/components/dashboard/dashboard-header.tsx</files>
  <action>
**Step 1: Create `src/app/pricing/layout.tsx`.**

Simple layout for the pricing page. This is a public page (no auth required). Use a minimal layout with a back-to-home link and the app name.

```tsx
export default function PricingLayout({ children }: { children: React.ReactNode }) {
  return (
    <div className="min-h-screen bg-background">
      <header className="border-b">
        <div className="container mx-auto flex h-14 items-center px-4">
          <Link href="/" className="text-lg font-bold">LinkLobby</Link>
        </div>
      </header>
      <main>{children}</main>
    </div>
  )
}
```

**Step 2: Create `src/app/pricing/page.tsx`.**

Server component that checks if user is logged in (optional auth — page works for logged-out visitors too).

- Try to get current user via Supabase server client. If logged in, call `getUserPlan(user.id)` to get current tier. If not logged in, pass `undefined` as currentTier.
- Render:
  - Hero section: "Simple, transparent pricing" heading, "Start free, upgrade when you're ready. 7-day free trial on all paid plans." subtext
  - `<PricingTable currentTier={currentTier} />`
  - FAQ section below (accordion or simple Q&A):
    - "What happens after the trial?" — "Your subscription continues if you've added a payment method. If not, you'll be downgraded to Free and your Pro features will be paused (not deleted)."
    - "Can I cancel anytime?" — "Yes. You keep access until the end of your billing period."
    - "What payment methods do you accept?" — "All major credit cards via Stripe."
    - "Do you take a cut of my sales?" — "Never. Zero transaction fees at any tier."
- SEO: export metadata with title "Pricing - LinkLobby", description about plans.

**Step 3: Update `src/app/(dashboard)/settings/page.tsx`.**

Add a "Plan & Billing" section to the settings page. Read the existing settings page first to understand its structure, then add a new section.

The billing section should show:
- Current plan tier with PlanBadge
- **Free users (no Stripe customer):** Show only "Upgrade Plan" link (links to /pricing). Do NOT render "Manage Billing" button — the portal API returns 404 for users who have never subscribed because no Stripe customer exists. Only show the portal button when the user has an active or canceled paid subscription (i.e., `tier !== 'free'`).
- If on a paid plan (active or canceled): "Your {Pro/Artist} plan renews on {date}" or "Your plan ends on {date}" if canceling. Show "Manage Billing" button that creates a Stripe Customer Portal session:
  ```typescript
  const res = await fetch('/api/billing/portal', { method: 'POST' })
  const { url } = await res.json()
  if (url) window.location.href = url
  ```
- If on trial: "Trial ends in X days" with a progress bar or text

Conditional logic in BillingSection component:
```tsx
{tier === 'free' ? (
  <Link href="/pricing" className="...">Upgrade Plan</Link>
) : (
  <>
    <p>Your {tierLabel} plan {cancelAtPeriodEnd ? 'ends' : 'renews'} on {formatDate(currentPeriodEnd)}</p>
    <Button onClick={handleManageBilling}>Manage Billing</Button>
  </>
)}
```

To get subscription data on the settings page, fetch it from the server component using `getUserPlan()` and also query the subscriptions table directly for period dates and trial info. Pass as props to a client component `BillingSection`.

Create a small client component `BillingSection` (can be inline in the settings file or in `src/components/billing/billing-section.tsx` — prefer inline if the settings page is simple enough):
- Props: `{ tier, status, currentPeriodEnd, trialEnd, cancelAtPeriodEnd }`
- Renders the billing info described above

**Step 4: Add PlanBadge to `src/components/dashboard/app-sidebar.tsx`.**

Read the current sidebar component. Add `PlanBadge` in the sidebar footer area. The sidebar needs to know the user's plan tier.

Since the sidebar is a client component but needs server data:
- Add a `planTier` prop to `AppSidebarProps`: `planTier?: PlanTier`
- Pass it from the dashboard layout (`src/app/(dashboard)/layout.tsx`) — call `getUserPlan(user.id)` in the layout's server component and pass to `<AppSidebar planTier={planTier} />`
- Render `<PlanBadge tier={planTier ?? 'free'} />` in the sidebar footer, next to or below the username/sign-out area

**Step 5: Add PlanBadge to `src/components/dashboard/dashboard-header.tsx`.**

Add the PlanBadge to the editor header. Since DashboardHeader is a client component:
- Add `planTier?: PlanTier` prop
- Render `<PlanBadge tier={planTier ?? 'free'} />` next to the save button or URL display
- Pass from the editor page or layout

Update `src/app/(dashboard)/layout.tsx` to pass `planTier` to the header section. The header is rendered inside the layout, so pass the plan tier through. Check how the header is currently rendered — it may be in individual pages rather than the layout. If so, update `src/app/(dashboard)/editor/page.tsx` to pass planTier to DashboardHeader.
  </action>
  <verify>
- `curl -s http://localhost:3000/pricing` (or check file exists) — pricing page renders
- `grep "PricingTable" src/app/pricing/page.tsx` — uses pricing table component
- `grep "PlanBadge" src/components/dashboard/app-sidebar.tsx` — badge in sidebar
- `grep "PlanBadge" src/components/dashboard/dashboard-header.tsx` — badge in header
- `grep "Manage Billing\|billing/portal" src/app/\\(dashboard\\)/settings/page.tsx` — portal integration
- `grep "tier.*free\|tier !== .free" src/app/\\(dashboard\\)/settings/page.tsx` — free user conditional hides portal button
- `grep "getUserPlan" src/app/\\(dashboard\\)/layout.tsx` — plan tier fetched in layout
- `npx tsc --noEmit` — no type errors
  </verify>
  <done>
Public /pricing page shows 3-tier comparison with checkout integration. Settings page has billing section with plan info and Manage Billing portal link. PlanBadge appears in sidebar footer and editor header, linking to /pricing. Plan tier is fetched server-side in dashboard layout and passed to client components.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. /pricing page is accessible without auth and shows 3 tiers
3. PlanBadge visible in sidebar and header
4. Settings billing section shows current plan and Manage Billing button
5. UpgradeModal can be opened programmatically with a feature name
6. Monthly/annual toggle changes displayed prices on pricing table
</verification>

<success_criteria>
- Public /pricing page with 3-tier comparison, monthly/annual toggle, FAQ
- PricingTable creates Stripe Checkout sessions on upgrade click
- PlanBadge in sidebar + header shows current tier and links to /pricing
- Settings page billing section with plan info and Customer Portal access
- UpgradeModal available for contextual upgrade prompts
- All components type-check
</success_criteria>

<output>
After completion, create `.planning/phases/12.5-billing-subscriptions/12.5-02-SUMMARY.md`
</output>
