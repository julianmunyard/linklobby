---
phase: 12.5-billing-subscriptions
plan: 01
subsystem: payments
tags: [stripe, supabase, webhooks, subscriptions, billing, rls, sql]

# Dependency graph
requires:
  - phase: supabase-auth
    provides: auth.users table referenced by billing tables; createClient server pattern
provides:
  - Stripe server singleton with pinned API version
  - 3-tier plan config (free/pro/artist) with feature flags
  - getUserPlan() reads active subscription from local DB
  - Admin Supabase client for service-role operations
  - POST /api/webhooks/stripe: signature-verified, idempotent, syncs to local DB
  - POST /api/billing/checkout: Stripe Checkout session with 7-day no-card trial
  - POST /api/billing/portal: Stripe Customer Portal session
  - DB migration: customers, subscriptions, webhook_events tables with RLS
affects:
  - 12.5-02: Pricing page UI calls /api/billing/checkout
  - 12.5-03: Feature gating uses getUserPlan() from subscription.ts
  - 12.5-04: Settings billing tab calls /api/billing/portal
  - 12.7: Transactional emails for trial_will_end event

# Tech tracking
tech-stack:
  added: [stripe@20.3.1, @stripe/stripe-js]
  patterns:
    - Stripe webhook raw body verification (request.text() not .json())
    - Idempotent webhook processing via webhook_events dedup table
    - Local subscription state sync from Stripe via webhooks (never trust Stripe for real-time gating)
    - Admin Supabase client (service_role) for webhook/server contexts that bypass RLS

key-files:
  created:
    - src/lib/stripe/client.ts
    - src/lib/stripe/plans.ts
    - src/lib/stripe/subscription.ts
    - src/lib/supabase/admin.ts
    - src/app/api/webhooks/stripe/route.ts
    - src/app/api/billing/checkout/route.ts
    - src/app/api/billing/portal/route.ts
    - supabase/migrations/20260225_billing_tables.sql
  modified: []

key-decisions:
  - "Stripe SDK v20 (API 2026-01-28.clover) installed - current_period_start/end moved from Subscription to SubscriptionItem; invoice.subscription moved to invoice.parent.subscription_details.subscription"
  - "7-day no-card trial with payment_method_collection: if_required and trial_settings.end_behavior: cancel"
  - "Admin Supabase client used in webhook and checkout/portal routes because customers table has no user-facing SELECT RLS policy"
  - "webhook_events table for idempotency - record before processing to prevent duplicate execution"
  - "getUserPlan uses anon/user server client with RLS for subscription reads (subscriptions table has SELECT policy)"

patterns-established:
  - "Billing reads: always from local subscriptions table via getUserPlan(), never real-time Stripe API calls"
  - "Billing writes: only from webhook handler via createAdminClient(), never direct from user routes"
  - "Checkout session metadata: always pass user_id in both session.metadata and subscription_data.metadata"

# Metrics
duration: 4min
completed: 2026-02-25
---

# Phase 12.5 Plan 01: Stripe Billing Backend Summary

**Stripe singleton, 3-tier plan config with feature flags, idempotent webhook pipeline syncing subscription state to local Supabase tables, Checkout and Customer Portal session routes**

## Performance

- **Duration:** ~4 min
- **Started:** 2026-02-25T02:27:09Z
- **Completed:** 2026-02-25T02:31:53Z
- **Tasks:** 2/2
- **Files modified:** 8 created

## Accomplishments

- Installed stripe@20.3.1 and created singleton server client with pinned API version
- Built complete plan tier system (free/pro/artist) with feature flags and price ID mapping
- Created webhook handler with signature verification, idempotency, and subscription sync adapted for Stripe SDK v20 API changes
- Created Checkout route with 7-day no-card trial and Customer Portal route
- Written DB migration for customers, subscriptions, and webhook_events tables with proper RLS

## Task Commits

Each task was committed atomically:

1. **Task 1: Stripe client, plan definitions, subscription helper, admin client** - `508e367` (feat)
2. **Task 2: Database migration and API routes (webhook, checkout, portal)** - `7333279` (feat)

**Plan metadata:** (docs commit to follow)

## Files Created/Modified

- `src/lib/stripe/client.ts` - Singleton Stripe server client (API v2026-01-28.clover)
- `src/lib/stripe/plans.ts` - PLANS config with PlanTier, PlanFeatures, getPlanTierByPriceId()
- `src/lib/stripe/subscription.ts` - getUserPlan(), isPro(), isArtist() reading from subscriptions table
- `src/lib/supabase/admin.ts` - Service role client for webhook/server-only contexts
- `src/app/api/webhooks/stripe/route.ts` - Webhook handler with signature verification, idempotency, syncSubscription
- `src/app/api/billing/checkout/route.ts` - Stripe Checkout session with 7-day no-card trial
- `src/app/api/billing/portal/route.ts` - Customer Portal session creation
- `supabase/migrations/20260225_billing_tables.sql` - customers, subscriptions, webhook_events tables with RLS

## Decisions Made

- **Stripe SDK v20 API adaptation:** Stripe SDK v20 (API 2026-01-28.clover) changed the Subscription object — `current_period_start`/`current_period_end` moved from Subscription to SubscriptionItem. Invoice subscription reference moved to `invoice.parent.subscription_details.subscription`. Both adapted in webhook handler.
- **Plan API version mismatch:** Plan specified `2025-03-31.basil` but installed SDK v20 uses `2026-01-28.clover` — updated to match installed version.
- **Idempotency strategy:** Insert into webhook_events before processing (not after) to prevent duplicate processing if the handler throws mid-way.
- **Admin client for customers lookup:** customers table intentionally has no user SELECT RLS policy (Stripe IDs should not be exposed to clients), so checkout and portal routes use admin client for that lookup.

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Stripe API version updated from plan-specified 2025-03-31.basil to installed SDK version 2026-01-28.clover**
- **Found during:** Task 1 (TypeScript type check)
- **Issue:** Plan specified `2025-03-31.basil` but installed stripe@20.3.1 uses `2026-01-28.clover` — TypeScript type error TS2322
- **Fix:** Updated apiVersion in src/lib/stripe/client.ts to match installed SDK
- **Files modified:** src/lib/stripe/client.ts
- **Verification:** `npx tsc --noEmit` passes
- **Committed in:** 508e367 (Task 1 commit)

**2. [Rule 1 - Bug] Stripe SDK v20 type changes in webhook handler**
- **Found during:** Task 2 (TypeScript type check)
- **Issue:** Stripe SDK v20 removed `current_period_start/end` from Subscription (moved to SubscriptionItem). Also removed `invoice.subscription` (now `invoice.parent.subscription_details.subscription`). Also `Parameters<typeof stripe.checkout.sessions.create>[0]` didn't resolve correctly.
- **Fix:** Updated webhook handler to read periods from `sub.items.data[0].current_period_start/end`. Updated invoice handling to use `invoice.parent.subscription_details.subscription`. Used `Stripe.Checkout.SessionCreateParams` type directly in checkout route.
- **Files modified:** src/app/api/webhooks/stripe/route.ts, src/app/api/billing/checkout/route.ts
- **Verification:** `npx tsc --noEmit` passes
- **Committed in:** 7333279 (Task 2 commit)

---

**Total deviations:** 2 auto-fixed (2 Rule 1 - Bug)
**Impact on plan:** Both fixes required for TypeScript correctness with the actual installed Stripe SDK version. No scope creep.

## Issues Encountered

Stripe SDK v20 has a newer API version (2026-01-28.clover) than the plan assumed (2025-03-31.basil), and the object shapes changed significantly. The webhook handler and checkout type annotations were adapted accordingly. All changes are in the same files specified by the plan.

## User Setup Required

**External services require manual configuration before billing works:**

### Environment Variables Required

```
STRIPE_SECRET_KEY=sk_live_...        # Stripe Dashboard -> Developers -> API keys
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_live_...
STRIPE_WEBHOOK_SECRET=whsec_...      # Stripe Dashboard -> Developers -> Webhooks -> Signing secret
STRIPE_PRO_MONTHLY_PRICE_ID=price_...   # Stripe Dashboard -> Products
STRIPE_PRO_ANNUAL_PRICE_ID=price_...
STRIPE_ARTIST_MONTHLY_PRICE_ID=price_...
STRIPE_ARTIST_ANNUAL_PRICE_ID=price_...
SUPABASE_SERVICE_ROLE_KEY=...        # Supabase Dashboard -> Settings -> API -> service_role
```

### Stripe Dashboard Setup

1. Create 4 products: Pro Monthly ($12/mo), Pro Annual ($115/yr), Artist Monthly ($20/mo), Artist Annual ($192/yr)
2. Create webhook endpoint pointing to `https://your-domain.com/api/webhooks/stripe` with events: `checkout.session.completed`, `customer.subscription.created`, `customer.subscription.updated`, `customer.subscription.deleted`, `invoice.paid`, `invoice.payment_failed`, `customer.subscription.trial_will_end`
3. For local dev: run `stripe listen --forward-to localhost:3000/api/webhooks/stripe`

### Database Migration

Run migration in Supabase:
```
supabase db push
```
or apply `supabase/migrations/20260225_billing_tables.sql` via Supabase Dashboard SQL editor.

## Next Phase Readiness

- Billing backend fully operational — webhook pipeline, local DB sync, and session routes ready
- Plan 02 (Pricing Page UI) can wire to `/api/billing/checkout`
- Plan 03 (Feature Gating) can import `getUserPlan` and `PLANS` from `src/lib/stripe/`
- Plan 04 (Settings Billing Tab) can call `/api/billing/portal`
- Requires Stripe account and env vars configured before end-to-end testing

---
*Phase: 12.5-billing-subscriptions*
*Completed: 2026-02-25*
