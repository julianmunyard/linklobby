---
phase: 12.2-theme-templates
plan: 03
subsystem: api
tags: [supabase, storage, templates, cards, fractional-indexing, nodejs]

# Dependency graph
requires:
  - phase: 12.2-01
    provides: TemplateDefinition type system and getTemplate() registry lookup
provides:
  - POST /api/templates/apply endpoint that uploads media assets and creates cards from a template
affects: [12.2-04-template-picker-ui, future template additions]

# Tech tracking
tech-stack:
  added: [fs (Node.js built-in for disk reads)]
  patterns:
    - "Template media uploads follow card-images / card-audio bucket routing by extension"
    - "User-scoped storage paths: {userId}/{uuid}.{ext} for template asset uploads"
    - "Three content path-replacement shapes: Shape A (imageUrl), Shape B (tracks[]), Shape C (images[])"
    - "fetchUserPage() + getUser() dual-call for auth (pageId + userId)"

key-files:
  created:
    - src/app/api/templates/apply/route.ts
  modified: []

key-decisions:
  - "Single file write covers both Task 1 and Task 2 — they are logically one route with no natural split point"
  - "fetchUserPage() used for page auth (returns pageId), then getUser() for userId needed for storage paths"
  - "Non-fatal asset uploads: missing/failed uploads skip with console.warn, not a 500 error"
  - "POSITION_REVERSE used to map DB position_x back to HorizontalPosition string in response"

patterns-established:
  - "Template apply: Node.js runtime for fs.readFileSync, identical structure to audio upload route"
  - "urlMap[filename] lookup with .split('/').pop() to extract filename from /templates/ paths"

# Metrics
duration: 2min
completed: 2026-02-19
---

# Phase 12.2 Plan 03: Template Apply API Route Summary

**POST /api/templates/apply that uploads template media to user Supabase storage, replaces all 3 content path shapes, and batch-inserts cards with replace/add mode support**

## Performance

- **Duration:** ~2 min
- **Started:** 2026-02-19T11:54:08Z
- **Completed:** 2026-02-19T11:55:36Z
- **Tasks:** 2 (both implemented in single file write)
- **Files modified:** 1 created

## Accomplishments
- Node.js runtime API route at `/api/templates/apply` that reads template assets from disk and uploads to user-scoped Supabase storage
- All 3 content path-replacement shapes implemented: `imageUrl` (hero/square/horizontal), `tracks[]` (audio), `images[]` (gallery)
- Both `replace` mode (delete existing cards first) and `add` mode (sort keys after last existing card) supported
- Response returns `{ cards, theme, profile, templateName }` for client-side store hydration

## Task Commits

Each task was committed atomically:

1. **Tasks 1+2: Auth, template lookup, asset upload, card building, and response** - `3a47e86` (feat)

**Plan metadata:** (committed with SUMMARY.md and STATE.md update)

## Files Created/Modified
- `src/app/api/templates/apply/route.ts` - Complete POST endpoint: auth, template lookup, media upload, 3-shape path replacement, batch insert, response

## Decisions Made
- Tasks 1 and 2 were implemented together in a single write since the route is a single cohesive function — splitting commits artificially would not add clarity
- `fetchUserPage()` provides `pageId` for the cards table, but `getUser()` is also called separately to get `userId` needed for scoping storage upload paths to the user
- Non-fatal asset upload: if an asset file is missing from `public/templates/{id}/` or upload fails, the card is still inserted with the original `/templates/` path rather than blocking the whole apply operation
- `POSITION_REVERSE` map (from `src/types/card.ts`) used to convert `position_x` integer back to `HorizontalPosition` string when mapping DB rows to Card type

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered
None - `npx tsc --noEmit` and `npm run build` both passed on first attempt.

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- Template apply API is complete and ready for Plan 04 (Template Picker UI)
- The `/api/templates/apply` endpoint accepts `{ templateId, mode }` and returns `{ cards, theme, profile, templateName }`
- Client-side code in Plan 04 should POST to this endpoint, then hydrate the theme store and card store from the response

---
*Phase: 12.2-theme-templates*
*Completed: 2026-02-19*
