---
phase: 12.2-theme-templates
plan: 04
type: execute
wave: 3
depends_on: ["12.2-01", "12.2-03"]
files_modified:
  - src/components/editor/template-picker.tsx
  - src/components/editor/theme-panel.tsx
autonomous: false

must_haves:
  truths:
    - "User can see a Templates tab in the Theme panel"
    - "Templates tab shows templates filtered by the active theme"
    - "User can preview template details before applying"
    - "Clicking Use Template triggers apply with loading state"
    - "Confirmation dialog appears when user has existing cards"
    - "After apply, stores are hydrated with template data and toast confirms"
    - "Applied template theme and profile persist across page reload"
    - "Template picker works in mobile bottom sheet"
  artifacts:
    - path: "src/components/editor/template-picker.tsx"
      provides: "Template picker grid, preview, and apply flow"
      exports: ["TemplatePicker"]
    - path: "src/components/editor/theme-panel.tsx"
      provides: "Theme panel with Templates tab added"
      contains: "TemplatePicker"
  key_links:
    - from: "src/components/editor/template-picker.tsx"
      to: "src/lib/templates/index.ts"
      via: "getTemplatesByTheme(themeId)"
      pattern: "getTemplatesByTheme"
    - from: "src/components/editor/template-picker.tsx"
      to: "/api/templates/apply"
      via: "fetch POST on Use Template click"
      pattern: "fetch.*api/templates/apply"
    - from: "src/components/editor/template-picker.tsx"
      to: "src/stores/theme-store.ts"
      via: "loadFromDatabase then set hasChanges:true"
      pattern: "loadFromDatabase"
    - from: "src/components/editor/template-picker.tsx"
      to: "src/stores/page-store.ts"
      via: "setCards after apply"
      pattern: "setCards"
    - from: "src/components/editor/theme-panel.tsx"
      to: "src/components/editor/template-picker.tsx"
      via: "TemplatePicker in Templates tab"
      pattern: "TemplatePicker"
---

<objective>
Build the user-facing template picker UI and integrate it into the theme panel.

Purpose: This is the user-facing feature — the template grid, preview, confirmation dialog, and apply flow that lets users pick a curated template and instantly get a designed page.
Output: Templates tab in ThemePanel with template grid, preview, confirmation, and apply logic.
</objective>

<execution_context>
@/Users/julianmunyard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julianmunyard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12.2-theme-templates/12.2-RESEARCH.md
@.planning/phases/12.2-theme-templates/12.2-01-SUMMARY.md
@.planning/phases/12.2-theme-templates/12.2-03-SUMMARY.md
@src/components/editor/theme-panel.tsx
@src/components/editor/theme-presets.tsx
@src/stores/theme-store.ts
@src/stores/page-store.ts
@src/stores/profile-store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TemplatePicker component</name>
  <files>src/components/editor/template-picker.tsx</files>
  <action>
Create `src/components/editor/template-picker.tsx` — a client component that handles the full template selection and application flow.

**Template Grid:**
- Read active themeId from `useThemeStore(state => state.themeId)`
- Call `getTemplatesByTheme(themeId)` to get templates for the current theme
- Render a grid of template cards (2 columns on desktop, 1 on mobile)
- Each card shows: thumbnail image (using Next.js Image component with width/height for optimization), template name, energy label badge, short description
- If no templates exist for this theme, show empty state: "No templates available for this theme yet"
- Use `motion/react` for subtle hover animations (same pattern as theme-presets.tsx)

**Template Selection & Preview:**
- Clicking a template card sets it as "selected" in local state
- Selected template shows expanded details below the grid (or as an overlay):
  - Larger thumbnail
  - Full description
  - List of cards included (e.g., "5 cards: Hero, 2 Links, Music, Social Icons")
  - "Use Template" button (primary variant, full width)
  - "Cancel" text button to deselect

**Confirmation Dialog (only if user has existing cards):**
- Before applying, check `usePageStore.getState().cards.length`
- If cards exist, show Radix AlertDialog with:
  - Title: "Apply Template?"
  - Description: "You have {N} existing cards. What would you like to do?"
  - Two action buttons:
    - "Replace my page" — calls apply with mode 'replace' (deletes existing cards)
    - "Add to my page" — calls apply with mode 'add' (appends template cards)
  - Cancel button to dismiss
- If NO cards exist, skip dialog and apply immediately with mode 'replace'

**Apply Flow:**
1. Set loading state (disable button, show spinner)
2. POST to `/api/templates/apply` with `{ templateId, mode }`
3. On success response:
   - Call `usePageStore.getState().setCards(response.cards)` to load cards (map DB rows to Card type if needed)
   - Call `useThemeStore.getState().loadFromDatabase(response.theme)` to hydrate theme state
   - Call `useProfileStore.getState().initializeProfile(response.profile)` to set profile defaults

   **CRITICAL — Trigger autosave persistence:**
   After calling `loadFromDatabase` and `initializeProfile`, both stores will have `hasChanges: false` (those methods are designed for DB-loaded data). But the template IS a new change that must be persisted on next autosave. You MUST explicitly mark both stores as changed AFTER hydration:

   ```typescript
   // Hydrate stores with template data
   useThemeStore.getState().loadFromDatabase(response.theme)
   useProfileStore.getState().initializeProfile(response.profile)

   // Mark as changed so autosave picks them up — loadFromDatabase and
   // initializeProfile both set hasChanges:false, but applying a template
   // IS a change that needs to persist to the database.
   useThemeStore.setState({ hasChanges: true })
   useProfileStore.setState({ hasChanges: true })
   ```

   - Show success toast: `toast.success('Template "{name}" applied!')`
   - Clear selected template state
4. On error: Show error toast: `toast.error('Failed to apply template. Please try again.')`
5. Clear loading state

**Mobile considerations:**
- The component renders inside ThemePanel which is already inside the mobile bottom sheet (Vaul drawer). No special mobile layout needed — the grid naturally stacks to 1 column via responsive classes.
- Ensure touch targets are at least 44px (h-11) for template cards.

**Imports:** Use AlertDialog from `@/components/ui/alert-dialog`, Button from `@/components/ui/button`, Image from `next/image`, toast from `sonner`, motion from `motion/react`.
  </action>
  <verify>Run `npx tsc --noEmit` — no type errors. Component handles all states: loading, empty, grid, selected, confirming, applying. Verify that `hasChanges: true` is set on both themeStore and profileStore after apply.</verify>
  <done>TemplatePicker component renders template grid filtered by active theme, shows preview on selection, confirmation dialog when existing cards present, and applies template with loading state and toast feedback. Theme and profile stores explicitly marked hasChanges:true after hydration so autosave persists the template.</done>
</task>

<task type="auto">
  <name>Task 2: Add Templates tab to ThemePanel</name>
  <files>src/components/editor/theme-panel.tsx</files>
  <action>
Modify `src/components/editor/theme-panel.tsx` to add a Templates tab.

1. Import TemplatePicker: `import { TemplatePicker } from './template-picker'`

2. Update the TabsList from `grid-cols-4` to `grid-cols-5` to accommodate the new tab.

3. Add a new TabsTrigger after "Style": `<TabsTrigger value="templates" className="text-xs">Templates</TabsTrigger>`

4. Add the corresponding TabsContent:
   ```tsx
   <TabsContent value="templates" className="mt-3">
     <TemplatePicker />
   </TabsContent>
   ```

Keep the existing tab order: Presets | Colors | Fonts | Style | Templates. Templates is last because it's a higher-level action (applying a full template) vs the granular controls in the other tabs.
  </action>
  <verify>Run `npm run build` — build succeeds. Theme panel shows 5 tabs. Templates tab renders the TemplatePicker component. All existing tabs still work.</verify>
  <done>ThemePanel has 5 tabs: Presets, Colors, Fonts, Style, Templates. Templates tab renders TemplatePicker filtered by active theme.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Template picker UI integrated into editor theme panel. Selecting a theme then clicking Templates tab shows available templates for that theme. Clicking a template shows preview with Use Template button. Apply creates cards and sets theme.</what-built>
  <how-to-verify>
    1. Open editor in browser
    2. Click on Theme section in the design panel
    3. Verify 5 tabs visible: Presets, Colors, Fonts, Style, Templates
    4. Click Templates tab
    5. For instagram-reels theme: verify one template card appears (Dark Minimal) with a visible thumbnail image (not broken)
    6. Click the template card — verify expanded preview shows card count and description
    7. Click "Use Template" — if you have existing cards, verify confirmation dialog appears with Replace/Add options
    8. Choose "Replace my page" — verify cards are created, theme is applied, toast confirms
    9. **Persistence test:** Reload the page. Verify the template's theme and cards are still there (not reverted). This confirms the hasChanges:true fix is working.
    10. Test on mobile viewport — verify template picker works in bottom sheet
    11. Switch to a theme with no templates (e.g., mac-os) — verify "No templates available" empty state
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
- `npm run build` passes
- Templates tab visible in ThemePanel
- Template grid shows templates for active theme only
- Confirmation dialog appears when user has existing cards
- Template apply creates cards, sets theme, uploads assets
- Applied template persists across page reload (hasChanges:true triggers autosave)
- Mobile layout works in bottom sheet
- Empty state shown for themes without templates
</verification>

<success_criteria>
- User can see and browse templates per theme
- User can preview template details before applying
- Apply flow handles both replace and add modes
- Confirmation protects users with existing cards
- Applied theme and profile persist across reload (autosave triggered)
- Loading states and error handling provide good UX
- Works on mobile in the existing bottom sheet
</success_criteria>

<output>
After completion, create `.planning/phases/12.2-theme-templates/12.2-04-SUMMARY.md`
</output>
