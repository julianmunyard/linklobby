---
phase: 12.2-theme-templates
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/editor/dev-template-saver.tsx
  - src/components/editor/editor-header.tsx
autonomous: true

must_haves:
  truths:
    - "Dev can click a button to snapshot current page state as template JSON"
    - "Button only appears when NEXT_PUBLIC_DEV_TOOLS=true"
    - "Snapshot captures cards, theme, and profile state correctly"
    - "Output is copied to clipboard as formatted JSON"
  artifacts:
    - path: "src/components/editor/dev-template-saver.tsx"
      provides: "Dev-only template snapshot button component"
      exports: ["DevTemplateSaver"]
    - path: "src/components/editor/editor-header.tsx"
      provides: "Editor header with dev tool button integrated"
      contains: "DevTemplateSaver"
  key_links:
    - from: "src/components/editor/dev-template-saver.tsx"
      to: "src/stores/theme-store.ts"
      via: "useThemeStore.getState().getSnapshot()"
      pattern: "getSnapshot()"
    - from: "src/components/editor/dev-template-saver.tsx"
      to: "src/stores/page-store.ts"
      via: "usePageStore.getState().getSnapshot()"
      pattern: "getSnapshot()"
    - from: "src/components/editor/dev-template-saver.tsx"
      to: "src/stores/profile-store.ts"
      via: "useProfileStore.getState().getSnapshot()"
      pattern: "getSnapshot()"
---

<objective>
Build the dev-only "Save as Template" tool that snapshots the current editor state.

Purpose: Enables the developer to design pages in the live editor and capture them as template definitions. This is the content creation pipeline — without it, templates must be hand-written.
Output: A dev-gated button in the editor header that copies template JSON to clipboard.
</objective>

<execution_context>
@/Users/julianmunyard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julianmunyard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12.2-theme-templates/12.2-RESEARCH.md
@src/stores/theme-store.ts
@src/stores/page-store.ts
@src/stores/profile-store.ts
@src/components/editor/editor-header.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DevTemplateSaver component</name>
  <files>src/components/editor/dev-template-saver.tsx</files>
  <action>
Create `src/components/editor/dev-template-saver.tsx` — a client component with a single button that:

1. **Environment gate:** Return `null` if `process.env.NEXT_PUBLIC_DEV_TOOLS !== 'true'`. This ensures the component renders nothing in production.

2. **On click handler:**
   - Call `useThemeStore.getState().getSnapshot()` to get clean ThemeState — this is the AUTHORITATIVE theme source
   - Call `usePageStore.getState().getSnapshot()` to get `{ cards }` — use ONLY the `cards` field from this snapshot
   - Call `useProfileStore.getState().getSnapshot()` to get Profile

3. **Build template object:**
   ```typescript
   const themeSnapshot = useThemeStore.getState().getSnapshot()
   const pageSnapshot = usePageStore.getState().getSnapshot()
   const profileSnapshot = useProfileStore.getState().getSnapshot()

   const template = {
     id: `TEMPLATE-${Date.now()}`,
     themeId: themeSnapshot.themeId,
     name: 'FILL IN NAME',
     description: 'FILL IN DESCRIPTION',
     energyLabel: 'FILL IN',
     thumbnailPath: '/templates/FILL-IN/thumbnail.jpg',
     // IMPORTANT: Use pageSnapshot.cards for cards, but use themeSnapshot for
     // the theme field. Do NOT use pageSnapshot.theme — it may be stale.
     cards: pageSnapshot.cards.map(card => {
       // Strip DB-specific fields: id, page_id, created_at, updated_at
       const { id, page_id, created_at, updated_at, ...templateCard } = card
       return templateCard
     }),
     theme: themeSnapshot,  // From useThemeStore, NOT pageSnapshot.theme
     profile: {
       profileLayout: profileSnapshot.profileLayout,
       showAvatar: profileSnapshot.showAvatar,
       showTitle: profileSnapshot.showTitle,
       titleSize: profileSnapshot.titleSize,
       showSocialIcons: profileSnapshot.showSocialIcons,
       showLogo: profileSnapshot.showLogo,
       headerTextColor: profileSnapshot.headerTextColor,
       socialIconColor: profileSnapshot.socialIconColor,
     },
     mediaAssets: [],  // Dev manually populates after downloading assets
   }
   ```

   **CRITICAL:** The `theme` field in the template object MUST come from `useThemeStore.getState().getSnapshot()`, NOT from `pageSnapshot.theme`. The page store's theme can be stale (it reflects the last-saved DB state), while the theme store always has the live editor state. Add a code comment making this explicit.

4. **Output:** Copy formatted JSON to clipboard via `navigator.clipboard.writeText(JSON.stringify(template, null, 2))`. Also `console.log` the full output. Show success toast via sonner: `toast.success('Template snapshot copied to clipboard')`.

5. **UI:** Small button with a camera/save icon (use `Camera` or `Save` from lucide-react). Style: `variant="outline" size="sm"` with text "Save Template". Use a subtle dev-tool appearance — maybe a dashed border or a small "DEV" badge.

Do NOT import from `src/lib/templates/types.ts` — the dev tool outputs raw JSON that the dev will paste into a template file manually. The TemplateDefinition type is the target format, but the snapshot doesn't need to import it.
  </action>
  <verify>Component renders nothing when NEXT_PUBLIC_DEV_TOOLS is not set. With the env var set to 'true', the button appears and clicking it copies JSON to clipboard.</verify>
  <done>DevTemplateSaver component exported. Returns null in production. Clicking the button captures all three store snapshots and copies formatted template JSON to clipboard with toast confirmation. Theme field sourced from useThemeStore (not pageSnapshot.theme).</done>
</task>

<task type="auto">
  <name>Task 2: Integrate DevTemplateSaver into editor header</name>
  <files>src/components/editor/editor-header.tsx</files>
  <action>
Read `src/components/editor/editor-header.tsx` and add the DevTemplateSaver component.

1. Import DevTemplateSaver: `import { DevTemplateSaver } from './dev-template-saver'`
2. Place `<DevTemplateSaver />` in the header bar, near existing action buttons (undo/redo area or right side of header). Position it so it's visible but not intrusive.
3. Since the component self-gates on NEXT_PUBLIC_DEV_TOOLS, no additional conditional rendering is needed in the header.

Keep changes minimal — just the import and the component placement. Do not restructure the existing header layout.
  </action>
  <verify>Build passes (`npm run build`). Dev tool button appears in editor header when NEXT_PUBLIC_DEV_TOOLS=true in .env.local. Button does not appear without the env var.</verify>
  <done>DevTemplateSaver rendered in editor header. Invisible in production, visible with dev tools enabled.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- Component renders nothing without NEXT_PUBLIC_DEV_TOOLS=true
- With env var, button appears and clicking copies JSON to clipboard
- JSON output contains cards (without id/page_id/timestamps), theme snapshot from useThemeStore (NOT pageSnapshot.theme), and profile defaults
</verification>

<success_criteria>
- Dev-only button gated behind NEXT_PUBLIC_DEV_TOOLS env flag
- Captures all three store states (page cards, theme from themeStore, profile) via existing getSnapshot() methods
- Theme field explicitly sourced from useThemeStore.getState().getSnapshot(), never from pageStore
- Copies formatted JSON to clipboard with toast feedback
- Zero impact on production builds
</success_criteria>

<output>
After completion, create `.planning/phases/12.2-theme-templates/12.2-02-SUMMARY.md`
</output>
