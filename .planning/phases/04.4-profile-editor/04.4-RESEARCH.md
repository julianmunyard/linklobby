# Phase 4.4: Profile Editor - Research

**Researched:** 2026-01-26
**Domain:** Image cropping, profile forms, drag-reorder social icons
**Confidence:** HIGH

## Summary

This phase implements the profile editor section within the Design tab, enabling artists to customize their page header (profile photo, title, social icons). The core technical challenge is a universal image crop component that handles multiple aspect ratios with preset buttons (FREE/RECTANGLE/SQUARE/RESET) as specified in CONTEXT.md.

Research focused on three areas: (1) image cropping library selection where react-easy-crop emerges as the clear choice for its simplicity, 125k+ weekly downloads, and touch support; (2) integration with existing dnd-kit patterns for social icon reordering; and (3) extending the Zustand store to handle profile state alongside existing card state.

The existing codebase provides strong foundations: Supabase Storage upload patterns in `storage.ts`, dnd-kit sortable patterns in `sortable-card-list.tsx`, and form patterns in `card-property-editor.tsx`. The profile editor will follow these established patterns.

**Primary recommendation:** Use react-easy-crop v5.5.x with a custom getCroppedImg utility that outputs Blob for Supabase upload. Store profile state in a new profile store separate from page-store to maintain separation of concerns.

## Standard Stack

The established libraries/tools for this domain:

### Core
| Library | Version | Purpose | Why Standard |
|---------|---------|---------|--------------|
| react-easy-crop | ^5.5.6 | Image cropping with zoom/pan | 125k+ weekly downloads, lightweight, excellent touch support, simple API |
| @dnd-kit/sortable | ^10.0.0 | Drag-reorder social icons | Already in project, established patterns |
| react-hook-form | ^7.71.1 | Profile form state | Already in project, optimistic update patterns |
| zod | ^4.3.6 | Schema validation | Already in project |
| zustand | ^5.0.10 | Profile state management | Already in project |

### Supporting
| Library | Version | Purpose | When to Use |
|---------|---------|---------|-------------|
| lucide-react | ^0.562.0 | Social platform icons | Instagram, Twitter/X, YouTube, Spotify, TikTok icons |
| @radix-ui/react-dialog | ^1.1.15 | Crop modal | Already in project as shadcn/ui dialog |
| @radix-ui/react-switch | ^1.2.6 | Toggle social icons on/off | Already in project |

### Alternatives Considered
| Instead of | Could Use | Tradeoff |
|------------|-----------|----------|
| react-easy-crop | react-image-crop | react-image-crop is more minimal but lacks built-in zoom/pan; react-easy-crop handles aspect ratios more elegantly |
| react-easy-crop | react-advanced-cropper | More customizable but heavier and more complex; overkill for this use case |
| Client-side crop | Supabase transforms | Supabase transforms require Pro plan; client-side is free tier compatible |

**Installation:**
```bash
npm install react-easy-crop
```

**CSS Import Required:**
```typescript
// In the crop component or global CSS
import 'react-easy-crop/react-easy-crop.css'
```

## Architecture Patterns

### Recommended Project Structure
```
src/
├── stores/
│   ├── page-store.ts         # Existing - cards, theme
│   └── profile-store.ts      # NEW - profile header state
├── components/
│   ├── editor/
│   │   ├── design-tab.tsx           # NEW - replaces empty state
│   │   ├── header-section.tsx       # NEW - profile editor section
│   │   ├── social-icons-editor.tsx  # NEW - social icons list
│   │   └── social-icon-picker.tsx   # NEW - platform selection popup
│   └── shared/
│       ├── image-crop-dialog.tsx    # NEW - universal crop component
│       └── crop-utils.ts            # NEW - getCroppedImg utility
├── types/
│   ├── profile.ts            # NEW - profile types
│   └── social.ts             # NEW - social icon types
└── lib/
    └── supabase/
        └── storage.ts        # EXTEND - add profile image upload
```

### Pattern 1: Universal Crop Component
**What:** A reusable image crop dialog that supports multiple aspect ratio presets
**When to use:** Profile photo, profile logo, card images (future enhancement)
**Example:**
```typescript
// Source: CONTEXT.md decisions + react-easy-crop patterns
interface ImageCropDialogProps {
  open: boolean
  onOpenChange: (open: boolean) => void
  imageSrc: string
  onCropComplete: (croppedBlob: Blob) => void
  initialAspect?: number  // undefined = free
}

// Aspect preset buttons per CONTEXT.md
const ASPECT_PRESETS = [
  { label: 'FREE', aspect: undefined },
  { label: 'RECTANGLE', aspect: 16 / 9 },
  { label: 'SQUARE', aspect: 1 },
] as const
```

### Pattern 2: Profile Store Separation
**What:** Separate Zustand store for profile state, parallel to page-store
**When to use:** Profile header fields, social icons
**Example:**
```typescript
// Source: Existing page-store.ts patterns
interface ProfileState {
  // Profile fields
  displayName: string | null
  avatarUrl: string | null
  titleStyle: 'text' | 'logo'
  titleSize: 'small' | 'large'
  logoUrl: string | null
  profileLayout: 'classic' | 'hero'

  // Social icons
  showSocialIcons: boolean
  socialIcons: SocialIcon[]

  // Tracking
  hasChanges: boolean

  // Actions
  setDisplayName: (name: string) => void
  setAvatarUrl: (url: string | null) => void
  // ... etc
}
```

### Pattern 3: Social Icons with dnd-kit
**What:** Sortable list of social icons using existing dnd-kit patterns
**When to use:** Social icons row in header section
**Example:**
```typescript
// Source: Existing sortable-card-list.tsx patterns
<DndContext sensors={sensors} onDragEnd={handleDragEnd}>
  <SortableContext items={socialIcons.map(i => i.id)} strategy={horizontalListSortingStrategy}>
    {socialIcons.map(icon => (
      <SortableSocialIcon key={icon.id} icon={icon} />
    ))}
  </SortableContext>
</DndContext>
```

### Anti-Patterns to Avoid
- **Embedding crop logic in upload component:** Keep crop dialog separate from upload trigger for reusability
- **Storing cropped image data in state:** Crop to Blob immediately and upload to Supabase; only store URLs
- **Mixing profile and card state:** Keep profile-store separate from page-store for cleaner undo/redo boundaries

## Don't Hand-Roll

Problems that look simple but have existing solutions:

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Image cropping | Canvas + drag handlers | react-easy-crop | Touch events, zoom, pan, aspect ratio constraints are complex |
| Cropped image output | Manual canvas drawing | getCroppedImg utility | Rotation, CORS, coordinate math has edge cases |
| Drag reorder | Custom drag handlers | @dnd-kit/sortable | Accessibility, touch support, animation handled |
| Social URL validation | Custom regex per platform | Simple URL validation + platform detection | Full regex matching is brittle; just validate URL format |

**Key insight:** Image cropping looks simple until you handle rotation, touch gestures, aspect ratio constraints, and memory management. The getCroppedImg canvas utility has subtle edge cases around CORS, coordinate systems, and memory leaks that react-easy-crop handles.

## Common Pitfalls

### Pitfall 1: Crop Preview Memory Leaks
**What goes wrong:** Creating object URLs for crop previews without revoking them
**Why it happens:** `URL.createObjectURL(blob)` creates a reference that persists until manually revoked
**How to avoid:** Always call `URL.revokeObjectURL(url)` in cleanup or after upload completes
**Warning signs:** Memory usage grows with each crop operation

```typescript
// Correct pattern
const previewUrl = URL.createObjectURL(blob)
// ... use previewUrl
URL.revokeObjectURL(previewUrl) // Clean up after upload or component unmount
```

### Pitfall 2: CORS Issues with Cropping
**What goes wrong:** Canvas tainted error when cropping images from external URLs
**Why it happens:** Canvas security prevents reading pixel data from cross-origin images
**How to avoid:** Always use `crossOrigin="anonymous"` on image elements AND ensure Supabase bucket has CORS configured
**Warning signs:** "Tainted canvas" errors in console

```typescript
// In getCroppedImg utility
const image = new Image()
image.crossOrigin = 'anonymous' // Required for canvas operations
```

### Pitfall 3: Aspect Ratio Switch During Crop
**What goes wrong:** Changing aspect ratio doesn't reset crop area, leaving invalid crop
**Why it happens:** react-easy-crop maintains crop state; switching aspect doesn't auto-adjust
**How to avoid:** Reset crop position when aspect changes
**Warning signs:** Crop area extends outside image bounds after aspect change

```typescript
// When aspect preset button clicked
const handleAspectChange = (newAspect: number | undefined) => {
  setAspect(newAspect)
  setCrop({ x: 0, y: 0 }) // Reset position
  setZoom(1) // Reset zoom
}
```

### Pitfall 4: Social Icon URL Validation False Positives
**What goes wrong:** Rejecting valid URLs or accepting invalid ones
**Why it happens:** Platform URL formats change; regex becomes outdated
**How to avoid:** Validate as URL first, then just check domain; don't try to extract username
**Warning signs:** User complaints about "invalid" URLs that work in browser

```typescript
// Simple approach: validate URL format, check domain
const SOCIAL_DOMAINS: Record<SocialPlatform, string[]> = {
  instagram: ['instagram.com', 'instagr.am'],
  tiktok: ['tiktok.com'],
  youtube: ['youtube.com', 'youtu.be'],
  spotify: ['spotify.com', 'open.spotify.com'],
  twitter: ['twitter.com', 'x.com'],
}
```

### Pitfall 5: Profile Save Race Conditions
**What goes wrong:** Multiple rapid changes result in stale data being saved
**Why it happens:** Async save operations complete out of order
**How to avoid:** Use debounced save with latest state snapshot (existing pattern in use-auto-save.ts)
**Warning signs:** Profile reverts to older values intermittently

## Code Examples

Verified patterns from official sources and existing codebase:

### getCroppedImg Utility
```typescript
// Source: https://dev.to/sukanta47/cropping-uploading-profile-pictures-in-react-with-typescript-and-react-easy-crop-5dl9
// Adapted for this project
import type { Area } from 'react-easy-crop'

const createImage = (url: string): Promise<HTMLImageElement> =>
  new Promise((resolve, reject) => {
    const image = new Image()
    image.crossOrigin = 'anonymous'
    image.onload = () => resolve(image)
    image.onerror = (error) => reject(error)
    image.src = url
  })

export async function getCroppedImg(
  imageSrc: string,
  croppedAreaPixels: Area,
  rotation = 0
): Promise<Blob> {
  const image = await createImage(imageSrc)
  const canvas = document.createElement('canvas')
  const ctx = canvas.getContext('2d')!

  // Handle rotation
  const radians = (rotation * Math.PI) / 180
  const rotatedWidth = Math.abs(Math.cos(radians) * image.width) + Math.abs(Math.sin(radians) * image.height)
  const rotatedHeight = Math.abs(Math.sin(radians) * image.width) + Math.abs(Math.cos(radians) * image.height)

  canvas.width = rotatedWidth
  canvas.height = rotatedHeight
  ctx.translate(rotatedWidth / 2, rotatedHeight / 2)
  ctx.rotate(radians)
  ctx.drawImage(image, -image.width / 2, -image.height / 2)
  ctx.setTransform(1, 0, 0, 1, 0, 0)

  // Extract cropped area
  const croppedCanvas = document.createElement('canvas')
  const croppedCtx = croppedCanvas.getContext('2d')!
  croppedCanvas.width = croppedAreaPixels.width
  croppedCanvas.height = croppedAreaPixels.height

  croppedCtx.drawImage(
    canvas,
    croppedAreaPixels.x,
    croppedAreaPixels.y,
    croppedAreaPixels.width,
    croppedAreaPixels.height,
    0,
    0,
    croppedAreaPixels.width,
    croppedAreaPixels.height
  )

  return new Promise((resolve, reject) => {
    croppedCanvas.toBlob(
      (blob) => {
        if (blob) resolve(blob)
        else reject(new Error('Canvas toBlob failed'))
      },
      'image/jpeg',
      0.9
    )
  })
}
```

### react-easy-crop Basic Usage
```typescript
// Source: https://github.com/ValentinH/react-easy-crop
import Cropper from 'react-easy-crop'
import type { Area, Point } from 'react-easy-crop'

function ImageCropper({ imageSrc }: { imageSrc: string }) {
  const [crop, setCrop] = useState<Point>({ x: 0, y: 0 })
  const [zoom, setZoom] = useState(1)
  const [aspect, setAspect] = useState<number | undefined>(1) // Square default
  const [croppedAreaPixels, setCroppedAreaPixels] = useState<Area | null>(null)

  const onCropComplete = useCallback((_: Area, croppedAreaPixels: Area) => {
    setCroppedAreaPixels(croppedAreaPixels)
  }, [])

  return (
    <div className="relative h-[400px]">
      <Cropper
        image={imageSrc}
        crop={crop}
        zoom={zoom}
        aspect={aspect}
        onCropChange={setCrop}
        onZoomChange={setZoom}
        onCropComplete={onCropComplete}
      />
    </div>
  )
}
```

### Supabase Profile Image Upload
```typescript
// Source: Existing storage.ts patterns
const PROFILE_BUCKET = 'profile-images'

export async function uploadProfileImage(
  file: Blob,
  userId: string,
  type: 'avatar' | 'logo'
): Promise<UploadResult> {
  const supabase = createClient()
  const fileName = `${userId}/${type}-${crypto.randomUUID()}.jpg`

  const { data, error } = await supabase.storage
    .from(PROFILE_BUCKET)
    .upload(fileName, file, {
      contentType: 'image/jpeg',
      upsert: false,
    })

  if (error) throw new Error(error.message)

  const { data: urlData } = supabase.storage
    .from(PROFILE_BUCKET)
    .getPublicUrl(data.path)

  return { url: urlData.publicUrl, path: data.path }
}
```

### Social Icons Type Definitions
```typescript
// Source: CONTEXT.md decisions
export type SocialPlatform = 'instagram' | 'tiktok' | 'youtube' | 'spotify' | 'twitter'

export interface SocialIcon {
  id: string
  platform: SocialPlatform
  url: string
  sortKey: string  // Fractional indexing for ordering
}

// Platform metadata for UI
export const SOCIAL_PLATFORMS: Record<SocialPlatform, {
  label: string
  icon: string  // Lucide icon name
  placeholder: string
  enabled: boolean
}> = {
  instagram: { label: 'Instagram', icon: 'Instagram', placeholder: 'https://instagram.com/username', enabled: true },
  tiktok: { label: 'TikTok', icon: 'Music2', placeholder: 'https://tiktok.com/@username', enabled: true },
  youtube: { label: 'YouTube', icon: 'Youtube', placeholder: 'https://youtube.com/@channel', enabled: true },
  spotify: { label: 'Spotify', icon: 'Music', placeholder: 'https://open.spotify.com/artist/...', enabled: true },
  twitter: { label: 'X / Twitter', icon: 'Twitter', placeholder: 'https://x.com/username', enabled: true },
}
```

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| Server-side image processing | Client-side canvas crop + upload | Ongoing | Reduces server load, instant preview |
| react-image-crop (manual zoom) | react-easy-crop (built-in zoom/pan) | 2023+ | Better UX, less boilerplate |
| Twitter URL format | X.com URL format | 2023 | Must support both twitter.com and x.com |

**Deprecated/outdated:**
- Supabase image transforms on free tier: Still requires Pro plan; client-side crop is the free-tier approach
- Complex social URL regex: Platform URL formats change frequently; simple domain validation is more maintainable

## Open Questions

Things that couldn't be fully resolved:

1. **Profile Logo Dimensions for Hero Layout**
   - What we know: Classic layout uses small circle avatar; Hero layout uses larger format
   - What's unclear: Exact pixel dimensions and aspect ratio for hero logo
   - Recommendation: Default to 16:9 rectangle for hero, allow override; test visually during implementation

2. **Social Icon Appearance in Preview**
   - What we know: Icons should show in header when toggled on
   - What's unclear: Exact icon sizes, spacing, hover states for preview
   - Recommendation: Match Linktree reference styling; implement basic version first

3. **Profile Storage Bucket**
   - What we know: Existing bucket is "card-images"
   - What's unclear: Whether to use same bucket or create "profile-images" bucket
   - Recommendation: Create separate "profile-images" bucket for organizational clarity

## Sources

### Primary (HIGH confidence)
- react-easy-crop npm package (v5.5.6) - API, usage patterns
- Existing codebase: sortable-card-list.tsx, page-store.ts, storage.ts - established patterns
- Supabase Storage documentation - upload patterns, transform options

### Secondary (MEDIUM confidence)
- [DEV.to react-easy-crop TypeScript tutorial](https://dev.to/sukanta47/cropping-uploading-profile-pictures-in-react-with-typescript-and-react-easy-crop-5dl9) - getCroppedImg utility
- [npm-compare library comparison](https://npm-compare.com/react-cropper,react-easy-crop,react-image-crop) - library selection rationale

### Tertiary (LOW confidence)
- [lorey/social-media-profiles-regexs](https://github.com/lorey/social-media-profiles-regexs) - social URL patterns (noted as not comprehensive for all platforms)

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH - react-easy-crop is clearly the ecosystem standard for this use case
- Architecture: HIGH - follows existing patterns from codebase
- Pitfalls: HIGH - canvas/CORS issues are well-documented; memory leaks are common

**Research date:** 2026-01-26
**Valid until:** 2026-02-26 (30 days - stable libraries)
