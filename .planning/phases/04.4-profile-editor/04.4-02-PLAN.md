---
phase: 04.4-profile-editor
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/shared/crop-utils.ts
  - src/components/shared/image-crop-dialog.tsx
autonomous: true

must_haves:
  truths:
    - "getCroppedImg utility produces Blob from crop coordinates"
    - "Image crop dialog shows FREE/RECTANGLE/SQUARE/RESET preset buttons"
    - "Aspect ratio change resets crop position"
    - "Crop dialog returns cropped Blob on save"
  artifacts:
    - path: "src/components/shared/crop-utils.ts"
      provides: "getCroppedImg canvas utility"
      exports: ["getCroppedImg"]
    - path: "src/components/shared/image-crop-dialog.tsx"
      provides: "Universal crop dialog component"
      exports: ["ImageCropDialog"]
  key_links:
    - from: "src/components/shared/image-crop-dialog.tsx"
      to: "src/components/shared/crop-utils.ts"
      via: "imports getCroppedImg"
      pattern: "import.*getCroppedImg.*from.*crop-utils"
    - from: "src/components/shared/image-crop-dialog.tsx"
      to: "react-easy-crop"
      via: "npm package"
      pattern: "import Cropper from 'react-easy-crop'"
---

<objective>
Create universal image crop component with aspect ratio presets for profile photos, logos, and card images.

Purpose: The crop component is shared across all image uploads in the app - this is the foundation for profile photo, logo, and future card image editing.
Output: Reusable ImageCropDialog component and getCroppedImg utility.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04.4-profile-editor/04.4-CONTEXT.md
@.planning/phases/04.4-profile-editor/04.4-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install react-easy-crop and create getCroppedImg utility</name>
  <files>src/components/shared/crop-utils.ts</files>
  <action>
1. Install react-easy-crop:
   ```bash
   npm install react-easy-crop
   ```

2. Create getCroppedImg utility in src/components/shared/crop-utils.ts:

```typescript
import type { Area } from 'react-easy-crop'

// Create image element from URL with CORS handling
const createImage = (url: string): Promise<HTMLImageElement> =>
  new Promise((resolve, reject) => {
    const image = new Image()
    image.crossOrigin = 'anonymous'  // Required for canvas operations
    image.onload = () => resolve(image)
    image.onerror = (error) => reject(error)
    image.src = url
  })

// Get cropped image as Blob
export async function getCroppedImg(
  imageSrc: string,
  croppedAreaPixels: Area,
  rotation = 0
): Promise<Blob> {
  const image = await createImage(imageSrc)
  const canvas = document.createElement('canvas')
  const ctx = canvas.getContext('2d')!

  // Handle rotation if needed
  const radians = (rotation * Math.PI) / 180
  const rotatedWidth = Math.abs(Math.cos(radians) * image.width) + Math.abs(Math.sin(radians) * image.height)
  const rotatedHeight = Math.abs(Math.sin(radians) * image.width) + Math.abs(Math.cos(radians) * image.height)

  canvas.width = rotatedWidth
  canvas.height = rotatedHeight
  ctx.translate(rotatedWidth / 2, rotatedHeight / 2)
  ctx.rotate(radians)
  ctx.drawImage(image, -image.width / 2, -image.height / 2)
  ctx.setTransform(1, 0, 0, 1, 0, 0)

  // Extract cropped area
  const croppedCanvas = document.createElement('canvas')
  const croppedCtx = croppedCanvas.getContext('2d')!
  croppedCanvas.width = croppedAreaPixels.width
  croppedCanvas.height = croppedAreaPixels.height

  croppedCtx.drawImage(
    canvas,
    croppedAreaPixels.x,
    croppedAreaPixels.y,
    croppedAreaPixels.width,
    croppedAreaPixels.height,
    0,
    0,
    croppedAreaPixels.width,
    croppedAreaPixels.height
  )

  return new Promise((resolve, reject) => {
    croppedCanvas.toBlob(
      (blob) => {
        if (blob) resolve(blob)
        else reject(new Error('Canvas toBlob failed'))
      },
      'image/jpeg',
      0.9  // 90% quality
    )
  })
}
```

Key points:
- crossOrigin="anonymous" prevents tainted canvas errors
- Supports rotation (default 0)
- Returns Blob ready for Supabase upload
- Uses 90% JPEG quality for good size/quality balance
  </action>
  <verify>`npx tsc --noEmit` passes</verify>
  <done>getCroppedImg utility exports and compiles correctly</done>
</task>

<task type="auto">
  <name>Task 2: Create ImageCropDialog component</name>
  <files>src/components/shared/image-crop-dialog.tsx</files>
  <action>
Create universal image crop dialog component:

1. Import dependencies:
   - Cropper from 'react-easy-crop'
   - Area, Point types from 'react-easy-crop'
   - Dialog components from shadcn/ui
   - Button from shadcn/ui
   - getCroppedImg from './crop-utils'

2. Define aspect ratio presets (per CONTEXT.md):
```typescript
const ASPECT_PRESETS = [
  { label: 'FREE', aspect: undefined },
  { label: 'RECTANGLE', aspect: 16 / 9 },
  { label: 'SQUARE', aspect: 1 },
] as const
```

3. Define props interface:
```typescript
interface ImageCropDialogProps {
  open: boolean
  onOpenChange: (open: boolean) => void
  imageSrc: string
  onCropComplete: (croppedBlob: Blob) => void
  initialAspect?: number  // undefined = free
}
```

4. Component state:
   - crop: Point ({ x: 0, y: 0 })
   - zoom: number (1)
   - aspect: number | undefined (initialAspect or SQUARE default)
   - croppedAreaPixels: Area | null
   - isSaving: boolean

5. Key handlers:
   - handleAspectChange: Reset crop position and zoom when preset clicked
   - handleReset: Reset crop/zoom to initial state
   - handleSave: Call getCroppedImg with croppedAreaPixels, pass Blob to onCropComplete

6. UI structure (following Linktree reference from CONTEXT.md):
   - Dialog with title "Crop Image"
   - Top row: FREE | RECTANGLE | SQUARE buttons (styled as toggle group) + RESET button
   - Main area: Cropper component (min-height 300px)
   - Bottom: Save button (disabled while saving)

7. Styling:
   - Selected aspect preset should have different background/border
   - Cropper container needs relative positioning with explicit height
   - Use Tailwind classes consistent with project

Key implementation notes:
- When aspect changes, reset crop position: setCrop({ x: 0, y: 0 }); setZoom(1)
- Cropper onCropComplete callback gives (croppedArea, croppedAreaPixels) - store croppedAreaPixels
- Save button shows loading state while processing
- Close dialog after successful crop
  </action>
  <verify>`npm run build` succeeds, component can be imported</verify>
  <done>ImageCropDialog exports, renders preset buttons, produces cropped Blob on save</done>
</task>

</tasks>

<verification>
- `npm run build` passes
- react-easy-crop is in package.json dependencies
- ImageCropDialog can be imported and rendered
- Aspect preset buttons visible in component
</verification>

<success_criteria>
- getCroppedImg utility correctly crops images with CORS handling
- ImageCropDialog shows FREE/RECTANGLE/SQUARE/RESET controls
- Aspect ratio change resets crop position (prevents invalid crop)
- Save button produces Blob and calls onCropComplete callback
</success_criteria>

<output>
After completion, create `.planning/phases/04.4-profile-editor/04.4-02-SUMMARY.md`
</output>
