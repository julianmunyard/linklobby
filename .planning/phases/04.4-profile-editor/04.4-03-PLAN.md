---
phase: 04.4-profile-editor
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/supabase/storage.ts
  - supabase/schema.sql
autonomous: true

must_haves:
  truths:
    - "Profile images upload to profile-images bucket"
    - "Upload function accepts Blob (not just File)"
    - "Uploaded images get public URLs"
  artifacts:
    - path: "src/lib/supabase/storage.ts"
      provides: "Profile image upload function"
      exports: ["uploadCardImage", "deleteCardImage", "uploadProfileImage"]
  key_links:
    - from: "src/lib/supabase/storage.ts"
      to: "Supabase Storage"
      via: "supabase.storage.from('profile-images')"
      pattern: "from\\(['\"]profile-images['\"]\\)"
---

<objective>
Extend Supabase storage utilities to support profile image uploads with a dedicated bucket.

Purpose: Profile images (avatar, logo) need their own storage bucket separate from card images for organizational clarity and potential different access policies.
Output: uploadProfileImage function that accepts Blob from crop dialog and returns public URL.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04.4-profile-editor/04.4-CONTEXT.md
@.planning/phases/04.4-profile-editor/04.4-RESEARCH.md
@src/lib/supabase/storage.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Supabase bucket creation SQL</name>
  <files>supabase/schema.sql</files>
  <action>
Add storage bucket configuration to schema.sql (at the end, after existing schema):

```sql
-- ============================================
-- STORAGE BUCKETS
-- ============================================

-- Note: Storage buckets are created via Supabase Dashboard or CLI
-- This SQL documents the expected bucket configuration

-- Bucket: profile-images
-- Purpose: Store user profile photos and logos
-- Access: Public read (for public pages), authenticated write
-- Structure: {user_id}/{type}-{uuid}.jpg
--   - type: 'avatar' or 'logo'
--   - Example: abc123/avatar-def456.jpg

-- To create via Supabase Dashboard:
-- 1. Go to Storage in Supabase Dashboard
-- 2. Create bucket "profile-images"
-- 3. Enable "Public bucket" toggle
-- 4. RLS policies are optional for public buckets

-- Alternatively, if using Supabase CLI:
-- supabase storage create profile-images --public
```

Note: This is documentation only - actual bucket creation is a manual step in Supabase Dashboard. The schema.sql serves as the source of truth for what buckets should exist.
  </action>
  <verify>SQL file is valid (no syntax errors)</verify>
  <done>Schema documents profile-images bucket requirements</done>
</task>

<task type="auto">
  <name>Task 2: Add uploadProfileImage function to storage.ts</name>
  <files>src/lib/supabase/storage.ts</files>
  <action>
Extend storage.ts with profile image upload support:

1. Add new constant for profile bucket:
```typescript
const PROFILE_BUCKET = 'profile-images'
```

2. Add profile image upload function that accepts Blob (not File):
```typescript
export type ProfileImageType = 'avatar' | 'logo'

export async function uploadProfileImage(
  blob: Blob,
  userId: string,
  type: ProfileImageType
): Promise<UploadResult> {
  // Validate blob size (use same 5MB limit)
  if (blob.size > MAX_FILE_SIZE) {
    throw new Error('Image must be less than 5MB')
  }

  const supabase = createClient()

  // Generate unique filename: userId/type-uuid.jpg
  // Always .jpg since getCroppedImg outputs JPEG
  const fileName = `${userId}/${type}-${crypto.randomUUID()}.jpg`

  const { data, error } = await supabase.storage
    .from(PROFILE_BUCKET)
    .upload(fileName, blob, {
      contentType: 'image/jpeg',
      upsert: false,
    })

  if (error) {
    console.error('Profile upload error:', error)
    throw new Error(error.message || 'Failed to upload profile image')
  }

  // Get public URL
  const { data: urlData } = supabase.storage
    .from(PROFILE_BUCKET)
    .getPublicUrl(data.path)

  return {
    url: urlData.publicUrl,
    path: data.path,
  }
}
```

3. Add delete function for profile images:
```typescript
export async function deleteProfileImage(path: string): Promise<void> {
  const supabase = createClient()

  const { error } = await supabase.storage
    .from(PROFILE_BUCKET)
    .remove([path])

  if (error) {
    console.error('Profile delete error:', error)
    throw new Error(error.message || 'Failed to delete profile image')
  }
}
```

Key differences from uploadCardImage:
- Takes Blob instead of File (crop dialog outputs Blob)
- Uses 'profile-images' bucket
- Path structure is userId/type-uuid.jpg (not cardId/uuid.ext)
- Always JPEG content type (cropper outputs JPEG)
  </action>
  <verify>`npx tsc --noEmit` passes, exports are available</verify>
  <done>uploadProfileImage and deleteProfileImage functions work with Blob input</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- storage.ts exports: uploadCardImage, deleteCardImage, uploadProfileImage, deleteProfileImage
- UploadResult type is reused for profile uploads
</verification>

<success_criteria>
- uploadProfileImage accepts Blob (from crop dialog) not File
- Images stored at profile-images/{userId}/{type}-{uuid}.jpg
- Returns public URL in same UploadResult format
- Bucket requirements documented in schema.sql
</success_criteria>

<output>
After completion, create `.planning/phases/04.4-profile-editor/04.4-03-SUMMARY.md`
</output>
