---
phase: 06-advanced-cards
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/contexts/multi-select-context.tsx
  - src/hooks/use-multi-select.ts
autonomous: true

must_haves:
  truths:
    - "Multi-select state is managed via context"
    - "Cards can be selected/deselected individually"
    - "Selection can be cleared"
  artifacts:
    - path: "src/contexts/multi-select-context.tsx"
      provides: "MultiSelectProvider and useMultiSelectContext"
      exports: ["MultiSelectProvider", "useMultiSelectContext"]
    - path: "src/hooks/use-multi-select.ts"
      provides: "useMultiSelect hook with selection logic"
      exports: ["useMultiSelect"]
  key_links:
    - from: "src/hooks/use-multi-select.ts"
      to: "src/contexts/multi-select-context.tsx"
      via: "context consumption"
      pattern: "useMultiSelectContext"
---

<objective>
Create multi-select state management infrastructure for bulk card operations.

Purpose: Provides shared state for tracking which cards are selected, enabling bulk actions like "Group into Dropdown".
Output: MultiSelectProvider context, useMultiSelect hook with selection operations.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/06-advanced-cards/06-CONTEXT.md
@.planning/phases/06-advanced-cards/06-RESEARCH.md
@src/stores/page-store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Multi-Select Context</name>
  <files>src/contexts/multi-select-context.tsx</files>
  <action>
Create src/contexts/multi-select-context.tsx:

```typescript
"use client"

import { createContext, useContext, useState, useCallback, ReactNode } from "react"

interface MultiSelectContextValue {
  // State
  selectedIds: Set<string>
  isSelectMode: boolean  // For mobile checkbox mode

  // Actions
  toggleSelect: (id: string) => void
  setSelected: (ids: Set<string>) => void
  clearSelection: () => void
  enterSelectMode: () => void
  exitSelectMode: () => void

  // Computed
  isSelected: (id: string) => boolean
  selectedCount: number
}

const MultiSelectContext = createContext<MultiSelectContextValue | null>(null)

export function MultiSelectProvider({ children }: { children: ReactNode }) {
  const [selectedIds, setSelectedIds] = useState<Set<string>>(new Set())
  const [isSelectMode, setIsSelectMode] = useState(false)

  const toggleSelect = useCallback((id: string) => {
    setSelectedIds((prev) => {
      const next = new Set(prev)
      if (next.has(id)) {
        next.delete(id)
      } else {
        next.add(id)
      }
      return next
    })
  }, [])

  const setSelected = useCallback((ids: Set<string>) => {
    setSelectedIds(ids)
  }, [])

  const clearSelection = useCallback(() => {
    setSelectedIds(new Set())
    setIsSelectMode(false)
  }, [])

  const enterSelectMode = useCallback(() => {
    setIsSelectMode(true)
  }, [])

  const exitSelectMode = useCallback(() => {
    setIsSelectMode(false)
    setSelectedIds(new Set())
  }, [])

  const isSelected = useCallback(
    (id: string) => selectedIds.has(id),
    [selectedIds]
  )

  const value: MultiSelectContextValue = {
    selectedIds,
    isSelectMode,
    toggleSelect,
    setSelected,
    clearSelection,
    enterSelectMode,
    exitSelectMode,
    isSelected,
    selectedCount: selectedIds.size,
  }

  return (
    <MultiSelectContext.Provider value={value}>
      {children}
    </MultiSelectContext.Provider>
  )
}

export function useMultiSelectContext() {
  const context = useContext(MultiSelectContext)
  if (!context) {
    throw new Error("useMultiSelectContext must be used within MultiSelectProvider")
  }
  return context
}
```

Key features:
- Tracks selected card IDs in a Set for O(1) lookup
- isSelectMode flag for mobile checkbox mode
- Toggle, set, and clear operations
- enterSelectMode/exitSelectMode for mobile workflow
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>MultiSelectProvider and useMultiSelectContext created</done>
</task>

<task type="auto">
  <name>Task 2: Create useMultiSelect Hook with Shift-Click Logic</name>
  <files>src/hooks/use-multi-select.ts</files>
  <action>
Create src/hooks/use-multi-select.ts with enhanced selection logic:

```typescript
"use client"

import { useCallback, useRef } from "react"
import { useMultiSelectContext } from "@/contexts/multi-select-context"

interface UseMultiSelectOptions {
  orderedIds: string[]  // Card IDs in display order for range selection
}

export function useMultiSelect({ orderedIds }: UseMultiSelectOptions) {
  const context = useMultiSelectContext()
  const lastSelectedRef = useRef<string | null>(null)

  // Handle click with Shift support for range selection
  const handleClick = useCallback(
    (id: string, event: React.MouseEvent) => {
      if (event.shiftKey && lastSelectedRef.current) {
        // Range selection: select all cards between last selected and current
        const startIndex = orderedIds.indexOf(lastSelectedRef.current)
        const endIndex = orderedIds.indexOf(id)

        if (startIndex !== -1 && endIndex !== -1) {
          const [from, to] = startIndex < endIndex
            ? [startIndex, endIndex]
            : [endIndex, startIndex]

          const rangeIds = orderedIds.slice(from, to + 1)
          const newSelection = new Set(context.selectedIds)
          rangeIds.forEach((rangeId) => newSelection.add(rangeId))
          context.setSelected(newSelection)
        }
      } else {
        // Single toggle
        context.toggleSelect(id)
        lastSelectedRef.current = id
      }
    },
    [context, orderedIds]
  )

  // For mobile checkbox mode - simple toggle without shift
  const handleCheckbox = useCallback(
    (id: string) => {
      context.toggleSelect(id)
    },
    [context]
  )

  return {
    ...context,
    handleClick,
    handleCheckbox,
  }
}
```

Key features:
- Shift+click for range selection
- Tracks last selected card for range calculation
- Uses orderedIds to determine range
- Separate handleCheckbox for mobile mode (no shift logic)
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>useMultiSelect hook exists with shift-click range selection</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with no errors
- MultiSelectProvider can be imported
- useMultiSelectContext throws if used outside provider
- useMultiSelect has handleClick with shift support
</verification>

<success_criteria>
- Selection state accessible throughout editor
- Shift+click supports range selection
- Mobile checkbox mode supported
- Selection can be cleared programmatically
</success_criteria>

<output>
After completion, create `.planning/phases/06-advanced-cards/06-03-SUMMARY.md`
</output>
