---
phase: 06-advanced-cards
plan: 13
type: execute
wave: 3
depends_on: ["06-03", "06-04"]
files_modified:
  - src/components/canvas/selectable-flow-grid.tsx
  - src/components/editor/editor-client-wrapper.tsx
autonomous: true

must_haves:
  truths:
    - "Drawing a box selects cards within it"
    - "Shift+click toggles individual card selection"
    - "Selected cards show visual indicator (white border)"
    - "Selection persists until cleared"
  artifacts:
    - path: "src/components/canvas/selectable-flow-grid.tsx"
      provides: "SelectableFlowGrid with box selection"
      exports: ["SelectableFlowGrid"]
    - path: "src/components/editor/editor-client-wrapper.tsx"
      provides: "MultiSelectProvider wrapper"
      contains: "MultiSelectProvider"
  key_links:
    - from: "src/components/canvas/selectable-flow-grid.tsx"
      to: "@air/react-drag-to-select"
      via: "useSelectionContainer"
      pattern: "useSelectionContainer"
    - from: "src/components/canvas/selectable-flow-grid.tsx"
      to: "src/hooks/use-multi-select.ts"
      via: "useMultiSelect hook"
      pattern: "useMultiSelect"
---

<objective>
Implement box selection for multi-selecting cards on desktop.

Purpose: Enables drag-to-select multiple cards for bulk operations like "Group into Dropdown".
Output: SelectableFlowGrid with @air/react-drag-to-select integration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/06-advanced-cards/06-CONTEXT.md
@.planning/phases/06-advanced-cards/06-RESEARCH.md
@.planning/phases/06-advanced-cards/06-03-SUMMARY.md
@.planning/phases/06-advanced-cards/06-04-SUMMARY.md
@src/components/canvas/flow-grid.tsx
@src/components/editor/editor-client-wrapper.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SelectableFlowGrid Component</name>
  <files>src/components/canvas/selectable-flow-grid.tsx</files>
  <action>
Create src/components/canvas/selectable-flow-grid.tsx that wraps FlowGrid with box selection:

```typescript
"use client"

import { useCallback, useRef } from "react"
import { useSelectionContainer, boxesIntersect, Box } from "@air/react-drag-to-select"
import { FlowGrid } from "./flow-grid"
import { useMultiSelect } from "@/hooks/use-multi-select"
import type { Card } from "@/types/card"

interface SelectableFlowGridProps {
  cards: Card[]
  onReorder: (oldIndex: number, newIndex: number) => void
}

export function SelectableFlowGrid({ cards, onReorder }: SelectableFlowGridProps) {
  const containerRef = useRef<HTMLDivElement>(null)

  // Get card IDs in display order for range selection
  const orderedIds = cards.map((c) => c.id)

  const { setSelected, handleClick, isSelected } = useMultiSelect({ orderedIds })

  // Handle box selection completion
  const handleSelectionChange = useCallback(
    (box: Box) => {
      if (!containerRef.current) return

      const selected = new Set<string>()

      // Find all selectable elements within the container
      containerRef.current.querySelectorAll("[data-selectable-id]").forEach((el) => {
        const selectableId = el.getAttribute("data-selectable-id")
        if (!selectableId) return

        const elRect = el.getBoundingClientRect()
        const containerRect = containerRef.current!.getBoundingClientRect()

        // Convert element rect to container-relative coordinates
        const relativeRect = {
          left: elRect.left - containerRect.left,
          top: elRect.top - containerRect.top,
          width: elRect.width,
          height: elRect.height,
        }

        // Check if element intersects with selection box
        if (boxesIntersect(box, relativeRect)) {
          selected.add(selectableId)
        }
      })

      if (selected.size > 0) {
        setSelected(selected)
      }
    },
    [setSelected]
  )

  // Should not start selecting on drag handles or interactive elements
  const shouldStartSelecting = useCallback((target: Element | null) => {
    if (!target || !(target instanceof HTMLElement)) return true

    // Don't start selection on drag handles
    if (target.closest("[data-drag-handle]")) return false
    // Don't start on buttons
    if (target.closest("button")) return false
    // Don't start on inputs
    if (target.closest("input, textarea")) return false
    // Don't start on interactive cards (games, videos)
    if (target.closest("[data-no-select]")) return false

    return true
  }, [])

  const { DragSelection } = useSelectionContainer({
    onSelectionChange: handleSelectionChange,
    shouldStartSelecting,
    selectionProps: {
      style: {
        border: "2px solid white",
        backgroundColor: "rgba(255, 255, 255, 0.1)",
        borderRadius: "4px",
      },
    },
    eventsElement: containerRef.current ?? undefined,
  })

  return (
    <div ref={containerRef} className="relative">
      <DragSelection />
      <FlowGrid
        cards={cards}
        onReorder={onReorder}
        isSelected={isSelected}
        onCardClick={handleClick}
      />
    </div>
  )
}
```

Note: This requires updating FlowGrid to accept isSelected and onCardClick props - will be done in the same task.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>SelectableFlowGrid component created with box selection</done>
</task>

<task type="auto">
  <name>Task 2: Update FlowGrid and SortableFlowCard for Selection</name>
  <files>src/components/canvas/flow-grid.tsx, src/components/canvas/sortable-flow-card.tsx</files>
  <action>
Update flow-grid.tsx to pass selection props:

1. Add props to FlowGridProps:
```typescript
interface FlowGridProps {
  cards: Card[]
  onReorder: (oldIndex: number, newIndex: number) => void
  isSelected?: (id: string) => boolean
  onCardClick?: (id: string, event: React.MouseEvent) => void
}
```

2. Pass props down to SortableFlowCard:
```typescript
<SortableFlowCard
  key={card.id}
  card={card}
  isSelected={isSelected?.(card.id)}
  onCardClick={onCardClick}
/>
```

Update sortable-flow-card.tsx:

1. Add props:
```typescript
interface SortableFlowCardProps {
  card: Card
  isInsideDropdown?: boolean
  isSelected?: boolean
  onCardClick?: (id: string, event: React.MouseEvent) => void
}
```

2. Add data attribute for selection targeting:
```typescript
<div
  data-selectable-id={card.id}
  // ... existing props
>
```

3. Add click handler for shift-click:
```typescript
onClick={(e) => {
  if (e.shiftKey && onCardClick) {
    e.preventDefault()
    onCardClick(card.id, e)
  }
}}
```

4. Add visual selection indicator:
```typescript
className={cn(
  // existing classes
  isSelected && "ring-2 ring-white ring-offset-2 ring-offset-background"
)}
```
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>FlowGrid and SortableFlowCard support selection</done>
</task>

<task type="auto">
  <name>Task 3: Add MultiSelectProvider to Editor</name>
  <files>src/components/editor/editor-client-wrapper.tsx</files>
  <action>
Wrap the editor with MultiSelectProvider:

1. Import MultiSelectProvider:
```typescript
import { MultiSelectProvider } from "@/contexts/multi-select-context"
```

2. Wrap the editor content with MultiSelectProvider (inside any existing providers):
```typescript
<MultiSelectProvider>
  {/* existing editor content */}
</MultiSelectProvider>
```

This ensures multi-select context is available throughout the editor.

3. Also update the preview panel usage to use SelectableFlowGrid instead of FlowGrid (if in editor mode). The preview panel should use regular FlowGrid (no selection in preview).

Check where FlowGrid is currently used in the editor and swap to SelectableFlowGrid for the editor canvas (not the iframe preview).
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>MultiSelectProvider wraps editor, SelectableFlowGrid used in editor canvas</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- Box selection creates selection rectangle
- Cards within box get selected (white ring)
- Shift+click toggles individual cards
- Selection persists until cleared
</verification>

<success_criteria>
- Drawing a selection box selects overlapping cards
- Shift+click adds/removes individual cards
- Selected cards show white ring indicator
- Selection doesn't trigger on drag handles/buttons
- Selection state accessible via context
</success_criteria>

<output>
After completion, create `.planning/phases/06-advanced-cards/06-13-SUMMARY.md`
</output>
