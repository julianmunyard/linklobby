---
phase: 06-advanced-cards
plan: 14
type: execute
wave: 3
depends_on: ["06-03", "06-13", "06-01"]
files_modified:
  - src/components/editor/selection-toolbar.tsx
  - src/components/editor/editor-panel.tsx
  - src/components/editor/cards-tab.tsx
autonomous: true

must_haves:
  truths:
    - "Floating toolbar appears when cards are selected"
    - "Group into Dropdown creates new dropdown with selected cards"
    - "Move to Dropdown shows submenu with existing dropdowns"
    - "Delete All removes all selected cards with confirmation"
  artifacts:
    - path: "src/components/editor/selection-toolbar.tsx"
      provides: "SelectionToolbar component"
      exports: ["SelectionToolbar"]
      min_lines: 80
  key_links:
    - from: "src/components/editor/selection-toolbar.tsx"
      to: "src/stores/page-store.ts"
      via: "moveCardToDropdown"
      pattern: "moveCardToDropdown"
    - from: "src/components/editor/selection-toolbar.tsx"
      to: "src/contexts/multi-select-context.tsx"
      via: "useMultiSelectContext"
      pattern: "useMultiSelectContext"
---

<objective>
Create floating selection toolbar with bulk actions.

Purpose: Provides quick access to bulk operations when multiple cards are selected.
Output: SelectionToolbar with Group into Dropdown, Move to Dropdown, Delete All actions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/06-advanced-cards/06-CONTEXT.md
@.planning/phases/06-advanced-cards/06-03-SUMMARY.md
@.planning/phases/06-advanced-cards/06-13-SUMMARY.md
@.planning/phases/06-advanced-cards/06-01-SUMMARY.md
@src/stores/page-store.ts
@src/contexts/multi-select-context.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SelectionToolbar Component</name>
  <files>src/components/editor/selection-toolbar.tsx</files>
  <action>
Create src/components/editor/selection-toolbar.tsx:

```typescript
"use client"

import { useState } from "react"
import { FolderPlus, FolderInput, Trash2, X } from "lucide-react"
import { Button } from "@/components/ui/button"
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu"
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from "@/components/ui/alert-dialog"
import { useMultiSelectContext } from "@/contexts/multi-select-context"
import { usePageStore } from "@/stores/page-store"
import { toast } from "sonner"
import type { Card } from "@/types/card"
import { isDropdownContent } from "@/types/card"

export function SelectionToolbar() {
  const { selectedIds, selectedCount, clearSelection } = useMultiSelectContext()
  const [showDeleteConfirm, setShowDeleteConfirm] = useState(false)

  const cards = usePageStore((state) => state.cards)
  const addCard = usePageStore((state) => state.addCard)
  const removeCard = usePageStore((state) => state.removeCard)
  const updateCard = usePageStore((state) => state.updateCard)
  const moveCardToDropdown = usePageStore((state) => state.moveCardToDropdown)

  // Don't render if no selection
  if (selectedCount === 0) {
    return null
  }

  // Get existing dropdowns for "Move to Dropdown" submenu
  const dropdowns = cards.filter((c) => c.card_type === "dropdown")

  // Group selected cards into new dropdown
  const handleGroupIntoDropdown = () => {
    // Create new dropdown
    addCard("dropdown")

    // Get the newly created dropdown (last card added)
    const newDropdown = usePageStore.getState().cards.find(
      (c) => c.card_type === "dropdown" && !c.content?.childCardIds?.length
    )

    if (newDropdown) {
      // Move all selected cards into the dropdown
      selectedIds.forEach((cardId) => {
        const card = cards.find((c) => c.id === cardId)
        // Don't move dropdowns into dropdowns
        if (card && card.card_type !== "dropdown") {
          moveCardToDropdown(cardId, newDropdown.id)
        }
      })

      toast.success(`Created dropdown with ${selectedCount} cards`)
    }

    clearSelection()
  }

  // Move selected cards to existing dropdown
  const handleMoveToDropdown = (dropdownId: string) => {
    const dropdown = cards.find((c) => c.id === dropdownId)
    if (!dropdown) return

    let movedCount = 0
    selectedIds.forEach((cardId) => {
      const card = cards.find((c) => c.id === cardId)
      // Don't move dropdowns into dropdowns
      if (card && card.card_type !== "dropdown") {
        moveCardToDropdown(cardId, dropdownId)
        movedCount++
      }
    })

    toast.success(`Moved ${movedCount} cards to "${dropdown.title || "Dropdown"}"`)
    clearSelection()
  }

  // Delete all selected cards
  const handleDeleteAll = async () => {
    const idsToDelete = Array.from(selectedIds)

    // Remove from store
    idsToDelete.forEach((id) => removeCard(id))

    // Delete from database
    try {
      await Promise.all(
        idsToDelete.map((id) =>
          fetch(`/api/cards/${id}`, { method: "DELETE" })
        )
      )
    } catch (error) {
      console.error("Failed to delete some cards:", error)
    }

    toast.success(`Deleted ${idsToDelete.length} cards`)
    clearSelection()
    setShowDeleteConfirm(false)
  }

  return (
    <>
      {/* Floating toolbar */}
      <div className="fixed bottom-6 left-1/2 -translate-x-1/2 z-50 flex items-center gap-2 bg-background border rounded-lg shadow-lg p-2">
        <span className="text-sm text-muted-foreground px-2">
          {selectedCount} selected
        </span>

        {/* Group into Dropdown */}
        <Button
          variant="outline"
          size="sm"
          onClick={handleGroupIntoDropdown}
          className="h-9"
        >
          <FolderPlus className="h-4 w-4 mr-2" />
          Group into Dropdown
        </Button>

        {/* Move to Dropdown */}
        {dropdowns.length > 0 && (
          <DropdownMenu>
            <DropdownMenuTrigger asChild>
              <Button variant="outline" size="sm" className="h-9">
                <FolderInput className="h-4 w-4 mr-2" />
                Move to Dropdown
              </Button>
            </DropdownMenuTrigger>
            <DropdownMenuContent align="center">
              {dropdowns.map((dropdown) => (
                <DropdownMenuItem
                  key={dropdown.id}
                  onClick={() => handleMoveToDropdown(dropdown.id)}
                >
                  {dropdown.title || "Untitled Dropdown"}
                  {isDropdownContent(dropdown.content) && (
                    <span className="text-xs text-muted-foreground ml-2">
                      ({dropdown.content.childCardIds?.length ?? 0})
                    </span>
                  )}
                </DropdownMenuItem>
              ))}
            </DropdownMenuContent>
          </DropdownMenu>
        )}

        {/* Delete All */}
        <Button
          variant="destructive"
          size="sm"
          onClick={() => setShowDeleteConfirm(true)}
          className="h-9"
        >
          <Trash2 className="h-4 w-4 mr-2" />
          Delete All
        </Button>

        {/* Clear Selection */}
        <Button
          variant="ghost"
          size="sm"
          onClick={clearSelection}
          className="h-9"
        >
          <X className="h-4 w-4" />
        </Button>
      </div>

      {/* Delete Confirmation Dialog */}
      <AlertDialog open={showDeleteConfirm} onOpenChange={setShowDeleteConfirm}>
        <AlertDialogContent>
          <AlertDialogHeader>
            <AlertDialogTitle>Delete {selectedCount} cards?</AlertDialogTitle>
            <AlertDialogDescription>
              This action cannot be undone. All selected cards will be permanently deleted.
            </AlertDialogDescription>
          </AlertDialogHeader>
          <AlertDialogFooter>
            <AlertDialogCancel>Cancel</AlertDialogCancel>
            <AlertDialogAction onClick={handleDeleteAll}>
              Delete All
            </AlertDialogAction>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>
    </>
  )
}
```

Key features:
- Shows selected count
- Group into Dropdown creates new dropdown
- Move to Dropdown shows submenu of existing dropdowns
- Delete All with confirmation dialog
- Clear selection button

**Database Persistence Note:** The store mutations (addCard, moveCardToDropdown) mark `hasChanges = true`. The existing auto-save mechanism (triggered on close or via save button) will persist all changes including:
- New dropdown cards
- Updated parentDropdownId on moved cards
- Updated childCardIds arrays on dropdowns

No additional persistence code needed - rely on existing saveCards() flow which includes all card fields.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>SelectionToolbar component created</done>
</task>

<task type="auto">
  <name>Task 2: Add SelectionToolbar to Editor</name>
  <files>src/components/editor/editor-panel.tsx</files>
  <action>
Add SelectionToolbar to the editor layout:

1. Import SelectionToolbar:
```typescript
import { SelectionToolbar } from "./selection-toolbar"
```

2. Add SelectionToolbar at the root level of the editor panel (so it can float over everything):
```typescript
return (
  <>
    {/* existing editor panel content */}

    {/* Selection toolbar - floats at bottom when cards selected */}
    <SelectionToolbar />
  </>
)
```

The toolbar will automatically hide when no cards are selected and show when cards are selected.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>SelectionToolbar added to editor</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- Toolbar appears when cards selected
- Toolbar hides when selection cleared
- Group into Dropdown creates dropdown with selected cards
- Move to Dropdown shows existing dropdowns
- Delete All shows confirmation before deleting
</verification>

<success_criteria>
- Floating toolbar appears at bottom when cards selected
- Selected count displays correctly
- Group into Dropdown works (creates dropdown, moves cards)
- Move to Dropdown submenu lists existing dropdowns
- Delete All requires confirmation
- Clear selection (X) works
</success_criteria>

<output>
After completion, create `.planning/phases/06-advanced-cards/06-14-SUMMARY.md`
</output>
