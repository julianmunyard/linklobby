---
phase: 06-advanced-cards
plan: 06
type: execute
wave: 2
depends_on: ["06-01", "06-05"]
files_modified:
  - src/components/canvas/flow-grid.tsx
  - src/components/canvas/dropdown-sortable.tsx
  - src/lib/dnd-utils.ts
autonomous: true

must_haves:
  truths:
    - "Cards can be dragged into dropdowns"
    - "Cards can be dragged out of dropdowns to main canvas"
    - "Cards inside dropdowns can be reordered"
    - "Dragging between containers updates parentDropdownId"
  artifacts:
    - path: "src/components/canvas/flow-grid.tsx"
      provides: "Nested SortableContext for dropdowns"
      contains: "SortableContext"
    - path: "src/components/canvas/dropdown-sortable.tsx"
      provides: "Sortable wrapper for cards inside dropdown"
      exports: ["DropdownSortable"]
    - path: "src/lib/dnd-utils.ts"
      provides: "findContainer and collision detection helpers"
      exports: ["findContainer", "multiContainerCollisionDetection"]
  key_links:
    - from: "src/components/canvas/flow-grid.tsx"
      to: "src/stores/page-store.ts"
      via: "moveCardToDropdown/removeCardFromDropdown"
      pattern: "moveCardToDropdown|removeCardFromDropdown"
---

<objective>
Implement nested dnd-kit container structure for dropdown drag-and-drop.

Purpose: Enables dragging cards into/out of dropdowns and reordering within dropdowns.
Output: Extended FlowGrid with multi-container support, DropdownSortable component.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/06-advanced-cards/06-CONTEXT.md
@.planning/phases/06-advanced-cards/06-RESEARCH.md
@.planning/phases/06-advanced-cards/06-01-SUMMARY.md
@.planning/phases/06-advanced-cards/06-05-SUMMARY.md
@src/components/canvas/flow-grid.tsx
@src/stores/page-store.ts
@src/types/card.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create dnd-kit Multi-Container Utilities</name>
  <files>src/lib/dnd-utils.ts</files>
  <action>
Create src/lib/dnd-utils.ts with helper functions for multi-container drag:

```typescript
import type { UniqueIdentifier } from "@dnd-kit/core"
import type { Card } from "@/types/card"

// Container types for drag operations
export type ContainerId = "canvas" | string  // "canvas" or dropdown card ID

/**
 * Find which container a card belongs to
 * Returns "canvas" for main canvas cards, or dropdown ID for nested cards
 */
export function findContainer(
  cardId: string,
  cards: Card[]
): ContainerId {
  const card = cards.find((c) => c.id === cardId)
  if (!card) return "canvas"
  return card.parentDropdownId || "canvas"
}

/**
 * Get card IDs for a container
 * For "canvas": cards without parentDropdownId
 * For dropdown ID: cards with that parentDropdownId
 */
export function getContainerCards(
  containerId: ContainerId,
  cards: Card[]
): Card[] {
  if (containerId === "canvas") {
    return cards.filter((c) => !c.parentDropdownId && c.card_type !== "dropdown")
  }
  // Return cards inside this dropdown
  return cards.filter((c) => c.parentDropdownId === containerId)
}

/**
 * Get all container IDs (canvas + all dropdown IDs)
 */
export function getAllContainerIds(cards: Card[]): ContainerId[] {
  const dropdownIds = cards
    .filter((c) => c.card_type === "dropdown")
    .map((c) => c.id)
  return ["canvas", ...dropdownIds]
}

/**
 * Check if a card can be dropped into a container
 * Dropdowns cannot be put inside dropdowns (no nesting)
 */
export function canDropInContainer(
  cardId: string,
  containerId: ContainerId,
  cards: Card[]
): boolean {
  const card = cards.find((c) => c.id === cardId)
  if (!card) return false

  // Dropdowns cannot be nested
  if (card.card_type === "dropdown" && containerId !== "canvas") {
    return false
  }

  return true
}
```

Key features:
- findContainer: Determines which container a card is in
- getContainerCards: Gets cards for a specific container
- getAllContainerIds: Lists all containers (canvas + dropdowns)
- canDropInContainer: Validates drop targets (no nested dropdowns)
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>dnd-kit multi-container utilities created</done>
</task>

<task type="auto">
  <name>Task 2: Create DropdownSortable Component</name>
  <files>src/components/canvas/dropdown-sortable.tsx</files>
  <action>
Create src/components/canvas/dropdown-sortable.tsx for rendering sortable cards inside dropdowns:

```typescript
"use client"

import { SortableContext, rectSortingStrategy } from "@dnd-kit/sortable"
import { useDroppable } from "@dnd-kit/core"
import { SortableFlowCard } from "./sortable-flow-card"
import { DropdownCard } from "@/components/cards/dropdown-card"
import type { Card } from "@/types/card"
import { cn } from "@/lib/utils"

interface DropdownSortableProps {
  dropdown: Card
  childCards: Card[]
}

export function DropdownSortable({ dropdown, childCards }: DropdownSortableProps) {
  // Make the dropdown a droppable area for receiving cards
  const { setNodeRef, isOver } = useDroppable({
    id: dropdown.id,
    data: {
      type: "dropdown",
      dropdownId: dropdown.id,
    },
  })

  return (
    <div
      ref={setNodeRef}
      className={cn(
        "w-full transition-colors",
        isOver && "ring-2 ring-primary ring-offset-2"
      )}
    >
      <DropdownCard card={dropdown}>
        <SortableContext
          items={childCards.map((c) => c.id)}
          strategy={rectSortingStrategy}
        >
          <div className="space-y-2">
            {childCards.map((card) => (
              <SortableFlowCard
                key={card.id}
                card={card}
                isInsideDropdown
              />
            ))}
          </div>
        </SortableContext>
      </DropdownCard>
    </div>
  )
}
```

Key features:
- Wraps DropdownCard with droppable zone
- Nested SortableContext for child cards
- Visual feedback (ring) when card is dragged over
- Passes children to DropdownCard component
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>DropdownSortable component created</done>
</task>

<task type="auto">
  <name>Task 3: Extend FlowGrid for Multi-Container Drag</name>
  <files>src/components/canvas/flow-grid.tsx</files>
  <action>
Update flow-grid.tsx to support dragging between main canvas and dropdowns:

1. Import new utilities and components:
```typescript
import { DropdownSortable } from "./dropdown-sortable"
import { findContainer, getContainerCards, canDropInContainer } from "@/lib/dnd-utils"
import { usePageStore } from "@/stores/page-store"
import { DragOverEvent } from "@dnd-kit/core"
```

2. Get store actions:
```typescript
const moveCardToDropdown = usePageStore((state) => state.moveCardToDropdown)
const removeCardFromDropdown = usePageStore((state) => state.removeCardFromDropdown)
```

3. Split cards into main canvas and dropdown children:
- Main canvas cards: cards where !parentDropdownId AND card_type !== "dropdown", plus dropdowns
- Group child cards by their parentDropdownId

4. Add onDragOver handler to track container changes during drag:
```typescript
function handleDragOver(event: DragOverEvent) {
  const { active, over } = event
  if (!over) return

  const activeCard = cards.find((c) => c.id === active.id)
  if (!activeCard) return

  const activeContainer = findContainer(active.id as string, cards)
  const overContainer = over.data.current?.type === "dropdown"
    ? over.id as string
    : findContainer(over.id as string, cards)

  // If moving to different container, update parentDropdownId
  if (activeContainer !== overContainer) {
    if (!canDropInContainer(active.id as string, overContainer, cards)) {
      return // Can't drop dropdown into dropdown
    }
    // Update will happen in onDragEnd
  }
}
```

5. Update handleDragEnd to handle cross-container moves:
```typescript
function handleDragEnd(event: DragEndEvent) {
  const { active, over } = event
  setActiveCard(null)

  if (!over) {
    resume()
    return
  }

  const activeCard = cards.find((c) => c.id === active.id)
  if (!activeCard) {
    resume()
    return
  }

  const activeContainer = findContainer(active.id as string, cards)
  const overContainer = over.data.current?.type === "dropdown"
    ? over.id as string
    : findContainer(over.id as string, cards)

  // Cross-container move
  if (activeContainer !== overContainer) {
    if (!canDropInContainer(active.id as string, overContainer, cards)) {
      resume()
      return
    }

    if (overContainer === "canvas") {
      removeCardFromDropdown(active.id as string)
    } else {
      moveCardToDropdown(active.id as string, overContainer)
    }
  } else {
    // Same container reorder (existing logic)
    if (active.id !== over.id) {
      const containerCards = getContainerCards(activeContainer, cards)
      const oldIndex = containerCards.findIndex((c) => c.id === active.id)
      const newIndex = containerCards.findIndex((c) => c.id === over.id)
      if (oldIndex !== -1 && newIndex !== -1) {
        onReorder(oldIndex, newIndex)
      }
    }
  }

  resume()
}
```

6. Render dropdowns using DropdownSortable:
```typescript
{cards.map((card) => (
  card.card_type === "dropdown" ? (
    <DropdownSortable
      key={card.id}
      dropdown={card}
      childCards={cards.filter((c) => c.parentDropdownId === card.id)}
    />
  ) : !card.parentDropdownId && (
    <SortableFlowCard key={card.id} card={card} />
  )
))}
```

Add onDragOver={handleDragOver} to DndContext.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>FlowGrid supports multi-container drag and drop</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- dnd-utils exports all helper functions
- DropdownSortable renders nested sortable context
- FlowGrid handles cross-container drag operations
</verification>

<success_criteria>
- Cards can be dragged into expanded dropdowns
- Cards can be dragged out of dropdowns to main canvas
- Cards inside dropdowns can be reordered
- Dropdowns cannot be nested inside other dropdowns
- Visual feedback shows when dragging over dropdown
</success_criteria>

<output>
After completion, create `.planning/phases/06-advanced-cards/06-06-SUMMARY.md`
</output>
