---
phase: 04.2-linktree-import
plan: 01
subsystem: api
tags: [linktree, scraping, import, axios, cheerio, zod, layout-generation]

# Dependency graph
requires:
  - phase: 04.1-flow-layout
    provides: CardType, CardSize types and flow layout system
  - phase: 04-basic-cards
    provides: Card content infrastructure and type system
provides:
  - Zod schemas for validating Linktree __NEXT_DATA__ structure
  - Scraper service with error handling for fetching Linktree profiles
  - Layout generator algorithm for randomized visual rhythm
  - Foundation for API route to import Linktree links to cards
affects: [04.2-02-api-route, 04.2-03-ui-integration]

# Tech tracking
tech-stack:
  added: [axios, cheerio, @types/cheerio]
  patterns: [
    "__NEXT_DATA__ scraping pattern",
    "Custom error classes for user-friendly feedback",
    "Pattern-based layout generation for visual variety",
    "Deterministic randomization for consistent results"
  ]

key-files:
  created:
    - src/types/linktree.ts
    - src/lib/import/linktree-scraper.ts
    - src/lib/import/layout-generator.ts
  modified:
    - package.json

key-decisions:
  - "Use axios and cheerio for __NEXT_DATA__ extraction instead of Puppeteer (lighter weight)"
  - "Custom error classes (LinktreeNotFoundError, LinktreeEmptyError, LinktreeFetchError) for clear user feedback"
  - "Filter to only clickable links (exclude HEADER type and locked links)"
  - "Pattern-based layout generation creates 'this is different' feeling vs uniform Linktree"
  - "Deterministic randomization ensures same link count produces same layout (testable)"

patterns-established:
  - "__NEXT_DATA__ scraping: Extract embedded JSON from Next.js script tag"
  - "normalizeLinktreeInput: Accept username or full URL, auto-detect format"
  - "Layout patterns: 5 rhythm patterns cycling (hero/horizontal/square mix)"
  - "Zod validation: safeParse scraped data to catch structure changes"

# Metrics
duration: 3min
completed: 2026-01-25
---

# Phase 04.2 Plan 01: Linktree Import Infrastructure Summary

**Core scraping infrastructure for Linktree import: __NEXT_DATA__ extraction with axios/cheerio, Zod validation, and pattern-based layout generator for randomized card types**

## Performance

- **Duration:** 3 min
- **Started:** 2026-01-25T10:18:11Z
- **Completed:** 2026-01-25T10:21:06Z
- **Tasks:** 3
- **Files modified:** 4

## Accomplishments
- Zod schemas validate Linktree __NEXT_DATA__ structure with flexible optional fields
- Scraper service fetches profiles, extracts JSON, filters clickable links, handles errors gracefully
- Layout generator creates visual rhythm with 5 patterns mixing hero/horizontal/square cards and big/small sizes
- Custom error classes provide clear user feedback for not-found, empty, and fetch failures
- Foundation ready for API route and UI integration (next plans)

## Task Commits

Each task was committed atomically:

1. **Task 1: Install dependencies and create Linktree type schemas** - `15af9f0` (feat)
2. **Task 2: Create Linktree scraper service** - `07951e9` (feat)
3. **Task 3: Create layout generator for randomized card types** - `1793569` (feat)

## Files Created/Modified
- `src/types/linktree.ts` - Zod schemas for LinktreeData, LinktreeLink, LinktreePageProps validation
- `src/lib/import/linktree-scraper.ts` - scrapeLinktreeProfile and normalizeLinktreeInput exports with custom error classes
- `src/lib/import/layout-generator.ts` - generateLayoutPattern and generateLayoutPatternRandomized for visual variety
- `package.json` - Added axios, cheerio, @types/cheerio dependencies

## Decisions Made

1. **__NEXT_DATA__ scraping approach**: Use cheerio to extract embedded JSON blob from Linktree's Next.js pages instead of Puppeteer (much lighter weight, faster)

2. **Custom error classes**: Create LinktreeNotFoundError, LinktreeEmptyError, LinktreeFetchError for clear user feedback instead of generic errors

3. **Filter clickable links only**: Exclude HEADER type links and locked links per CONTEXT.md - only import actual clickable links

4. **Pattern-based layout**: 5 visual rhythm patterns (mixing hero/horizontal/square cards with big/small sizes) to create immediate "this is different" feeling vs Linktree's uniform vertical list

5. **Deterministic randomization**: Use link count modulo pattern count as start index - ensures same count produces same layout (predictable for testing, but different counts feel different)

6. **Flexible Zod schemas**: Use `.optional()` and `.nullable()` liberally to handle Linktree structure variations without breaking validation

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None - dependencies installed successfully, TypeScript compiled without errors, all exports verified.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

**Ready for next plan (04.2-02: API Route)**
- Scraper service exports ready to be called from API route
- Layout generator ready to assign card types during import
- Error classes ready for API error responses
- Zod schemas ready to validate scraped data

**Foundation complete for:**
- API route to accept username/URL and return cards array
- Image downloader to fetch thumbnails and re-upload to Supabase storage
- Mapper service to transform Linktree links to Card format

**No blockers or concerns.**

---
*Phase: 04.2-linktree-import*
*Completed: 2026-01-25*
