---
phase: 04.2-linktree-import
plan: 02
subsystem: api, ui
tags: [linktree, import, api-route, dialog, mapper, image-upload]

# Dependency graph
requires:
  - phase: 04.2-linktree-import
    plan: 01
    provides: Scraper service, layout generator, Zod schemas
provides:
  - API route for importing Linktree profiles
  - Mapper service for transforming links to cards with image handling
  - Import dialog UI with add/replace confirmation
  - Editor integration with import button and empty state
affects: []

# Tech tracking
tech-stack:
  added: []
  patterns: [
    "Structured {card, imageBlob} return for clean data flow",
    "Promise.allSettled for parallel image downloads",
    "Confirmation dialog for existing cards (add vs replace)",
    "Toast notifications for import feedback"
  ]

key-files:
  created:
    - src/app/api/import/linktree/route.ts
    - src/lib/import/linktree-mapper.ts
    - src/components/editor/linktree-import-dialog.tsx
  modified:
    - src/components/editor/cards-tab.tsx
    - src/types/linktree.ts

key-decisions:
  - "Structured MappedCardWithImage return keeps image blobs separate from card data"
  - "Images downloaded as Blob then re-uploaded to our Supabase storage"
  - "Confirmation dialog when user has existing cards (add to vs start fresh)"
  - "Permissive Zod schemas with .passthrough() to handle Linktree data variations"

patterns-established:
  - "Import dialog pattern: username input -> fetch -> confirm -> update store"
  - "API route pattern: auth -> scrape -> map -> upload images -> create cards"
  - "Error propagation: custom error classes -> API -> toast messages"

# Metrics
duration: ~15min (including debugging)
completed: 2026-01-25
---

# Phase 04.2 Plan 02: API Route, UI Dialog & Editor Integration Summary

**Complete Linktree import flow: API route orchestrating scrape/map/create, import dialog with confirmation, editor integration**

## Performance

- **Duration:** ~15 min (including Zod schema debugging)
- **Started:** 2026-01-25
- **Completed:** 2026-01-25
- **Tasks:** 3 (2 auto + 1 checkpoint)
- **Files modified:** 5

## Accomplishments
- API route at /api/import/linktree handles full import flow
- Mapper service downloads thumbnails and transforms to LinkLobby cards
- Import dialog accepts username or full URL input
- Confirmation dialog asks add/replace when user has existing cards
- Import button added to Cards tab header
- Empty state shows prominent "Import from Linktree" CTA
- Toast notifications show import results (X imported, Y failed)
- Thumbnails re-uploaded to our Supabase storage
- Cards created with varied types/sizes from layout generator

## Task Commits

1. **Task 1: Create mapper and API route** - `6b3ddd6` (feat)
2. **Task 2: Create import dialog and integrate** - `525274e` (feat)
3. **Task 3: Verify import flow** - `b66d46c` (fix - schema permissiveness)

## Files Created/Modified
- `src/app/api/import/linktree/route.ts` - POST handler for import
- `src/lib/import/linktree-mapper.ts` - mapLinktreeToCards with image download
- `src/components/editor/linktree-import-dialog.tsx` - Dialog with confirmation
- `src/components/editor/cards-tab.tsx` - Import button and empty state
- `src/types/linktree.ts` - Made schemas permissive for Linktree variations

## Decisions Made

1. **Structured return type**: MappedCardWithImage keeps `{card, imageBlob}` separate for clean API handling instead of embedding blobs in content object

2. **Permissive Zod schemas**: Added `.passthrough()` and `.nullable()` to handle Linktree's varying data structure (locked can be null, extra fields allowed)

3. **Confirmation dialog pattern**: When user has existing cards, ask whether to "Add to existing" or "Start fresh" before importing

4. **Image re-upload**: Download thumbnails from Linktree and re-upload to our Supabase storage for consistency and avoiding external dependencies

## Deviations from Plan

1. **Zod schema fixes**: Original schemas were too strict - `locked: boolean` didn't allow `null`. Fixed by making all fields nullable and adding `.passthrough()` to allow extra fields.

2. **Added debug logging**: Added console logs throughout scraper, API route, and dialog to aid troubleshooting.

## Issues Encountered

1. **Zod validation failing**: Linktree sends `locked: null` but schema expected `boolean | undefined`. Fixed by making schema permissive.

2. **Empty error response**: Error message wasn't reaching client due to instanceof checks failing in bundled environment. Fixed by also checking error.name.

## User Setup Required

None - feature is fully functional.

## Next Phase Readiness

**Phase 4.2 Linktree Import complete:**
- User can import from Linktree with one click
- Cards appear with varied types and sizes (visual variety)
- Thumbnails preserved via re-upload
- Error handling with clear messages
- Confirmation flow for existing cards

**Ready for verification and next phase (4.3 Card Context Menu & Undo/Redo)**

---
*Phase: 04.2-linktree-import*
*Completed: 2026-01-25*
